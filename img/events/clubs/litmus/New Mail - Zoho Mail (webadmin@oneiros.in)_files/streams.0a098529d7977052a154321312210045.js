"use strict";window.zmStreamsApp=window.zmStreamsApp||{},window.zmStreamsApp.constants=function(){var a={};return a.rightClickId="",a.workspaceId="zmStreamsApp",a.popupId="zms_dropdown",a.elements={},a.groupWorkId="zmStreamsGroup",a.setElements=function(){var b=a.workspaceId,c=zmsuite.getCenter(b)[0].getNodes(),d=c[2]&&c[2].$el.find(".SCS_rgt").length?c[2].$el.find(".SCS_rgt"):zmsuite.getCenter(b)[0].getNodes()[2].$el;a.elements={center:zmsuite.getCenter(b)[1],zm_stHdr:c[0].$el[0],streamListWrapper:c[2].$el[0],zm_stMain:c[1].$el[0].parentElement,zm_stPView:zmsuite.getCenter(b)[1].$el[0],preview:zmsuite.getCenter(b)[1],zm_stream:c[0].$el[0].parentElement,centerOuter:zmsuite.getCenterOuter(b).$el[0],leftHolder:c[2].$el.find(".zmGroupLft"),postHolder:d}},a.removeNotificationPreview="/ncenter/closePreview",a.closeDialog="/stream/closeDialog",a.reconnect="zmailReconnect",a.appSwitch="/apps/tabSwitched",a.mailPreviewUnload="mail/preview/unload",a.smartComposeUnload="smartCompose/removeComment",a.taskCloseTab="/zm/task/closetab",a.notificationStopEvent="/ncenter/stopEvents",a.rhsOpenClose="/integ/rhs",a.rhsWidth="",a.closeMailTab="/mail/tabClosed",a.toggleAppBar="zmsuite/appBarToggle",a.mailShareUpdate="/mail/collab/updateshareicon",a.updateShareIcon="/mail/preview/updateshare",a.maxLimit={MAX_ALLOWED_MEMBERS:200,MAX_ALLOWED_IMAGE_SIZE:300,MAX_GROUP_NAME_LENGTH:100,MAX_GROUP_DESC_LENGTH:200},a.errCode={nopost:"ENTITY_DOES_NOT_EXIST",opPermit:"OPERATION_NOT_PERMITTED",pagination:"PAGINATION_ERROR"},a.groupEvents={removeMembers:"CONTACT_BOOK_GROUP_MEMBERS_REMOVED",addModerator:"CONTACT_BOOK_GROUP_MODERATORS_ADDED",remModerator:"CONTACT_BOOK_GROUP_MODERATORS_REMOVED",addMembers:"CONTACT_BOOK_GROUP_MEMBERS_ADDED",groupAdded:"CONTACT_BOOK_GROUP_ADDED",groupRemoved:"CONTACT_BOOK_GROUP_REMOVED",groupEdit:"CONTACT_BOOK_GROUP_CHANGED"},a.streamTypeInfo={"-1":"all",1:"mail",2:"note",3:"task",4:"event",6:"status",10:"link",13:"tweet"},a.streamTypeName={all:"-1",mail:"1",note:"2",task:"3",event:"4",status:"6",link:"10",tweet:"13"},a.postLoadCount={grid:10,list:15},a.notifications={mail_type:"4",like:"23",unlike:"24",post_mention:"25",unlike_comment:"26",unshared:"27",invite:"29",add_post:"30",add_comment:"31",delete_post:"32",delete_comment:"34",delete_private_comment:"35",add_private_comment:"36",change_entity:"37",comment_mention:"38",bulk_update:"39",bulk_delete:"40",add_task:"41",reminder_task:"42",add_share_comment:"43",post_group_mention:"44",comment_group_mention:"45",add_event:"46",update_event:"47",delete_event:"48",like_comment:"49",add_group_member:"50",change_moderator:"109",remove_group_member:"51",resource_share:"52",shareperm_change:"53",shareperm_removal:"54",update_event_status_yes:"55",update_event_status_no:"56",update_event_status_maybe:"57",task_assign:"58",mail_reminder:"59",accept_share:"60",mail_share:"61",add_attachment:"62",change_task_due_date:"63",change_task_assignee:"64",change_task_status:"65",change_task_priority:"66",change_task_category:"67",change_task_title:"68",change_task_description:"69",remove_attachment:"70",draft_share:"71",draft_shareupdate:"72",draft_mailmention:"73",share_unsubscribe:"74",stream_group_enable:"75",stream_group_disable:"76",mail_streams_enable:"77",mail_streams_disable:"78",add_link:"79",change_link_category:"80",change_link_title:"81",change_link_description:"82",change_link_url:"83",mark_link_fav:"84",calendar_reminder:"85",calendar_reminder_mailid_change:"86",calendar_sharing:"87",calendar_unsubscribe:"88",biz_sub_online_renew_due_fewday:"89",biz_sub_online_renew_tdy:"90",biz_sub_online_renew_overdue:"91",biz_sub_online_renew_overdue_tdy:"92",biz_sub_offline_renew_due_fewday:"93",biz_sub_offline_renew_tdy:"94",biz_sub_offline_renew_overdue:"95",biz_sub_offline_renew_overdue_tdy:"96",biz_sub_purchase_more:"97",biz_sub_purchase:"98",domain_not_verified:"99",domains_not_verified:"100",mail_hosting_nil:"101",mx_not_pointed_to_zoho:"102",reg_domain_auto_renew:"103",reg_domain_manual_renew:"104",add_subtask:"105",edit_link:"106",lock_invites:"107",unlock_invites:"108",add_tweet:"112",draft_autosave:"118",mark_read:"121",watch_post:"122",unwatch_post:"123",favourite:"124",unfavourite:"125",pin:"126",unpin:"127",add_tag:"128",remove_tag:"129",enable_comment:"130",disable_comment:"131",archive:"134",unarchive:"135"},a.gender={0:"FEMALE",1:"MALE",2:"COMMON"},a}(),zmStreamsApp.i18ntext=function(){var a={};return a.streams=zmText.get("streams","streams"),a}(),window.zmStreamsApp=window.zmStreamsApp||{},zmStreamsApp.util=function(){var a=zmStreamsApp.constants,b=a.groupEvents,c=zmText.get("streams"),d=function(a,b){if(a){var c=a.model.toJSON();return c&&c.gnrl.id===b}return!1},e={hideMenu:function(a){$("#zm_dropDown").remove(),$(".SCS_postHover").removeClass("SCS_postHover"),a&&$(".SC_ddn").removeClass("active"),$(".SC_ddn").removeClass("SC_ddn"),$(".SC_ddnB").removeClass("SC_ddnB"),$("#zm_stream_edit").remove()},getTabElement:function(a){var b,c=zmsuite.getCenter()[0].$el,d=c.find(".SCS_tabWrapper.posFixed").is(":visible"),e=void 0!==a?a:d,f=e?"zm_staticTab":"zm_fixedTab";return b=c.find(".SCS_tabWrapper."+f)},orderComments:function(a,b){var c=_(b).map(function(b,c){var d=a[b];return d.sequence=c+1,d});return c},removeCommentClass:function(a,b,c){b&&b.listObject[a]&&b.removeClassAtStart(a,"msi-lcmnt")},removeGroup:function(a){$.publish(b.groupRemoved,{id:a})},addGroup:function(a){$.publish(b.groupAdded,{group:a,groupID:a.id})},editGroup:function(a,c){$.publish(b.groupEdit,{props:c,id:a})},groupManagement:function(a){var c=a.members,d=a.groupId;c=_.isArray(c)?c:c.split(","),"addMember"===a.mode?$.publish(b.addMembers,{id:d,members:c}):"removeMember"===a.mode?$.publish(b.removeMembers,{id:d,members:c}):"addModerator"===a.mode?($.publish(b.addModerator,{id:d,moderators:c}),c.indexOf(zmail.zuid)!==-1&&e.editGroup(d,{isOwner:!0})):"removeModerator"===a.mode&&($.publish(b.remModerator,{id:d,moderators:c}),c.indexOf(zmail.zuid)!==-1&&e.editGroup(d,{isOwner:!1}))},showGroupDetails:function(a,b){var c="zmStreamsApp"===zmTab.currentTab?zmsuite.getCenter("zmStreamsApp")[0].$el[0]:a.viewDOM,d=b&&b.type?b.type:"dropdown",e=zmUtil.createFLComp("groups",{data:a.groupInfo,search:"name",display:"name",displayAs:d,onSelect:a.fn,showCheckbox:!1,showCreate:!1,parentDOM:$(a.elm),removehandler:!0,viewDOM:c,showUnread:a.showUnread});"dropdown"===d&&$(a.elm).addClass("SC_ddn"),$.publish("/mail/menuCreated",{menuHandler:function(){$(".SC_ddn").removeClass("SC_ddn")}}),e.show()},getNameOfInvitee:function(a,b,c){var d,e="",f=0;a=a.split(",");var g=zmStreamsApp.util.getContactDetails(a);for(var h in g){d=g[h];var i=d.name||d.fn;if(i)e+=i;else for(var j in b)String(j)===h&&(e+=b[j]);!e&&c&&(e=c),f++,f!==a.length&&(e+=", ")}return e},publishDeletePost:function(a){$.publish("zmstreamsapp/deletePost",a)},getHourAndTime:function(a){var b=new Date(a),c=b.getHours(),d=b.getMinutes(),e=c>=12?"PM":"AM";return c%=12,c=c?c:12,(c<10?"0":"")+c+":"+(d<10?"0":"")+d+" "+e},getFullDateFormat:function(a){var b=new Date(a);return"undefined"==typeof b.getDateBy?b="":(b=b.getDateBy(zmail.userDateFormat.toUpperCase()),b+" "+zmStreamsApp.util.getHourAndTime(a))},updateTime:function(a){var b,d,e,f=new Date(a),g=new Date;if(d=f.toDateString()===g.toDateString(),e=f.getFullYear()===g.getFullYear(),b=g-f,b=Math.floor(b/6e4),e&&b&&b>0)return d?b<60?1===b?b+" "+c.streams.common.minago:b+" "+c.streams.common.minsago:zmStreamsApp.util.getHourAndTime(a):f.toDateString().slice(0,10).toUpperCase();if(!e){var h=f.toDateString().slice(4,10).toUpperCase();return h+", "+String(f.getFullYear())}return!1},getMentionList:function(a){var b=[],c=a.myact?a.myact:a.get("myact");b=c.showinvite?[]:c.mention;var d=a.gnrl?a.gnrl:a.get("gnrl"),e=d.group.id;if(c.showinvite)b="org";else if(!c.showinvite&&zmUtil.isGroupMember(zmail.zuid,e)){var f=c.inviteeList||[],g=zmStreamsApp.util.getGroupDetails(e).members||[];if(b=g.concat(f),b=b.concat(e),d.shared){var h,i=c.shGroup;for(var j in i)h=i[j].id,h!==zmail.zuid&&zmUtil.isGroupMember(zmail.zuid,h)&&(b=b.concat(h))}}return b},getMentionData:function(a){var b,c,d="",e=zmMention.getMentions($(a)),f=[],g=e.length;for(b=0;b<g;b++)c=e[b].zid||e[b].id,f.push(c);d=f.join(",");var h;return d.length&&(h=zmAutoFill.mentionData($(a))),{offset:h,mention:d}},getMentionDataEditor:function(a){a=a||[];for(var b,c=[],d=[],e=[],f=0,g=a.length;f<g;f++)"mention"===a[f].type&&(c.push(a[f].id),d.push(a[f].start),e.push(a[f].end));return b=c.join(","),{offset:{from:d,to:e,text:c},mention:b}},getMentionsFromTextArea:function(a){var b=$(a).data().editor;if(b){var c=b.getMetaBlocks(),d=zmStreamsApp.util.getMentionDataEditor(c);return d}return{}},getCaretPosition:function(a){var b=$(a).data().editor;if(b)return b.getCursorPosition()},getPostType:function(a){var b=zmStreamsApp.constants.streamTypeInfo[a];return c.streams.post.postType[b]},sendRemove:function(a,b,c){b?$(a).removeClass("zs_snd"):void 0!==b&&$(a).addClass("zs_snd"),$(a).text(c)},membersSetPagination:function(a,b,c){var d=a.splice(b,c);return d},membersFilter:function(a,b){var c=zmStreamsApp.util.getGroupDetails(a),d=_zm.copyOf(zmStreamsApp.util.getContactDetails(c.members));d=_.toArray(d);var e=zmAutoFill.filterArray(d,["fn","eid","nn"],b,!0);return""!==b&&(e=e.slice(0,99)),e},showMembersDialog:function(a,b){var c=zmStreamsApp.template.listMembers(a),d={$content:c,title:b,dialogDidMount:function(a){a.$els.$content.css("max-height",.6*$(window).height())}};Dialog["new"](d)},createDialog:function(a){var b,d=a.items,e=a.shGroup,f=a.users,g=a.streamsEnabled,h={},i=Object.keys(d);h=zmStreamsApp.util.getContactDetails(i);for(var j in h)if(h[j].isDummyObj){for(var k in e)String(e[k].id)===j&&(h[j]=e[k],h[j].isGroupid=!0);h[j].isDummyObj&&(h[j].fn=f[j]||"")}for(var l in d)b=zmStreamsApp.util.getContactDetails([d[l]])[d[l]],b.isDummyObj&&(b.fn=f[d[l]]),h[d[l]]=b;var m=_.pick(a.items,function(a){return a===String(zmail.zuid)}),n=_.pick(a.items,function(a){return a!==String(zmail.zuid)}),o=[],p=[];o.push(n),p.push(m);var q=_.size(o[0])%2;if(q&&0!==_.size(p[0])){var r=Object.keys(p[0])[0],s={};s[r]=p[0][r],o.push(s),delete p[0][r]}var t=zmStreamsApp.template.popup[a.type](p,a.showInvite,h,a.isOwner,g),u={};u.$content=t,u.dialogDidMount=a.dialogDidMount,a.closeAction&&(u.closeAction=a.closeAction),u.dialogWillMount=function(b){$(b.$els.$content).append(zmStreamsApp.template.popup[a.type](o,a.showInvite,h,a.isOwner,g));var c=_.size(o[0])+_.size(p[0]);if(a.showInvite){var d=zmStreamsApp.template.invitee_input();$(b.$els.$content).after(d),c>1&&$(d).css("width",500),setTimeout(function(){$(d).find("input").focus()},500)}c>1&&$(b.$els.$contentWrapper).css("width",500),$(b.$els.$content).css("max-height",.8*$(window).height())},a.buttons&&a.buttons.length>0&&(u.buttons=a.buttons),u.title=c.common.labels.invitee,Dialog["new"](u)},createPopup:function(b){var c={};if("invitee_popup"===b.type){var d=b.items,e=b.shGroup;for(var f in d)if(zmUtil.isGroup(f))c[f]=zmStreamsApp.util.getGroupDetails(f);else{for(var g in e)String(e[g].id)===f&&(c[f]=e[g]);void 0===c[f]&&(c[f]=zmStreamsApp.util.getContactDetails([f])[f])}}var h=zmStreamsApp.template.popup[b.type](b.items,b.invite,c,b.showInvite),i={par:b.parent,showArrow:!0,liDom:h,ulClass:b.ulclass,spanClass:b.parentClass,id:a.popupId};return b.callback&&(i.clk=b.callback),b.buttons&&b.buttons.length>0&&(i.buttons=b.buttons),b.direction&&(i.direction=b.direction),b.noArrow&&(i.showArrow=!1),void 0!==b.liHover&&(i.liHover=b.liHover),b.align&&(i.align=b.align),b.container&&(i.container=b.container),b.onhide&&(i.onHide=b.onhide),b.avoidScroll&&(i.avoidScroll=b.avoidScroll),zmStreamsApp.util.showDropdown(i,b.hoverElm),b.done&&b.done($("#zm_dropDown")),$("#zm_dropDown")},closePreview:function(){var a=zmsuite.getCenter(),b=$(a[1].$el),c=b.data("view");c||(b=$(a[0].$el),c=b.data("view")),c&&c.remove(),a[1].$el.parent().removeClass("SC_sw"),a[1].close();var d=a[0].$el.find(".streamsList").filter(".zmSLst");if(d.length){d.removeClass("zmSLst");var e=zmStreamsApp.events.getCurrentView();if("unread"===e.view&&"zmStreamsApp"===zmTab.currentTab&&(d.remove(),!e.elm.children().length)){var f=$(e.tab).parent().siblings(".postFilter")[1];f&&$(f).hide();var g=zmStreamsApp.PostApp.template.noPost();$(e.elm).empty().append(g)}}},bindEntityElements:function(a){var b=a.entityElem,c=a.entityId,e=zmUtil.getMailObj(c),f=e.TH,g=zmsuite.getCenter(),h=f?e.T:c,i=$(g[1].$el).find(".SC_Twpr"),j=i.data("view"),k=d(j,h);j&&k||(i=$(g[0].$el).find(".SC_Twpr"),j=i.data("view"),k=d(j,h),j&&k||(i=a.entityElem.parents(".SCS_postMail"),j=i.data("view"))),f||(i=""),b.hasClass("msi-fav")?j.addLabel(b,"","",i):b.hasClass("zmst_lbl")&&j.applyLabel(b,!0)},getDropdownMenu:function(a,b){var d=$(zmsuite.getCenter()[1].$el).find(".SC_Twpr").data("view");d||(d=$(zmsuite.getCenter()[0].$el).find(".SC_Twpr").data("view")),d||"2"!==b&&"3"!==b||(d=$(zmsuite.getCenter()[1].$el).find(".SCS_post").data("view"));var e,f=zmStreamsApp.PostApp.getModelForEntity(a,b);e="2"===b?c.streams.post.postType.note:"3"===b?c.streams.post.postType.task:c.streams.post.postType.mail;var g=[],h=f.getGnrlInfo(),i=zmStreamsApp.util.getGroupDetails(h.group.id),j=h.owner||i&&i.isOwner;if("2"===b||"3"===b){g.push({htm:c.common.labels.print,data:{action:"print",fn:function(){zmStreamsApp.util.printEntity({pid:f.get("gnrl").id,etype:b,actionType:zmStreamsApp.events.getActionType(f.getGroupInfo()),gid:f.getGroupInfo().id,allComments:!0})}}});var k="",l="",m=i.disabled;if("2"===b&&(zmUtil.isGroupMember(zmail.zuid,h.group.id)||h.owner))k=c.common.labels.postAsNewNote,j&&!m&&(l=c.common.labels.moveNote);else if("3"===b){k=c.common.labels.postAsNewTask;var n=f.get("tasks");j&&n&&!n.subTaskPosition&&!m&&(l=c.common.labels.moveTask)}k&&g.push({htm:k,data:{action:"postasnew",fn:function(){d.postAsNew.apply(d)}}}),l&&g.push({htm:l,data:{action:"moveEntity",fn:function(){d.moveEntity.apply(d)}}})}if(zmUtil.isArchiveEnabled()&&j){var o=h.archived?c.common.labels.unarchive:c.common.labels.archive;g.push({htm:o+" "+e,data:{action:"archive",fn:function(){d.archivePost.apply(d)}}})}if("3"!==b&&g.push({htm:c.streams.activitylog.timeline,data:{action:"streamsTimeline",fn:function(){zmStreamsApp.PostActions.getActivityLogs(f,!1,d.$el),setTimeout(function(){var a=d.$el.find(".SCS_postAct"),b=_zm("<","body")[0].getBoundingClientRect(),c=d.$el.find(".SCS_activitiyFeed").offset().top;a&&c>b.height&&a[0].scrollIntoView({behavior:"smooth"})},500)}}}),g.push({htm:f.get("myact").watching?c.common.labels.unwatch+" "+e:c.common.labels.watch+" "+e,data:{action:"watch",fn:function(){d.watchPost.apply(d)}}}),f.get("myact").showdelete&&g.push({htm:c.common.labels.deleteOnly+" "+e,data:{action:"streamsdelete",fn:function(){d.deletePost.apply(d)}}}),h.owner){var p=f.get("cmnt").total>0?c.common.labels.disableFurtherComments:c.common.labels.disableComments,q=h.allowComments?p:c.common.labels.enableComments;g.push({htm:q,data:{action:"streamsdelete",fn:function(){d.enableDisableComment.apply(d)}}})}return g.push({htm:c.common.labels.copylink,data:{action:"copylink",fn:function(){d.showDialogLink.apply(d)}}}),g},hideOptions:function(){var a=zmsuite.getCenter();_zm(".","msi-gototop",a[0].$el[0])[0].parentElement.parentElement.style.visibility="hidden",_zm(".","msi-status",a[0].$el[0])[0].parentElement.parentElement.style.visibility="hidden"},removeViews:function(a,b,c){b=b.element?b.element:b,zmStreamsApp.util.detachAndRemove(b,c)},detachAndRemove:function(a,b){var c=$.Deferred();try{b=b||zmTab.currentTab,a=a||zmsuite.getCenter(b)[0].$el;var d=$(a).find("#s_postview");if(d=d.length?$(d):$(a),d.length){var e=$(d).find("div.SCSpostAct");e.length&&zmStreamsApp.PostActions.removeViews(e);var f=$(d).find("div.sc_cmdv");f.length&&zmStreamsApp.CommentModule.removeViews(f);var g=$(d).find("div.SCS_post");!g.length&&$(d).hasClass("SCS_post")?g=$(d):!g.length&&$(d).find(".SC_Twpr")&&(g=$(d).find(".SC_Twpr")),g.length&&zmStreamsApp.PostApp.removeViews(g);var h=$(d).find("div.zmL");h.length&&zmStreamsApp.PostApp.removeViews(h),c.resolve()}else c.resolve()}catch(i){zmUtil.debugLog(i),c.resolve()}return c},restoreStreams:function(a){var b=zmStreamsApp.RouteHelper,d={appname:c.common.labels.appName,appId:a,data:{CNodes:"3"},appIcon:"msi-streams",searchPlaceHolder:c.common.labels.searchStreams,faqKey:"Streams",router:b,onDelete:function(){return $.publish(zmStreamsApp.constants.removeNotificationPreview,{element:zmsuite.getCenter(a)[0].$el[0]}),!0}};return{streamAppObj:d,tabRouter:b}},printEntity:function(a){var b=zmStreamsApp.constants.streamTypeName;a.etype===b.note?zmUtil.loadNotes("printNote",{data:{id:a.pid,namespaceId:a.gid}}):(a.dataRequest=!0,a.callback=function(a){var d=a,e=d.gnrl.type,f=zmStreamsApp.PostApp.template.post({data:a,grid:!0,type:"Status",id:a.id,isPrint:!0}),g=$(f).find(".postMsg");e===b.task?zmStreamsApp.PostApp.components.addTask(a,g):e===b.event?zmStreamsApp.PostApp.components.addEvent(a,g):e===b.link?zmStreamsApp.PostApp.components.addLink(a,g):e===b.tweet&&zmStreamsApp.twitter.showTweet(a,g);var h={elm:$(f).find(".SCS_postWra"),by:d.gnrl.by,id:d.id,etype:e,groupId:d.gnrl.group.id,showinvite:d.myact.showinvite,like:d.myact.like,invitee:parseInt(d.act.invitees),likes:parseInt(d.act.likes),postUuid:d.gnrl.on,inviteeList:d.myact.inviteeList,isOwner:d.gnrl.by===zmail.zuid,lockInvites:d.gnrl.lockInvites,shGroup:d.myact.shGroup,mentionList:d.myact.mention,isDraft:d.gnrl.draft,shared:d.gnrl.shared};zmStreamsApp.PostActions.getPostTemplate(h);var i=zmStreamsApp.util.orderComments(d.cmnt.comments,d.cmnt.order);i.total=d.cmnt.total;var j={elm:$(f).find(".SCS_postWra"),comments:i,id:d.id,isShare:!1,groupId:d.gnrl.group.id,etype:e,owner:d.gnrl.by,isDisableAdd:!0,shGroup:d.myact.shGroup,isPrint:!0};zmStreamsApp.CommentModule.getCommentTemplate(j),zmail.Printer.print({title:c.common.labels.titlePrint,content:f,css:["streams.css"]})},zmStreamsApp.PostApp.singlePost(a))},reconnectActions:function(){zmUtil.getGroupOrder().length&&(window.console.log("Updating streams View, in respond to zmailReconnect - "+new Date),"undefined"!=typeof zmStreamsApp.GroupApp&&zmStreamsApp.GroupApp.getAllUnread(),"undefined"!=typeof zmStreamsApp.PostApp&&zmStreamsApp.PostApp.updateCurrentListing(),e.setStreamsAppSelection())},setStreamsAppSelection:function(b,c,d){c=c||zmTab.currentTab;var f=a.workspaceId;if(c!==f&&d===f&&"m"===(zmApp.selectedApp||zmApp.currentApp))zmail.mailLeft.getNodes()[0].resetDefaultSelection();else if(c===f&&zmStreamsApp.GroupApp&&zmStreamsApp.GroupApp.GroupId){var g=e.getGroupDetails(zmStreamsApp.GroupApp.GroupId);g.disabled?zmail.mailLeft.getNodes()[0].setTempSelection("zmStreamTree","disabledGrp"):zmail.mailLeft.getNodes()[0].setTempSelection("zmStreamTree",zmStreamsApp.GroupApp.GroupId)}},getContactDetails:function(a){var b,c,d={};if(a&&a.length)for(var e=0,f=a.length;e<f;e++){if(b=String(a[e]),zmUtil.isGroup(b))c=zmStreamsApp.util.getGroupDetails(b);else{var g={isDummyObj:!0,photo:zmResource.get("image","SC-Photo.png"),fn:"",zid:"",eid:"",nn:""},h=zmail.ContactBook.get({zuid:b,type:"org",promise:!1});h.length?(c=h[0].attrs,c.avatar=h[0].avatar()[0]):c=g}d[b]=c}return d},getGroupDetails:function(a,b){zmUtil.loadGroupManagement();var c,d={},e={includeGroupHome:Boolean(a||b),includeAllGroups:!0};if(c=zmail.ContactBook.getGroups(a,e),!a&&c.length){var f;d={};for(var g=0;g<c.length;g++)f=c[g].attrs,f&&(d[f.id]=f,d[f.id].avatar=c[g].avatar()[0])}else c.length?(d=c[0].attrs,d.avatar=c[0].avatar()[0]):!c.length&&zmUtil.isNewGroupUser()&&zmStreamsApp.GroupManageApp&&(d=zmStreamsApp.GroupManageApp.getGroup(a),d.disabled&&(d.isDisabled=!0));return d},reOrderMembers:function(a){for(var b=a.members,c=[a.owner],d=a.moderator,e=[],f=[],g=[],h=0;h<b.length;h++)c.indexOf(b[h])!==-1?e.push(b[h]):d.indexOf(b[h])!==-1?f.push(b[h]):g.push(b[h]);return e.concat(f).concat(g)},generateAvatarTemp:function(a,b,c){var d=zmail.ContactBook,e=a,f="";return b||(e=d.Utils.initials(a)),c||(f=d.Utils.colorClasses()),d.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:e,avatarBgColor:f})[0]},getAttachments:function(a,b){var d={},e=$.Deferred();if("undefined"!=typeof a&&""!==a){if(!a.isUploadCompleted()){var f=b?c.streams.common.attUpComm:c.streams.common.attUpPost;zmUtil.succErrMsg("i",f)}a.getStoreAttachments().done(function(a){var b=a.tempLocation,c=a.myAttachment;b.error?d=b:(d.attTmpObj=JSON.stringify(b),d.attEntObj=JSON.stringify(c)),e.resolve(d)}).fail(function(){e.reject()})}else"undefined"!=typeof a&&""!==a||e.resolve(d);return e.promise()},showDropdown:function(a,b){var c=zmsuite.showMenu(a);if(b){var d="SC_ddn";c&&c.dropObj&&("bottom"===c.dropObj.mountPosition?d="SC_ddnB":"top"===c.dropObj.mountPosition&&(d="SC_ddn")),$(b).addClass(d)}return c},adjustWidth:function(a,b){if(zmUtil.isSelectedShareEnabled()&&"undefined"!=typeof zmsuite.getCenter()[1]){var c=zmsuite.getCenter();if(c[1]){var d=c[1].$el;if(d&&d.length&&d.hasClass("shw")){var e=c[1].$el.find("div.zmCmntFixed"),f=d[0].getBoundingClientRect().width-20;e.css("width",f+"px")}}}},addInvitee:function(a){var b=zmail.conPath+"/post.do",c={mode:"invite",actionType:"addInvitee",entityId:a.pid,entityType:a.etype,fZuid:a.zuid,streamsView:!0,groupId:a.gid},d={t:"POST",u:b,p:c,fn:function(b){a.succCallbk(b)},error:function(b){a.errCallbk(b)}};zmAjq.XHR(d)},errorHandling:function(a){var b=zmStreamsApp.template.errorTemplate(a),d=b.element,e=c.common.messages;return zmail.isInternalOrgUser&&$(d).find(".requestAuthor").unbind().bind("click",function(){if(!$(d).find(".requestSnt").hasClass("disButton")){$(d).find(".requestAuthor").text(e.requesting),$(d).find(".requestSnt").addClass("disButton");var b=zmail.conPath+"/post.do",c={mode:"accessRequest",groupId:a.gid,entityId:a.pid,entityType:a.etype},f={t:"POST",u:b,p:c,fn:function(){var a=$(d).find(".requestAuthor");a.text(e.requested),a.attr("data-val","Disabled")},error:function(a){zmUtil.succErrMsg("e",e.errRequest),$(d).find(".requestSnt").removeClass("disButton"),$(d).find(".requestAuthor").text(e.requestAccess)}};zmAjq.XHR(f)}}),b},selfPhotoUrl:function(){var a="//"+zmail.urls.contactsURL+"/file?fs=thumb&nocache="+Date.now();return a},defaultGroupPhotoUrl:function(){return zmResource.get("image","streams/SC-Group.png")},storeUnposted:function(a,b,c,d){b=b||{};var f=function(a){var b,c,d,e;return b=a.text?a.text.trim():"",d=a.mentions?_.size(a.mentions):0,e=a.replyTo?_.size(a.replyTo):0,c=a.attachment?_.size(a.attachment):0,!(b||d||e||c)};if("localStorage"in window&&null!==window.localStorage){var g=zmail.zuid+"_streamsContent",h=localStorage.getItem(g);if(h){var i=JSON.parse(h);if(i[a]){if(b.hasOwnProperty("text")&&(i[a].text=b.text),b.hasOwnProperty("replyTo")&&(i[a].replyTo=b.replyTo),b.hasOwnProperty("mentions")&&(i[a].mentions=b.mentions),b.hasOwnProperty("attachment")&&(i[a].attachment=b.attachment),f(i[a]))return void e.removeUnposted(a,c,d)}else{if(f(b))return;i[a]={text:b.text||"",attachment:b.attachment||"",mentions:b.mentions||"",replyTo:b.replyTo||""}}localStorage[g]=JSON.stringify(i)}else{if(f(b))return;var j={};j[a]={text:b.text||"",attachment:b.attachment||"",mentions:b.mentions||"",replyTo:b.replyTo||""};var k=JSON.stringify(j);localStorage.setItem(g,k)}}else if(c)d&&(b.hasOwnProperty("text")&&d.set("unPost",b.text),b.hasOwnProperty("mentions")&&d.set("mentions",b.mentions),b.hasOwnProperty("attachment")&&d.set("attachment",b.attachment));else{var l=zmStreamsApp.CommentModule.unPost||{};l[a]||(l[a]={}),b.hasOwnProperty("text")&&(l[a].text=b.text),b.hasOwnProperty("replyTo")&&(l[a].replyTo=b.replyTo),b.hasOwnProperty("mentions")&&(l[a].mentions=b.mentions),b.hasOwnProperty("attachment")&&(l[a].attachment=b.attachment),f(l[a])&&delete l[a]}},retrieveUnposted:function(a,b,c){var d={};if("localStorage"in window&&null!==window.localStorage){var e=zmail.zuid+"_streamsContent",f=localStorage.getItem(e);if(f){var g=JSON.parse(f);g[a]&&(d=g[a])}}else if(b)c&&(d={text:c.get("unPost"),mentions:c.get("mentions"),attachment:c.get("attachment")});else{var h=zmStreamsApp.CommentModule.unPost||{};h[a]&&(d=h[a])}if(zmUtil.isNettyUploadEnabled()&&Array.isArray(d.attachment)){var i=d.attachment.filter(function(a){return a.virusFree});d.attachment=i}return d},removeUnposted:function(a,b,c){if(a=a||"","localStorage"in window&&null!==window.localStorage){var d=zmail.zuid+"_streamsContent",e=localStorage.getItem(d);if(e){var f=JSON.parse(e);if(f[a]){if(delete f[a],!_.size(f))return void localStorage.removeItem(d);localStorage[d]=JSON.stringify(f)}}}else if(b)c&&(c.set("unPost",""),c.set("mentions",""),c.set("attachment",""));else{var g=zmStreamsApp.CommentModule.unPost||{};g[a]&&delete g[a]}},triggerSearch:function(a){a=_zm.copyOf(a);for(var b,c,d,e=zmail.Search,f=e.Models.Filters,g=[],h=e.Utils.CommonUtil.appUtil.filterConstantsNames,i=0;i<a.length;i++)switch(b=a[i],b.name){case f.GroupFilter.name:c=zmail.ContactBook.getGroups(b.value),g.push({name:b.name,value:c[0]});break;case f.HashtagFilter.name:g.push({name:b.name,value:b.value});break;case h.PostedBy:d=zmail.ContactBook.get({zuid:b.value,promise:!1}),g.push({name:b.name,value:d[0]})}g&&(zmail.Search.setContext(e.Models.Contexts.streamSearchContext),zmail.Search.newSearch(g))},loadMemberPopup:function(a){var b=zmStreamsApp.util.getGroupDetails(a);if(b.isOwner)zmUtil.loadGroupManagement().then(function(){zmStreamsApp.GroupManageApp.triggerEditGroup(a,{type:"mem",callback:zmStreamsApp.events.loadPostsOfUsers})});else{var d={gid:a,callback:zmStreamsApp.events.loadPostsOfUsers,title:c.groupSubscription.memberActions.loadPost};zmStreamsApp.GroupApp.showMemberDialog(d)}}};return e}(),window.zmStreamsApp=window.zmStreamsApp||{},window.zmStreamsApp=function(a){var b=zmText.get("streams"),c=zmStreamsApp.constants;a.constructWorkSpace=function(b,d){var e,f=c.workspaceId,g=zmStreamsApp.util.restoreStreams(f);if("restore"===d&&zmsuite.isWorkspaceAvailable(f))zmsuite.resetWorkspace(f,g.streamAppObj);else if(!zmsuite.setWorkSpace(g.streamAppObj))return!1;e=a.getCenter($(zmStreamsApp.constants.elements.postHolder)),zmsuite.renderWorkSpace(),zmsuite.showWorkSpace(f);var h="SC_streams";return $(e[1].$el[0].parentElement).addClass(h),c.setElements(),!0};var d=function(a){var b=zmStreamsApp.events.getCurrentView(),c=b.elm.parent().children();c.each(function(c,d){$(d).find("div.SC_nmsg").length||"files"===b.view&&"s_files"===$(d).attr("id")||$.when(zmStreamsApp.util.detachAndRemove(d)).done(function(){$(d).data({grid:"grid"===a,request:!1,next:""}).empty()})})},e=function(a){var b,e,f="msi-gridview"===a;if(c.setElements(),b=c.elements.zm_stHdr,e=$(b).find(".SC_sel i").hasClass(a),!e){var g=$(c.elements.zm_stMain).find(".SCS_lft");g.length&&$(c.elements.zm_stMain)[f?"removeClass":"addClass"]("SC_list"),$(b).find(".SC_sel").removeClass("SC_sel"),$(b).find("."+a).parents("b").addClass("SC_sel");var h=zmStreamsApp.events.getCurrentGroupId();d(f?"grid":"list");var i=zmStreamsApp.events.getCurrentView();if(i.elm.parent()[f?"addClass":"removeClass"]("SCS_rgtIn"),"files"===i.view)zmStreamsApp.PostApp.attachScrollRef.toggleView();else{var j={view:i.view,gridview:f,switchView:!0};zmStreamsApp.PostApp.init(i.elm,h,j,!1)}var k=f?"grid":"list";zmAdHocSettings.setStreamsListType(k)}};a.getCenter=function(a,c){var d,f=zmsuite.getCenter(),g=f[0].getNodes(),h={list:{left:[],right:[{actionArr:[{iconList:["msi-status"],tooltip:b.common.tooltips.writeStatus,data:"status"},{iconList:["msi-gototop"],tooltip:b.common.tooltips.toTop,data:"gototop"}]},{actionArr:[{iconList:["msi-gridview"],tooltip:b.common.tooltips.gridView,data:"grid"},{iconList:["msi-listview"],tooltip:b.common.tooltips.listView,data:"list"}]}]},clk:function(a,b,c){if("msi-gototop"===b)$(zmsuite.getCenter()[0].$el.find(".SCS_rgt")).animate({scrollTop:0},500);else if("msi-listview"===b||"msi-gridview"===b)e(b);else if("msi-status"===b){$(zmsuite.getCenter()[0].$el.find(".SCS_rgt")).animate({scrollTop:0},500);var d=zmsuite.getCenter()[0].$el.find("#s_sbox textArea");d.click(),d.focus()}}};if(c&&c!==zmail.zuid){var i=zmStreamsApp.util.getGroupDetails(c),j=i.members.length,k=j+(1===j?" "+b.common.labels.person:" "+b.common.labels.members),l=i.eid?"<span id='geid' class='SC_lnk'>"+i.eid+"</span>":"",m=zmail.IntegrationStatus.CHAT?"<span><i class='msi-chat' id='createChat'></i></span>":"",n=i.isOwner?"<div class='SCmb'><ul><li class='SC_lbr SC_lbR'><b class='moreOpt'><div class='SC_hd'></div><span><i class='msi-action'></i></span></li></ul></div>":"";d="<div class='SCmb'><ul><li class='SCtxt'><b class='gdrop'><div class='SC_hd'></div><span class='gName'>''<i class='msi-barrow'></i></span></b></li></ul></div>"+l+"<span id='viewmembers' class='SC_lnk'>"+k+"</span>"+m+n}else d="<div class='SCmb'><ul><li class='SCtxt'><b class='gdrop'><div class='SC_hd'></div><span class='gName'>"+b.common.labels.home+"<i class='msi-barrow'></i></span></b></li></ul></div>";var o={list:{left:{leftHTML:d,centerAlign:!0}}};return g[0].push(h.list),g[0].setListener("click",h.clk),g[1].push(o.list),g[1].setListener("click",o.clk),g},a.currentListingView=function(){var a,b,d,e;return c.setElements(),a=c.elements.zm_stHdr,d=$(a).find(".SC_sel i").attr("class"),b={"msi-gridview":"grid","msi-listview":"list"},e=b[d]||"grid"},a.init=function(a,b){a&&(zmUtil.isGroup(a)||zmail.zuid===a)||(a=zmail.zuid);var c=!("list"===zmAdHocSettings.getStreamsListType());a=a?a:zmail.zuid;var d={view:"all",gridview:c,addTitleHeader:!0};if(a===zmail.zuid&&_zm.isAllUnreadEnabled()){var e=zmStreamsApp.util.getGroupDetails(a);e.scount>0&&(d.view="unread")}zmStreamsApp.PostApp.init("",a,d,!0,!1,b)};var f=function(){$.subscribe(c.removeNotificationPreview,function(a,b){if(zmStreamsApp.CommentModule.retainComment(b.element),zmStreamsApp.util.removeViews(a,b),"tab"===b.from){var c=zmsuite.getCenter()[1].getNodes(),d=c[0].headerArr.rIcons;if(d.length){var e=d.filter(function(a){return"chatlet"===a[0].data.action});if(e.length){var f=d.indexOf(e[0]);c[0].headerArr.rIcons.splice(f,1),c[0].render()}}}}),$.subscribe(c.closeDialog,zmStreamsApp.util.removeViews),$.subscribe(c.reconnect,zmStreamsApp.util.reconnectActions),$.subscribe(c.mailPreviewUnload,function(a,b){zmStreamsApp.util.detachAndRemove(b.prevElem)}),$.subscribe(c.closeMailTab,function(a,b){zmStreamsApp.util.detachAndRemove(b.container)}),$.subscribe(c.smartComposeUnload,function(a,b){zmStreamsApp.util.detachAndRemove(b.prevElem)}),$.subscribe(c.taskCloseTab,function(a,b){zmStreamsApp.util.detachAndRemove(b.prevElem)}),$.subscribe(c.appSwitch,zmStreamsApp.util.setStreamsAppSelection),$.subscribe(c.rhsOpenClose,zmStreamsApp.util.adjustWidth),$.subscribe(c.toggleAppBar,zmStreamsApp.util.adjustWidth),zmUtil.isSelectedShareEnabled()&&$(window).on("resize",function(){zmStreamsApp.util.adjustWidth()})};return f(),a}(window.zmStreamsApp||{}),zmStreamsApp.template=function(){var a=zmText.get("streams"),b={},c=function(a,b){var c;return c=a.from>b.from?1:a.from===b.from?0:-1,"QUOTE"===b.type&&a.from>b.from&&(c=1),c},d=function(a,b,c,d,e){var f=zmStreamsApp.util.getContactDetails([a.text])[a.text],g={},h="zms_mention",i=f.fn;i=!i&&b&&b.id===a.text?b.name:c.substring(a.from,a.to);var j=[];d&&d.length&&(j=_.pluck(d,"id")),(zmUtil.isGroup(a.text)||j.indexOf(a.text)!==-1)&&(h+=" cursorDefault");var k="";return"string"==typeof b&&b.indexOf("#")!==-1?k=b.substring(0,b.indexOf("#")):"object"===("undefined"==typeof b?"undefined":babelHelpers["typeof"](b))&&(k=b.id),k&&h.indexOf("cursorDefault")===-1&&(zmUtil.isGroup(k)||_.size(e)&&e.indexOf(a.text)!==-1)&&!zmUtil.isGroupMember(a.text,k)&&(h+=" inviteeColor"),g=f.zid?{"data-zid":a.text}:{},g["class"]=h,["SPAN",{attrs:g,child:[["text",String(i)]]}]},e=function(a,b,c,e,f){var g=[],h=a.type;if("MENTION"===h)g=d(a,c,b,e,f);else if("HASHTAG"===h){var i=b.substring(a.from,a.to),j=i.indexOf("#"),k=i.substring(0,j);g=["SPAN",{attrs:{"class":"zm_HTag"},child:[["text",k+"#"],["SPAN",{child:[["text",String(a.text.substring(1))]]}]]}]}else if("LINK"===h)g=["A",{attrs:{href:a.text,
target:"_blank"},child:[["text",a.text]]}];else if("SMILEY"===h){var l=a.text;g=["EM",{attrs:{"class":l,style:"vertical-align:middle;",title:a.title||""}}]}else"BOLD"===h?g=["STRONG",{child:[["text",a.text]]}]:"ITALIC"===h?g=["I",{child:[["text",a.text]]}]:"STRIKE"===h&&(g=["STRIKE",{child:[["text",a.text]]}]);return g},f=function(a){var b=zmUtil.parseURLS(a,{httpOnly:!0}),c=[];if(b.length){var d=0,e=b.length;for(d=0;d<e;d++)c.push({from:b[d].startIndex,to:b[d].endIndex,text:b[d].url,type:"LINK"})}return c},g=function(a,c,d,e,f){var g,h=0,i=c.length,j=[],k="";for(h=0;h<i;h++)g=c[h],"LINK"!==g.type&&"SMILEY"!==g.type&&j.push({from:g.from-d,to:g.to-d,type:g.type,text:g.text});var l,m={text:a,offset:j,group:e};return f?(l=b.richTextOffSet(m),k=["SPAN",{attrs:{"class":"SC_quote"},child:[["text:html",l]]}]):(l=b.setOffsetValues(m),k=["SPAN",{attrs:{"class":"SC_quote"},child:[l]}]),k};return b={errorTemplate:function h(b){var c,d,e,f,g=zmStreamsApp.constants.errCode,i=[],j=b.accessRequest;if(b.code===g.opPermit){if(c="noAccess",d=a.common.messages.allowHeader,e=a.common.messages.allowCont,f=a.common.labels.errAccess,zmail.isInternalOrgUser&&"DENIED"!==j){var k="REQUESTED"===j,l=k?"Disabled":"",m=k?a.common.messages.requested:a.common.messages.requestAccess;i=["DIV",{attrs:{"class":"SC_PUbtm requestSnt"},child:[["SPAN",{attrs:{"class":"requestAuthor","data-val":l},child:[["text",m]]}]]}]}}else c="doesNotExist",d=a.common.messages.notFoundHeader,e=a.common.messages.notFoundCont,f=a.common.labels.errFound;var h=["DIV",{attrs:{"class":"zmErrorPage "+c},child:[["DIV",{attrs:{"class":"zmEPMsg"},child:[["H4",{child:[["text",d]]}],["P",{child:[["text",e]]}],i]}]]}];return{element:_zm.getDOM(h),title:f}},RenderAttachment:function(a,b){b=b||{};var c,d=b.isDraft,e=a.attArr,f=[],g=e.length,h=a.pid;h=h.indexOf("#")!==-1?h.substring(h.indexOf("#")+1,h.length):h;for(var i,j=a.actionType,k=a.groupId,l=0;l<g;l++)i=e[l],i.inline||(c={Id:i.id,e:h,et:a.type,fs:i.size,ft:i.ft,l:i.l,fn:i.name,p:i.part,thn:i.thn,tn:!0,type:j,u:i.u,gId:k},f.push(c));var m={attList:f,entityInfo:{groupId:k,e:h,et:a.type,actionType:j},appName:"streams"};d?(m.attClass="SC_Pbar zmAch",m.attListClass="zmCAt"):(m.attListClass="zmPAtt",m.showTag=!0,m.supportDrag=!0),b.showZipOpt&&(m.zipType="downloadall",m.showMOpt=!0);var n=zmAttach.build(m);return n},setOffsetValues:function(a){var b=a.text,d=a.offset,h=a.span?"DIV":"SPAN",i=0,j=-1,k=[h,{attrs:{"class":"zmsPCcontent"},child:[]}],l=f(b),m=zmSmiley.replaceText(b);if(a.listView?(k[1].attrs["class"]="sum",d=m):(d=l.length?d.concat(l):d,d=m.length?d.concat(m):d),d&&d.length){d.sort(c);var n,o,p,q=0,r=d.length;for(q=0;q<r;q++){if(n=d[q].from,0!==n&&(o=0===q?b.substring(0,n):b.substring(d[q-1].to,n),o=o.trim().length?" "+o+" ":o,k[1].child.push(["text",o])),"QUOTE"===d[q].type){j=q,0!==q&&k[1].child.push(["BR"]),i=d[q].from,p=d.slice(q+1,d.length),k[1].child.push(g(d[q].text,p,i,a.group));break}0===i&&j===-1&&k[1].child.push(e(d[q],b,a.group,a.shGroup,a.inviteeList))}0===i&&q>0&&d[q-1].to<b.length&&(o=b.substring(d[q-1].to,b.length),k[1].child.push(["text"," "+o+" "]))}else j===-1&&k[1].child.push(["text",b]);return k},richTextOffSet:function(a){var b=a.text,d=a.text,f=a.offset,h=0,i=-1;if(f&&f.length){f.sort(c);var j,k,l,m,n=0,o=f.length;for(b="",n=0;n<o;n++){if(j=f[n].from,0!==j&&(k=0===n?d.substring(0,j):d.substring(f[n-1].to,j),b=b.concat(k)),"QUOTE"===f[n].type){i=n,0!==n&&(b=b.concat("<br>")),h=f[n].from,l=f.slice(n+1,f.length),m=g(f[n].text,l,h,a.group,!0),b=b.concat(_zm.getDOM(m).outerHTML);break}0===h&&i===-1&&(m=e(f[n],d,a.group,a.shGroup,a.inviteeList),b=b.concat(_zm.getDOM(m).outerHTML))}0===h&&n>0&&f[n-1].to<d.length&&(k=d.substring(f[n-1].to,d.length),b=b.concat(k))}return b},listMembers:function(a){a=_.isArray(a)?a:a.split(",");var b,c,d,e,f=[];c=zmStreamsApp.util.getContactDetails(a);for(var g in c)e=c[g],d=e.fn||e.name,d&&(b=["LI",{child:[["DIV",{child:[["text",d],["SPAN",{child:[["text",e.eid||""]]}]]}],["IMG",{attrs:{src:e.photo}}]]}],f.push(b));var h=["UL",{attrs:{"class":"SC_P2r",id:"zms_memView"},child:f}];return _zm.getDOM(h)},addAttachment:function(a){return _zm.getDOM(["DIV",{attrs:{"class":"zmCA zms_aAtt"},child:[["DIV",{attrs:{id:a,"class":"zmCAt"}}]]}])},invitee_input:function(){var b=["DIV",{attrs:{"class":"addInv"},child:[["INPUT",{attrs:{type:"text","class":"zm_sgst",placeholder:a.common.labels.addInvitee}}]]}];return _zm.getDOM(b)},popup:{oneLine:function(a){var b,c,d,e=[],f=a.length;for(c=0;c<f;c++)d=a[c].fn||a[c].name,b=d?["LI",{attrs:{"data-id":String(a[c].id)},child:[["DIV",{child:[["text",d]]}],["IMG",{attrs:{src:a[c].photo}}]]}]:["LI",{attrs:{"data-item":a[c].data},child:[["text",a[c].txt]]}],e.push(_zm.getDOM(b));return e},comment:function(a){var b,c=[];return b=["LI",{attrs:{style:"white-space:pre-wrap;max-height:200px;overflow:auto"},child:[["B",{child:[["text",a.name+": "]]}],["text",a.text]]}],c.push(_zm.getDOM(b)),c},invitee_popup:function(a,b,c,d,e){var f,g,h,i,j,k="",l="",m="",n=_zm.getDOM(["UL",{attrs:{"class":"invList"}}]);if(e=void 0===e||e,a&&void 0===a.input)for(var o=0;o<a.length;o++){var p=a[o];for(var q in p)if(f=c[q]){var r=_zm.getDOM(["LI"]);l=f.isGroupid?zmStreamsApp.util.defaultGroupPhotoUrl():f.photo||zmResource.get("image","SC-Photo.png"),g=f.fn||f.name,_zm.preloadimg(l),i=c[p[q]];var s=i.zid===zmail.zuid;j=f.id||f.zid,h={name:g,attr:{"data-uid":j,"data-iid":i.zid},ph:l,ret:"dom",img:!0},s||d?(e&&(h.iclass="msi-close"),h.cls="SC_cs myInv"):h.cls="SC_cs othrInv",m=zmConUtil.bubbleUtil(h),r.appendChild(m),s||(k=i.fn||i.name,r.appendChild(_zm.getDOM(["SPAN",{child:[["text",k]]}]))),n.appendChild(r)}}return n},trendingtags:function(b,c){var d,e,f=[];_.each(b,function(a){e=a.id||a.name,d=c?[["FONT",{attrs:{"class":"SClbl",style:"background-color:"+a.color}}],["text",a.dispName]]:[["text",a.name]],f.push(["SPAN",{attrs:{"data-text":e},child:d}])});var g=c?a.streams.tooltip.tag:zmText.applyArgs(a.common.labels.trendingtags,{tag:"#"}),h=["LI",{child:[["DIV",{child:[["STRONG",{child:[["text",g]]}],["DIV",{attrs:{"class":"SCS_tTags"},child:f}]]}]]}];return[_zm.getDOM(h)]}}}}(),window.zmStreamsApp=window.zmStreamsApp||{},zmStreamsApp.events=function(){var a=zmText.get("streams"),b={cardTime:null,mentionsInput:function(a){var b=a.elm,c=a.resize,d=a.mention||[],e=a.gid,f=a.keyCallback,g="org";if(d.length&&"org"!==d){var h=zmUtil.getGroupOrder(),i=[],j=[];_.each(d,function(a){if(a=String(a),h.indexOf(a)!==-1){var b=zmStreamsApp.util.getGroupDetails(a);b.disabled||j.push(a)}else i.push(a)}),d=_.without(i,zmail.zuid),g=zmStreamsApp.util.getContactDetails(d),g=_.toArray(g),a.gid&&zmUtil.isGroupMember(zmail.zuid,a.gid)&&h.push(a.gid),j.length&&_.each(j,function(a){var b=zmStreamsApp.util.getGroupDetails(a),c={fn:b.name,nn:"",eid:b.eid,photo:b.photo,zid:a};g.push(c)})}var k={contentArray:g,compare:["fn","ln","nn","eid"],LType:"3",OType:"3"};e&&e!==zmail.zuid&&(k.groupId=e,k.addtolist=!0,$(b).data("gid",e)),a.addGroups&&(k.groupId=!0,k.addtolist=!0),f&&(k.keyCallback=f,k.keyParam=a.keyParam),"undefined"!=typeof zmStreamsApp.GroupApp&&(k.hashTag=!0,k.hashArray=zmStreamsApp.GroupApp.fetchHashTags),k.aliasPlusForAt=!0,k.resize=c||!1,a.isShareFolder&&(k={contentArray:[],LType:"2",OType:"3",compare:[]}),k.heightPadding=22,zmAutoFill.setAutofill(k,$(b))},previewImage:function(a){if(a){for(var b=$(a).find("img"),c=[],d=b.length,e=0;e<d;e++)b[e].src&&c.push({ft:101,fn:"image.png",src:b[e].src});var f={attObjList:c,hideAllOptions:!0,ignoreThumb:!0},g=c.length;b.click(function(a){for(var b=$(this),d=0,e=0;e<g;e++)c[e].src===b[0].src&&(d=e);f.startIndex=d,zmUtil.initAttSlideShow(f)})}},getActionType:function(a){return a.isGroup?"viewGroupEntity":"viewSelfData"},getCurrentGroupId:function(){var a="zmStreamsApp"===zmTab.currentTab?zmStreamsApp.GroupApp.getCurrentGroup():zmail.mailLeft.selId;return a},getCurrentView:function(a){if(!zmsuite.isWorkspaceAvailable("zmStreamsApp"))return{};zmStreamsApp.constants.setElements(),a=a||zmStreamsApp.constants.elements.postHolder;var b=a.find("#stabHol").children(".stSel"),c=$(b).data("type"),d=a.find("#s_postview #s_"+c);return c="userPost"===c||"hashTag"===c||"label"===c?"other":c,{elm:d,view:c,tab:b}},publishKeyEvent:function(a){$.publish("zmstreamsapp/keyevent",{data:a})},highlightPostAndScroll:function(a,b){var c=_zm("<","body")[0].getBoundingClientRect(),d=a.offset().top,e=a.height(),f=d+e,g="zmStreamsApp"===zmTab.currentTab,h=g?a.parents("#zm_stHolder"):a.parent(),i=g?40:0,j=h.offset().top+i,k=b?d<j:f>c.height;if(a&&k){var l=b?"start":"end";l=b&&g?"center":"start",a[0].scrollIntoView({behavior:"instant",block:l})}},getListHolders:function(a){var b,c,d=[];return zmsuite.isWorkspaceAvailable("zmStreamsApp")&&(a&&zmStreamsApp.GroupApp.getCurrentGroup()===a||!a)&&(c="zmStreamsApp"),c&&(b=zmsuite.getWorkSpace(c)[0].$el.find("#s_postview")),b&&b.length&&d.push(b),d},openPost:function(a){var b=a.ntype;if("43"===b)return a.sharedMail=!0,void zmList.showNotificationPopup(a);if(a.commentuuid){var c=a.commentuuid;c instanceof Array&&(c=c[0]),a.commentId=c}zmStreamsApp.PostApp.singlePost(a)},setMaxHeight:function(a,b,c,d){var e,f=$(a).find(".SC_ptit",a)[0],g=0,h=$(window).height(),i=$(a).hasClass("zmNotiPopUp")?a[0]:$(a).parent(".zmNotiPopUp")[0],j=0;f&&(g=f.getBoundingClientRect().height),$(a).hasClass("SC_DrftShr")&&(i=$(a).parent(".zmScCmnt")[0]),i&&(j=i.getBoundingClientRect().top,j<=0&&(c.style.maxHeight="300px",j=i.getBoundingClientRect().top));var k=$(c).innerHeight()-$(c).height(),l=b?b.getBoundingClientRect().height:0,m=h-(j+zmUtil.wmsBarHeight()),n=m-(l+g+k);if(c.style.maxHeight=n+"px",$(a).hasClass("SC_DrftShr")){var o=$(a).find(".SCSpostAct"),p=o[0]?o[0].getBoundingClientRect().height:0,q=n-p+"px";$(a).find(".SCS_draftCmnt").css("maxHeight",q),e=i?i.getBoundingClientRect().height/2:190,$(b).find(".cmntText").css("maxHeight",e)}if(d){var r=b.getBoundingClientRect().height+15;setTimeout(function(){var c=$(a).parents(".SC_Twpr");$(c).css("bottom",r+"px");var d=c;if(d.length){var f=zmInit.cliWid;f||(f=document.body.getBoundingClientRect().width),e=$(c)[0].getBoundingClientRect().height/2,$(b).css({position:"fixed","will-change":"transform"}).show(),$(b).find(".cmntText").css("maxHeight",e)}},200)}},createWorkSpace:function(a){var b=a.msgId||a.pid,c="Streams_"+b;if(zmsuite.isWorkspaceAvailable(c)&&"restore"!==a.src)return zmsuite.showWorkSpace(c),!1;var d=function(){var c=zmsuite.createAppRouter();return c._hashKey="stream",c.initialize({hashKey:"stream",handler:function(){return{updateParams:!1,handled:!1,daultAction:!1}}}),c.setParams(["tab",a.gid,b,a.etype,a.actionType]),c},e=d(),f={appname:"Streams single post",appId:c,appIcon:"msi-post",data:{CNodes:"3"},router:e,onDelete:function(){return $.publish(zmStreamsApp.constants.removeNotificationPreview,{element:zmsuite.getCenter(c)[0].$el[0]}),!0}},g=function(a,d){var e=d.id;b.indexOf("#")===-1&&(e=d.id.split("#")[1]),e===b&&zmsuite.isWorkspaceAvailable(c)&&zmsuite.closeWorkspace(c)};if($.subscribe("zmstreamsapp/deletePost",g),"restore"===a.src&&zmsuite.isWorkspaceAvailable(c))f.appname=zmTab.getTabObject(c).appname,zmsuite.resetWorkspace(c,f);else if(!zmsuite.setWorkSpace(f))return{maxTabSize:!0};var h=zmsuite.getCenter(c),i=h[0].getNodes();zmsuite.renderWorkSpace(),zmsuite.showWorkSpace(c),a.elm=i[2].$el[0],a.allComments=!0;var j={actionType:a.actionType,etype:a.etype,gid:a.gid,pid:a.pid};return a.callback=function(b,d){if(!a.opentype){var e={list:{left:{leftText:d,centerAlign:!0}}};i[1].push(e.list),f.appname=d,zmTab.updateTabLst(f),zmsuite.getCenterOuter(c).paint(),$(a.elm).scroll(function(){zmUtil.hideMenu()}),$.publish("zmail/SaveTabState",[{appId:c,app:"stream",appObj:{appId:c,appname:d,data:{},appIcon:"msi-post"},category:"stream_post",data:j}])}},a},openPostInTab:function(a){var b=zmStreamsApp.constants,c=a.pid||a.msgId;if(a.markRead=!0,a.isMail||String(a.etype)===b.streamTypeName.mail){c.indexOf("t")!==-1&&(c=c.substring(1,c.length)),a.opentype=2;var d=zmUtil.getMailObj(c);if(d&&d.groupId){a.gid=d.groupId,a.pid=a.thId||c,a.etype=b.streamTypeName.mail,a.cachedData=!0;var e="zm_tab"+(d.T?"t":"")+c;if(zmsuite.isWorkspaceAvailable(e))return void zmsuite.showWorkSpace(e);zmUtil.publishCloseNotif()}a.allComments=!0,a.isTab=!0,zmStreamsApp.events.openPost(a)}else if("group"===a.gid)zmStreamsApp.init(c);else if(String(a.etype)===b.streamTypeName.task){var f={groupId:a.gid,entityId:c,commentId:a.commentId,opentype:"tab"};zmUtil.requireTaskModule("taskPreview").done(function(){zmTask.Preview(f)})}else if(String(a.etype)===b.streamTypeName.note&&zmail.isInternalOrgUser)zmUtil.loadNotes("openNoteInTab",{e:c,gId:a.gid,commentId:a.commentId});else{if(a=zmStreamsApp.events.createWorkSpace(a),a.maxTabSize)return;a&&zmStreamsApp.events.openPost(a)}},clearList:function(a){var b=zmStreamsApp.events.getCurrentView();if(b){var c=$(b.elm).data("groupId");if(c===a&&"unread"===b.view){$(b.elm).data("postlist",[]),zmStreamsApp.util.detachAndRemove(b.elm[0]);var d=$(b.tab).parent().siblings(".postFilter")[1];d&&$(d).hide(),$(b.elm).empty().append(zmStreamsApp.PostApp.template.noPost()),zmStreamsApp.util.closePreview()}}},loadPostsOfUsers:function(a){var b=String(a.zid),c=a.gid,d=a.dialog,e=a.name||"";if("zmStreamsApp"===zmTab.currentTab&&zmStreamsApp.events.getCurrentGroupId()===c){var f=zmStreamsApp.events.getCurrentView(),g=zmStreamsApp.util.getContactDetails([b])[b];g=g.isDummyObj?e:g.fn,zmStreamsApp.util.closePreview(),zmail.zuid===String(b)&&zmStreamsApp.events.getCurrentGroupId()!==zmail.zuid?f.tab.siblings("li[data-type='byme']").trigger("click"):"other"===f.view&&g===$("#s_zms_otherT").find("span").text()||(zmStreamsApp.PostApp.showOtherTab(g,"userPost",b,c),zmStreamsApp.PostApp.fetchPosts({type:"other",ele:f.elm,previous:f.tab}))}else{var h=[{name:zmail.Search.Utils.CommonUtil.appUtil.filterConstantsNames.PostedBy,value:b},{name:zmail.Search.Models.Filters.GroupFilter.name,value:c}];zmStreamsApp.util.triggerSearch(h)}d&&d.remove()},listHashTags:function(a){a=a||{};var b=a.gid,c=a.tag;if(zmUtil.publishCloseNotif(),"zmStreamsApp"===zmTab.currentTab&&b!==zmail.zuid&&zmStreamsApp.events.getCurrentGroupId()===b){zmStreamsApp.util.closePreview();var d=zmStreamsApp.events.getCurrentView();zmStreamsApp.PostApp.showOtherTab("#"+c,"hashTag",c,b),zmStreamsApp.PostApp.fetchPosts({type:"other",ele:d.elm,previous:d.tab})}else{var e=zmail.Search.Models.Filters,f=[{name:e.HashtagFilter.name,value:{name:a.tag}}];a.gid!==zmail.zuid&&zmail.ContactBook.isGroup(a.gid)&&f.push({name:e.GroupFilter.name,value:a.gid}),zmStreamsApp.util.triggerSearch(f)}},groupAction:function(a){zmUtil.hideMenu();var b=a.action,c=a.gid;if(c&&b)switch(b){case"viewMembers":zmStreamsApp.util.loadMemberPopup(c);break;case"createChat":zmStreamsApp.GroupApp.createGroupChat(c);break;case"email":zmStreamsApp.GroupApp.emailGroup(c);break;case"markRead":zmStreamsApp.GroupApp.markAllRead(c);break;case"hideGroup":zmUtil.loadGroupManagement().then(function(){zmStreamsApp.GroupManageApp.hideGroup(c)});break;case"editGroup":zmUtil.loadGroupManagement().then(function(){zmStreamsApp.GroupManageApp.triggerEditGroup(c)})}},showContactCard:function(b){b=b||{};var c=zmStreamsApp.constants,d=b.zid||"",e=b.elm,f=b.groupId,g=String(b.eType);$(e).data("show","");var h=zmStreamsApp.util.getContactDetails([d])[d];if(!h.isDummyObj){var i=[];if(zmUtil.isGroupMember(d,f)){var j={zid:d,gid:f};i.push({htm:a.common.labels.viewposts,clk:this.listUserPosts,id:"post",args:[j]});var k=d===zmail.zuid;g===c.streamTypeName.note?i.push({htm:k?a.common.labels.notesbyme:a.common.labels.viewnotes,clk:this.listUserPosts,id:"notes",args:[j]}):g===c.streamTypeName.task&&(i.push({htm:k?a.common.labels.tasksbyme:a.common.labels.viewtasksby,clk:this.listUserPosts,id:"taskby",args:[j]}),i.push({htm:k?a.common.labels.taskstome:a.common.labels.viewtasksto,clk:this.listUserPosts,id:"taskto",args:[j]}))}var l=zmStreamsApp.events.getCurrentView();this.cardTime=setTimeout(function(){var a=$(e).data("show"),b=$("#zm_dropDown"),c="",f=zmStreamsApp.events.getCurrentView().view;b&&(c=b.data("zid")),"false"!==a&&c!==d&&l.view===f&&$(document).find($(e)).length?zmConUtil.showContactCard({dom:e,items:i,event:null,source:"streams",hideOnBlur:!0}):$(e).data("show","")},750)}},listUserPosts:function(a,b,c){c&&c.remove(),zmStreamsApp.util.hideMenu(),b=b||{};var d=b.zid,e=b.gid,f=this.id||b.data;switch(f){case"post":zmStreamsApp.events.loadPostsOfUsers(b);break;case"notes":zmUtil.invokeNoteSearch({zuid:d,groupId:e}),$.publish("zm/closeAllOpenDialog");break;case"taskby":zmUtil.requireTaskModule("taskSearchUtil").done(function(){zmTask.Search.listTaskSearchAction({zuid:d,groupId:e,type:"addedby"})});break;case"taskto":zmUtil.requireTaskModule("taskSearchUtil").done(function(){zmTask.Search.listTaskSearchAction({zuid:d,groupId:e,type:"assignedto"})})}},commentBoxMaxHeight:function(a){var b=$(a).parents(".cmntText"),c=$(a).parents(".zm_mention"),d=$(a).parents(".SCS_popUp"),e=0;if(d.length){var f=$(d).find(".SC_ptit");f.length&&(e=f[0].clientHeight)}if(!b.length||!c.length)return 0;var g=b.siblings(".cmntActions"),h=0;g.length&&(h=g[0].clientHeight);var i=b.find(".zms_rep"),j=0;i.length&&(j=i[0].clientHeight);var k=b.find(".SC_linkpreview"),l=0;k.length&&(l=k[0].clientHeight);var m=window.parseInt(b.css("max-height"));m=window.isFinite(m)?m:0;var n=window.parseInt(c.css("padding-top"));n=window.isFinite(n)?n:0;var o=window.parseInt(c.css("padding-bottom"));return o=window.isFinite(o)?o:0,m-(n+o+j+l+e+h)}};return b}(),zmStreamsApp.linkPreview=function(a){a=a||{};var b=zmText.get("streams"),c=function(a){var b=zmHash.decode(a),c={};return b&&"stream"===b.key&&("tab"===b.params[0]?(c.etype=b.params[3],c.cId=b.params[5]):(c.etype=b.params[2],c.cId=b.params[4])),c},d=function(a){var b={};return a=a||{},b.linktitle=a.title||"",b.linkdesc=a.description||"",b.linkurl=a.url||"",b.videourl=a.videoURL||"",a.thumbnailURL&&(b.imageurls=[a.thumbnailURL]),a.tags&&a.tags.length&&(b.linktags=a.tags),b},e=function(a){var b={};return b.url=a.linkUrl,b.title=a.title,b.description=a.desc,b.tags=a.tags,b.thumbnails=a.imageUrls,b.videoURL=a.videoUrl||"",b.title&&b.title.length>100&&(b.title=b.title.substr(0,97)+"..."),b.description&&b.description.length>200&&(b.description=b.description.substr(0,197)+"..."),b.tags&&b.tags.length>10&&(b.tags=b.tags.slice(0,10)),b.thumbnails&&b.thumbnails.lenth>20&&(b.thumbnails=b.thumbnails.slice(0,20)),b},f=function(a){return function(c){var d=zmStreamsApp.PostApp.models.posts.get(a)||{},e=("function"==typeof d.get?d.get("myact"):{})||{};if(e.showinvite){var f=zmStreamsApp.events.getCurrentView();zmStreamsApp.PostApp.showOtherTab("#"+c,"hashTag",c,d.getGroupInfo().id),zmStreamsApp.PostApp.fetchPosts({type:"other",ele:f.elm,previous:f.tab})}else _zm.succErrMsg("e",b.common.messages.noHashTagSearch)}},g=function(a,b,d){if(a.link&&a.link.linkUrl){var g={},h={},i=a.link;h=e(i),g.editMode=!1,g.data=h,g.playVideoInline=!0;var j=c(h.url);j.etype&&(g.data.entityType=j.etype,j.cId&&(g.data.isComment=!0));var k=zmLinks.createComponent(g);h.tags&&h.tags.length&&k.setConfig("onHashTagClick",f(d,b,!1));var l=(_zm(".","postMsg",b)||[])[0];_zm.after(l,k.getDOM())}},h=function(a,b,d){if(a.link&&a.link.linkUrl){var g={},h={},i=a.link;h=e(i),g.editMode=!1,g.data=h,g.playVideoInline=!0;var j=c(h.url);j.etype&&(g.data.entityType=j.etype,j.cId&&(g.data.isComment=!0));var k=zmLinks.createComponent(g);h.tags&&h.tags.length&&k.setConfig("onHashTagClick",f(d,b,!0)),b.appendChild(k.getDOM())}},i=function(a,b){for(var c in a)b[c]=a[c];b.imageurls&&(b.imageurls=b.imageurls.join("\n")),b.tags&&(b.tags=b.tags.join("\n"))};return a.getLinkInfoFromComponentData=d,a.addLinkPreviewToPost=g,a.addLinkPreviewToComment=h,a.addDataToParams=i,a.getComponentDataFromLinkInfo=e,a}(),window.zmLinks=function(a){a=a||{};var b,c,d=zmText.get("streams","linkPreview"),e="click",f="mouseup",g="mousedown",h=zmail.streamsLinkPreviewSupportedUrls||["connect","projects","mail","zmail","bugtracker"],i={6:"msi-status",1:"msi-mail",2:"msi-notes",3:"msi-task",4:"msi-calendar",10:"msi-links"},j=function(a){this.url=a,this.title="",this.description="",this.images=[],this.tags=[],this.hasData=!1,this.videoURL="",this.isZohoDocsURL=!1},k=function(a){var b,d=function(a){a&&a.st?b(!0,a):b(!1),c=null},e=function(){b(!1),c=null},f=function(){c=zmAjq.XHR({u:zmail.conPath+"/link.do",t:"POST",p:{link:a,mode:"link",actionType:"getLinkDetails"},fn:d,efn:e})};return{done:function(a){b=a,f()}}};j.prototype={loadData:function(){var a,b=this,c=function(){b.hasData?a(b):k(b.url).done(function(c,d){if(c&&d.st){if(b.hasData=d.st,b.url=d.linkUrl||b.url,b.title=d.title||"",b.description=d.desc||"","string"==typeof d.imageUrls&&(d.imageUrls=[d.imageUrls]),b.images=d.imageUrls||[],b.tags=d.tags||[],b.videoURL=d.videoUrl||"","ZohoMail"===d.serviceName){if(b.entityType=d.entityType,b.isComment=d.isComment,!d.imageUrls&&d.authorZuid){var e=zmStreamsApp.util.getContactDetails([d.authorZuid])[d.authorZuid];b.images=[e.photo]}d.entityTitle&&d.desc?b.description=d.entityTitle+" - "+d.desc:b.description=d.entityTitle||d.desc}else"ZohoConnect"===d.serviceName?b.images=["https://connect."+zmail.zohoUrl+"/favicon.ico"]:"ZohoProjects"!==d.serviceName&&"ZohoBugTracker"!==d.serviceName||(b.images=["https://projects."+zmail.zohoUrl+"/favicon.ico"]);$(b).trigger("changed",b),a(b)}else a()})};return{then:function(b){a="function"==typeof b?b:function(){},c()}}},subscribeChanges:function(a){var b=this;$(b).on("changed",a)},unsubscribeChanges:function(a){var b=this;$(b).off("changed",a)}};var l=function(a,b){return a=a||"",b=b||[],b.indexOf(a)},m=function(a){return a.title&&a.title.length>100&&(a.title=a.title.substr(0,97)+"..."),a.description&&a.description.length>200&&(a.description=a.description.substr(0,197)+"..."),a.tags&&a.tags.length>10&&(a.tags=a.tags.slice(0,10)),a.thumbnails&&a.thumbnails.lenth>20&&(a.thumbnails=a.thumbnails.slice(0,20)),a},n=function(a){a=a||{},a.data=a.data||{};var b,c={},e=a.data,f=function(){var f=e.name||"";b=zdom("div",{className:"SC_cs zmfc"},zdom("span",{title:f},f),zdom("i",{title:d.tooltips.removeTag,className:"msi-close"})),a.editMode||$(b).find("i").remove(),$(b).off().on("click",function(b){"function"==typeof a.onTagClick&&a.onTagClick(c),_zm.stopEvents(b)}),"function"==typeof a.onRemoveTag&&$(b).find("i").off().on("click",function(b){a.onRemoveTag(c),_zm.stopEvents(b)})};return c.setData=function(a,b){e[a]=b,f()},c.setConfig=function(b,c){a[b]=c,f()},c.getData=function(a){return a?e[a]:e},c.getDOM=function(){return b},f(),c},o=function(c){c=c||{},c.data=c.data||{},c.data.tags=c.data.tags||[],c.data.thumbnails=c.data.thumbnails||[];var h={},j=c.data,k={},o=0;j.thumbnails.length&&(j.thumbnailURL=j.thumbnails[o]);var p,q=function(){if(j.videoURL&&!c.playerLoading){var b=a.getVideoIframe(j.videoURL);b&&($(p).find(".SC_vpv").before(b).hide(),c.playerLoading=!0)}},r=function(){var a="";j=m(j);var b=j.title||"",d=j.description||"",e=zmUtil.getHostName(j.url),f="zmL SC_vpv SC_sq";j.thumbnails&&j.thumbnails.length?(a=j.thumbnails[o]||"",a&&zmUtil.loadImage(a).then(function(a){if(a){var b=a.width/a.height,c="SC_sq";b<=.8?c="SC_po":b>=2?c="SC_sls":b>=1.3&&(c="SC_ls"),f+=" "+c}})):f+=" noimg",c.editMode&&(f+=" SC_edit");var g=j.tags&&j.tags.length?"zm_linkTag SC_input":"zm_linkTag SC_input SC_dyn";if(p=zdom("div",{className:"SC_linkpreview zmOwnLinkPreview"},zdom("div",{className:f},zdom("div",{className:"zmLst"},zdom("div",{className:"zmDtl"},zdom("div",{className:"zmImg"},zdom("img",{src:a}),zdom("i",{className:"msi-play"}),zdom("i",{className:"msi-larrow"}),zdom("i",{className:"msi-rarrow"})),zdom("div",{className:"zmFrm"},zdom("span",{className:"zm_linkTitle"},b)),zdom("div",{className:"zmSub"},zdom("span",null,d),zdom("span",{className:"sum"},e)),zdom("div",{className:"SC_icn"},zdom("i",{className:"msi-close"}))))),zdom("div",{className:g})),j.entityType){var h=i[j.entityType];j.isComment&&(h="msi-comment"),$(p).find(".zm_linkTitle").prepend(zdom("i",{className:h}))}j.videoURL&&!c.editMode||$(p).find(".msi-play").remove(),c.editMode||$(p).find(".msi-close").remove();var l=$(p).find(".zm_linkTag");if(l.html(""),j.tags&&j.tags.length)for(var n in j.tags)k[n]&&l.append(k[n].getDOM());j.thumbnails&&j.thumbnails.length||$(p).find(".zmImg").remove(),(!j.thumbnails||j.thumbnails.length<2)&&($(p).find(".msi-larrow").remove(),$(p).find(".msi-rarrow").remove())},s=function(a){var b=n({editMode:c.editMode,data:{name:a},onRemoveTag:function(){h.removeTag(a)},onTagClick:function(a){if("function"==typeof c.onHashTagClick){var b=a.getData();c.onHashTagClick(b.name)}}});return b},t=function(){if(j.tags&&j.tags.length){k={};for(var a in j.tags)k[a]=s(j.tags[a])}},u=function(){t(),r(),b()},v=function(a,b){var c=j.thumbnails.length?j.thumbnails.length-1:0;if(a>=0&&a<=c)o=a,j.thumbnailURL=j.thumbnails[o],$(p).find(".zmImg img").attr("src",j.thumbnailURL);else{var e=b?d.messages.noPrevThumbnails:d.messages.noNextThumbnails;_zm.succErrMsg("e",e)}},w=function(){v(o-1,!0)},x=function(){v(o+1)};b=function(){var a,b;$(p).find(".zmLst").off(g).on(g,function(){window.getSelection&&(a=window.getSelection()||"",a=a.toString())}),$(p).find(".zmLst").off(f).on(f,function(){window.getSelection&&(b=window.getSelection()||"",b=b.toString())}),$(p).find(".zmLst").off(e).on(e,function(c){a===b&&zmUtil.openLink(j.url),_zm.stopEvents(c)}),$(p).find(".msi-larrow").off().on(e,function(a){w(),_zm.stopEvents(a)}),$(p).find(".msi-rarrow").off().on(e,function(a){x(),_zm.stopEvents(a)}),$(p).find(".zmImg img").off().on(e,function(a){j.videoURL&&(c.playVideoInline===!0?q():"function"==typeof c.onPlayVideo&&c.onPlayVideo(),_zm.stopEvents(a))}),$(p).find(".msi-play").off().on(e,function(a){j.videoURL&&(c.playVideoInline===!0?q():"function"==typeof c.onPlayVideo&&c.onPlayVideo(),_zm.stopEvents(a))}),"function"==typeof c.onRemovePreview&&$(p).find(".msi-close").off().on(e,function(a){c.onRemovePreview(),_zm.stopEvents(a)})};var y=function(b){b instanceof a.LinkData&&(j.url=b.url||"",j.title=b.title||"",j.description=b.description||"",j.thumbnails=b.images,j.thumbnails&&j.thumbnails.length&&(j.thumbnailURL=j.thumbnails[0]),j.tags=b.tags,j.videoURL=b.videoURL||"",b.entityType&&(j.entityType=b.entityType),j.isComment=b.isComment)};return h.setConfig=function(a,b){c[a]=b,"data"===a&&(j=c.data,o=0,j.thumbnails.length&&(j.thumbnailURL=j.thumbnails[o])),u()},h.setData=function(a,b){j[a]=b,u()},h.setTags=function(a){a=a||[];for(var b in a)h.addTag(b,!0);u()},h.addTag=function(a,b){a=a||"",a&&l(a,j.tags)===-1&&(j.tags.push(a),b||u())},h.removeTag=function(a){a=a||"";var b=l(a,j.tags);a&&b!==-1&&(j.tags.splice(b,1),u())},h.getDOM=function(){return p},h.getData=function(a){return a?j[a]:j},h.initFromLink=function(b){var c=new a.LinkData(b);c.loadData().then(function(){c.hasData&&(y(c),u())})},c.linkData instanceof a.LinkData&&y(c.linkData),u(),h},p=function(b,c){var d,e=function(){var e=new a.LinkData(b);e.loadData().then(function(){if(e.hasData){c.linkData=e;var b=a.createComponent(c);d(b)}else d()})};return{then:function(a){d=a,e()}}},q='<iframe src="" class="SC_ve" style="min-width: 400px; height: 300px; width: 100%;" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>',r={YOUTUBE:{urlPatterns:[/(?:https?:\/\/)?[^.\s]+\.youtube\.[^.\/]+\/[^\s]*watch\?[^\s]*v=([^\s&#\/]+)(?:&t=([^\s&#]+))*[^\s]*/g,/(?:https?:\/\/)?[^.\s]+\.youtube\.[^.\/]+\/v\/([^\s&#\/]+)(?:&t=([^\s&#]+))*[^\s]*/g,/(?:https?:\/\/)?youtu\.be\/([^\s&#\/]+)(?:&t=([^\s&#]+))*[^\s]*/g],iframeURL:"//www.youtube.com/embed/{{videoID}}{{extraParams}}",timeParseRegex:/(?:([0-9]*)h)*(?:([0-9]*)m)*(?:([0-9]*)s)*/gi},VIMEO:{urlPatterns:[/(?:https?:\/\/)?vimeo\.[^.\/]+\/([^\s&#\/]+)[^\s]*/g],iframeURL:"//player.vimeo.com/video/{{videoID}}"},DAILYMOTION:{urlPatterns:[/(?:https?:\/\/)?[^.\s]+\.dailymotion\.[^.\/]+\/video\/([^\s&#\/_]+)[^\s]*/g,/(?:https?:\/\/)?dai.ly\/([^\s&#\/_]+)[^\s]*/g],iframeURL:"//www.dailymotion.com/embed/video/{{videoID}}"},FACEBOOK:{urlPatterns:[/(?:https?:\/\/)?[^.\s]+\.facebook\.[^.\/]+\/[^\s]*videos\/([^\s&#\/]+)*[^\s]*/g],iframeURL:"//www.facebook.com/video/embed?video_id={{videoID}}"}},s=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o=Object.keys(r);for(b=0,c=o.length;b<c;b++){for(d=r[o[b]],f=0,g=d.urlPatterns.length;f<g;f++)if(e=d.urlPatterns[f],e.lastIndex=0,j=void 0,null!==(j=e.exec(a))&&(e.lastIndex=0,j[1])){h=j[1],i=j[2]||"";break}if(h)return k=d.iframeURL.replace(/\{\{videoID\}\}/,h),i?(l=d.timeParseRegex,l.lastIndex=0,m=l.exec(i),m[1]=parseInt(m[1])||0,m[2]=parseInt(m[2])||0,m[3]=parseInt(m[3])||0,n=3600*m[1]+60*m[2]+m[3],k=k.replace(/\{\{extraParams\}\}/,"?start="+n)):k=k.replace(/\{\{extraParams\}\}/,""),k}},t=function(a){return Boolean(s(a))},u=function(a,b){var c=s(a);if(c+=(c.indexOf("?")!==-1?"&":"?")+"autoplay=true"){var d=$(q).attr("src",c)[0];return"function"==typeof b&&$(d).on("load",function(){b()}),d}},v="zmlinks_"+Math.round(1e3*Math.random())+"_",w=1,x=function(){return v+Date.now()+"_"+w++},y={},z=function(b){var d,e,f,g={},i=!1,j={},k="",l=function(){},m=function(){},n=function(){},o=function(a){j[a]=!0},p=function(a){var b=Boolean(j[a]),c="http";if(b=b||a.indexOf(c)===-1&&a.indexOf("www")===-1)return b;b=b||a.indexOf("."+zmail.zohoUrl)!==-1;for(var d=0,e=h.length;d<e;d++)if(a.indexOf(h[d])!==-1){b=h[d].indexOf("mail")!==-1&&a.indexOf("#stream")===-1;break}if(zmail.isBaihui&&!b){var f;for(var g in r)if("YOUTUBE"===g||"FACEBOOK"===g){f=r[g].urlPatterns;for(var i=0,k=f.length;i<k;i++)if(f[i].lastIndex=0,null!==f[i].exec(a)){b=!0;break}}}return b},q=function(){j={}},s=function(a){l="function"==typeof a?function(){i||a.apply(this,arguments)}:function(){}},t=function(a){m="function"==typeof a?function(){i||a.apply(this,arguments)}:function(){}},u=function(a){n="function"==typeof a?function(){i||a.apply(this,arguments)}:function(){}},v=function(){var a=$("<div>").addClass("SC_lpload");zmComponent.loadingBand({type:"pagination",container:a[0]});var b=function(){e&&e.append(a)},c=function(){e&&a.remove()};return{show:b,hide:c}}(),w=function(){var a=d;d=void 0,a&&$(a.getDOM()).remove(),n(a)},x=function(b){d||p(b)||k===b||(k=b,l(b),a.createComponentFromLink(b,{editMode:!0,onRemovePreview:function(){o(b),w()}}).then(function(a){v.hide(),k&&(k="",a?(w(),d=a,m(a)):o(b))}),v.show())},z=function(){var a,c=b.tagName;a="TEXTAREA"===c||"INPUT"===c?b.value:$(b).text();var d=zmUtil.parseURLS(a);if(d.length)for(var e in d){var f=d[e].url;if(!j[f])return void x(f)}},A=function(){return d&&d.getData()},B=function(){f&&f.unbind()},C=function(){B(),f=zmUtil.bindInputTextChange({input:b,callback:z})},D=function(){return i=!0,k="",q(),w(),C(),i=!1,g},E=function(){return D()};return g.setLinkFoundCallback=function(a){return s(a),g},g.setComponentReadyCallback=function(a){return t(a),g},g.setPreviewRemovedCallback=function(a){return u(a),g},g.setProgressDisplayDOM=function(a){return e=a?$(a):void 0,g},g.reset=function(){return E()},g.getPreview=function(){return d},g.getPreviewData=function(){return A()},g.destroy=function(){E(),B(),y[b]=void 0,delete y[b]},g.removeLoadingBar=function(){v.hide(),c&&c.abort()},D(),g};return a.PreviewManager=function(a){var b=$(a).attr("data-zmlinks");return b||(b=x(),$(a).attr("data-zmlinks",b)),y[b]||(y[b]=z(a)),y[b]},a.PreviewManager.destroy=function(){for(var a in y)y[a].destroy()},a.getVideoIframe=u,a.isURLEmbeddable=t,a.createComponentFromLink=p,a.createComponent=function(a){return o(a)},a.requestLinkData=k,a.LinkData=j,a}();