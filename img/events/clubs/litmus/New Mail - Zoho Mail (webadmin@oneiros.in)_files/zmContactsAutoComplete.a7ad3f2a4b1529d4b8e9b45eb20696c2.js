"use strict";!function(){var a=zmail.Core.Namespaces,b=a.create("zmContactsAutoComplete"),c=zmail.Utils.DOM,d=zmail.Components.AutoComplete,e=d.System.AbstractTrigger,f=d.Utils,g=function(a){function b(){return babelHelpers.classCallCheck(this,b),babelHelpers.possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return babelHelpers.inherits(b,a),babelHelpers.createClass(b,[{key:"textChangeAction",value:function(){var a=this,b=a._input,c=b.getCurrentTypingWord();c=c.trim(),0===c.indexOf("@")&&(c=c.substr(1,c.length)),c?a.publishTriggerEvent({searchToken:c}):a.publishNegativeTriggerEvent()}},{key:"bindEvents",value:function(){var a=this,b=a._input,d=null,e=200;b.setDebounce>=0&&(e=b.setDebounce),a._textChangeEventHandler=a._textChangeEventHandler.bind(a),a._textChangeEventHandler=f.debounce(a._textChangeEventHandler,e),d=a._textChangeEventHandler,c.element(b).on("textchange",d)}}]),b}(e);b.zmInputTrigger=g}(),function(){var a=zmail.Core.Namespaces,b=a.create("zmContactsAutoComplete"),c=zmail.Utils.DOM,d=zmail.Components.AutoComplete,e=d.System.AbstractTrigger,f=d.Utils,g=/(?:^[@]{1}(([^\s]+[\s]?)*))/i,h=function(a){function b(){return babelHelpers.classCallCheck(this,b),babelHelpers.possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return babelHelpers.inherits(b,a),babelHelpers.createClass(b,[{key:"getCurrentWord",value:function(){var a=this._input,b=a.getText(),c=a.getCursorPosition(),d=b.substr(0,c),e=d.lastIndexOf("@"),f="";return 0===e?f=d.substr(e,c):e>0&&(" "===d[e-1]||"\n"===d[e-1])&&(f=d.substr(e,c)),f}},{key:"textChangeAction",value:function(){var a,b=this;a=b._input.editor||b._input.contenteditable?b._input.getCurrentTypingWord():b.getCurrentWord(),b.currentText=a,g.lastIndex=0;var c=g.exec(a);if(c){var d=c[1]||"";b.publishTriggerEvent({searchToken:d})}else b.publishNegativeTriggerEvent()}},{key:"bindEvents",value:function(){var a=this,b=a._input,d=null;a._textChangeEventHandler=a._textChangeEventHandler.bind(a),a._textChangeEventHandler=f.debounce(a._textChangeEventHandler,0),d=a._textChangeEventHandler,c.element(b).on("textchange",d)}}]),b}(e);b.zmMentionTrigger=h}(),function(){var a=zmail.Core.Namespaces,b=a.create("zmContactsAutoComplete"),c=zmail.Components.AutoComplete,d=c.System.AbstractListItemModel,e=d.extend({defaults:{firstName:"",middleName:"",lastName:"",nickName:"",email:"",profileImage:"",zid:null,internalData:{}}});b.zmListItemModel=e}(),function(){var a=zmail.Core.Namespaces,b=a.create("zmContactsAutoComplete"),c=zmail.Utils.DOM,d=zmail.Components.AutoComplete,e=d.System.AbstractListItemComponent,f=d.Utils.constructDOM,g=function(a,b,c){a=a||"",b=b||"",c=c||{};var d=[];if(!b)return d=a?[a]:[];var e=a;c.caseSensitive||(b=b.toLowerCase(),e=e.toLowerCase());var f,g,h=-1;for(f=0,g=a.length;f<g&&(h=e.indexOf(b,f),h!==-1);f++)0!==h&&d.push(a.substring(f,h)),d.push(a.substring(h,h+b.length)),f=h+b.length-1;return f<g&&d.push(a.substring(f)),d},h=function(a,b,d){d=d||{};var e=c.element(zdom("span",null));return e.text(a),d.caseSensitive||(b=b.toLowerCase(),a=a.toLowerCase()),b===a&&e.addClass("afHgl"),e},i=function(a,b,d,e){e=e||{},c.clearHTML(a);var f=g(b,d,e);f.forEach(function(b){var f=h(b,d,e);c.mount(f,a)}),c.setAttribute(a,{title:b})},j=function(a){function b(){return babelHelpers.classCallCheck(this,b),babelHelpers.possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return babelHelpers.inherits(b,a),babelHelpers.createClass(b,[{key:"createDOM",value:function(a){var b,c=this;return b=a?['<li ref = "wrapper">','<div ref="name"></div>','<div ref = "avatar"></div>',"</li>"].join(""):['<li ref = "wrapper">','<div class = "SC_cont">','<div ref="name"></div>','<span ref= "email"></span>',"</div>",'<div ref = "avatar"></div>',"</li>"].join(""),c.dom=f(b),c.dom}},{key:"render",value:function(a,b){var d=this;b=b||{};var e=a.attributes;d.model=a,d.state.selected=e.selected||!1,d.dom?d.uninitializeDOM():(d.createDOM(b.hideEmailId),d.createDOMRefs()),d.state.searchWord=b.searchWord||d.state.searchWord||"";var f="SC_Psli";d.state.selected?c.addClass(d.refs.wrapper,f):c.removeClass(d.refs.wrapper,f);var g=e.internalData.avatar()[0];c.mountAfter(g,d.refs.avatar),c.unmount(d.refs.avatar,!0);var h=d.state.searchWord,j=[],k=(e.firstName||"").trim(),l=(e.middleName||"").trim(),m=(e.lastName||"").trim(),n=(e.nickName||"").trim();if(k&&j.push(k),l&&j.push(l),m&&j.push(m),n&&(n="("+n+")",j.push(n)),j=j.join(" "),c.clearHTML(d.refs.name),i(d.refs.name,j,h),"crm"===e.internalData.type){var o=c.element(zdom("i",{className:"msi-crm",title:"CRM Contact"}));c.mount(o,d.refs.name)}if(d.refs.email){var p=e.email||"";c.clearHTML(d.refs.email),p?i(d.refs.email,p,h):c.hide(d.refs.email)}else c.setAttribute(d.refs.name,{title:e.email});d._postRender()}},{key:"focus",value:function(){var a=this;a.focusTimeoutID=setTimeout(function(){a._mounted&&(c.focus(a.refs.wrapper),a.refs.wrapper.scrollIntoView(!1))},0)}}]),b}(e);b.zmListItemComponent=j}(),function(){var a=zmail.Core.Namespaces,b=a.create("zmContactsAutoComplete"),c=zmail.Components.AutoComplete,d=c.System.AbstractListItemComponentFactory,e=zmContactsAutoComplete.zmListItemModel,f=zmContactsAutoComplete.zmListItemComponent,g=function(a){function b(){return babelHelpers.classCallCheck(this,b),babelHelpers.possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return babelHelpers.inherits(b,a),babelHelpers.createClass(b,[{key:"createComponent",value:function(a){if(a instanceof e)return new f}}]),b}(d);b.zmListItemComponentFactory=g}(),function(){var a=zmail.Core.Namespaces,b=a.create("zmContactsAutoComplete"),c=zmail.Utils.DOM,d=zmail.Components.AutoComplete,e=d.System.AbstractListComponent,f=function(a){function b(){babelHelpers.classCallCheck(this,b);var a=babelHelpers.possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this)),c=a;return c.popUp=!0,a}return babelHelpers.inherits(b,a),babelHelpers.createClass(b,[{key:"createDOM",value:function(a){var b=this,c=a?"SC_Pr":"SC_P2r";b.dom=zdom("div",{ref:"wrapper",className:"SC_dd shw SC_contacts"},zdom("div",{className:"scrlldiv zmDDScroll"},zdom("ul",{ref:"listWrapper",className:c})))}},{key:"_preRender",value:function(a,b){var c=this;c.model=a,c.dom?c.uninitializeDOM():(c.createDOM(b),c.createDOMRefs())}},{key:"render",value:function(a,b){var c=this;b=b||{},c._preRender(a,b.hideEmailId),c.renderListItems(a,b),c._postRender()}},{key:"getScrollWrapperDOM",value:function(){var a=this;return a.refs.listWrapper}},{key:"handleListSpaceOverflow",value:function(a){var b=this;a=a||{};var d=b.getScrollWrapperDOM();c.setStyle(d,{height:a.height+"px"})}},{key:"positionComponent",value:function(a){var d=this,e=d.getScrollWrapperDOM();return c.setStyle(e,{height:"auto"}),babelHelpers.get(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"positionComponent",this).call(this,a)}},{key:"_mouseDownHandler",value:function(a){var b=this;b.mouseDown=!0,_zm.stopEvents(a)}},{key:"show",value:function(){var a=this;babelHelpers.get(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"show",this).call(this),a.popUp?c.setStyle(a.dom,{"z-index":"105"}):c.setStyle(a.dom,{"z-index":""}),c.show(a.dom)}},{key:"hide",value:function(){var a=this;babelHelpers.get(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"hide",this).call(this),c.hide(a.dom)}}]),b}(e);b.zmListComponent=f}(),function(){var a=zmail.Core.Namespaces,b=a.create("zmContactsAutoComplete"),c=zmail.Components.AutoComplete,d=c.System.AbstractDataAccumulator,e=function(a){function b(){return babelHelpers.classCallCheck(this,b),babelHelpers.possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return babelHelpers.inherits(b,a),babelHelpers.createClass(b,[{key:"accumulateData",value:function(a){var b=this,c=a.collectionList;c.forEach(function(a){b.dataCollection.add(a.models)});var d=b.dataCollection.models;b.dataCollection.reset(d,{silent:!0}),b.triggerAccumulationComplete()}}]),b}(d);b.zmContactDataAccumulator=e}(),function(){var a=zmail.Core.Namespaces,b=a.create("zmContactsAutoComplete"),c=zmail.Components.AutoComplete,d=c.System.AbstractDataProvider,e=zmContactsAutoComplete.zmListItemModel,f=function(a){function b(){babelHelpers.classCallCheck(this,b);var a=babelHelpers.possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this)),c=a;return c.searchResultLimit=10,a}return babelHelpers.inherits(b,a),babelHelpers.createClass(b,[{key:"destroy",value:function(){var a=this;babelHelpers.get(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"destroy",this).call(this),a.searchResultLimit=null}},{key:"constructModel",value:function(a){a=a||{};for(var b=a.contact||[],c=a.collection,d=0,f=b.length;d<f;d++){var g=b[d];if(a.showGroup||!a.excludeGroups||!zmail.ContactBook.isGroup(g.attrs.eid)){var h=new e({id:g.attrs.eid||g.id,firstName:g.attrs.fn||g.attrs.name,middleName:g.attrs.mn,lastName:g.attrs.ln,nickName:g.attrs.nn,email:g.attrs.eid,profileImage:g.attrs.photo,zid:g.attrs.zid||g.attrs.id,internalData:g});if(c.add(h),c.length>=10)break}}return c}},{key:"searchData",value:function(a){var b=this;a=a||{};var c=a.searchToken||"",d="";a.showGroup&&(d=a.showGroup,a.includeAllGroups=!1,a.includeEmailedGroups=!1,a.excludeGroups=!0);var e=[],f=a.collection||null,g=a.deferred||null;if(a.exclude&&(e=a.exclude()),!c)return void g.reject();c=c.toLowerCase();var h,i,j,k,l=a.includeOnly||[],m=[];if(d&&!(e&&e.indexOf(d)>-1)){var n=zmail.ContactBook.getGroups(d);if(n.length){var o=n[0].attrs.name.toLowerCase();0===o.indexOf(c)&&m.push(n[0])}}if(Array.isArray(l)&&l.length){var p,q,r,s,t,u=[],v=[],w=zmail.ContactBook.get({zuid:l,type:a.type,promise:!1});for(m=m.concat(w),h=0,i=m.length;h<i&&(j=m[h],r=j.attrs.zid||j.attrs.id,s=j.attrs.eid||"",t=j.attrs.fn||j.attrs.name,e&&e.indexOf(r)>-1||(p=s.toLowerCase().indexOf(c),q=t.toLowerCase().indexOf(c),0===p||0===q?u.push(m[h]):(p>0||q>0)&&v.push(j),!(u.length>=b.searchResultLimit)));h++);if(u.length<b.searchResultLimit&&v.length){var x=b.searchResultLimit-u.length;v.length>x&&(v=v.splice(0,x)),u=u.concat(v)}k=b.constructModel({contact:u,collection:f,excludeGroups:a.excludeGroups}).models,f.reset(k,{silent:!0}),g.resolve()}else{var y={str:c,excludeMe:a.excludeMe,exclude:e,includeAllGroups:a.includeAllGroups,includeEmailedGroups:a.includeEmailedGroups,excludeGroups:a.excludeGroups,type:a.type,expected:10};d&&(y.prioritizeGroupMembers=[d]),zmail.ContactBook.get(y).done(function(c){m=m.concat(c),k=b.constructModel({contact:m,collection:f,excludeGroups:a.excludeGroups,showGroup:a.showGroup}).models,f.reset(k,{silent:!0}),g.resolve()}).fail(function(){g.resolve()})}}}]),b}(d);b.zmContactsDataProvider=f}(),function(){var a=zmail.Core.Namespaces,b=a.create("zmContactsAutoComplete"),c=zmail.Utils.DOM,d=zmail.Components.AutoComplete,e=d.System.BaseHTMLEditableAutoCompleteSystem,f=d.System.AbstractHTMLInput,g=d.System.AbstractHTMLTextArea,h=zmContactsAutoComplete.zmInputTrigger,i=zmContactsAutoComplete.zmMentionTrigger,j=zmContactsAutoComplete.zmListComponent,k=zmContactsAutoComplete.zmListItemComponentFactory,l=zmContactsAutoComplete.zmContactsDataProvider,m=zmContactsAutoComplete.zmContactDataAccumulator,n={LIST_SHOWN:"listShown",LIST_HIDDEN:"listHidden",CLICK:"click"},o={TEXTAREA:"1",INPUT:"2",EDITOR:"3",DIV:"4"},p=function(a){function b(){return babelHelpers.classCallCheck(this,b),babelHelpers.possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return babelHelpers.inherits(b,a),babelHelpers.createClass(b,[{key:"initUserInput",value:function(a){var b=this,c=a.inputElement;switch(b.inputType){case"1":b.userInput=new g,b.userInput.init(c);break;case"2":b.userInput=new f,b.userInput.init(c);break;case"3":b.userInput=c;break;case"4":b.userInput=c}b.userInput.setDebounce=b.setDebounce}},{key:"createDataProviders",value:function(){return[new l]}},{key:"createTrigger",value:function(){var a=this;switch(a.inputType){case"1":return new i;case"2":return new h;case"3":return new i;case"4":return new i}}},{key:"createDataAccumulator",value:function(){return new m}},{key:"createListComponent",value:function(){return new j}},{key:"createListItemComponentFactory",value:function(){return new k}},{key:"showComponent",value:function(){var a=this,b=a.dataAccumulator.dataCollection,e=b.find(function(a){return a.attributes.selected});if(e&&e.set({selected:!1}),b.length){var f;"2"===a.inputType?f=a.userInput._element.getBoundingClientRect():(f=a.userInput.getListAnchorBounds(),f.top-=a.userInput._element.scrollTop,f.bottom-=a.userInput._element.scrollTop),a.listComponent.positionComponent({anchorBounds:f}),a.listComponent.listItemComponents[0].model.set("selected",!0),a.listComponent.show(),c.element(a).triggerHandler(n.LIST_SHOWN),d.Utils.autoCompleteListsShown({instance:a})}}},{key:"hideComponent",value:function(){var a=this;a&&a.listComponent&&(a.listComponent.hide(),c.element(a).triggerHandler(n.LIST_HIDDEN),d.Utils.autoCompleteListsShown({instance:a,hide:!0}))}},{key:"invokeDataProviderSearch",value:function(a){var b=this,c=b.dataProviders||[];b.dataAccumulator.dataCollection.reset(null),b.listModel.resetData(),b.listModel.set({currentSearchKey:a.searchToken}),b.hideComponent(),b.disable||c.forEach(function(c){c.getData({searchToken:a.searchToken,trigger:a.trigger,includeAllGroups:b.includeAllGroups,includeEmailedGroups:b.includeEmailedGroups,excludeGroups:b.excludeGroups,exclude:b.exclude,excludeMe:b.excludeMe,showGroup:b.showGroup,includeOnly:b.includeOnly,type:b.contactType})})}},{key:"renderComponent",value:function(){var a=this,b=a.listModel,c=a.listComponent,d=b.attributes.currentSearchKey||"";c.render(b,{searchWord:d,hideEmailId:a.hideEmailId})}},{key:"_inputClickHandler",value:function(){var a=this;a.hideComponent()}},{key:"bindEvents",value:function(){var a=this;c.element(a.userInput._element).on(n.CLICK,a._inputClickHandler.bind(a)),babelHelpers.get(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"bindEvents",this).call(this)}},{key:"unbindEvents",value:function(){var a=this;c.element(a.userInput._element).off(n.CLICK,a._inputClickHandler),babelHelpers.get(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"unbindEvents",this).call(this)}}]),b}(e);p.EVENTS=n,p.INPUTS=o,b.zmAutoCompleteSystem=p}(),function(){var a=zmail.Core.Namespaces,b=a.create("zmContactsAutoComplete"),c=zmail.Components.AutoComplete,d=c.System.AbstractAutoCompleteSystem,e=zmail.Utils.DOM,f=zmContactsAutoComplete.zmAutoCompleteSystem,g=function(a){a=a||{};var b=a.input,c=new f;return"INPUT"===e.element(b,!0).nodeName?c.inputType=f.INPUTS.INPUT:"TEXTAREA"===e.element(b,!0).nodeName?c.inputType=f.INPUTS.TEXTAREA:b.editor?c.inputType=f.INPUTS.EDITOR:b.contenteditable&&(c.inputType=f.INPUTS.DIV),c.excludeMe=a.excludeMe||!1,c.exclude=a.exclude,c.includeAllGroups=a.includeAllGroups||!1,c.includeEmailedGroups=a.includeEmailedGroups||!1,c.excludeGroups=a.excludeGroups||!1,c.disable=a.disable||!1,c.showGroup=a.showGroup,c.contactType=a.contactType,c.setDebounce=a.setDebounce,c.inputInstance=a.inputInstance,c.hideEmailId=a.hideEmailId,c.includeOnly=a.includeOnly,c.init({inputElement:b,parentDOM:document.body}),e.element(c).on(d.EVENTS.ITEM_SELECTED,a.onSelect),e.element(c).on(f.EVENTS.LIST_SHOWN,a.listShown),e.element(c).on(f.EVENTS.LIST_HIDDEN,a.listHidden),c};b.autoComplete=g}();