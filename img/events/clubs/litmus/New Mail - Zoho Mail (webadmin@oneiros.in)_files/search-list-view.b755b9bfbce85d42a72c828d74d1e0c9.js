"use strict";!function(a){a.call(zmail.Core.Namespaces.create("zmail.SearchComponents"),zmail.Core.Namespaces.get)}(function(a){var b=a("_"),c=a("zmail.Utils.DOM"),d="default",e=function(a){return a},f=function(a,b){b.str?a.text(b.str):c.mount(b.$el,a)},g={DEFAULT:"default",HEADER:"header",CUSTOM:"custom",SEPARATOR:"separator",BUBBLE:"bubble"},h={LIST_CLASS:"js-dropmenu",LIST_ITEM_CLASS:"js-dropmenuitem",LIST_WRAPPER_CLASS:"js-wrapper",SCROLL_CLASS:"zmDDScroll",ZOHO_ONE_SEARCH_CLASS:"js-zone-dropmenuitem","default":function(a,b){var d=c.element(zdom("li",{className:h.LIST_ITEM_CLASS,"data-menuid":b}));return f(d,a),d},header:function(a,b){var d=c.element(zdom("li",{className:"nohr dd_label"}));return f(d,a),d},custom:function(a,b){return c.addClass(a,h.LIST_ITEM_CLASS),c.setData(a,"menuid",b),a},separator:function(){return c.element(zdom("li",{className:"SC_lne"}))},zohoOneSearch:function(a,b){var d=c.element(document.createDocumentFragment()),e=c.element(zdom("li",{className:h.LIST_ITEM_CLASS+" "+h.ZOHO_ONE_SEARCH_CLASS,"data-menuid":b}));return f(d,{$el:c.element(zdom("li",{className:"SC_lne "+h.ZOHO_ONE_SEARCH_CLASS}))}),f(e,a),f(d,{$el:e}),d},bubble:function(a,b){var d=c.element(zdom("div",{className:"zmSearchBub zmSBC "+h.LIST_ITEM_CLASS,"data-menuid":b}));return a.selected&&d.addClass("sel"),d.text(a.name),a.iconClass&&c.mountAtStart(zdom("i",{className:a.iconClass}),d),d},bubbles:function(a,b){var d=c.element(zdom("li",{className:"nohr"},zdom("div",{className:"zmSAS"}))),e=d.find(".zmSAS");return a.bubbles.forEach(function(a,d){c.mount(h.bubble(a,b+"."+d),e)}),d},listItems:function(a,f){var i,j,k=f.template||e,l=f.$parent||c.element(document.createDocumentFragment()),m=f.baseIndex||0;return a.forEach(function(a,e){a=k(a),b.isString(a)?(i=d,a={str:a}):a.str||a.templateType||a.$el?(i=a.templateType||d,a.$el="zohoOneSearch"===a.templateType?c.element(a):""):(a=c.element(a),a.hasClass(h.LIST_ITEM_CLASS)?i=g.CUSTOM:(a={$el:a},i=d)),j=h[i],c.mount(j(a,m+e),l)}),l},list:function(a,b){var d=c.element(zdom("div",{className:"SC_dd shw zmSearchDD js-list-container"},zdom("div",{className:h.LIST_WRAPPER_CLASS+" "+h.SCROLL_CLASS},zdom("ul",{className:h.LIST_CLASS}))));return b=b||{},d.find("."+h.LIST_WRAPPER_CLASS).addClass(b.wrapperClass||""),b.$parent=d.find("."+h.LIST_CLASS),b.$parent.addClass(b.ulClass||""),b.baseIndex=0,h.listItems(a,b),d}};this.ListViewTemplate=h,this.LIST_ITEMS_TEMPLATE_TYPES=g}),function(a){a.call(zmail.Core.Namespaces.create("zmail.SearchComponents"),zmail.Core.Namespaces.get)}(function(a){var b=a("zmail.Utils.DOM"),c=a("_"),d=a("$.Deferred"),e=a("zmail.Traverser"),f=a("zmail.Paginator"),g=a("zmail.SearchComponents.ListViewTemplate"),h=a("zmail.Search.Utils.ShortcutUtil"),i=a("zmail.Search.ViewInstance.SearchBoxContainer"),j=a("$.publish"),k="ZMAIL_MOUSE_DOWN_EVENT",l={TAB:9,UP_ARROW:38,DOWN_ARROW:40,ENTER:13,ESCAPE:27,SPACE:32,RIGHT_ARROW:39},m=function n(a){return this instanceof n?void this.init(a):new n(a)};this.ListView=m,m.prototype={__eventFlag:!1,__active:!0,selectionClass:"sel",wrapperClass:"",ulClass:"",bindEventsForElement:!0,forElementDebounceTime:0,hideOnRemove:!1,removeOnSelect:!0,removeOnMouseDown:!0,removeOnEscape:!0,$for:void 0,$parent:b.element(document.body),$left:void 0,$top:void 0,$right:void 0,$bottom:void 0,list:void 0,nextPageList:void 0,doPaginate:!0,paginator:void 0,pageSize:10,paginateThreshold:30,paginateScrollPercentage:80,selectionStartIndex:-1,autoComplete:!0,onKeyEvent:c.noop,__bindable:["handleClickEvent","handleKeyEvent","handleMouseDownEvent","handleInputAndChangeEvent","handlePagination","template"],bindFunctions:function(){return this.__bindable.reduce(function(a,b){return a[b]=a[b].bind(a),a},this)},init:function(a){c.extend(this,a),this.traverser=this.traverser||new e({skip:this.skip,startIndex:this.selectionStartIndex}),this.bindFunctions().bindEvents$For().setPaginator().paginate()},skip:function(a,b){var c=a&&a.templateType;return"separator"===c||"header"===c},show:function(){return this.hasElement()&&this.__active&&(this.hasPage()?(this.bindEvents().$el.show(),this.$for&&this.$for.focus(),this.onShow()):this.hide()),this},hide:function(){return this.hasElement()&&(this.traverser.resetIndex(),this.paginator.resetPage(),this.unbindEvents().$el.hide(),this.onHide()),this},reset:function(){return this.traverser.reset(),this.paginator.reset(),this},remove:function(){return this.hideOnRemove?this.hide():this.reset().unbindEvents$For().unbindEvents().removeDOM().onRemove(),this},removeDOM:function(){return this.hasElement()&&this.$el.remove(),this},removePreviousListElements:function(){return b.unmount(b.selector("div.js-list-container"),!0),this},paginate:function(a){var b=this;return this.__active?this.paginator.next(a).then(function(a){b.paginator.isFirstPage()?(b.list=a,b.nextPageList=void 0):(b.nextPageList=a,b.baseIndex=b.list.length,b.list=b.list.concat(a)),b.traverser.set({list:b.list}),b.render()},function(){b.hide()}):d().reject().promise()},render:function(){return this.paginator.isFirstPage()?(this.hasElement()&&this.unbindEvents().$el.remove(),this.removePreviousListElements().compileTemplate().setPosition().mount().setHeight().setWidth().show().select()):this.compileTemplate().show(),this},bindMouseEvents:function(){var a=this;this.$el.find("li").off("mouseenter").on("mouseenter",function(){b.element(this).on("mousemove",function(){var c=b.element(this).prevAll().length;a.traverser.index=c,b.element(this).parent().children().removeClass(a.selectionClass),b.addClass(this,a.selectionClass)})}).off("mouseleave").on("mouseleave",function(){b.removeClass(this,a.selectionClass),a.traverser.resetIndex()})},compileTemplate:function(){return this.paginator.isFirstPage()?this.$el=g.list(this.list,{template:this.template,ulClass:this.ulClass,wrapperClass:this.wrapperClass}):(g.listItems(this.nextPageList,{$parent:this.getListElement(),baseIndex:this.baseIndex,template:this.template}),this.bindMouseEvents()),this},setPosition:function(){return this.$el.css(c.result(this,"position")),this},mount:function(){return b.mount(this.$el,this.$parent),this},isZohoOneSearchContext:function(){return this.$el.find(".js-zone-dropmenuitem").eq(0)[0]},getChildHeight:function(){var a=this.getListElement().children(),c=0;return a.each(function(d,e){c+=b.hasClass(e,"SC_lne")?b.element(a[d-1]||a[d+1]||e).outerHeight():b.element(e).outerHeight()}),c},getAverageChildHeight:function(){return this.getChildHeight()/this.getListElement().children().length},setHeight:function(){if(this.hasElement()){var a=this.isZohoOneSearchContext(),b=0;if(a)b=this.getChildHeight();else{var c=this.getAverageChildHeight();b=c*this.paginator.getPageSize(),this.paginator.hasMoreToFetch&&(b-=c)}var d=this.getListWrapperElement();d.css({"max-height":b})}return this},setWidth:function(){return this.hasElement()&&this.maxWidth&&this.$el.css({"max-width":this.maxWidth}),this},setPaginator:function(){return this.paginator instanceof f||(this.paginator=f({provider:this.list||[],pageSize:this.pageSize,threshold:this.paginateThreshold})),this},position:function(){var a={top:0,left:0};return this.$left?a.left=this.$left.offset().left:this.$right&&(a.left=this.$right.offset().left+this.$right.outerWidth()),this.$top?a.top=this.$top.offset().top+this.$top.outerHeight():this.$bottom&&(a.top=this.$bottom.offset().top),a},hasElement:function(){return void 0!==this.$el},isVisible:function(){return this.hasElement()&&this.$el.is(":visible")},hasPage:function(){return this.list&&this.list.length},getListWrapperElement:function(){return this.$el.find("."+g.LIST_WRAPPER_CLASS)},getListElement:function(){return this.$el.find("."+g.LIST_CLASS)},getSelectedIndex:function(){return this.traverser.index},scrollIntoView:function(a){return a&&a.scrollIntoViewIfNeeded?a.scrollIntoViewIfNeeded(!1):a&&a.scrollIntoView&&a.scrollIntoView(!1),this},selectMenuItem:function(){var a="[data-menuid="+this.selectedMenu+"]",b=this.$el.find(a);return b.addClass(this.selectionClass),this.scrollIntoView(b[0]),this},unselectMenuItem:function(){return this.$el.find("."+this.selectionClass).removeClass(this.selectionClass),this},select:function(){return this.selectedMenu=this.getSelectedIndex(),this.unselectMenuItem().selectMenuItem(),this},getSelected:function(){var b,d=this.list;if(!c.isEmpty(d)){var e=String(this.selectedMenu).split(".");if(1===e.length){if(b=d[this.selectedMenu],c.isString(b)){var f=a("zmail.Search.SearchWatcher"),g=f.getCurrentContext(),h={name:b},i=g.classMap&&g.classMap[b];h.description=this.$el.find("li[data-menuid='"+this.selectedMenu+"']").find(".greyText").eq(0).text(),i&&"function"==typeof i.getDefaultValue&&(h.value=i.getDefaultValue()),h.value&&h.description!==i.description&&(b=h)}}else 2===e.length&&(b=d[e[0]].bubbles[e[1]])}return b},isSelected:function(){return this.isVisible()&&void 0!==this.getSelected()},handleSelection:c.debounce(function(b){var c=this.getSelected();if(c&&c.__isZohoOneSearch){var d=a("_zm");d&&"function"==typeof d.openZohoOneSearch&&(d.openZohoOneSearch(b),j("mailsuite/searchClose"))}else this.onSelect(c);return c&&c.__keepAutofill?this:(this.removeOnSelect?this.remove():this.hide(),this)},300,!0),handleClickEvent:function(c){var d=a("zmUtil");if(d&&"function"==typeof d.hideMenu&&d.hideMenu(!0),b.element(b.element(c.target).closest("."+g.ZOHO_ONE_SEARCH_CLASS),!0))a("_zm").openZohoOneSearch(c),j("mailsuite/searchClose");else{var e=b.element(c.target).closest("."+g.LIST_ITEM_CLASS).data("menuid");this.selectedMenu=e,this.handleSelection(c)}c.stopPropagation(),c.stopImmediatePropagation()},handleMouseDown:function(a){a.stopImmediatePropagation()},isClickedOnScrollBar:function(a){var c=this.$el,d=b.element(b.selector("ul",this.$el)),e=c.offset().left,f=d.outerWidth()+e,g=c.outerWidth(!0)+e;return a>=f&&a<=g},ignoreMouseDownEvent:function(a){return!1},handleMouseDownEvent:function(a,b){this.ignoreMouseDownEvent(b)||this.isClickedOnScrollBar(b.clientX)||(this.removeOnMouseDown?this.remove():this.hide(),this.onMouseDown())},onEscape:function(){i=i||a("zmail.Search.ViewInstance.SearchBoxContainer"),i.collapseSearch({blur:!0})},handleKeyEvent:function(b){var c=b.keyCode;if(c===l.UP_ARROW||c===l.DOWN_ARROW){var d=c===l.DOWN_ARROW?1:-1;this.traverser.traverse(d),this.select(),this.isVisible()&&(b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation())}else c===l.ENTER?(this.selectedMenu=this.getSelectedIndex(),this.handleSelection(b),b.preventDefault()):c===l.TAB&&!b.shiftKey&&this.isVisible()?(this.selectedMenu=this.getSelectedIndex(),this.selectedMenu>=0&&(this.handleSelection(b),b.preventDefault())):c===l.ESCAPE?(this.removeOnEscape?this.remove():this.hide(),this.onEscape()):((this.opts||{}).isContextFilter&&(h=h||a("zmail.Search.Utils.ShortcutUtil"),h.handleIfShortcut(b)),this.onKeyEvent(b))},isActiveElement:function(){var a=document.activeElement,b=this.$for&&this.$for[0];return void 0!==a&&a===b},handleInputAndChangeEvent:function(a){if(this.bindEventsForElement&&this.isActiveElement()){var c=b.element(a.target),d=(c.val()||c.text()||"").trim();this.paginate(d)}},handlePagination:function(a){if(this.doPaginate){var b=this.getListWrapperElement(),c=Math.round(100*(b[0].scrollTop+b.height())/b[0].scrollHeight);this.paginator.hasMoreToFetch&&this.paginateScrollPercentage<=c?this.paginate(this.paginator.query):(a.preventDefault(),a.stopPropagation())}},bindEvents$For:function(){return this.bindEventsForElement&&this.$for&&(this.forElementDebounceTime>0&&(this.handleInputAndChangeEvent=c.debounce(this.handleInputAndChangeEvent,this.forElementDebounceTime)),this.$for.on("change input",this.handleInputAndChangeEvent)),this},unbindEvents$For:function(){return this.bindEventsForElement&&this.$for&&this.$for.off("change input",this.handleInputAndChangeEvent),this},bindEvents:function(){var a=this;return this.__eventFlag||(this.__eventFlag=!0,this.hasElement()&&(this.getListWrapperElement().on("scroll",this.handlePagination),this.$el.on("click","."+g.LIST_ITEM_CLASS,this.handleClickEvent),this.$el.on("mousedown",this.handleMouseDown),$.subscribe(k,this.handleMouseDownEvent)),a.bindMouseEvents(),this.$parent&&this.$parent.on("keydown",this.handleKeyEvent)),this},unbindEvents:function(){return this.__eventFlag&&(this.__eventFlag=!1,this.hasElement()&&(this.getListWrapperElement().off("scroll",this.handlePagination),this.$el.off("click","."+g.LIST_ITEM_CLASS,this.handleClickEvent),this.$el.off("mousedown",this.handleMouseDown),this.$el.find("li").off("mouseenter").off("mouseleave"),$.unsubscribe(k,this.handleMouseDownEvent)),this.$parent&&this.$parent.off("keydown",this.handleKeyEvent)),this},bind:function(){return this.__active||(this.__active=!0,this.bindEvents$For()),this},unbind:function(){return this.__active&&(this.__active=!1,this.hide().unbindEvents$For()),this},text:function(a){return a},dom:function(a){},template:function(a){return this.dom(a,this.paginator)||this.text(a,this.paginator)},onShow:c.noop,onHide:c.noop,onSelect:c.noop,onRemove:c.noop,onMouseDown:c.noop,change:function(a){return this.paginate(a)}}});