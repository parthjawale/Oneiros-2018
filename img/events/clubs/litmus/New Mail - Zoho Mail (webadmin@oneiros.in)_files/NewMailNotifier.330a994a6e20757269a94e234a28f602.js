"use strict";!function(){var a,b=zmail.Core.Namespaces,c=b.create("zmail.Listing.Notifier"),d=ZMail.lConstants,e=d.cls,f=function(a){var b=0,c=zmList.getListObj(a);c=c&&c.MO||[];var d=c.length,e=0;if(zmUtil.isInlineCompose())for(e=0;e<d;e++)zmList.getMailObj(c[e]).DMID&&b++;else for(e=0;e<d;e++)zmList.getMailObj(c[e]).FD===zmail.folId.dId&&b++;return b},g=function(a,b){var c=zmList.getMailObj(a),d=zmList.getMailObj(b);if(c&&d){0===d.S?d.TS=0:d.TS=void 0!==c.TS?c.TS:c.S,d.TC=c.TC||1,d.TTAGS=c.TTAGS||c.TAG,d.TSB=d.TSB||c.TSB||c.SB,d.FD===zmail.folId.sId?d.TSM=c.TSM||c.SM:d.TSM=d.TSM||c.TSM||c.SM,d.TSN=d.TSN||c.TSN||c.SN,d.TI=c.TI||!1,d.TF=c.TF||!1,d.TM=c.TM||!1,1===d.AT?d.TA=1:d.TA=void 0!==c.TA?c.TA:c.AT;var e=c.NFG?parseInt(c.NFG):0;if(!d.TI&&!d.TF&&!d.TM&&0!==e)switch(e){case 1:d.TI=!0;break;case 2:d.TM=!0;break;case 3:d.TF=!0}d.NFG&&(1===parseInt(d.NFG)?d.TI=!0:2===parseInt(d.NFG)?d.TM=!0:3===parseInt(d.NFG)&&(d.TF=!0)),d.FD===zmail.folId.dId&&(d.DC=f(d.T))}},h=function(a,b){var c=zmList.getDupThdRowId(a,b);return!!c&&(g(c,a),!0)},i=function(a){var b=a.length,c=1,d=a[c];for(c=1;c<b;c++)if(zmList.getMailObj(a[c]).FD!==zmail.folId.sId){d=a[c];break}return d},j=function(a,b){var c=$(zmail.mailCenter.listElem).find("#"+a),d="",g=zmInit.getThreadSubject(b.M);if(b.FD!==zmail.folId.dId&&(zmail.mailOpt.isshowSummary&&b.TSM&&b.TSM.trim()&&(d=b.TSM),c.find("."+e.from+" span:first").html(b.TSN),c.find("."+e.subject).html(ZMail.lView.constTemplate("subject",{subject:g})),c.find("."+e.summary).html(ZMail.lView.constTemplate("summary",{summary:d}))),b.TC>0){var h=c.find("."+e.tc);h.length&&b.FD!==zmail.folId.dId?h.text(b.TC):h.length||c.find("."+e.tcOuter).html(ZMail.lView.constTemplate("threadCount",{count:b.TC}))}var i=a;if(0===a.indexOf("t")&&(i=a.substring(1)),b.FD===zmail.folId.dId){var j=f(b.T)||1,k=zmList.getMailObj(i);k&&(k.DC=j)}if(b.TS2){var l=["","msi-rpd","msi-fwd","msi-fwdRpd"],m=c.find(".msi-mail,.msi-rpd,.msi-fwd,.msi-fwdRpd");m.length&&(m.removeClass(),m.addClass(l[b.TS2]+" zmLTicon"),m.html(""),m.append(zdom("i",{"class":"path"})))}},k=function(a,b,c,d){var e,f,g,h;a.TC=a.TC||1,e=zmUtil.getFolId(),f=zmList.getDupThdRowId(a.M,e),h=zmList.getMailObj(f)||{},f&&(g=$(zmail.mailCenter.listElem).find("#t"+f),h.T||(h.TC=1,h.TH=1,h.T=f),a.FD===zmail.folId.sId&&(2===c||1===c&&d)?(a.TC=h.TC+1,h.TC+=1):a.TC=h.TC||a.TC,a.DT=h.DT||a.DT,g.length?(j("t"+f,a),$(zmail.mailCenter.listElem).find("#thd"+f).remove()):(g=$(zmail.mailCenter.listElem).find("#"+f),g.length&&j(f,a)))},l=function(a,b){var c,d,e,f=a.T,g=[],h=!1,i=!1,j=$.Deferred();if(a.TC=a.TC||1,g=zmList.getViewBasedMsgList(f,b,!0),c=zmUtil.getFolId(),g.length>0&&(i=!0,e=$(zmail.mailCenter.listElem).find("#t"+g[1])),i&&a.FD!==zmail.folId.dId&&e.length)a.TC=g.length,e.remove(),$(zmail.mailCenter.listElem).find("#thd"+g[1]).remove(),h=!0,d=g[1];else if(d=zmList.getDupThdRowId(a.M,c)){var k=zmList.getMailObj(d);$.publish("mail/updateRead",{msgId:a.M,oldMId:d,newMailWS:!0}),k.T?($(zmail.mailCenter.listElem).find("#"+d).remove(),$(zmail.mailCenter.listElem).find("#t"+d).remove(),$(zmail.mailCenter.listElem).find("#thd"+d).remove()):(k.TC=1,k.TH=1,k.T=d,$(zmail.mailCenter.listElem).find("#"+d).remove()),a.FD!==zmail.folId.dId?a.TC=k.TC+1:a.TC=k.TC,h=!0}if(h){var l=zmList.getListObj(c),m=l&&l.MO.indexOf(d);m!==-1&&l.MO.splice(m,1),j.resolve()}else zmList.getThreadCount({msgId:a.M,viewObj:b,deferredObj:j});return j};a=function(a,b){var c={reply:"msi-rpd",replyall:"msi-rpd",forward:"msi-fwdRpd"},d=$(zmail.mailCenter.prevElem)[0].getAttribute("data-mid");if(d!==b.T)return!1;var e=$(zmail.mailCenter.listElem).find("#"+d);if(b.TS2&&e){var f=e.find(".msi-mail,.msi-rpd,.msi-fwd,.msi-fwdRpd");f.length&&(f.removeClass(),f.addClass(c[a]+" zmLTicon"),f.html(""),f.append(zdom("i",{className:"path"})))}},c.getNewMessage=function(a,b,c){var d,e;if("NEW_MAIL"===c.act?(d=c.AID,e=[c.data]):(d=c.accId,e=$.parseJSON(c.cs)),e)if(zmail.accId===d){var f;for(f in e){var g=e[f],h=zmList.getMailObj(g.M);if(h&&h.FD===zmail.folId.dId&&(g.PA=h.PA),g.DT=g.RDT||g.DT,g.SN=g.NSN||g.SN,g.SHID&&zmUtil.isSharedFolder(g.SHID))g.FD=g.SHID;else{var i=g.FD;g.S||(g.FD===zmail.folId.spId||g.FD===zmail.folId.tId?zmail.MailPreUtils.updateCount({fId:i,mode:"inc",count:1,isHighlight:!1}):zmail.MailPreUtils.updateCount({fId:i,mode:"inc",count:1,isHighlight:!0}))}zmList.addModel(g,g.M),$.publish("/maction/newm",[[g]])}}else{var j=0;e.forEach(function(a){a.S||(j+=1)}),j&&zmUtil.updateCountForAcc(d,"inc",j)}},c.reviewMailNotification=function(b,d,e){var f,j,k=zmUtil.getFolId(),l=zmInit.getListingDetObj(),m=!1,n=!1,o=!1,p=!1,q=zmUtil.getMLConversionValue(k);k===zmail.folId.sId||k===zmail.folId.tId?q=0:2===q&&k===zmail.folId.spId&&(q=1);var r=b.T,s=r&&zmList.getListObj(r),t=r&&zmList.getMailObj(r);if(r){b.FD===zmail.folId.dId&&zmUtil.isInlineCompose()||zmCache.updateObj({mode:"insert",msgId:b.M,rt:b.R,folId:r,type:"newm"});var u=zmList.getMailObj(b.PA);b.FD===zmail.folId.dId&&zmUtil.isInlineCompose()&&u&&(u.DMID=b.M,0===q&&(u.DC=zmList.updateModel("DC",u.DC+1||1,b.PA))),t&&0===t.TH&&(t.TH=1,t.T=r,t.TC=1,s?s.MO?1===zmail.convSortOrder?s.MO.unshift(b.M):s.MO.push(b.M):b.FD===zmail.folId.dId&&zmUtil.isInlineCompose()?s.MO=[r]:1===zmail.convSortOrder?s.MO=[r,b.M]:s.MO=[b.M,r]:b.FD===zmail.folId.dId&&zmUtil.isInlineCompose()?(t.DC=1,zmList.createListMap(r,"MO",[r])):(b.FD===zmail.folId.dId&&zmList.updateModel("DC",1,r),1===zmail.convSortOrder?zmList.createListMap(r,"MO",[r,b.M]):zmList.createListMap(r,"MO",[b.M,r])),$.publish("mail/threadCreated",{conversationID:r}))}if(!(b.FD===zmail.folId.spId&&k!==zmail.folId.spId||b.FD===zmail.folId.tId&&k!==zmail.folId.tId)){(l.fId&&k===b.FD||!l.fId)&&(o=!0),("unread"===l.view&&0===b.S||"1"===l.attach&&1===b.AT||b.NFG&&l.flag&&("-1"===l.flag&&0!==parseInt(b.NFG)||parseInt(l.flag)===parseInt(b.NFG))||l.label&&b.TAG&&("-1"===l.label||b.TAG.indexOf(l.label)!==-1)||(l.fId&&k===b.FD||!l.fId&&"all"===k)&&!l.flag&&!l.label&&!l.attach&&"unread"!==l.view)&&(n=!0);var v=zmList.getListObj(b.FD),w=zmList.getListObj(k);if((v&&v.MO.indexOf(b.M)===-1||w&&w.MO.indexOf(b.M)===-1)&&(p=!0),o&&n&&p&&(m=!0,b.TH&&0!==q)){var x=zmList.getDupThdRowId(b.M,k);x?g(x,b.M):s&&(j=zmList.getViewBasedMsgList(b.T,l,!0),j.length>0&&(b.FD===zmail.folId.dId?g(b.M,b.M):zmList.getMailObj(j[1]).FD===zmail.folId.sId?(f=i(j),g(f,b.M)):g(j[1],b.M)))}}!m&&0!==q&&b.TH&&k!==zmail.folId.spId&&k!==zmail.folId.tId&&(s?(j=zmList.getMailSummaryList(l,b.T),j.length>0&&(j=zmList.getViewBasedMsgList(b.T,l,!0),b.FD===zmail.folId.dId?g(b.M,b.M):zmList.getMailObj(j[1]).FD===zmail.folId.sId?(f=i(j),g(f,b.M)):g(j[1],b.M),m=!0)):m=h(b.M,k)),m?c.updateForNewMail(b,d,n):a(e,b);var y=[zmail.folId.spId,zmail.folId.tId,zmail.folId.dId];if("zmailReconnect"!==d&&y.indexOf(b.FD)===-1&&0===b.S&&(void 0!==b.SNS&&"1"!==b.SNS||!zmInit.isNotificationSuppressed(b.FD))){zmInit.mNotifier.push(b);var z={};z.title=b.SN||b.F||"",z.msg=zmUtil.decodeHTMLEntities(b.SB)||"",z.tag="Mail";var A=null,B=zmResource.get("image","SC-Photo.png");A=zmail.ContactBook.get({promise:!1,eid:b.F,type:["personal","org"]})[0],A&&(B=A.photo(!1)),z.imgUrl=B,z.callback=function(){zmList.getMailData({msgId:b.M,opentype:2,type:"lt",src:"external",eprm:{accId:zmail.accId}})},_zm.pushDesktopNotification(z)}},c.updateForNewMail=function(a,b,d){var f,g,h,i,m,n,o=!1,p=!1,q=!1,r=[],s="",t=!0,u="",v=zmUtil.getMLConversionValue();if(g=a.FD,f=zmInit.getListingDetObj(),h=zmUtil.getFolId(),a.AR||(a.AR=0),a.NFG||(a.NFG="0"),"zmailReconnect"!==b&&a.FD!==zmail.folId.sId&&a.FD!==zmail.folId.dId||(t=!1),h===zmail.folId.sId||h===zmail.folId.tId?v=0:2===v&&h===zmail.folId.spId&&(v=1),a.T&&0!==v){u="zm_tabt"+a.T,0!==a.S||a.TS||(a.TS=0),zmsuite.isWorkspaceAvailable(u)&&(q=!0);var w=$(zmail.mailCenter.prevElem);if(w.hasClass("shw")&&(i=w.attr("data-mid"),m=zmList.getMailObj(i),m.T===a.T||i===a.T)){p=!0,o=!0;var x=w.attr("data-ty");"th"===x?(s=zmCenterListing.mailObjectAPI.getViewParentOf("c"+i),s=s&&s.id||i,i=s,m=zmList.getMailObj(i)):s=i;var y=$(zmail.mailCenter.listElem).find("#"+s);n=$(zmail.mailCenter.listElem).find("#thd"+s),!n.length&&y.length?(s="t"+s,y.attr("id",s)):(s="t"+s,y=$(zmail.mailCenter.listElem).find("#"+s))}}else 0===v&&a.TH&&(a.TC=-1);if(p||"archive"===f.view||(0===v||(2===v||1===v&&d)&&h===zmail.folId.sId==(a.FD===zmail.folId.sId)&&h===zmail.folId.dId==(a.FD===zmail.folId.dId)?0!==v&&a.TH&&!o?$.when(l(a,f)).then(function(){var b=!0;"unread"===f.view&&1===a.TS&&(b=!1),b&&c.addMailsToListing(a,h),zmCache.updateObj({mode:"insert",msgId:a.M,rt:a.R,folId:h}),$.publish("mail/updateRead",{msgId:a.M,newMailWS:!0}),zmPrev.updatePvNtforNewMails()}):(c.addMailsToListing(a,h),o||(zmCache.updateObj({mode:"insert",msgId:a.M,rt:a.R,folId:g}),""===f.fId&&zmCache.updateObj({mode:"insert",msgId:a.M,rt:a.R,folId:h})),zmPrev.updatePvNtforNewMails()):k(a,f,v,d)),t||(p?r=zmPreviewTemplate.getMissingMailList(a.T,"P"):q&&(r=zmPreviewTemplate.getMissingMailList(a.T,"T"))),p&&(t?zmPreviewTemplate.showNotifBand({targetElem:zmsuite.getCenter("zm_Container")[1].getNodes()[1].$el,thdId:a.T,opentype:4===zmail.mailOpt.isPopup?4:0}):$.publish("/mail/updatemailview",[{list:r,opentype:4===zmail.mailOpt.isPopup?4:0}]),"archive"!==f.view&&(a.FD!==zmail.folId.sId||a.FD===zmail.folId.sId&&!zmList.excludeSent)&&(2===v||1===v&&(d||a.FD===zmail.folId.dId)))){if(a.FD!==zmail.folId.dId){if($(zmail.mailCenter.listElem).find("#thd"+i).length){var z=document.createDocumentFragment();z.appendChild(zmList.constructThreadChildRow(a.M,!1)[0]),zmail.convSortOrder?n.append(z):n.prepend(z)}m?(m.TC+=1,a.TC=m.TC):a.TC+=1,0===a.TS&&s&&a.FD!==zmail.folId.dId&&$("#"+s).addClass(e.unread)}j(s,a)}q&&(t?zmPreviewTemplate.showNotifBand({targetElem:zmsuite.getCenter(u)[1].getNodes()[1].$el,thdId:a.T,opentype:2}):$.publish("/mail/updatemailview",[{list:r,opentype:2}]))},c.addMailsToListing=function(a,b){var c;if(c=$(zmail.mailCenter.listElem),zmail.mailOpt.isshowSummary||(a.SM=""),!c.closest(".SC_streams").length){zmList.isAllListingChecked(c)&&zmsuite.getCenter("zm_Container")[0].getNodes()[0].$el.find(".msi-uncheck").removeClass().addClass("msi-uncheck msi-partcheck");var d=$(zmInit.constructMailRow(b,[a.M]));"h"===zmail.viewInfo[0].DT&&d.find("."+e.date).hide(),"h"===zmail.viewInfo[0].SZ&&d.find("."+e.size).hide(),c.find("#nomails").length&&c.html(d);var f=zmfolAction.getSortProperties(b,"type");0===f?c.prepend(d):1===f&&0===zmList.getListObj(b).showNextPage&&c.append(d),zmInit.listingBand.SpamTrashBand.setBand()}}}();