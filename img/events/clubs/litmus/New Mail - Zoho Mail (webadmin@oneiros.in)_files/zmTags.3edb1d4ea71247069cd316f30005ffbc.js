"use strict";define([],function(a,b){var c=a("zmText"),d=a("zmAjq"),e=a("zmInit"),f=a("zmsuite"),g=a("zmail.Core.Namespaces"),h=a("zmail.Utils.DOM"),i=g.create("zmlab"),j=c.get("zmTags","tags"),k="#96ccf5",l=function(b,c){return a("zmList").getRowInfo(b,c)},m=function(b,c,d){a("zmUtil").succErrMsg(b,c,d)},n=function(b){return a("zmUtil").getTagList(b)},o=function(b,c){a("zmUtil").hideMenu(b,c)},p=function(b,c){a("zmUtil").stopEvents(b,c)},q=function(b,c){var d=a("zmPreviewTemplate");for(var e in zmail.mailObj){var f=$.inArray(String(b),zmail.mailObj[e].TAG||[]),g=$.inArray(String(b),zmail.mailObj[e].TTAGS||[]);f!==-1&&("del"===c&&zmail.mailObj[e].TAG.splice(f,1),d.refreshLabelsForMail(e)),g!==-1&&("del"===c&&zmail.mailObj[e].TTAGS.splice(f,1),d.refreshLabelsForMail(e))}},r=function(a,b){var c=e.getListingDetObj();q(a,b),c.label===a&&("del"===b&&(""!==c.fId?e.foldView({folId:c.fId,reInitialize:!0}):(e.foldView({folId:zmail.folId.iId,reInitialize:!0}),zmail.mailLeft.selRow(String(zmail.folId.iId),"zmlTreeH"))),e.updateHeaderBand())},s=function(a){if(a&&a.id){var b,c,d=a.id,e="zmllabelH";b=zmail.mailLeft.getNodes()[0].getLayer(e),c=l(d,e),r(d,"del"),$.publish("label/deleted",{labelID:d}),b.deleteNode(c)}else a.e&&m("e",j.errors.processError)},t=function(a,b){var c,d,e,f,g,i,k,o,p="zmllabelH",q=zmail.labInfo,r="",s="";if("default"===b.accType&&zmail.accId!==zmail.defAccId&&(q=n(b.accType)),a.e)m("e",j.errors.processError);else{if(k=a.labelId||a.id,"a"===b.mode&&($.isEmptyObject(q)&&h.show(h.selector("#zmllabelH .SC_ltl .SC_frt")),q[k]={}),e=q[k].system||"0",f=q[k].shId||"-1",q[k]={color:a.color||a.c,id:a.labelId||a.id,label:a.displayName||a.n,dispName:a.displayName||a.n,fav:"true",system:e,shId:f},"a"===b.mode&&$.publish("label/added",{label:q[k],info:a}),zmail.mailLeft){if(c=zmail.mailLeft.getNodes()[0].getLayer(p),d=l(k,p),d[k]||"default"!==b.accType||(d={}),i=a.seq,1!==i){var t=h.selector("#zmllabel #"+k).prev();t.length&&(s=t.attr("id"))}"e"===b.mode&&($.publish("label/renamed",{label:q[k],info:a}),c.deleteNode(d))}for(g in d){d[g].label=a.displayName||a.n,d[g].color=a.color||a.c,d[g].dispName=a.displayName||a.n;break}for(o=Object.keys(q),g=0;g<o.length;g++)if(o[g]===(a.labelId||a.id)){i=g+1;break}zmail.mailLeft&&($.isEmptyObject(d)||(1!==i||h.selector("#zmllabel .SC_tre").length?1===i?(r=h.selector("#zmllabel .SC_tre").eq(0).attr("id"),c.insertNodeBefore(d,c.mapObject,r)):(r=h.selector("#zmllabel .SC_tre").eq(i-2).attr("id"),r||(r=s),r?c.insertNodeAfter(d,c.mapObject,r):c.prependNode(d,c.mapObject)):(r="zmllabel",c.appendNode(d,c.mapObject)))),q[k].se=i,zmail.accId===zmail.defAccId&&(zmail.labInfo=q,zmail.zohoAccLabInfo=$.extend({},q))}b.reqDoneClbk&&b.reqDoneClbk(!a.e,k)},u=function(a,b,c,e){var f={mode:a,accType:c},g={accId:zmail.accId,mode:a},h=zmail.labInfo,j=t;"default"===c&&(h=n(c),g.accId=zmail.defAccId),"d"!==a&&"m"!==a&&(g.name=b,"e"!==a?g.color=e.color||k:g.color=h[i.labelId].color),"a"!==a&&"m"!==a&&(g.labId=i.labelId),"d"===a?j=s:"m"===a&&(g.labIdArr=e.labIdArr,j=""),e&&"function"==typeof e.reqDoneClbk&&(f.reqDoneClbk=e.reqDoneClbk),d.XHR({u:zmail.conPath+"/lA.do",t:"POST",fn:j,p:g,csr:"s",ep:f})},v=function(b){var c=[],d={},e=[];if("selected"===b.type)e=a("zmUtil").getSelectedMails(),e[0].forEach(function(a){c.push({id:a,ttag:!1})}),e[1].forEach(function(a){c.push({id:a,ttag:!0})});else{if("list"!==b.type)return;c=b.list}if(c.length>=1){var f,g=(c[0].ttag?zmail.mailObj[c[0].id].TTAGS:zmail.mailObj[c[0].id].TAG)||[];for(f in zmail.labInfo)$.inArray(f,g)!==-1&&(d[f]="check");if(c.length>1)for(var h=1,i=c.length;h<i;h++){g=(c[h].ttag?zmail.mailObj[c[h].id].TTAGS:zmail.mailObj[c[h].id].TAG)||[];for(f in zmail.labInfo)$.inArray(f,g)!==-1?d[f]||(d[f]="partial"):d[f]&&(d[f]="partial")}}return d},w=function(a){var b,c,d,e=document.createDocumentFragment();for(a=a||{},b=["#e5e5e5","#f9baab","#f9d3a2","#fef86a","#d7f3b0","#c8e5fb","#e0ceef","#f6d0e6","#c4c4c4","#e07861","#ecb772","#f6e565","#badf88","#96ccf5","#b99fce","#e099c2","#808080","#ce232c","#dd902f","#d0c04b","#90ca40","#70abec","#a97ac6","#c26a9d","#000000","#9d1812","#a56016","#a69646","#5b8828","#4c76a2","#8343a0","#ba3682"],d=b.length,c=0;c<d;c++){var f=[];b[c]===a.selColor&&f.push("sel"),"#000000"===b[c]&&f.push("black"),f=f.join(" "),h.mount(zdom("div",{className:f,style:{backgroundColor:b[c]}}),e)}return e},x={DEFAULT_COLOR:k,labelId:"",labelmov:function(a,b,c){var d,e,f,g,i,j=[];if(0===zmail.mailOpt.labSort){if(!c.id||"zmllabelH"!==c.id)for(e in c)i=e;for(g=zmail.mailLeft.getNodes()[0].getLayer("zmllabelH"),g.moveNode(b,g.mapObject,i),d=h.selector(".SC_tre",h.selector("#zmllabel")),f=d.length,e=0;e<f;e++)j.push(d[e].id);u(a,"","",{labIdArr:j})}},labelCreate:function(a,b,c){u("a",a,b,c)},labelreq:function(a,b,c){var d="",e=h.selector("#"+b);"d"!==a&&(d=$.trim(h.getText(e))),(d.length||"d"===a)&&u(a,d),"e"!==a||c||(h.clearHTML(e),h.setText(e,j.labels.editTag),h.setAttribute(e,"contentEditable",!1))},isValidLabel:function(a,b){var c=$.trim(h.getText(h.selector("#"+a)).toLowerCase());return!!x.isValidName(c,b)||(h.focus(h.selector("#"+a)),!1)},isValidName:function(b,c,d,e){var f,g=a("zmUtil"),h=zmail.labInfo;if("default"===d&&(h=n(d)),b=$.trim(b.toLowerCase()),!b.length)return m("e",j.errors.empty,e),!1;if(g.hasSpecialChars(b,"labelName"))return g.succErrMsg("e",j.errors.specialCharacters,e),!1;if(b.length>25)return m("e",j.errors.lengthExceeded,e),!1;if("info"===b||"important"===b||"follow-up"===b)return m("e",j.errors.retrictedWord,e),!1;for(f in h)if(("rename"!==c||i.labelId!==f)&&h[f].label.toLowerCase()===b)return m("e",j.errors.exists,e),!1;return!0},createColorPicker:function(a){var b;b=w(),i.labelId=a.parent()[0].id,f.showMenu({par:a,list:[{htm:b}],align:"colorpicker",ulClass:"SC_cp",clk:function(a,b){"DIV"===b.tagName&&(i.updateLabColor(a,b),o())}})},updateLabColor:function(a,b){var c=h.element(b);zmail.labInfo[i.labelId].color=i.convertRGBtoHex(h.getStyle(c,"background-color")),zmail.zohoAccLabInfo[i.labelId]&&(zmail.zohoAccLabInfo[i.labelId].color=zmail.labInfo[i.labelId].color),i.labelreq("e",i.labelId,!0)},convertRGBtoHex:function(a){var b;if(a.indexOf("rgb")!==-1){a=a.replace(/rgb\(|\)/g,"").split(","),b=a.length;for(var c=0;c<b;c++)a[c]=parseInt(a[c]).toString(16),a[c]=1===a[c].length?"0"+a[c]:a[c];a="#"+a.join("")}return a},labelSelectionInfo:v,labelMenuHadler:function(a){a=a||"a";var b=h.element(this.activeMenu.activeMenuElement),c=b[0].id;return i.isValidLabel(c,"add")?(i.labelreq(a,c),!0):(b.focus(),!1)},showCreateTagPopUp:function(b){var c,d,e,g,l,m,q,r,s,t,v,x,y,z,A=a("zmsDialog"),B="",C=200;b=b||{},s=b.accType||"",v=n(s),g=b.mode||"new",x=f.getAppLeft().getNodes()[0].getLayer("zmllabelH").el,t=h.selector(".zm_compose"),m=t.offset(),y=m.left+t.width(),z=x.position().top<0?h.selector(".zm_compose").offset().top:x.offset().top,l=z+350-h.element(document.body).height(),l>0&&(z-=l),"rename"===g?(e=j.labels.editTag,B=v[i.labelId].label,r=v[i.labelId].color):"new"===g&&(e=j.labels.createTag,r=k),c={title:e,style:{width:C+"px","min-width":"168px","max-width":"168px"},posParent:{top:z+"px",left:y+"px"},customClass:"noanim",buttons:[{txt:j.labels.save,selected:!0,callback:function(){var a;a=h.selector("#zm_createlabelpopup").find("input:first").val(),b.callback?b.callback("a",a,r):i.isValidName(a,g,s,{parElem:h.element(h.selector("#zm_createlabelpopup"),!0)})&&("new"===g?u("a",a,s,{color:r}):"rename"===g&&(v[i.labelId].color=r,u("e",a,s,{color:r})),A.remove())}},{isCancel:!0,txt:j.labels.cancel,callback:function(){A.remove()}}],closeaction:function(){h.unmount(h.selector("#zm_createlabelpopup"),!0)},afterDisplay:function(){h.focus(h.selector("input",h.selector("#zm_createlabelpopup")))}},q=w({selColor:r}),d=h.element(zdom("div",{id:"zm_createlabelpopup"},zdom("ul",{className:"tempFormList"},zdom("li",null,zdom("input",{type:"text",maxLength:"25",className:"SC_tiput","data-enableshortcuts":"true",placeholder:j.labels.tagName})),zdom("li",null,zdom("div",null,j.labels.tagColor),zdom("ul",{className:"SC_cp"},zdom("li",null)))))),h.mount(q,h.selector("ul.SC_cp li",d)),d.find("input").val(B),d.find(".SC_cp").on("click","div",function(a){var b;p(a,!0),b=a.target||a.srcElement,b=h.element(b),r=b.css("background-color"),r=i.convertRGBtoHex(r),h.selector("#zm_createlabelpopup").find(".sel").removeClass("sel black"),b.addClass("sel"),"#000000"===r&&b.addClass("black")}),h.selector("#zm_createlabelpopup").length||h.mount(d,document.body),"fr"===zmail.user.lang&&(c.style["max-width"]="200px"),A.create("zm_createlabelpopup",c),h.selector("#zmsdialog_zm_createlabelpopup").mousedown(function(a){p(a,!0)}),h.selector("#zmsdialog_zm_createlabelpopup").click(function(){o(!1,!0)})}};return i.createLabel=u,$.extend(!0,i,x)});