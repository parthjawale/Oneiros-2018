"use strict";window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupManageApp=function(a){return a}(zmStreamsApp.GroupManageApp||Zmail.App.extend({})),zmStreamsApp.GroupManageApp.ajaxReq=function(){var a={sync:function(a,b,c){c=c||{},c.type=c.type||"POST",c.url=_.result(b,"url"),c.data=b.serialized(a,c),c.setSessionId=c.setSessionId||!1;var d=c.xhr=this.ajax(c);return b.trigger("request",b,d,c),d},ajax:function(a){var b=a.url,c=(new Date).getTime(),d="get"===a.type.toLowerCase();d&&(b=b+(b.indexOf("?")+1?"&":"?")+"xhr="+c);var e=a.data,f={url:b,type:a.type||"POST"};return d||(f.contentType="application/json"),a.noStringify&&(f.data=e,f.contentType=!1,f.processData=!1,f.cache=!1),e&&!a.noStringify&&(f.data=JSON.stringify(e)),a.noStringify||(f.dataType="json"),a.header?f.headers={"X-ZCSRF-TOKEN":"zmrcsr="+zmAjq.getCookie("zmcsr")}:e.zmrcsr=zmAjq.getCookie("zmcsr"),a.setSessionId&&zmail.isWSEnabled&&zmail._ws&&zmail._ws.getSessionId()&&(f.headers||(f.headers={}),f.headers.sId=zmail._ws.getSessionId()),$.ajax(f)}};return a}(),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupManageApp=function(a){var b=zmText.get("streams"),c=a.models,d=a.views,e=zmStreamsApp.constants;a.template=zmStreamsApp.GroupManageApp.template,a.imageInput=void 0,a.domainList=void 0,a.isorgadmin=zmail.isAdmin,a.isMailHostingEnabled=void 0,a.groupCount=0,a.groupMode="",a.createMode="",a.fromApp="",a.createCallback="",a.closeWorkspace=!1,a.activeGroups=[],a.isOnboard=!1;var f={};a.groupPermission={};var g,h=zmStreamsApp.GroupManageApp.ajaxReq,i=!0,j=function(){a.fromApp="",a.createCallback="",a.closeWorkspace=!1,a.activeGroups=[],a.groupCount=0,a.groupMode="",a.createMode="",a.imageInput=void 0,f={},a.groupPermission={}},k=function(){var b=zmsuite.getCenter(e.groupWorkId)[0].getNodes();a.removeGroupViews(b[2].$el.find(".groupHolder").find("div.groupDom")),g&&g.dataProviders&&g.destroy(),$.publish(zmStreamsApp.constants.removeNotificationPreview,{element:zmsuite.getCenter(e.groupWorkId)[0].$el[0]}),j()},l=function(b,c){g=zmContactsAutoComplete.autoComplete({input:b[0],exclude:function(){var a=zmStreamsApp.GroupManageApp.getMembersAddress(c.find(".autoFilldata"));return a=a.length?a:[],a.push(zmail.zuid),a},contactType:"org",excludeGroups:!0,setDebounce:0,onSelect:function(d,e){d.stopPropagation();var f=e.item.attributes,g=a.template.autoFillData(f.zid),h=c.find(".autoFilldata");h.append($(g));var i=h.children().length;1===i&&(h.removeClass("SC_dyn"),zmStreamsApp.GroupManageApp.checkMembers(b,h)),$(b).val(""),$(g).find(".closePopup").unbind("click").bind("click",function(){$(this).parent(".dFill").remove(),h.children().length||(h.addClass("SC_dyn"),b.focus())}),b.focus()}})},m=function(a,b){var c=zmsuite.getCenter(e.groupWorkId)[0].$el;c&&(c=c.find(".groupHolder")),b=b?b:c;var f=new d.GroupManage({model:a});b.find("#addGroup").length&&b.html(f.$el),a.get("isOwner")?b.prepend(f.$el):b.append(f.$el)},n=function(a){var b;return a&&c.lists&&(b=_.find(c.lists.models,function(b){return String(b.id)===String(a)})),b},o=function(a,b){"string"==typeof b.group&&(b.group=$.parseJSON(b.group)),"string"==typeof b.shgroups&&(b.shgroups=$.parseJSON(b.shgroups)),b.group=b.group||{};var c=_.size(b.shgroups)?b.shgroups:[b.group];if(c&&_.size(c)){var d=e.notifications,f=b.ntype,g=!1,h=[d.mail_type,d.post_mention,d.unshared,d.invite,d.add_post,d.add_comment,d.comment_mention,d.add_task,d.post_group_mention,d.comment_group_mention,d.add_event,d.update_event,d.add_group_member,d.mail_share,d.add_attachment,d.change_task_due_date,d.change_task_assignee,d.change_task_status,d.change_task_priority,d.change_task_category,d.change_task_title,d.change_task_description,d.remove_attachment,d.draft_share,d.draft_shareupdate,d.draft_autosave,d.draft_mailmention,d.add_link],i=[d.add_comment,d.comment_group_mention,d.comment_mention];if(h.indexOf(f)!==-1&&b.nby!==zmail.zuid&&(g=!0),i.indexOf(f)!==-1&&b.nby!==zmail.zuid&&(g=!0),zmsuite.isWorkspaceAvailable(e.groupWorkId)&&g){var j,k;for(var l in c)k=c[l],j=n(k.id),j&&j.get("hidden")&&(j.set("lastActivityAt",(new Date).toString()),j.trigger("change:showActivity"))}}};"undefined"!=typeof zmComponent&&zmComponent.notifier&&zmComponent.notifier.addHandler("streams",o),$.subscribe("streams/removeGroupMember",function(b,c){var d=n(c.gid);if(d){var f=d.get("members"),g=d.get("moderators"),h=d.get("totalMembers"),i=[],j=[];_.each(f,function(a,b){a.id!==c.zid&&i.push(a)}),_.each(g,function(a,b){a.id!==c.zid&&j.push(a)}),d.set("members",i),d.set("moderators",j),h-=1,d.set("totalMembers",h),zmsuite.isWorkspaceAvailable(e.groupWorkId)&&a.groupMode&&d.trigger("change:memberList")}}),$.subscribe("streams/addGroupMember",function(b,c){var d=n(c.gid);if(d){var f=d.get("members"),g=d.get("totalMembers"),h=zmStreamsApp.util.getContactDetails([c.zid])[c.zid],i={emailAddress:h.eid,name:h.fn,id:h.zid};f.push(i),d.set("members",f),g+=1,d.set("totalMembers",g),zmsuite.isWorkspaceAvailable(e.groupWorkId)&&a.groupMode&&d.trigger("change:memberList")}}),$.subscribe("streams/addRemGroupSelf",function(a,b){var d;if(b.isAdd){var f=new c.listGroup({id:b.gid});h.sync("getGroupDetail",f).done(function(a){if(200===a.status.code){c.lists||(c.lists=new c.listGroupCollection);var b=a.data;f=c.lists.addModel(b),zmTab.currentTab===e.groupWorkId&&m(f)}})}else d=n(b.gid),d&&d.trigger("change:deleteGroup")}),$.subscribe("streams/changeMemberRole",function(b,c){var d=n(c.gid);if(d){var f=d.get("moderators"),g={},h=d.get("isOwner");if("addModerator"===c.mode){var i=zmStreamsApp.util.getContactDetails([c.zid])[c.zid];g={emailAddress:i.eid,name:i.fn,id:i.zid},f.push(g),d.set("moderators",f),c.zid===zmail.zuid&&(h=!0)}else g=[],_.each(f,function(a,b){a.id!==c.zid&&g.push(a)}),d.set("moderators",g),c.zid===zmail.zuid&&(h=!1);d.set("isOwner",h),zmsuite.isWorkspaceAvailable(e.groupWorkId)&&a.groupMode&&c.zid===zmail.zuid&&d.trigger("change:memberRole")}}),a.removeGroupViews=function(a){var b,c;_.each(a,function(a){b=$(a).data();var d=n(b.id);d&&(c=d.getView(b.groupviewid),c.onClose())})},a.triggerEditGroup=function(a,b){var e=n(a),f=b&&b.type?b.type:"gen",g=b&&b.callback?b.callback:"",i=function(){var a=new d.GroupManage({model:e,editGroup:!0,className:f,callback:g});return a};e?i():(e=new c.listGroup({id:a}),h.sync("getGroup",e).done(function(a){if(200===a.status.code){c.lists||(c.lists=new c.listGroupCollection);var b=a.data;e=c.lists.addModel(b),i()}}).fail(function(a){a&&a.status.description&&zmUtil.succErrMsg("e",a.status.description)}))},a.hideGroup=function(a){var d,e=function(a){d=a.get("hidden"),a.set("hidden",!d),h.sync("update",a).done(function(){zmStreamsApp.GroupManageApp.editGroupDetails(a),zmUtil.succErrMsg("s",zmText.applyArgs(b.groupSubscription.editGrp.hiddenMsg,{gName:a.get("name")})),$.publish("group/showHideGroup",{id:a.id,hidden:!d})}).fail(function(b){b.length&&(b=$.parseJSON(b)),zmUtil.succErrMsg("e",b.status.description),a.set("hidden",d)})},f=n(a);f?e(f):(f=new c.listGroup({id:a}),h.sync("getGroup",f).done(function(a){if(200===a.status.code){c.lists||(c.lists=new c.listGroupCollection);var b=a.data;f=c.lists.addModel(b),e(f)}}).fail(function(a){a&&a.status.description&&zmUtil.succErrMsg("e",a.status.description)}))};var p=function(a,b){for(var c=_.pluck(a,"id"),d=0,e=0;e<b.length;e++)for(var f=0;f<c.length;f++)b[e]===c[f]&&d++;return d===b.length},q=function(a,b){if(a.length<1)return!1;a.push(zmail.zuid);for(var c,d=[],e=[],f=0;f<b.length;f++)c=!1,d=b[f],d.members.length===a.length&&(c=p(d.members,a),c&&e.push(d));return e},r=function(d,f,j){if(i=!1,!$(d).hasClass("zs_snd")){var l,m,n,o=f.find(".groupClass"),p=f.find(".descClass"),q=f.find(".membersClass"),r=a.imageInput[0].files[0],s=f.find(".onoffToggle"),t="",u="",v="";if(l=zmStreamsApp.GroupManageApp.checkGroupName(o,c.lists.toJSON()),m=zmStreamsApp.GroupManageApp.checkMembers(q,j),n=zmStreamsApp.GroupManageApp.checkDescription(p),s.length&&!s.hasClass("sadiv")){t=f.find(".userName").val(),u=f.find(".domainList select").val();var w=zmUtil.hasXSSChars(t);if(""===t.trim()||""===u.trim()||w){var x="";return x=w?b.groupSubscription.errMsg.emailSplChar:b.groupSubscription.errMsg.validEmail,zmUtil.succErrMsg("e",x),void f.find(".userName").focus()}v=t+"@"+u}if(n&&l&&m){var y=zmStreamsApp.GroupManageApp.getMembersAddress(j),z=$.trim(o.val()),A=$.trim(p.val()),B={name:z,desc:A,mzuid:y};v&&""!==v&&(B.emailAddress=v),zmStreamsApp.util.sendRemove($(d),"",b.streams.common.creating+"...");var C=new c.listGroup(B);h.sync("createGroup",C).done(function(d){if(200===d.status.code){c.lists||(c.lists=new c.listGroupCollection);var j=d.data;if(C=c.lists.addModel(j),a.addGroupToContacts(C.toJSON()),zmTab.currentTab===e.groupWorkId&&(f.html(""),i=!0,g&&g.dataProviders&&g.destroy(),a.constructGroupView()),r){var l=C.get("photo");C.set("photo",r),h.sync("updateLogo",C).done(function(a){200===a.status.code&&(C.set("photo",a.data.photo),C.trigger("change:changepreview"))}).fail(function(a){C.set("photo",l),a&&(a=$.parseJSON(a)),a&&a.status.description?zmUtil.succErrMsg("e",a.status.description):zmUtil.succErrMsg("e",b.groupSubscription.errMsg.errLogoUpload)})}a.createCallback&&(a.createCallback(j.id),a.closeWorkspace&&(k(),zmsuite.closeWorkspace(e.groupWorkId)))}}).fail(function(a){zmStreamsApp.util.sendRemove($(d),!0,b.groupSubscription.creategrp);var c=b.groupSubscription.errMsg;if(a.responseText){a=$.parseJSON(a.responseText);var e=a.status.description;e.indexOf("G113")!==-1?zmUtil.succErrMsg("e",c.privilegeErr):e.indexOf("G119")!==-1?zmUtil.succErrMsg("e",c.maxGrpErr):zmUtil.succErrMsg("e",e)}else a&&(a=$.parseJSON(a),a&&a.status.description?zmUtil.succErrMsg("e",a.status.description):zmUtil.succErrMsg("e",c.errcreate))})}}},s=function(d){var e=d.find(".createButton"),f=d.find(".autoFilldata"),g=b.groupSubscription.createGrp;if(a.groupCount>1&&i){var h=zmStreamsApp.GroupManageApp.getMembersAddress(f),j=q(h,c.lists.toJSON());if(j.length){var k=["H2",{attrs:{"class":"cs_main_header SC_thm"},child:[["text",g.simGrpHeader]]}],l={ignoreMouseDown:!1,$content:$(_zm.getDOM(k)),defaultCloseIcon:!1,dialogDidMount:function(b){var c=$(b.$els.$content);if(c.append(a.template.getSimilarGroup(j)),j.length>5){$(b.$els.$positionWrapper).addClass("SC_PopTop");var d="40px";$(b.$els.$positionWrapper).css("top",d),c.css("max-height",.7*$(window).height())}c.find(".moreOpt").bind("click",function(){var b=c.find("ul.ulDom");b.html(""),a.template.constUlGroup(b,j,!0)})},buttons:[{name:b.groupSubscription.proceed,callback:function(a){r(e,d,f),a.remove()}},{name:b.common.labels.cancel,isCancel:!0,callback:function(a){a.remove()}}]};Dialog["new"](l)}else r(e,d,f)}else r(e,d,f)},t=function(a,b){var c=b.find(".autoFilldata");a.unbind("focusin").bind("focusin",function(){$(this).parent().addClass("flBoxF")}).unbind("focusout").bind("focusout",function(){zmStreamsApp.GroupManageApp.checkMembers($(this),c)}),l(a,b)},u=function(a){var b=a,c=$(b.find(".createButton"));$(b.find(".imgLogo")).attr("tabindex",10),$(b.find(".groupClass")).attr("tabindex",11),$(b.find(".membersClass")).attr("tabindex",12),$(b.find(".descClass")).attr("tabindex",13);var d=$(b.find(".toggleSel"));d.length&&d.attr("tabindex",13),c.attr("tabindex",14),d.unbind("keydown").bind("keydown",function(e){if(13===e.keyCode){var f=zmStreamsApp.GroupManageApp.validateIncludeEmail();if(f){var g=a.find(".emailBox");d.find(".onoffToggle").toggleClass("sadiv"),g.toggle(),g.is(":visible")?(b.find(".userName").attr("tabindex",14),b.find(".domainList select").attr("tabindex",15),c.attr("tabindex",16),b.find(".userName").focus()):c.attr("tabindex",14)}}}),$(c).unbind("keydown").bind("keydown",function(a){9===a.keyCode?($(b.find(".imgLogo")).focus(),a.preventDefault()):13===a.keyCode&&s(b)})},v=function(b){var c=a.imageInput[0].files[0],d=new FileReader;_zm.bind(d,"loadend",function(c){b.removeClass().addClass("SC_avtr imgLogo");var d=a.template.addImageDiv();b.html(_zm.getDOM(d)),b.find(".logoImg")[0].src=c.result,b.append(_zm.getDOM(a.template.editImageDiv()))},[d]),d.readAsDataURL(c)},w=function(c,d,e){var f=zmStreamsApp.GroupManageApp.checkLogo(a.imageInput);"success"===f.type?e?(_zm.succErrMsg("s",b.groupSubscription.editGrp.uploading),e(a.imageInput[0].files[0]).done(function(a){a||(_zm.succErrMsg("s",b.groupSubscription.editGrp.uploaded),v(c))})):v(c):_zm.succErrMsg("e",f.message)},x=function(b,c,d){a.imageInput.change(function(){$(this).val()&&w(b,c,d)})};a.bindGroupLogo=function(b,c){var d=b.find(".imgLogo");a.imageInput=$(a.template.groupLogo()),$(d).unbind("click").bind("click",function(){a.imageInput.click()}),$(d).unbind("keydown").bind("keydown",function(b){13===b.keyCode&&a.imageInput.click()}),x(d,b.find(".logoImg"),c)};var y=function(b,d){b.unbind("focusin").bind("focusin",function(){$(this).parent().addClass("flBoxF")}).unbind("focusout").bind("focusout",function(){var b=zmStreamsApp.GroupManageApp.checkGroupName($(this),c.lists.toJSON());if(b&&!d.find(".logoImg")[0].src){var e=d.find(".SC_avtr"),f=$(this).val(),g=_zm.getDOM(zmStreamsApp.util.generateAvatarTemp(f));$(g).addClass("imgLogo"),$(e[0]).before(g),$(e[0]).remove();var h=a.template.addImageDiv();$(g).append(_zm.getDOM(h)),$(g).append(_zm.getDOM(a.template.editImageDiv())),a.bindGroupLogo(d),u(d)}var i=d.find(".userName");if(i.length&&""===i.val()){var j=$.trim($(this).val());j=j.replace(/ /gi,"_"),i.val(j),i.parent().removeClass("flVR vrFail")}})},z=function(a){a.unbind("focusin").bind("focusin",function(){$(this).parent().addClass("flBoxF")}).unbind("focusout").bind("focusout",function(){zmStreamsApp.GroupManageApp.checkDescription($(this))})},A=function(c){y(c.find(".groupClass"),c),z(c.find(".descClass")),t(c.find(".membersClass"),c),a.bindGroupLogo(c),u(c),c.find(".groupClass").focus();var d=$(c.find(".emailEn"));if(d.length){var e=d.find(".emailTip");if(e.length){var f=b.groupSubscription.createGrp.inclHelp;zmComponent.tooltip({elm:e[0],text:f,arrow:"top"})}}c.find(".createButton").unbind("click").bind("click",function(){s(c)}),c.find(".toggleSel").unbind("click").bind("click",function(){$(this).find(".onoffToggle").toggleClass("sadiv");var a=c.find(".emailBox");a.toggle(),a.is(":visible")?(c.find(".userName").attr("tabindex",14),c.find(".domainList select").attr("tabindex",15),c.find(".createButton").attr("tabindex",16),c.find(".userName").focus()):c.find(".createButton").attr("tabindex",14)}),c.find(".userName").unbind("focusin").bind("focusin",function(){$(this).parent().addClass("flBoxF")}).unbind("focusout").bind("focusout",function(){$(this).parent().removeClass("flBoxF");var a=$.trim($(this).val()),b=zmUtil.hasXSSChars(a);!a||b?$(this).parent().addClass("flVR vrFail"):$(this).parent().removeClass("flVR vrFail")})},B=function(a,b){var c=$(a).width(),d=a.find(".zmMSL")[0],e=$(d).width()+40,f=c-e*b;f>0&&f>e?a.addClass("zmMSboxL"):a.removeClass("zmMSboxL")},C=function(c){var d=zmsuite.getCenter(e.groupWorkId)[0].$el,f=d.find(".groupHolder");if(a.groupCount=c.length,a.groupCount){f.html("");var g,h,i=[],j=[],k=[];for(c.each(function(a){h=a.get("isOwner"),h&&a.get("streamsEnabled")?i.push(a):h?j.push(a):k.push(a)}),g=0;g<k.length;g++)m(k[g],f);for(g=0;g<j.length;g++)m(j[g],f);for(g=0;g<i.length;g++)m(i[g],f);B(f,a.groupCount)}else{f.html(""),f.removeClass("zmMSboxL");var l=a.groupPermission;if(!_.size(l)||l.Org||l.personal){var n=$("<a>").attr({href:"#",id:"addGroup"}).text(b.groupSubscription.creategrp),o=$("<span>").text(b.groupSubscription.grpNtAvl+". ");f.append(o).append(n),$("#addGroup").click(function(){a.constructCreateView()})}else{var p=$("<span>").text(b.groupSubscription.errMsg.privilegeErr);f.append(p)}}var q=a.groupCount?a.groupCount:b.groupSubscription.no;d.find(".groupCount").text(q+" "+b.groupSubscription.grp)},D=function(a){var d=b.groupSubscription.managegrp,f=zmsuite.getCenter(e.groupWorkId)[0].getNodes();f[1].$el.html(""),f[1].$el.append('<div class="SC_flt setTitle"><span class="SC_mtb">'+d+"</span></div>");var g=_zm.getDOM(["SPAN",{attrs:{"class":"sum SC_folFil SC_dyn groupView"},child:[["text",""],["I",{attrs:{"class":"msi-close closeView"}}]]}]),h=_zm.getDOM(["SPAN",{attrs:{"class":"sum unreadText groupCount"},child:[["text",""]]}]);f[1].$el.find(".SC_mtb").append($(h)).append($(g)),f[1].$el.find(".closeView").unbind("click").bind("click",function(){f[1].$el.find(".groupView").addClass("SC_dyn");var a=f[2].$el.find(".groupHolder");a.children().remove();var b=c.lists;C(b)}),a?f[1].$el.parent().addClass("zm_grpMgmt"):f[1].$el.parent().removeClass("zm_grpMgmt")},E=function(){var c,d=zmsuite.getCenter(e.groupWorkId)[0].getNodes();if(d[0].$el.find(".SC_flt").html(""),a.groupMode){var f=a.groupPermission,g=_.size(f)&&!(f.Org||f.personal),h=g?[]:zdom("li",{className:"SC_lbr addGroup","data-tooltip":b.groupSubscription.addgrp,"data-tooltip-pos":"bottom"},zdom("b",null,zdom("div",{className:"SC_hd"}),zdom("span",null,zdom("i",{className:"msi-plus"})))),i=b.groupSubscription.view;c=zdom("ul",null,zdom("li",{className:"SCtxt"},zdom("b",{className:"grpDrop"},zdom("div",{className:"SC_hd"}),zdom("span",{className:"gname"},b.streams.common.all,zdom("i",{className:"msi-barrow"})))),zdom("li",{className:"SC_lbr"},zdom("b",{className:"dropFilter"},zdom("div",{className:"SC_hd"}),zdom("span",null,zdom("i",{className:"msi-filter","data-tooltip":i,"data-tooltip-pos":"bottom"})))),h),d[0].$el.find(".SC_flt").append(c),d[0].$el.find(".gname").data("id","All")}else a.createMode&&(c=zdom("ul",null,zdom("li",{className:"viewGroup SC_thm SCtxt"},zdom("b",null,zdom("div",{className:"SC_hd"}),zdom("span",{className:"SC_thm"},zdom("i",{className:"msi-goback"}),zdom("span",null,b.groupSubscription.viewGrp))))),d[0].$el.find(".SC_flt").append(c))},F=function(a){var b,c,d,e=[],f=a.length;for(c=0;c<f;c++)d=a[c].txt,b=d?["LI",{attrs:{"data-item":a[c].data},child:[["text",a[c].txt]]}]:["LI",{attrs:{"class":"SC_lne"}}],e.push(_zm.getDOM(b));return e},G=function(d){if(_.size(d)){var f,g=zmsuite.getCenter(e.groupWorkId)[0].$el,h=g.find(".groupHolder");h.children().remove();var i,j,k=c.lists,l=[];if("all"===d.item)C(k),g.find(".groupView").addClass("SC_dyn");else{if("disabled"===d.item?(_.each(k.models,function(b){b&&b.get("streamsEnabled")===!1&&(f=b.get("id"),a.activeGroups.indexOf(f)!==-1&&l.push(b))}),j=b.groupSubscription.stDisGrp):"enabled"===d.item?(_.each(k.models,function(a){a&&a.get("streamsEnabled")===!0&&l.push(a)}),j=b.groupSubscription.stEnGrp):"personal"===d.item?(_.each(k.models,function(a){a&&a.get("organizationGroup")===!1&&l.push(a)}),j=b.groupSubscription.stperGrp):"org"===d.item?(_.each(k.models,function(a){a&&a.get("organizationGroup")===!0&&l.push(a)}),j=b.groupSubscription.storgGrp):"mod"===d.item?(_.each(k.models,function(a){a&&a.get("isOwner")&&l.push(a)}),j=b.groupSubscription.modMsg):"mem"===d.item?(_.each(k.models,function(a){a&&!a.get("isOwner")&&l.push(a)}),j=b.groupSubscription.memMsg):"hidden"===d.item&&(_.each(k.models,function(a){a&&a.get("hidden")&&l.push(a)}),j=b.groupSubscription.hiddenGrp),l.length){for(var o=0;o<l.length;o++)i=n(l[o].id),m(i,h);B(h,l.length)}else $(h).html(zmInit.emptyRow(b.groupSubscription.nogrp)),h.removeClass("zmMSboxL");g.find(".groupView").removeClass("SC_dyn"),g.find(".groupView")[0].childNodes[0].textContent=j;var p=l.length?l.length:b.groupSubscription.no;g.find(".groupCount").text(p+" "+b.groupSubscription.grp)}}},H=function(){var d=zmsuite.getCenter(e.groupWorkId)[0].$el;a.createMode?$(d).find(".viewGroup").unbind("click").bind("click",function(){a.constructGroupView()}):a.groupMode&&($(d).find(".grpDrop").unbind("click").bind("click",function(){var f=c.lists,g=f.toJSON(),h=$(this),i=[];"All"!==h.find(".gname").data("id")&&i.push({id:"All",name:b.streams.common.all,photo:zmStreamsApp.util.defaultGroupPhotoUrl()}),_.each(g,function(a){a&&a.id!==h.find(".gname").data("id")&&i.push(a)}),zmStreamsApp.util.showGroupDetails({groupInfo:i,elm:h,fn:function(c){var e=d.find(".groupHolder");h.find(".gname")[0].textContent=c.name,h.find(".gname").data("id",c.id),e.children().remove();var g;if("All"===c.id)C(f),$(d).find(".dropFilter").parent().show(),g=a.groupCount?a.groupCount:b.groupSubscription.no,g=g+" "+b.groupSubscription.grp;else{var i=n(c.id);m(i,e),B(e,1),$(d).find(".dropFilter").parent().hide(),d.find(".groupView").addClass("SC_dyn"),g="1 "+b.groupSubscription.grpSingular}d.find(".groupCount").text(g),zmUtil.hideMenu()},showUnread:!1,viewDOM:zmsuite.getCenter(e.groupWorkId)[0].$el[0]})}),$(d).find(".addGroup").unbind("click").bind("click",function(){a.constructCreateView()}),$(d).find(".dropFilter").unbind("click").bind("click",function(a){$(a.currentTarget).parent().addClass("show");var c=[];c.push({txt:b.streams.common.all,data:"all"}),c.push({txt:""}),c.push({txt:b.groupSubscription.modGrp,data:"mod"}),c.push({txt:b.groupSubscription.otherGrp,data:"mem"}),c.push({txt:""}),c.push({txt:b.groupSubscription.disGrp,data:"disabled"}),c.push({txt:b.groupSubscription.enGrp,data:"enabled"}),c.push({txt:""}),c.push({txt:b.groupSubscription.perGrp,data:"personal"}),c.push({txt:b.groupSubscription.orgGrp,data:"org"}),c.push({txt:""}),c.push({txt:b.groupSubscription.hiddenGrp,data:"hidden"});var d=F(c),e={liDom:d,par:$(a.currentTarget),spanClass:"SC_Sopt",showArrow:!1,avoidScroll:!0,align:"pleft",onHide:function(){$(a.currentTarget).parent().removeClass("show")},clk:function(a,b,c){G(a),zmUtil.hideMenu()}};zmStreamsApp.util.showDropdown(e,a.currentTarget)}))},I=function(a){var c=!1,d={appname:b.groupSubscription.managegrp,appId:e.groupWorkId,data:{CNodes:"3"},appIcon:"msi-manageGroup",faqKey:"Streams",onDelete:function(){return k(),!0},hashKey:"groups",hashChangeHandler:function(a){var b=this;zmUtil.debugLog("groups management hash url changed",a,b)}};if(zmsuite.isWorkspaceAvailable(e.groupWorkId))a.isRestore&&zmsuite.isWorkspaceAvailable(e.groupWorkId)&&(zmsuite.resetWorkspace(e.groupWorkId,d),c=!0);else{var f=zmsuite.setWorkSpace(d);if(!f)return{maxTab:!0};c=!0}return c&&(D(a.groupManage),zmsuite.renderWorkSpace(),$.publish("zmail/SaveTabState",[{appId:e.groupWorkId,app:"groups",appObj:{appId:e.groupWorkId,appname:b.groupSubscription.managegrp,data:{},appIcon:"msi-manageGroup"},category:"group_app"}])),zmsuite.showWorkSpace(e.groupWorkId),c};a.getAllOrgGroups=function(b){var d,e,f=$.Deferred();return c.lists||(c.lists=new c.listGroupCollection),d=c.lists,b&&_.size(d)&&f.resolve(),a.isRequestProgress||(a.isRequestProgress=!0,a.isRequestComplete=!1,h.sync("getAllGroups",d).done(function(b){if(a.isRequestProgress=!1,a.isRequestComplete=!0,b.data){b=b.data,e=b.groups,a.groupCount=e.length||0;for(var g=0;g<e.length;g++)d=d||c.listCol,d.addModel(e[g])}f.resolve()}).error(function(b){a.isRequestProgress=!1,a.isRequestComplete=!0,f.resolve("error")})),f.promise()};var J=function(c){for(var d,e,f=c[2].$el,g=c[0].$el,h=f.find(".groupDom"),i=$(f.find(".groupDom")[0]),j=!1,k=0;k<h.length;k++)if(d=$(h[k]).data("id"),e=n(d),e&&e.get("isOwner")&&!e.get("streamsEnabled")){i=$(h[k]),j=!0;break}if(h.length&&j){i[0].scrollIntoView();var l=b.groupSubscription.onboarding,m=[{featureElement:i.find(".streamState"),content:l.enContent,title:l.enHeader},{featureElement:g.find(".addGroup"),content:l.createContent,title:l.createHeader}],o=[{targetElement:i.find(".streamState"),slides:m,autoTrigger:"click"}],p={actionPoints:o,hideActionPoint:!0,onend:function(){zmAdHocSettings.setStreamsGroupMgmt("1"),a.isOnboard=!1}};zmUtil.loadAppTour(p)}};a.constructGroupView=function(b,d){a.groupMode=!0,a.createMode=!1,D(!0);var f=zmsuite.getCenter(e.groupWorkId)[0].getNodes(),g=f[2].$el.find(".createGroup"),h=f[2].$el.find(".groupHolder");g.addClass("SC_dyn"),h.removeClass("SC_dyn");var i=c.lists;$(f[2].$el).off("scroll").on("scroll",function(){zmStreamsApp.util.hideMenu(!0)}),E(),H(),a.isRequestComplete&&(b&&b(),d?G({item:d}):C(i)),a.isOnboard&&"0"===zmAdHocSettings.getStreamsGroupMgmt()&&J(f)};var K=function(){var a=zmail.superAdmin,b=!a;return!(!b||!zmail.isAdmin)};a.constructCreateView=function(b){var c=a.isCreateAvailable();if(c){D(),a.groupMode=!1,a.createMode=!0;var d=zmsuite.getCenter(e.groupWorkId)[0].getNodes(),f=d[2].$el.find(".createGroup"),g=d[2].$el.find(".groupHolder");if(g.addClass("SC_dyn"),f.removeClass("SC_dyn"),f.children().length)f.find(".groupClass").focus();else{var h=a.template.createGroup();f.append($(h)),A(f)}(!b||b&&!b.noHeader)&&(E(),H())}};var L=function(){var b=$.Deferred();if(a.isorgadmin&&!a.domainList){c.lists||(c.lists=new c.listGroupCollection);var d=c.lists;h.sync("getDomainList",d).done(function(c){a.domainList=c.data.domainVO;for(var d,e=a.domainList.length,f=0,g=0;g<e;g++)d=a.domainList[g],d.mailHostingEnabled||f++;f===e?a.isMailHostingEnabled=!1:a.isMailHostingEnabled=!0,b.resolve()}).error(function(c){401===c.status||200===c.status?(a.domainList=[],b.resolve()):b.resolve("error")})}else b.resolve();return b.promise()},M=function(){return new Promise(function(a,b){if(_.size(f))a();else{c.lists||(c.lists=new c.listGroupCollection);var d=c.lists;h.sync("isCreateAllowed",d).done(function(b){if(200===b.status.code){var c=b.data;f=_zm.copyOf(c)}a()}).error(function(){f={},a()})}})};a.isCreateAvailable=function(c){var d=a.groupPermission;return!(_.size(d)&&!d.Org&&!d.personal)||(c||zmUtil.succErrMsg("e",b.groupSubscription.errMsg.privilegeErr),!1)};var N=function(){var b=!1,c=K();if(a.isorgadmin){var d=f.organizationGroupCreation;switch(d){case"SUPER_ADMIN":c&&(b=!0);break;case"ADMIN":zmail.isAdmin&&(b=!0);break;case"MEMBERS":b=!0;break;default:b=!1}a.groupPermission.Org=b}var e=f.personalGroupCreation;switch(b=!1,e){case"SUPER_ADMIN":c&&(b=!0);break;case"ADMIN":zmail.isAdmin&&(b=!0);break;case"MEMBERS":b=!0;break;default:b=!1}a.groupPermission.personal=b};return a.init=function(d){M().then(function(){var f;N(),a.isOnboard=d.isOnboard,_.size(zmail.ContactBook.getGroups())||(a.isOnboard=!0);var g=a.isCreateAvailable(!d.createGroup);if(!d.createGroup||g){var h=I(d);if(!h.maxTab){a.isorgadmin=zmail.isAdmin,f=zmsuite.getCenter(e.groupWorkId)[0].getNodes();var i,j;h&&(f[2].$el.append('<div class="zmMSWra zmMSbox groupHolder"></div>'),f[2].$el.append('<div class="zmMSgCreWra createGroup"></div>')),a.closeWorkspace=d.closeWorkspace,a.createCallback=d.createCallback,a.activeGroups=_.pluck(zmail.ContactBook.getGroups(),"id"),a.fromApp=d.app;var k=f[2].$el.find(".createGroup"),l=f[2].$el.find(".groupHolder"),m=k.children(),n=l.find(".groupDom"),o=d.groupManage===a.groupMode,p=d.createGroup===a.createMode;if(!h&&m.length&&p||n.length&&o)return void(o?d.view&&(D(!0),E(),H(),G({item:d.view})):k.find(".groupClass").focus());if(!h&&n.length&&d.groupManage&&a.createMode)return k.addClass("SC_dyn"),l.removeClass("SC_dyn"),a.groupMode=!0,a.createMode=!1,D(!0),E(),H(),void G(d.view?{item:d.view}:{item:"all"});if(!h&&m.length&&d.createGroup&&a.groupMode)return k.removeClass("SC_dyn"),l.addClass("SC_dyn"),a.groupMode=!1,a.createMode=!0,D(),(!d||d&&!d.noHeader)&&(E(),H()),void k.find(".groupClass").focus();d.groupManage?(a.groupMode=!0,a.createMode=!1,a.removeGroupViews(l.find(".groupDom")),l.html(""),k.addClass("SC_dyn"),l.removeClass("SC_dyn")):d.createGroup&&(a.groupMode=!1,a.createMode=!0,k.removeClass("SC_dyn"),l.addClass("SC_dyn"),a.isorgadmin&&(j=zmComponent.loadingBand({container:k[0],type:"pagination"}))),a.isRequestProgress||(i=zmComponent.loadingBand({container:l[0],type:"pagination"})),L().done(function(c){j&&j(),a.createMode&&(c&&_zm.succErrMsg("e",b.groupSubscription.errMsg.err_fetchdomain),a.constructCreateView(d))}),(h||a.groupMode)&&a.getAllOrgGroups(a.createMode).done(function(e){if(e){zmUtil.debugLog(b.groupSubscription.errMsg.errgrp),a.groupMode&&_zm.succErrMsg("e",b.groupSubscription.grpLoadErr),i&&i(),l.html(""),d.groupManage&&f[1].$el.parent().addClass("zm_grpMgmt"),l.removeClass("zmMSboxL");var h=$("<span>").text(b.groupSubscription.grpNtAvl+". ");l.append(h)}else if(!d.isOnboard||d.groupManage||d.createGroup)a.groupMode&&a.constructGroupView(i,d.view,d.isOnboard);else{for(var j=c.lists.toJSON(),k=_.pluck(j,"isOwner"),m=!1,n=0;n<k.length;n++)if(k[n]){m=!0;break}j.length&&m||!g?a.constructGroupView(i,d.view,d.isOnboard):(i&&i(),a.constructCreateView(d))}})}}})},a.getMembers=function(a){var c=n(a),d=$.Deferred();return c?h.sync("getMembers",c).done(function(a){var b;200===a.status.code?c.set("members",a.data.members):zmUtil.succErrMsg("e",a.status.description),b=_.pluck(c.get("members"),"id"),d.resolve(b)}).fail(function(){zmUtil.succErrMsg("e",b.groupSubscription.editGrp.errMemFetch),d.resolve("error")}):d.resolve(),d.promise()},a.changeToContacts=function(a){var b,c=[],d=[];c=_.pluck(a.members,"id"),d=_.pluck(a.moderators,"id"),a.createdBy&&(b=a.createdBy.id);var e=a.mailDeliveryEnabled?a.emailAddress:"",f={name:a.name,desc:a.description,photo:a.photo,members:c,moderator:d,isOwner:a.isOwner,owner:b,eid:e,id:a.id,disabled:!a.streamsEnabled,isFav:a.favourite,totalMembers:a.totalMembers};return f},a.getGroupAppModel=function(a){var b=n(a);return b},a.addGroupToContacts=function(b){var c=a.changeToContacts(b);zmStreamsApp.util.addGroup(c)},a.editGroupDetails=function(a){var b=_zm.copyOf(a.changed),c=a.get("id");b.hasOwnProperty("streamsEnabled")&&(b.disabled=!b.streamsEnabled,delete b.streamsEnabled),b.hasOwnProperty("mailDeliveryEnabled")&&(b.eid=b.mailDeliveryEnabled?a.get("emailAddress"):"",b.hasOwnProperty("emailAddress")&&delete b.emailAddress,delete b.mailDeliveryEnabled),zmStreamsApp.util.editGroup(c,b)},a.isGroupMember=function(a,b){var c=n(b);if(c){var d=_.pluck(c.get("members"),"id");return d.indexOf(a)!==-1}return!1},a.getGroup=function(b){var d={};if(b){var e=n(b);e&&(e=e.toJSON(),d=a.changeToContacts(e))}else for(var f,g=c.lists.toJSON(),h=0;h<g.length;h++)f=g[h],d[f.id]=a.changeToContacts(f);return d},a}(zmStreamsApp.GroupManageApp||Zmail.App.extend({})),zmStreamsApp.GroupManageApp.template=function(){var a=zmText.get("streams"),b={};return b.addImageDiv=function(a){var b="";return b=a?"opacity:0":"visibility:hidden",["IMG",{attrs:{"class":"logoImg",style:b}}]},b.groupLogo=function(){return _zm.getDOM(["INPUT",{attrs:{type:"file",accept:"image/*"}}])},b.editImageDiv=function(){return["SPAN",{attrs:{"class":"zm_editImg updateLogo"},child:[["text",a.groupSubscription.createGrp.editImg]]}]},b.autoFillData=function(a){var b,c=zmStreamsApp.util.getContactDetails([a])[a],d=["DIV",{attrs:{"class":"zmMSgMbr dFill","data-zid":String(a)},child:[["text",c.fn],["I",{attrs:{"class":"msi-close closePopup"}}]]}];b=c&&c.avatar?c.avatar:_zm.getDOM(zmStreamsApp.util.generateAvatarTemp(c.fn));var e=_zm.getDOM(d);return $(e).prepend(b),e},b.showNewActivity=function(){return _zm.getDOM(["SPAN",{attrs:{"class":"SC_notify notify",style:""}}])},b.createGroup=function(){var c=a.groupSubscription.createGrp,d=b.addImageDiv(!0),e=b.editImageDiv(),f=[],g=[],h=zmStreamsApp.GroupManageApp.groupPermission.Org;h&&zmStreamsApp.GroupManageApp.isMailHostingEnabled&&(f=["DIV",{attrs:{"class":"zmMSgMail emailEn"},child:[["DIV",{attrs:{"class":"zmMSgSel",id:"zmMSgSel inclMail"},child:[["LABEL",{child:[["text",c.inclEmail],["SPAN",{attrs:{"class":"msi-info tooltip emailTip"},child:[["text","i"]]}]]}],["DIV",{attrs:{"class":"onoffButton toggleSel",style:"background-color: transparent !important;"},child:[["DIV",{attrs:{"data-on":c.yes,"data-off":c.no,"class":"sdiv sadiv onoffToggle curToggle"}}]]}]]}]]}],g=b.createEmailBox("",!0),$(g).hide());var i=["DIV",{attrs:{"class":"zmMSgCre"},child:[["DIV",{attrs:{"class":"zmMSgCIWra"},child:[["DIV",{attrs:{"class":"SCS_head"},child:[["DIV",{attrs:{"class":"SC_avtr imgLogo"},child:[["DIV",{attrs:{"class":"zmMSgCimg show"},child:[["I",{attrs:{"class":"msi-attimg"}}]]}],e,d]}],["H3",{child:[["text",c.headerName]]}],["P",{child:[["text",c.headerContent]]}]]}],["DIV",{attrs:{"class":"SC_floatLabel flFLabel flBox"},child:[["INPUT",{attrs:{"class":"groupClass",type:"text",placeholder:c.namePlh}}],["LABEL",{child:[["text",c.grpName],["SPAN",{attrs:{"class":"spanMsg"},child:[["text",""]]}]]
}]]}],["DIV",{attrs:{"class":"SC_floatLabel flFLabel flBox"},child:[["INPUT",{attrs:{"class":"membersClass",type:"text",placeholder:c.memPlh}}],["DIV",{attrs:{"class":"zmMSgMbrWra autoFilldata SC_dyn"}}],["LABEL",{child:[["text",c.addMem],["SPAN",{attrs:{"class":"spanMsg"},child:[["text",""]]}]]}]]}],["DIV",{attrs:{"class":"SC_floatLabel flFLabel flBox"},child:[["TEXTAREA",{attrs:{"class":"descClass",placeholder:c.descPlh}}],["LABEL",{child:[["text",c.grpDesc],["SPAN",{attrs:{"class":"spanMsg"},child:[["text",""]]}]]}]]}],f,g,["DIV",{attrs:{"class":"SC_PUbtm SC_rTxt"},child:[["SPAN",{attrs:{"class":"createButton"},child:[["text",c.createBtn]]}]]}]]}]]}];return _zm.getDOM(i)},b.constUlGroup=function(b,c,d){for(var e,f=0;f<c.length;f++){if(f>5&&!d){e=["LI",{attrs:{"class":"SC_more"},child:[["SPAN",{attrs:{"class":"SC_lnk moreOpt"},child:[["text",a.common.labels.seeMore]]}]]}],b.append(_zm.getDOM(e));break}e=["LI",{child:[["DIV",{child:[["text",c[f].name]]}],["IMG",{attrs:{src:c[f].photo}}]]}],b.append(_zm.getDOM(e))}},b.getSimilarGroup=function(c){var d=["DIV",{attrs:{"class":"SC_grpLst"},child:[["P",{child:[["text",a.groupSubscription.createGrp.simGrpCont]]}],["UL",{attrs:{"class":"SC_Pr SC_PLst ulDom"},child:[]}]]}];d=_zm.getDOM(d);var e=$(d).find("ul.ulDom");return b.constUlGroup(e,c),d},b.generateImage=function(a){var c,d=zmStreamsApp.util.getGroupDetails(a.id);return c=d&&d.avatar?d.avatar:_zm.getDOM(zmStreamsApp.util.generateAvatarTemp(a.name)),$(c).addClass("imgLogo"),a.isOwner&&(c.appendChild(_zm.getDOM(b.addImageDiv())),c.appendChild(_zm.getDOM(b.editImageDiv()))),c},b.constUrlLink=function(b){var c=[];return b.emailAddress&&(c=["SPAN",{attrs:{"class":"SC_lnk opLink SC_frt"},child:[["text",a.groupSubscription.mreSetting]]}]),_zm.getDOM(c)},b.editGroupProfile=function(c){var d=a.groupSubscription,e=_zm.getDOM(["DIV",{attrs:{"class":"zmMSgEdt zmMSgCre"}}]),f=["DIV",{attrs:{"class":"SCS_head headerGroupElm zmRgtAvtr"},child:[["DIV",{attrs:{"class":"zmMSgCtit"},child:[["LABEL",{child:[["text",d.editGrp.grpName+" "]]}],["SPAN",{attrs:{"class":"zm_msgCont SC_dyn"},child:[["SMALL",{attrs:{"class":" messgName msgTxt "},child:[["text",""]]}]]}],["H3",{attrs:{contenteditable:"false"},child:[["SPAN",{attrs:{"class":"edtitle","data-plhr":d.createGrp.namePlh},child:[["text",c.name]]}],["SMALL",{attrs:{"class":"zm_editLnk editName SC_lnk"},child:[["text",d.editGrp.edit]]}]]}]]}]]}],g=["DIV",{attrs:{"class":"SCS_head SC_np descElm"},child:[["DIV",{attrs:{"class":"zmMSgCdesc"},child:[["LABEL",{child:[["text",d.editGrp.grpDesc+" "]]}],["SPAN",{attrs:{"class":"zm_msgCont SC_dyn"},child:[["SMALL",{attrs:{"class":" msgTxt messgDesc"},child:[["text",""]]}]]}],["P",{child:[["SPAN",{attrs:{"class":"edcont","data-plhr":d.editGrp.descPlh},child:[["text",c.description]]}],["SMALL",{attrs:{"class":"zm_editLnk editDesc SC_lnk"},child:[["text",d.editGrp.edit]]}]]}]]}]]}],h=c.mailDeliveryEnabled&&c.streamsEnabled?"sel":"",i=c.streamsEnabled?"sel":"",j=c.streamsEnabled?"":"disable",k=Boolean(c.emailAddress||zmStreamsApp.GroupManageApp.isorgadmin),l=c.organizationGroup&&k?["DIV",{attrs:{"class":"zmMSgSel emailEn "+h+" "+j},child:[["I",{attrs:{"class":"msi-check emailEnabled"}}],["LABEL",{attrs:{"class":"emailEnabled"},child:[["text",d.editGrp.inclEmail]]}],["SPAN",{attrs:{"class":"msi-info tooltip emailTip"},child:[["text","i"]]}]]}]:[],m=["DIV",{attrs:{"class":"zmMSgMail"},child:[["DIV",{attrs:{"class":"zmMSgSel "+i},child:[["I",{attrs:{"class":"msi-check streamEn"}}],["LABEL",{attrs:{"class":"streamEn"},child:[["text",d.enState]]}]]}],l]}],n=_.pluck(c.createdBy,"id"),o=c.organizationGroup&&(n.indexOf(zmail.zuid)!==-1||zmStreamsApp.GroupManageApp.isorgadmin)||!c.organizationGroup&&c.isOwner,p=o?["DIV",{attrs:{"class":"zm_grpAction zm_CA"},child:[["DIV",{attrs:{"class":"zm_CATxt"},child:[["DIV",{attrs:{"class":"zm_CATitle"},child:[["text",d.editGrp.deleteHeader]]}],["P",{child:[["text",d.editGrp.deleteContent]]}]]}],["DIV",{attrs:{"class":"zm_CABtn"},child:[["SPAN",{attrs:{"class":"SC_thmBBtn SC_lnk deleteButton"},child:[["text",d.editGrp.deleteButton]]}]]}]]}]:[];e.appendChild(_zm.getDOM(f)),e.appendChild(_zm.getDOM(g)),e.appendChild(_zm.getDOM(m)),e.appendChild(_zm.getDOM(p));var q=b.generateImage(c);return $(e).find(".headerGroupElm").prepend($(q)),e},b.constructMemberDOM=function(a,b){var c,d,e,f=a.members,g=_.size(f)?["DIV",{attrs:{"class":"zmMSgMem viewMembers"}}]:[];g=_zm.getDOM(g);for(var h=!1,i=0,j=0;j<f.length;j++){if(i>3){var k="+"+(a.totalMembers-4);k=zmStreamsApp.util.generateAvatarTemp(k,!0,!0),e=_zm.getDOM(k),g.appendChild(e),h=!0,$(e).addClass("memImg SC_thmCount"),a.isOwner?$(e).addClass("isAdd"):$(e).addClass("isView");break}c=f[j].id,d=zmStreamsApp.util.getContactDetails([c])[c],d.isDummyObj||(e=d.avatar?d.avatar:_zm.getDOM(zmStreamsApp.util.generateAvatarTemp(d.fn)),g.appendChild(e),$(e).attr("name",d.fn),$(e).addClass("memImg"),i++)}!h&&a.isOwner&&(e=_zm.getDOM(["I",{attrs:{"class":"msi-plus borderPlus"}}]),g.appendChild(e),$(e).addClass("isAdd"),$(e).addClass("memImg")),$(b).find(".infoRole").after(g)},b.constructActions=function(b){var c=a.groupSubscription,d=b.isOwner?"":"disable",e=b.streamsEnabled,f=e?"sel":"",g=b.isOwner?["I",{attrs:{"class":"msi-check "}}]:[],h=!b.isOwner&&e?c.enState:c.disState;h=b.isOwner?c.enState:h;var i=["DIV",{attrs:{"class":"zmMSgAct "+d+" "+f},child:[["SPAN",{attrs:{"class":"streamState"},child:[g,["text",h]]}]]}];return i},b.createEmailBox=function(b,c){for(var d,e=zmStreamsApp.GroupManageApp.domainList,f=[],g=c?[]:["DIV",{attrs:{"class":"SC_hypBtn"},child:[["SPAN",{attrs:{"class":"SC_green SC_lnk saveEmail"},child:[["text",a.streams.common.create]]}],["SPAN",{attrs:{"class":"SC_gray SC_lnk cancelEmail"},child:[["text",a.streams.common.cancel]]}]]}],h=0;h<e.length;h++)e[h].mailHostingEnabled&&(d=["OPTION",{attrs:{value:e[h].domainName},child:[["text",e[h].domainName]]}],f.push(d));var i=["DIV",{attrs:{"class":"zmMSgMOpt emailBox"},child:[["LABEL",{child:[["text",a.groupSubscription.createGrp.createEmail]]}],["DIV",{attrs:{"class":"SC_floatLabelRow fLCol2"},child:[["DIV",{attrs:{"class":"SC_floatLabel flFLabel flBox"},child:[["INPUT",{attrs:{type:"text","class":"hasDD userName"}}]]}],["SPAN",{child:[["text","@"]]}],["DIV",{attrs:{"class":"SC_floatLabel flFLabel flBox domainList"},child:[["SELECT",{child:f}]]}]]}],g]}];if(b&&""!==b){var j=b.name.toLowerCase();j=j.replace(/ /gi,"_"),i=_zm.getDOM(i),$(i).find(".userName").val(j)}return i},b.searchTextBox=function(b){var c=b?a.groupSubscription.memberActions.searchModerator:a.groupSubscription.memberActions.searchUser;return _zm.getDOM(["DIV",{attrs:{"class":"SC_sch searchText SC_dyn"},child:[["I",{attrs:{"class":"msi-search"}}],["INPUT",{attrs:{type:"text",placeholder:c,style:"width: 400px;"}}]]}])},b.constructTabs=function(a){for(var b,c=_zm.getDOM(["UL",{attrs:{"class":"SCS_tab tabSel"}}]),d=0;d<a.length;d++)b=_zm.getDOM(["LI",{attrs:{"class":a[d].id},child:[["text",a[d].name]]}]),c.appendChild(b);return c},b.constructTabViews=function(a){var b="cal"===a.id?"zmGrpPolicy":"";return _zm.getDOM(["DIV",{attrs:{"class":"zm_tabCont tabView "+a.id+" "+b}}])},b.streamStateAlert=function(a){var b=["DIV",{attrs:{"class":""},child:[["text",a]]}];return _zm.getDOM(b)},b.getEditTemplate=function(){return _zm.getDOM(["DIV",{attrs:{"class":"zmMSgEdit editOpt"},child:[["DIV",{attrs:{"class":"SCmb"},child:[["UL",{child:[["LI",{attrs:{"data-event":"msi-action","class":"",style:"","data-drop":"1"},child:[["B",{child:[["DIV",{attrs:{"class":"SC_hd"}}],["SPAN",{child:[["I",{attrs:{"class":"msi-edit"}}]]}]]}]]}]]}]]}]]}])},b.getMoreOpt=function(){return _zm.getDOM(["DIV",{attrs:{"class":"zmMSgEdit moreOpt"},child:[["DIV",{attrs:{"class":"SCmb"},child:[["UL",{child:[["LI",{attrs:{"data-event":"msi-action","class":"",style:"","data-drop":"1"},child:[["B",{child:[["DIV",{attrs:{"class":"SC_hd"}}],["SPAN",{child:[["I",{attrs:{"class":"msi-action"}}]]}]]}]]}]]}]]}]]}])},b.addGroupView=function(b){var c,d=[],e=[],f=[];if(b&&b.id){var g,h=zmStreamsApp.util.getGroupDetails(b.id);g=h&&h.avatar?h.avatar:_zm.getDOM(zmStreamsApp.util.generateAvatarTemp(b.name));var i="",j="";if(b.createdBy&&b.createdBy.id===zmail.zuid)i=a.common.labels.owner,j="SC_urOwn";else{for(var k=b.moderators,l=!1,m=0;m<k.length;m++)if(zmail.zuid===k[m].id){l=!0;break}i=l?a.common.labels.moderator:a.common.labels.member,j=l?"SC_urMod":"SC_urMem"}var n=["SPAN",{attrs:{"class":"userRole "+j},child:[["text",i]]}];e=["DIV",{attrs:{"class":"zmMSgInfo infoRole"},child:[["STRONG",{attrs:{"class":"groupName"},child:[["text",b.name]]}],["DIV",{child:[["DIV",{attrs:{"class":"SC_SDot"}}],n]}]]}],c=this.constructActions(b);var o=h&&!h.isDisabled?"SC_csr":"",p=b.hidden?"zmHMSL":"";if(d=["DIV",{attrs:{"class":"zmMSL groupDom "+o+" "+p},child:[["DIV",{attrs:{"class":"zmMSDtl"},child:[e,f,c]}]]}],d=_zm.getDOM(d),$(d).prepend($(g)),b.isOwner||b.streamsEnabled){var q;q=this.getMoreOpt(),$(d).prepend(q)}$(g).addClass("grpImg"),this.constructMemberDOM(b,d)}return d},b}(),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupManageApp=function(a){return a}(zmStreamsApp.GroupManageApp||Zmail.App.extend({})),zmStreamsApp.GroupManageApp.models=function(a){var b=zmStreamsApp.GroupManageApp.ajaxReq,c=zmText.get("streams");return a.listGroup=Zmail.Model.extend({url:"/api/streams/groups/",defaults:{name:"",desc:"",mzuid:[]},constructor:function(a,b){Zmail.Model.apply(this,arguments)},setView:function(a,b){var c=this.get("views")||{};c[a]=b,this.set("views",c)},getView:function(a){var b=this.get("views")||{};return b[a]},removeView:function(a){var b=this.get("views")||{};delete b[a],_.isEmpty(b)&&this.trigger("destroy",this)},changeModerator:function(a,d){var e=a.mode,f=this,g=a.zuid,h=zmStreamsApp.util.getContactDetails([g])[g],i={},j=_zm.copyOf(f.get("moderators")),k=_.pluck(j,"id"),l=_zm.copyOf(f.get("members")),m=_zm.copyOf(j);if("addModerator"===e)i={emailAddress:h.eid,name:h.fn,id:g},j.push(i),k.push(g),f.set("moderators",[g]);else{var n;for(n=0;n<k.length&&g!==k[n].id;n++);j.splice(n,1),k=_.without(k,g),f.set("members",[g])}b.sync("update",f).done(function(){"addModerator"===e?f.set("moderators",j):(f.set("members",l),f.set("moderators",j)),d&&d()}).fail(function(a){a.length?(a=$.parseJSON(a),zmUtil.succErrMsg("e",a.status.description)):zmUtil.succErrMsg("e",c.groupSubscription.editGrp.roleErr),"addModerator"===e?f.set("moderators",m):f.set("members",l)})},removeMember:function(a,d){var e,f,g=this,h=_zm.copyOf(g.get("members")),i=_zm.copyOf(g.get("moderators")),j=_.pluck(h,"id"),k=_.pluck(i,"id");for(f=0;f<j.length;f++)j[f]===a&&(e=h[f],h.splice(f,1));g.set("removeMembers",[a]),b.sync("update",g).done(function(b){g.set("removeMembers",[]),g.set("members",h);var c=_.indexOf(k,a);if(c){for(f=0;f<k.length;f++)k[f]===a&&(e=i[f],i.splice(f,1));g.set("moderators",i),zmStreamsApp.util.groupManagement({mode:"removeModerator",groupId:g.get("id"),members:a})}d&&d()}).fail(function(a){g.set("removeMembers",[]),a.length?(a=$.parseJSON(a),zmUtil.succErrMsg("e",a.status.description)):zmUtil.succErrMsg("e",c.groupSubscription.editGrp.remMemErr);var b=g.get("members");b.push(e),g.set("members",b)})},addMember:function(a,d,e){var f,g,h=this,i=_zm.copyOf(h.get("members"));h.set("addMembers",a),b.sync("update",h).done(function(b){h.set("addMembers",[]),g=zmStreamsApp.util.getContactDetails(a);for(var c=0;c<g.length;c++)f={id:g[c].id,name:g[c].fn,emailAddress:g[c].eid},i.push(f);h.set("members",i),d&&d()}).fail(function(a){h.set("addMembers",[]),a.length?(a=$.parseJSON(a),zmUtil.succErrMsg("e",a.status.description)):zmUtil.succErrMsg("e",c.groupSubscription.editGrp.addMemErr),e&&e()})},serialized:function(a,b,c){var d=this,e=null;if("update"===a){b.url+=d.id,e=d.changed;var f=d.get("removeMembers");d.changed.emailAddress?e.mailDeliveryEnabled=!0:f&&f.length?e.removeMembers=f:d.get("addMembers")&&(e.addMembers=d.get("addMembers")),b.header=!0,b.setSessionId=!0,b.type="PUT"}else if("getGroup"===a)b.url+=d.id,b.type="GET",b.header=!0;else if("createGroup"===a)e={name:d.get("name"),description:d.get("desc"),members:d.get("mzuid")},d.get("emailAddress")&&(e.emailAddress=d.get("emailAddress")),b.header=!0,b.setSessionId=!0;else if("deleteGrp"===a)b.url+=d.id,b.type="DELETE",b.header=!0,b.setSessionId=!0;else if("updateLogo"===a){b.url+=d.id+"/photo";var g=d.get("photo"),h=new FormData;h.append("photo",g),e=h,b.type="PUT",b.noStringify=!0,b.header=!0,b.setSessionId=!0}else"getMembers"===a?(b.url+=d.get("id")+"/members",b.type="GET",b.header=!0):"getGroupDetail"===a&&(b.url+=d.get("id"),b.type="GET",b.header=!0);return e}}),a.listGroupCollection=Zmail.Collection.extend({model:a.listGroup,url:"/api/streams/groups",addModel:function(a,b,c){var d=_.pluck(a.moderators,"id");a.isOwner=!1;for(var e=0;e<d.length;e++)if(String(d[e])===zmail.zuid){a.isOwner=!0;break}return a.createdBy&&String(a.createdBy.id)===zmail.zuid&&(a.isOwner=!0),this.remove(a,{silent:c}),this.add(a,{at:b,silent:c}),this._byId[a.id]},serialized:function(a,b){var c=null;return"getAllGroups"===a?b.type="GET":"getDomainList"===a?(b.type="GET",b.url="/api/organization/"+zmail.zoid+"/domains"):"isCreateAllowed"===a&&(b.type="GET",b.url="/api/organization/"+zmail.zoid+"/privileges"),b.header=!0,c}}),a}(zmStreamsApp.GroupManageApp.models),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupManageApp=function(a){var b=zmText.get("streams","groupSubscription"),c=zmStreamsApp.constants.maxLimit,d={exists:b.errMsg.grpExists,empty:b.errMsg.grpEmpty,maxLength:b.errMsg.grpLimit,propName:b.errMsg.grpinvChar,nomemmesg:b.errMsg.memMin,descLength:b.errMsg.descLimit,propDesc:b.errMsg.descinvChar,sizeExceeds:b.errMsg.logoSize,maxmemLimit:zmText.applyArgs(b.errMsg.memMax,{max:c.MAX_ALLOWED_MEMBERS}),memInvalid:b.errMsg.memInvalid},e={avl:b.errMsg.grpAvl};a.isGroupValid=function(a,b,f){var g,h,i;if(!a.trim())return{type:"error",message:d.empty};if(0===a.length||a.length>c.MAX_GROUP_NAME_LENGTH)return{type:"error",message:d.maxLength};for(h=0;h<b.length;h++)if(g=b[h],i=$.trim(g.name.toLowerCase())===a.toLowerCase(),g.isOwner&&i&&(!f||b[h].id!==f))return{type:"error",message:d.exists};return{type:"success",message:e.avl}};var f=function(a,b){var e=$(b).val();return e&&!a.length?{type:"error",message:d.memInvalid}:a&&a.length?a.length>c.MAX_ALLOWED_MEMBERS&&{type:"error",message:d.maxmemLimit}:{type:"error",message:d.nomemmesg}};a.isGroupDescriptionValid=function(a){return!(a&&a.length>c.MAX_GROUP_DESC_LENGTH)||{type:"error",message:d.descLength}};var g=function(a){var b=a[0].files[0];return Math.round(b.size/1024)>c.MAX_ALLOWED_IMAGE_SIZE?{type:"error",message:d.sizeExceeds}:{type:"success"}};return a.validateIncludeEmail=function(){var a=zmStreamsApp.GroupManageApp.domainList;return a.length?!!zmStreamsApp.GroupManageApp.isMailHostingEnabled||(_zm.succErrMsg("e",b.errMsg.mailhost),!1):(_zm.succErrMsg("e",b.errMsg.nodomain),!1)},a.checkGroupName=function(b,c){var d=$(b).parent();d.removeClass("flBoxF"),d.removeClass("flVR vrFail vrSuccess vrWarning");var e=a.isGroupValid($.trim($(b).val()),c);return"error"===e.type?(d.addClass("flVR vrFail"),d.find(".spanMsg").text(e.message),!1):"success"===e.type||("warning"===e.type?(d.addClass("flVR vrWarning"),!1):void 0)},a.getMembersAddress=function(a){var b=a.children(".dFill");if(!b.length)return[];for(var c,d=[],e=0;e<b.length;e++)c=$(b[e]).data("zid"),c&&d.push(String(c));return d},a.checkMembers=function(b,c){var d=$(b).parent();d.removeClass("flBoxF");var e=a.getMembersAddress($(c)),g=f(e,b);return"error"===g.type?(d.addClass("flVR vrFail"),d.find(".spanMsg").text(g.message),!1):(d.removeClass("flVR vrFail"),!0)},a.checkDescription=function(b){var c=$(b).parent(),d=a.isGroupDescriptionValid($(b).val());return $(b).parent().removeClass("flBoxF"),"error"===d.type?(c.addClass("flVR vrFail"),c.find(".spanMsg").text(d.message),!1):(c.removeClass("flVR vrFail"),!0)},a.checkLogo=function(a){var b=g(a);return b},a}(zmStreamsApp.GroupManageApp||Zmail.App.extend({})),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupManageApp.views=function(a){var b=zmStreamsApp.GroupManageApp,c=zmStreamsApp.GroupManageApp.ajaxReq,d=zmStreamsApp.constants.groupWorkId,e=zmText.get("streams"),f=zmStreamsApp.constants,g=[{name:e.groupSubscription.editGrp.gen,id:"gen"},{name:e.groupSubscription.editGrp.calSetting,id:"cal"},{name:e.common.labels.members,id:"mem"}];return a.GroupManage=Zmail.View.extend({events:{click:function(){var a=this.model.toJSON(),b=zmail.mailLeft.getNodes()[0].getLayer("zmStreamTree"),c=zmStreamsApp.util.getGroupDetails(a.id);if(b.el.length&&!c.isDisabled){this.$el.find(".notify").remove();var d=this.model.get("hidden");d&&this.model.set("hiddenAt",(new Date).toString());var e="grid"===zmAdHocSettings.getStreamsListType(),f={view:"all",gridview:e,addTitleHeader:!0};zmUtil.requireStreamsApp().done(function(){zmStreamsApp.PostApp.init("",a.id,f,!0)})}},"click .viewMembers":function(a){var b=this.model.toJSON(),c=b.id;if(b.isOwner)zmStreamsApp.GroupManageApp.triggerEditGroup(c,{type:"mem"});else{var d={gid:c};zmStreamsApp.GroupApp.showMemberDialog(d)}a.stopPropagation()},"click .moreOpt":function(a){var b=this;a.stopPropagation(),$(a.currentTarget).addClass("show"),$(a.currentTarget).find("b").addClass("active");var d=[],f=this.model,g=f.toJSON();g.isOwner&&d.push({txt:e.groupSubscription.editgrp,data:"edit"});var h=g.hidden;if(g.streamsEnabled&&!g.isDisabled){var i=h?e.groupSubscription.showGrp:e.groupSubscription.hideGrp;d.push({txt:i,data:"hide"})}zmStreamsApp.util.createPopup({items:d,parent:$(a.currentTarget).find("li"),parentClass:"SC_Sopt",type:"oneLine",noArrow:!0,avoidScroll:!0,align:"pright",hoverElm:$(a.currentTarget).find("b"),onhide:function(){$(a.currentTarget).find("li").removeClass("show"),$(a.currentTarget).find("b").removeClass("active")},callback:function(d){zmStreamsApp.util.hideMenu(),$(a.currentTarget).find("b").removeClass("active"),"edit"===d.item?zmStreamsApp.GroupManageApp.triggerEditGroup(f.id):"hide"===d.item&&(f.set("hidden",!h),c.sync("update",f).done(function(){var c=h?zmText.applyArgs(e.groupSubscription.editGrp.showMsg,{gName:g.name}):zmText.applyArgs(e.groupSubscription.editGrp.hiddenMsg,{gName:g.name});zmUtil.succErrMsg("s",c),h?b.$el.removeClass("zmHMSL"):b.$el.addClass("zmHMSL"),$(a.currentTarget).removeClass("show"),zmStreamsApp.GroupManageApp.editGroupDetails(f),$.publish("group/showHideGroup",{id:g.id,hidden:!h})}).fail(function(a){a.length&&(a=$.parseJSON(a)),zmUtil.succErrMsg("e",a.status.description),f.set("hidden",h)}))}})},"click .streamState":"changeStreamState"},deleteAlert:function(a){var b=this.model.toJSON(),c=this,d={title:zmText.applyArgs(e.groupSubscription.editGrp.delAlertH,{gName:b.name}),$content:e.groupSubscription.editGrp.delAlertC,ignoreMouseDown:!1,buttons:[{name:e.groupSubscription.proceed,callback:function(b){c.deleteGroup(a),b.remove()}},{name:e.streams.common.cancel,isCancel:!0,callback:function(a){a.remove()}}]};Dialog["new"](d)},deleteGroup:function(a){var b=this.model,g=b.toJSON(),h=g.id,i=$(this.$el),j=$(a.$els.$content).find(".deleteButton");zmStreamsApp.util.sendRemove(j,"",e.groupSubscription.editGrp.deleting),c.sync("deleteGrp",b).done(function(){if(a.remove(),i.remove(),zmStreamsApp.GroupApp.removeGroup(h),zmStreamsApp.util.hideMenu(),zmTab.currentTab===d){var c,g=zmsuite.getCenter(f.groupWorkId)[0].$el,j=g.find(".groupView").hasClass("SC_dyn"),k=g.find(".groupHolder");if(c=zmStreamsApp.GroupManageApp.groupCount-1,zmStreamsApp.GroupManageApp.groupCount=c,zmStreamsApp.GroupManageApp.groupCount){if(!j){k.removeClass("zmMSboxL");var l=k.children().length;c=l,l||$(k).html(zmInit.emptyRow(e.groupSubscription.nogrp))}}else if(k.removeClass("zmMSboxL"),j){k.html("");var m=$("<a>").attr({href:"#",id:"addGroup"}).text(e.groupSubscription.creategrp),n=$("<span>").text(e.groupSubscription.grpNtAvl+". ");k.append(n).append(m),$("#addGroup").click(function(){zmStreamsApp.GroupManageApp.constructCreateView()})}else $(k).html(zmInit.emptyRow(e.groupSubscription.nogrp));c=c?c:e.groupSubscription.no,g.find(".groupCount").text(c+" "+e.groupSubscription.grp)}_.each(b.attributes.views,function(a){var c=b.getView(a.cid);c.onClose()})}).fail(function(){zmUtil.succErrMsg("e",e.groupSubscription.editGrp.delErr),zmStreamsApp.util.sendRemove(j,!0,e.groupSubscription.editGrp.deleteButton)})},viewMem:function(a,b,c,d,e){var f=this.model.id,g=zmStreamsApp.GroupApp.template("groupMemberText",{grpInfo:d,isAllow:!0}),h=zmStreamsApp.GroupApp.template("memberHeader",{name:g,members:d.members});a.append(h);var i={gid:f,callback:e};zmStreamsApp.GroupApp.constructMemberPopup(a,f,c,b,i)},constructMembers:function(a,b,d,f){a.html("");var g=this.model,h=this.model.id,i=this,j=zmStreamsApp.util.getGroupDetails(h);if(j.members.length!==g.get("totalMembers")){var k=zmComponent.loadingBand({container:a[0],type:"pagination"});c.sync("getMembers",g).done(function(c){200===c.status.code?(k&&k(),g.set("members",c.data.members),i.viewMem(a,b,d,j,f)):zmUtil.succErrMsg("e",c.status.description)}).fail(function(){zmUtil.succErrMsg("e",e.groupSubscription.editGrp.errMemFetch)})}else i.viewMem(a,b,d,j,f)},afterEdit:function(a,b,c,d){a.text(d),a.attr("contenteditable",!1),a.parent().removeClass("zm_setBorder"),a.css("display",""),b.removeClass("SC_dyn"),c&&c.parent().addClass("SC_dyn")},onEditTrigger:function(a,b,c){$(a).addClass("SC_dyn"),b.attr("contenteditable",!0),b.css("display","table-cell"),b.parent().addClass("zm_setBorder");var d,f=$(b).text().length;b.focus(),document.selection?(d=document.selection.createRange(),d.moveStart("character",f),d.select()):(d=window.getSelection(),d.collapse(b[0].firstChild,f)),c&&(c.parent().removeClass("SC_dyn"),c.addClass("SC_green"),c.text(e.groupSubscription.editGrp.infoMsg))},constructTooltip:function(a,c){var d=a.find(".emailTip"),f=e.groupSubscription.editGrp;if(d.length){var g="",h=c.emailAddress;if(g=c.streamsEnabled?h?c.mailDeliveryEnabled?zmText.applyArgs(f.enMail1,{eid:h}):zmText.applyArgs(f.enMail2,{eid:h}):f.enMail3:f.enMail,zmComponent.tooltip({elm:d[0],text:g,arrow:"top"}),h&&!$(a).find(".opLink").length){var i=b.template.constUrlLink(c);$(d).after($(i)),$(i).unbind("click").bind("click",function(){var a=window.location.protocol+"//mailadmin."+zmail.zohoUrl+"/cpanel/mailadmin.do?mode=gmlst&gid="+c.id;setTimeout(function(){window.open(a)},0)})}}},constructEdit:function(a,d){var f,g,h=this.model.toJSON(),i=this,j=this.model,k=b.template.editGroupProfile(h);a.html($(k));var l=$(k).find(".editName"),m=a.find(".edtitle"),n=a.find(".edcont"),o=a.find(".messgName"),p=a.find(".messgDesc"),q=$(k).find(".editDesc");this.constructTooltip(a,h),g=function(a){var b=$.Deferred(),d=i.model,f=d.get("photo");return d.set("photo",a),c.sync("updateLogo",d).done(function(a){200===a.status.code?(d.set("photo",a.data.photo),d.trigger("change:changepreview"),_zm.preloadimg(a.data.photo),b.resolve()):(zmUtil.succErrMsg("e",a.status.description),b.resolve(!0))}).fail(function(){d.set("photo",f),zmUtil.succErrMsg("e",e.groupSubscription.errMsg.errlogo),b.resolve(!0)}),b.promise()},zmStreamsApp.GroupManageApp.bindGroupLogo($(k),g),l.unbind("click").bind("click",function(){i.onEditTrigger(this,m,o);var a=j.get("description");i.afterEdit(n,q,p,a)}),m.unbind("keydown").bind("keydown",function(f){var h=j.get("name");if(13===f.keyCode){f.preventDefault();var n=$.trim(m.text()),p=zmStreamsApp.GroupManageApp.models.lists.toJSON(),q=zmStreamsApp.GroupManageApp.isGroupValid(n,p,j.get("id"));if("error"===q.type||"warning"===q.type)return o.text(q.message),o.addClass("SC_red"),void o.removeClass("SC_green");j.set("name",n),c.sync("update",j).done(function(){$(d.$els.$header).find("h3").text(n),i.afterEdit(m,l,o,n),zmUtil.succErrMsg("s",e.groupSubscription.editGrp.groupSaved),a.find(".headerGroupElm").children().first().remove(),a.find(".headerGroupElm").prepend($(b.template.generateImage(j.toJSON()))),zmStreamsApp.GroupManageApp.bindGroupLogo($(k),g),j.trigger("change:groupName")}).fail(function(a){a.length&&(a=$.parseJSON(a)),zmUtil.succErrMsg("e",a.status.description),j.set("name",h)})}else 27===f.keyCode&&i.afterEdit(m,l,o,h)}),q.unbind("click").bind("click",function(){i.onEditTrigger(this,n,p);var a=j.get("name");i.afterEdit(m,l,o,a)}),n.unbind("keydown").bind("keydown",function(a){var b=j.get("description");if(13===a.keyCode){a.preventDefault();var d=$.trim(n.text()),f=zmStreamsApp.GroupManageApp.isGroupDescriptionValid(d);if("error"===f.type)return p.text(f.message),void p.addClass("SC_red").removeClass("SC_green");j.set("description",d),c.sync("update",j).done(function(){i.afterEdit(n,q,p,d),zmUtil.succErrMsg("s",e.groupSubscription.editGrp.descSaved),zmStreamsApp.GroupManageApp.editGroupDetails(i.model)}).fail(function(a){a.length&&(a=$.parseJSON(a),zmUtil.succErrMsg("e",a.status.description)),zmUtil.succErrMsg("e",e.groupSubscription.editGrp.descErr),j.set("description",b)})}else 27===a.keyCode&&i.afterEdit(n,q,p,b)}),$(k).find(".streamEn").unbind("click").bind("click",function(b){var c=$(this).parent(),d=$(k).find(".emailEn");f=function(){var b=i.model.toJSON();i.constructTooltip(a,b),b.streamsEnabled?(c.addClass("sel"),d.removeClass("disable")):(c.removeClass("sel"),d.addClass("disable"),d.removeClass("sel"))},i.changeStreamState(b,f)}),$(k).find(".emailEnabled").unbind("click").bind("click",function(b){var c=$(this).parent(),d=zmStreamsApp.GroupManageApp.isMailHostingEnabled;return d===!1?void _zm.succErrMsg("e",e.groupSubscription.errMsg.mailhost):void($(this).parent().hasClass("disabled")||(f=function(){var b=i.model.toJSON();i.constructTooltip(a,b),b.mailDeliveryEnabled?c.addClass("sel"):c.removeClass("sel"),zmStreamsApp.GroupManageApp.editGroupDetails(i.model)},i.changeEmailState(f,$(k))))}),$(k).find(".deleteButton").unbind("click").bind("click",function(){$(this).hasClass("zs_snd")||i.deleteAlert(d)})},bindContentWrap:function(a,b,c,d){var e=a.find(".tabSel").find("li"),f=this;e.click(function(g){var h=$(g.currentTarget);if(h.hasClass("stSel"))h.hasClass("mem")&&a.find(".searchText").find("input").focus();else if(e.removeClass("stSel"),h.addClass("stSel"),b.find(".tabView").removeClass("shw"),b.find(".buttonBar").remove(),h.hasClass("mem"))b.find(".mem").addClass("shw"),f.constructMembers(b.find(".mem"),a.find(".searchText"),c,d);else if(h.hasClass("gen"))a.find(".searchText").addClass("SC_dyn"),b.find(".gen").addClass("shw"),f.constructEdit(b.find(".gen"),c);else if(h.hasClass("cal")){a.find(".searchText").addClass("SC_dyn"),b.find(".cal").addClass("shw");var i=f.model.toJSON(),j=i.organizationGroup?1:0,k=ZCL_groupPolicy;k&&_.size(k)&&k.getGroupPolicy({grpId:i.id,type:j},b.find(".cal")[0])}})},editGroupLoad:function(a,c){var d=this.model.toJSON(),e=this,f={title:d.name,ignoreMouseDown:!1,dialogDidMount:function(f){var h=f.$els;$(h.$positionWrapper).css("top","50px");var i=$(h.$contentWrapper),j=$(h.$content);j.before(b.template.constructTabs(g)),j.before(b.template.searchTextBox(d.isOwner)),j.css("width","550px");for(var k=0;k<g.length;k++)j.append(b.template.constructTabViews(g[k]));j.css("max-height",.7*$(window).height()),e.bindContentWrap(i,j,f,c),i.find(".tabSel").find("li."+a).click()},closeAction:function(){e.onClose()},positionWrapperClass:"SC_pe SC_PopTop",maskWrapperClass:"SC_Pop noanim",headerClass:"SC_PUtt"};Dialog["new"](f)},emailStateChange:function(a){var b,d=this.model,f=d.toJSON();b=f.mailDeliveryEnabled,f.mailDeliveryEnabled=!b,d.set("mailDeliveryEnabled",f.mailDeliveryEnabled),c.sync("update",d).done(function(){a&&a()}).fail(function(){zmUtil.succErrMsg("e",e.groupSubscription.editGrp.errInclMail),d.set("mailDeliveryEnabled",b)})},changeEmailState:function(a,d){var f,g=this.model,h=this;if(g.get("emailAddress"))g.get("mailDeliveryEnabled")===!1?this.emailStateChange(a):(f={title:e.groupSubscription.editGrp.emailDisH,ignoreMouseDown:!1,$content:b.template.streamStateAlert(e.groupSubscription.editGrp.emailDisC),buttons:[{name:e.groupSubscription.Continue,callback:function(b){h.emailStateChange(a),b.remove()}},{name:e.streams.common.cancel,isCancel:!0,callback:function(a){a.remove()}}]},Dialog["new"](f));else{var i=d.find(".emailBox");if(!i.length){i=b.template.createEmailBox(g.toJSON());var j=zmStreamsApp.GroupManageApp.domainList;if(!j.length)return void _zm.succErrMsg("e",e.groupSubscription.errMsg.nodomain);if(!zmStreamsApp.GroupManageApp.isMailHostingEnabled)return void _zm.succErrMsg("e",e.groupSubscription.errMsg.mailhost);if(d.find(".emailBox").length)return void $(i).find(".userName").focus();d.find(".zm_grpAction").before($(i))}$(i).show(),$(i).find(".userName").focus();var k=d.find(".saveEmail"),l=d.find(".cancelEmail");l.unbind("click").bind("click",function(){$(i).hide()}),k.unbind("click").bind("click",function(){if(!$(k).hasClass("zs_snd")){var b=$(i).find(".userName").val(),d=$(i).find(".domainList select").val();if(""===b.trim()||""===d.trim())return void zmUtil.succErrMsg("e",e.groupSubscription.editGrp.patternErr);var f=g.toJSON();f.emailAddress=b+"@"+d,f.mailDeliveryEnabled=!0,g.set("mailDeliveryEnabled",!0),g.set("emailAddress",f.emailAddress),zmStreamsApp.util.sendRemove($(k),"",e.groupSubscription.editGrp.creating),c.sync("update",g).done(function(){$(i).hide(),a&&a()}).fail(function(a){a.responseText&&(a=JSON.parse(a.responseText)),a&&a.data&&"PATTERN_NOT_MATCHED"===a.data.errorCode?zmUtil.succErrMsg("e",e.groupSubscription.editGrp.patternErr):a&&a.status?zmUtil.succErrMsg("e",a.status.description):zmUtil.succErrMsg("e",e.groupSubscription.editGrp.emailBoxErr),g.set("emailAddress",""),g.set("mailDeliveryEnabled",!1),zmStreamsApp.util.sendRemove($(k),!0,e.streams.common.create)})}})}},streamStateChange:function(a){var b,d=this.model,f=this,g=d.toJSON();b=g.streamsEnabled,g.streamsEnabled=!b,d.set("streamsEnabled",g.streamsEnabled),c.sync("update",d).done(function(){f.streamsState(),d.get("mailDeliveryEnabled")&&(d.set("mailDeliveryEnabled",!1),zmStreamsApp.GroupManageApp.editGroupDetails(d)),a&&a()}).fail(function(){zmUtil.succErrMsg("e",e.groupSubscription.editGrp.streamsErr),d.set("streamsEnabled",b)})},changeStreamState:function(a,c){if(!$(a.currentTarget).parent().hasClass("disable")){var d,f=this,g=this.model;g.get("streamsEnabled")===!1?f.streamStateChange(c):(d={title:e.groupSubscription.disGrpHeader,ignoreMouseDown:!1,$content:b.template.streamStateAlert(e.groupSubscription.disGrpCont),buttons:[{name:e.groupSubscription.Continue,callback:function(a){f.streamStateChange(c),a.remove()}},{name:e.streams.common.cancel,isCancel:!0,callback:function(a){a.remove()}}]},Dialog["new"](d))}a.stopPropagation()},streamsState:function(){var a=this.$el,b=a.find(".streamState i"),c=this.model.get("streamsEnabled"),d=this.model.toJSON();c===!1?b.parent().parent().removeClass("sel"):b.parent().parent().addClass("sel");var e=zmail.ContactBook.getGroups(d.id,{includeAllGroups:!0});e=e[0],e?zmStreamsApp.GroupManageApp.editGroupDetails(this.model):zmStreamsApp.GroupManageApp.addGroupToContacts(d),$.publish(c?"group/streamsenabled":"group/streamsdisabled",{id:d.id,name:d.name,membercount:d.members.length,members:d.members})},emailState:function(){var a=this.$el,b=a.find(".emailState i"),c=this.model.get("mailDeliveryEnabled");c===!0?b.removeClass().addClass("msi-check"):b.removeClass().addClass("msi-uncheck"),zmStreamsApp.GroupManageApp.editGroupDetails(this.model)},updateLogo:function(){var a=this.$el,b=a.find(".grpImg"),c=$(b).has("img"),d=this.model.get("photo");if(c.length)$(b).find("img").attr("src",d);else{var e=_zm.getDOM(["IMG",{}]);$(e).attr("src",d),$(b).html(""),$(b).append($(e))}zmStreamsApp.GroupManageApp.editGroupDetails(this.model)},onClose:function(){var a=this;a.model.removeView(a.cid),a.remove()},render:function(a){var c=this.model.toJSON();if(a&&a.editGroup)this.editGroupLoad(a.className,a.callback);else{var d,f=b.template.addGroupView(c);this.$el=$(f);var g=$(f).find(".viewMembers");
g=g.find(".memImg");for(var h=0;h<g.length;h++)d=$(g[h]).attr("name"),$(g[h]).length&&d?zmComponent.tooltip({elm:g[h],text:d,arrow:"top"}):$(g[h]).hasClass("isAdd")?zmComponent.tooltip({elm:g[h],text:e.groupSubscription.addVMem,arrow:"top"}):$(g[h]).hasClass("isView")&&zmComponent.tooltip({elm:g[h],text:e.groupSubscription.viewMem,arrow:"top"});var i=$(f).find(".editOpt");_.size(i)&&zmComponent.tooltip({elm:i[0],text:e.groupSubscription.editgrp,arrow:"top"});var j=$(f).find(".moreOpt");if(_.size(j)&&zmComponent.tooltip({elm:j[0],text:e.groupSubscription.mreAct,arrow:"top"}),$(f).attr("data-groupViewId",this.cid).attr("data-id",this.model.get("id")).data("view",this),c.hidden){var k=new Date(c.hiddenAt),l=new Date(c.lastActivityAt);l-k>0&&this.showActivity()}}this.model.setView(this.cid,this)},constMembers:function(){var a,c=this.$el;c.find(".viewMembers").remove(),b.template.constructMemberDOM(this.model.toJSON(),c);var d=$(c).find(".viewMembers");d=d.find(".memImg");for(var f=0;f<d.length;f++)a=$(d[f]).attr("name"),$(d[f]).length&&a?zmComponent.tooltip({elm:d[f],text:a,arrow:"top"}):$(d[f]).hasClass("isAdd")?zmComponent.tooltip({elm:d[f],text:e.groupSubscription.addVMem,arrow:"top"}):$(d[f]).hasClass("isView")&&zmComponent.tooltip({elm:d[f],text:e.groupSubscription.viewMem,arrow:"top"})},changeRole:function(){var a=this.$el,c="",d=this.model.toJSON();if(d.createdBy&&d.createdBy.id===zmail.zuid)c=e.common.labels.owner;else{for(var f=d.moderators,g=!1,h=0;h<f.length;h++)if(zmail.zuid===f[h].id){g=!0;break}c=g?e.common.labels.moderator:e.common.labels.member}a.find(".userRole").text(c),a.find(".zmMSgAct").remove(),a.append(_zm.getDOM(b.template.constructActions(d))),a.find(".viewMembers").remove(),b.template.constructMemberDOM(d,a);var i;d.streamsEnabled||d.isOwner?a.find(".moreOpt").length||(i=b.template.getMoreOpt(),a.prepend(i)):a.find(".moreOpt").remove()},showActivity:function(){var a=this.$el,c=a.find(".notify");c.length||(a.find(".grpImg").append(b.template.showNewActivity()),c=a.find(".notify"),c.length&&zmComponent.tooltip({elm:c[0],text:e.common.labels.newActivity,arrow:"top"}))},changeGroupName:function(){var a=$(this.$el),b=this.model.toJSON();a&&a.find(".groupName").length&&(a.find(".groupName")[0].childNodes[0].textContent=b.name),zmStreamsApp.GroupManageApp.editGroupDetails(this.model)},initialize:function(a){var b=this,c=b.model;b.render(a),b.listenTo(c,"change:mail",b.emailState),b.listenTo(c,"change:changepreview",this.updateLogo),b.listenTo(c,"change:memberList",this.constMembers),b.listenTo(c,"change:deleteGroup",this.deleteGroup),b.listenTo(c,"change:memberRole",this.changeRole),b.listenTo(c,"change:groupName",this.changeGroupName),b.listenTo(c,"change:showActivity",this.showActivity)}}),a}(zmStreamsApp.GroupManageApp.views);