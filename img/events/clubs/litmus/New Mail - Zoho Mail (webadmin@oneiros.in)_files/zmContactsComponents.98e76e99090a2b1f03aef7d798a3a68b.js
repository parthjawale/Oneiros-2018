"use strict";window.zmAdd=function(){var a,b,c,d,e,f,g,h,i,j,k,l="",m={},n=!1,o="a",p=!0,q=[],r={},s=[],t=[],u=0,v=0,w=!1,x=zmText.get("zmContactsComponents","addressBook.labels"),y=x.allContacts;k=$("<li>"+x.crminfoMsg+"</li>");var z=function(a,c,e){var f=$(a).attr("data-eid");if(!$(a).hasClass("SC_no")){if(!a||$(a).find("i").hasClass("msi-tick")&&"all"!==e)a&&($(a).find("i").removeClass("msi-tick"),$(a).removeClass("sel"),$("#zmabk_sel div[data-eid='"+f+"']").remove(),$(".SC_conSel").find("[data-eid = '"+f+"']").remove(),delete m[f],Object.keys(m).length<=3&&$(d).remove());else{if($(a).find("i").addClass("msi-tick"),$(a).addClass("sel"),!$("#zmabk_sel").length){var h=document.createElement("div");h.id="zmabk_sel",$("#zmabk").after(h),$("#zmabk_sel").css({height:"auto",overflow:"hidden"}).click(function(a){var c=a.target;$(c).hasClass("msi-close")&&b($(c).parent())})}if(!m[f]){var i=$(a).find("div").html(),j=$(a).find("[data-name]").text(),k="",l="";i.indexOf("<font>")!==-1&&(k=i.substring(i.indexOf("</b>")+4,i.indexOf("</font"))),l=$(a).find("img").attr("src"),m[f]={fn:j,nn:k,eid:f,photo:l};var n=_zm.getDOM(["DIV",{attrs:{"class":"SC_cs","data-eid":f},child:[["SPAN",{child:[["text",j]]}],["I",{attrs:{"class":"msi-close"}}]]}]);"crm"!==o?zmail.ContactBook.get(f).done(function(a){$(a[0].avatar()).insertBefore($(n).find("span"))}):"crm"===o&&zmail.ContactBook.get({eid:f,type:["crm"]}).done(function(a){$(a[0].avatar()).insertBefore($(n).find("span"))}),$("#zmsdialog_zmabk").find(".SC_conSelLst").append(n);var p=Object.keys(m).length;g(),p>3?($(d).css("display","block"),$(d).find("input").focus()):$(d).css("display","none")}var q=$("#zmsdialog_zmabk").find(".SC_conSelLst")[0];q.scrollHeight>0&&(q.scrollTop=q.scrollHeight)}zmAdd.resizeSelPane()}};b=function(a){var b=$(a).attr("data-eid");Object.keys(m).length<=3&&$(d).remove(),$("#zmabk li[data-eid='"+b+"']")[0]?z($("#zmabk li[data-eid='"+b+"']")):($(a).remove(),delete m[b])},g=function(){$("#SC_Category").remove(),$(d).css("display","none"),$(d).insertBefore(".SC_PUbtm"),$(d).on("click",function(a){e(a)})},e=function(a){var b,c=a.target,e=function(){var a=$(".SC_grpName");a.removeClass("SC_dyn"),$(d).find("input").focus(),a.on("keyup",function(c){a[0].value.length>0?(b=$(d).find(".msi-edit"),$(b).attr("class","msi-tick"),13===c.keyCode&&(f(a[0].value),a[0].value=""),$(b).on("click",function(){f(a[0].value),a[0].value=""})):(b=$(d).find(".msi-tick"),$(b).attr("class","msi-edit"))})};"SC_mkeGrpTxt"===c.className?($(c).addClass("SC_dyn"),e()):"msi-close"===c.className||"grp_close"===c.className?$(d).remove():"msi-edit"!==c.className&&"grp_save"!==c.className&&"msi-tick"!==c.className||($(".SC_mkeGrpTxt").addClass("SC_dyn"),e())},f=function(a){var b=function(a){_zm.succErrMsg("e",a["Error : "])},c=zmText.get("zmContactsComponents","addressBook.labels.successMsg"),e=function(a,b){_zm.succErrMsg("s",c),$(d).remove()},f=Object.keys(m),g=f.toString(),h={};h.mode="addToCategory",h.query="ad",h.ignoreCategoryCheck="true",h.categoryName=a,h.email=g,zmAjq.XHR({u:zmail.conPath+"/getContactsAlias.do",t:"POST",p:h,fn:e,efn:b,csr:"s"})};var A=function(){$("#zmabk_srch input").mousedown(function(a){$("#zmsdialog_zmabk #zmabk_srch input").focus(),zmUtil.stopEvents(a)}).keyup(function(a){if(""===$(this).val().trim()){if(w)return zmAdd.loadAlpt($(this).val(),"crm"),!1;l="a",$("#zmabk_s li").remove(),zmAdd.loadAlpt("a")}else w?zmAdd.loadAlpt($(this).val(),"crm"):zmAdd.loadAlpt($(this).val(),"search");zmUtil.stopEvents(a)}),$("#zmabks_sel").click(function(a){var b=a.target;"I"===b.tagName&&z(b,a)}),$("#zmabk").find(".SC_P2r").click(function(a){var b=a.target;"LI"!==b.tagName&&(b=$(a.target).parents("li")),z(b,a)}),$("#zmabk").find(".SC_P2r").scroll(function(a){n||zmAdd.loadAlpt("","orgper")}),$(".SC_conSel").click(function(a){var c=a.target;"msi-close"===c.className&&b(c.closest("div"))})};c=_zm.getDOM(["DIV",{attrs:{"class":" SC_Psa"},child:[["I",{attrs:{"class":""}}],["text",zmText.get("zmContactsComponents","addressBook.labels.selectAll")]]}]);var B=function(a){for(var b=$("#zmabk_c").children(),c=b.length,d=a.attr,e=0;e<c;e++)z(b[e],"",d)},C=function(){var a=$(c).find("i");$(c).insertAfter("#zmabk_hdr");var b=$("#zmabk_c li").length,d=$("#zmabk_c li.sel").length;b===d?a.addClass("msi-check").removeClass("msi-uncheck"):a.addClass("msi-uncheck").removeClass("msi-check")},D=function(a){var b=a.id,d=a.val;if("undefined"!=typeof b){zmUtil.hideMenu();var e=document.createTextNode(d),f=h.querySelector("[data-select]");if($(f).html(""),$(f).append(e),w=!1,"my"===b)$("#zmabk_s")[0].innerHTML="",$("#zmabk_c")[0].innerHTML="",$("#zmabk_a")[0].innerHTML="",$("#zmabk_crm")[0].innerHTML="",$("#zmabk").find(".SC_P2r").hide(),$("#zmabk .SC_Psa ").remove(),$("#zmabk_a").show().scrollTop(0),l="a",o="a",zmAdd.loadAlpt(l),p=!0,q=s;else if("CRM"===d)$("#zmabk_s").hide(),$("#zmabk_c").hide(),$("#zmabk_a").hide(),w=!0,$("#zmabk .SC_Psa ").remove(),$("#zmabk_crm")[0].style.display="block";else{zmAdd.loadAlpt(b,"category");var g=$(c).find("i");$(c).off().on("click",function(){"msi-uncheck"===g[0].className?(g.addClass("msi-check").removeClass("msi-uncheck"),B({attr:"category"})):(g.addClass("msi-uncheck").removeClass("msi-check"),B({attr:""}))}),s=q}}},E={showBook:function(b,c,e,f){if(p=!0,u=0,t=[],v=0,l="a",!$("#zmabk").length){var k=[String('<div id="zmabk" ref = "addressbook"><div id="zmabk_hdr" class="SC_PUhd"><div class="SC_sch SC_frt" id="zmabk_srch"><i class="msi-search"></i><input type="text" placeholder="Search Contact"></div><div class="SCmb SC_flt" style = "padding:0px;"><ul><li class="SCtxt"><b id = "allContacts"><div class="SC_hd"></div><span><span data-select="select">'+y+'</span><i class="msi-barrow"></i></span></b></li></ul></div><div style="clear:both;"></div></div><ul class="SC_P2r SC_Phr" data-index="0" id="zmabk_c" style = "display:none;"></ul><ul class="SC_P2r SC_Phr" data-index="0" id="zmabk_a" style = "display:none;"></ul><ul class="SC_P2r SC_Phr" id="zmabk_s" data-index="0" style = "display:none;"></ul><ul class="SC_P2r SC_Phr" id="zmabk_crm" data-index="0" style = "display:none;"><li>'+x.crminfoMsg)+"</li></ul></div><div></div>"].join("");a=e.target.innerText;var n=_zm.getDOMReferenceMap(k,!0);h=n.addressbook,$("body").append(h)}var o=f;f||(o=c);var q,r,s=document.getElementById(o).getBoundingClientRect();r=s.top+10;var w={title:"",buttons:[{txt:zmText.get("zmContactsComponents","addressBook.labels.insert"),callback:function(){zmAdd.insertCont(b)}},{txt:zmText.get("zmContactsComponents","addressBook.labels.cancel"),isCancel:!0,callback:function(){zmAdd.closeAddBook()}}],mask:!0,pos:"left"};zmsDialog.create("zmabk",w);var z=$("#zmsdialog_zmabk").parent();z.attr("class","SC_pe SC_PopTop"),z.css("top","70px"),$("#zmabk").find(".SC_P2r").innerHTML="",$("#zmabk_sel").html(""),$("#zmabk").scrollTop(0);var B,C=zmail.ContactBook.getCategories(),E=[],F=[],G=[],H=[],I=3,J=2,K={},L=C.length;for(E[0]={htm:"All Contacts",data:{id:"my",val:"All Contacts"}},E[1]={sep:!0},E[2]={htm:"General Category",className:"nohr dd_label"},F[0]={sep:!0},F[1]={htm:"Organization Category",className:"nohr dd_label"},B=0;B<L;B++)K={},C[B].isOrg()?(K={htm:C[B].attrs.cname,data:{id:C[B].attrs.cid,val:C[B].attrs.cname}},F[J]=K,J++):(K={htm:C[B].attrs.cname,data:{id:C[B].attrs.cid,val:C[B].attrs.cname}},E[I]=K,I++);for(J=E.length,L=F.length,G=E,B=0;B<L;B++)G[J]=F[B],J++;H[0]={sep:!0},H[1]={htm:"CRM",data:{id:"crm",val:"CRM"}},zmail.IntegrationStatus.CRM&&zmail.isCRMServiceUser&&(G.push(H[0]),G.push(H[1]));var M=$(h).find("#allContacts"),N={par:M,clk:function(a){D(a)},list:G,ulClass:"SC_tin",align:"pleft",leftOffset:-1,container:$("#zmsdialog_zmabk")[0]};$(M).on("click",function(){$(M).addClass("SC_ddn");var a=new zmDropDownMenu(N);a.paint()}),$("#zmsdialog_zmabk").css("max-width","500px"),"To"===a?a=zmText.get("zmContactsComponents","addressBook.labels.To"):"Cc"===a?a=zmText.get("zmContactsComponents","addressBook.labels.Cc"):"Bcc"===a&&(a=zmText.get("zmContactsComponents","addressBook.labels.Bcc"));var O=zmText.get("zmContactsComponents","addressBook.labels.create"),P=_zm.getDOM(["DIV",{attrs:{"class":"SC_conSel"},child:[["DIV",{attrs:{"class":"SC_conLbl SC_thm"},child:[["text",a]]}],["DIV",{attrs:{"class":"SC_conSelLst"}}]]}]);d=_zm.getDOM(["DIV",{attrs:{"class":"SC_mkeGrp",id:"SC_Category"},child:[["SPAN",{attrs:{"class":"SC_mkeGrpTxt"},child:[["text",x.create]]}],["INPUT",{attrs:{"class":"SC_grpName SC_dyn",type:"text",placeholder:O}}],["SPAN",{attrs:{"class":"grp_save"},child:[["I",{attrs:{"class":"msi-edit"}}]]}],["SPAN",{attrs:{"class":"grp_close"},child:[["I",{attrs:{"class":"msi-close"}}]]}]]}]),i=_zm.getDOM(["LI",{attrs:{"class":"SC_no",id:"noMatchFound"},child:[["DIV",{child:[["I"],["SPAN"]]}],["DIV",{child:[["text",zmText.get("zmContactsComponents","addressBook.labels.noMatchFound")]]}]]}]),$(P).insertAfter("#zmsdialogcont_zmabk");var Q=parseInt($("#zmsdialogcont_zmabk").css("max-height"))/2;$("#zmsdialogcont_zmabk").css("min-height",Q+"px");var R=parseInt($("#zmsdialog_zmabk").css("max-width"));$("#zmsdialog_zmabk").css("min-width",R+"px"),g(),j=$("#zmabk_crm"),q=60*document.body.getBoundingClientRect().height/100-r,q<0&&(q=60*document.body.getBoundingClientRect().height/120),A(),$("#zmabk").attr("data-def",q),$("#zmabk").show().children("ul").css({height:q+"px",width:"500px",overflow:"hidden","overflow-y":"auto"}),zmAdd.loadAlpt(l),m={},$("#zmsdialog_zmabk #zmabk_srch input").focus(),zmUtil.stopEvents(e)},loadAlpt:function(a,b){var c,d="abcdefghijklmnopqrstuvwxyz";if("undefined"==typeof b&&(o="a"),"orgper"===b){if(o="a",!p)return;if(v<10&&(c=d.indexOf(l),l=d.substring(c+1,c+2),t=[]),"z"===l)p=!1;else if(!$("#addLoad")[0]){var e=$('<li id = "addLoad">'+zmText.get("zmContactsComponents","addressBook.labels.loading")+"</div>");$("#zmabk_a").append(e)}}else{if("category"===b)return $("#zmabk").find(".SC_P2r").hide(),$("#zmabk_c")[0].innerHTML="",o="c",n=!0,l="a",void zmail.ContactBook.get({categoryid:a}).done(function(a){return r=a,0===r.length?void($(".zmabk_c")||$(".zmabk_c").append(_zm.getDOM(i))):(zmAdd.constructContacts(r,"category"),void C())});if("search"===b){$("#zmabk").find(".SC_P2r").hide(),$("#zmabk_s")[0].innerHTML="",$("#zmabk_a").hide(),$("#zmabk_c")[0].innerHTML="",o="s",n=!0,l="a";var f={str:a,expected:1e3,type:["personal"],excludeOrgUsers:!0};return void zmail.ContactBook.get(f).done(function(a){if(r=a,0===r.length){var b=_zm("#","zmabk_"+o),c=_zm.getDOM(["LI",{attrs:{"class":"SC_no"},child:[["DIV",{child:[["I"],["SPAN"]]}],["DIV",{child:[["text",zmText.get("zmContactsComponents","addressBook.labels.noMatchFound")]]}]]}]);return b.appendChild(c),void _zm.show(b)}zmAdd.constructContacts(r)})}if("crm"===b)return $("#zmabk_s")[0].innerHTML="",$("#zmabk_a").hide(),$("#zmabk_c")[0].innerHTML="",o="crm",n=!0,l="a",0===a.trim().length&&(j[0].innerHTML="",j.append(k)),void(a.trim().length>=3?($("#zmabk").find(".SC_P2r").hide(),zmail.ContactBook.get({str:a,type:["crm"]}).done(function(a){if(r=a,$("#zmabk_crm")[0].innerHTML="",0===r.length){var b=_zm("#","zmabk_"+o),c=_zm.getDOM(["LI",{attrs:{"class":"SC_no"},child:[["DIV",{child:[["I"],["SPAN"]]}],["DIV",{child:[["text",zmText.get("zmContactsComponents","addressBook.labels.noMatchCrmFound")]]}]]}]);return b.appendChild(c),void _zm.show(b)}zmAdd.constructContacts(r)})):(j[0].innerHTML="",j.append(k)))}n=!1;var g={fn:l,expected:10,sliceExpected:!0,exclude:t,type:["personal"],excludeOrgUsers:!0};zmail.ContactBook.get(g).done(function(a){$("#zmabk_c").hide(),$("#zmabk_s").hide(),r=a,zmAdd.constructContacts(r,"orgper")})},constructContacts:function(a,b){var c,d,e,f=function(a,b,c,d){$(d).insertAfter($(b).find("div"));for(var e in m)e===b.getAttribute("data-eid")&&(b.className="sel",$(b).find("i").addClass("msi-tick"));c.appendChild(b)};"crm"!==b?($(".noMatchFound").remove(),$("#addLoad").remove(),d=a,e=v=d.length):(d=a,e=d.length);var g,h,i;if(c=function(a,c,d){var e=_zm.getDOM(["DIV",{attrs:{"class":"SC_avtr"}}]);if(h=_zm.getDOM(["LI",{attrs:{"data-eid":c.eid,"class":a.cls},child:[["DIV",{attrs:{"data-primary":"primary"},child:[["SPAN",{child:[["b",{attrs:{"data-name":"name"},child:[["text",a.name]]}]]}],["SPAN",{attrs:{id:"emailid"},child:[["text",c.eid]]}]]}],e,["FONT",{child:[["I",{attrs:{"class":a.chk}}]]}]]}]),i=_zm("#","zmabk_"+o),_zm.show(i),"crm"!==b&&(e=r[g].avatar(),"category"===d&&c.isPrimary)){var j=$('<div class="SC_frt"><i class="msi-fav SC_fav"></i></div>'),k=$(h).find("[data-primary]");$(k).prepend(j)}f({},h,i,e)},"crm"!==b)for(g=0;g<e;g++){var j=r[g].attrs,k="",l="";if(j.eid&&(!j.eid||j.eid.indexOf("List")===-1)){u++,t[u]=j.eid,$("#zmabk_sel .SC_cs").length&&void 0!==m[j.eid]&&(k="msi-tick",l="sel"),j.photo||(j.photo=zmResource.get("image","SC-Photo.png"));var n=j.fn;j.ln&&(n+=" "+j.ln);var p={name:n,cls:l,chk:k};c(p,j,b)}}else{var q="",s="";d.forEach(function(a){var b=a.fullName;c(a,{name:b,chk:q,cls:s},"crm")})}$("#zmabk_a")[0].scrollHeight<=$("#zmabk_a")[0].clientHeight+$("#zmabk_a")[0].scrollTop&&"orgper"===b&&zmAdd.loadAlpt("","orgper")},resizeSelPane:function(){var a=document.getElementById("zmabk_sel");$("#zmabk_sel").height()>=60&&($("#zmabk_sel").css({height:"60px",overflow:"auto"}),a.scrollHeight<a.getBoundingClientRect().height&&0===a.scrollTop&&$("#zmabk_sel").css({height:"auto",overflow:"hidden"})),$("#zmabk_sel .SC_cs").length?$("#zmabk_sel").show():$("#zmabk_sel").hide();var b,c=parseInt($("#zmabk").data("def"));b="search"===l?_zm("#","zmabk_s"):1===l.length?_zm("#","zmabk_a"):_zm("#","zmabk_c");var d=c-_zm("#","zmabk_sel").getBoundingClientRect().height;b.style.height=d+"px"},insertCont:function(a){var b=[],c=0;for(var d in m)b[c]=m[d],c++;a&&"function"==typeof a&&a(b),zmAdd.closeAddBook()},closeAddBook:function(){_zm("#","zmabk_a").setAttribute("data-index",0),_zm("#","zmabk_c").setAttribute("data-index",0),_zm("#","zmabk_s").setAttribute("data-index",0),_zm("#","zmabk_crm").setAttribute("data-index",0),q=[],zmsDialog.remove(),$("#zmabk_sel").remove(),$("#zmabk").remove(),m={}}};return E}();