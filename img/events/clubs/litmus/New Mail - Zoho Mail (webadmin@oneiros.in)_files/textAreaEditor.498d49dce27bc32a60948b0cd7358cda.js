"use strict";define([],function(a){var b=a("_zm"),c=a("zmail.Utils.TextArea"),d=a("zmail.Utils.DOM"),e=a("zmail.Components.TextAreaEditor"),f="\ufeff",g=b.getDOMReferenceMap,h=function(a){var b=d.element(d.__dangerouslyParseHTML("<div />"));return d.__dangerouslySetInnerHTML(b,a),b=d.element(b.children(0),!0)},i=function(a){return a=a||"",a.replace(/[\uFEFF\uFFFE]/gim,"")},j={LEFT:37,RIGHT:39,DELETE:46,BACKSPACE:8,SPACE:32,ENTER:13,SHIFT:16,META:91,RIGHT_META:93},k={blockRemoved:"BLOCK_REMOVED",blockAdded:"BLOCK_ADDED",textChanged:"TEXT_CHANGED",heightChanged:"HEIGHT_CHANGED"},l=function(a){function b(){babelHelpers.classCallCheck(this,b);var a=babelHelpers.possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this)),c=a;return c.blockRenderers={},c.initBlockRenderers(),a}return babelHelpers.inherits(b,a),babelHelpers.createClass(b,[{key:"initBlockRenderers",value:function(){var a=this;a.setBlockRenderer("default",a.textBlockRenderer),a.setBlockRenderer("text",a.textBlockRenderer),a.setBlockRenderer("url",a.urlBlockRenderer)}},{key:"setBlockRenderer",value:function(a,b){var c=this;a&&(c.blockRenderers[a]=b)}},{key:"textBlockRenderer",value:function(a,b){var c=null;b=b||{};var d=b.padEOL||!1;return c=a.value.length>0&&"\n"===a.value[a.value.length-1]&&d?a.value+"_":a.value}},{key:"urlBlockRenderer",value:function(a,b){var c=null;return b=b||{},c=React.createElement("a",{href:a.data.url,target:"_blank",rel:"noreferrer noopener"},a.value)}},{key:"renderBlock",value:function(a,b){var c=this,d=null;b=b||{};var e=c.blockRenderers[a.type]||c.blockRenderers["default"];return d=e(a,b)}},{key:"render",value:function(){var a=this,b=a.props,c={whiteSpace:"pre-wrap",display:"block"},d=b.text||"",e=b.metaBlocks||[],f=[],g=0;return e.forEach(function(a){var b=d.substring(0,a.start-g);b&&f.push({type:"text",value:b});var c=d.substring(a.start-g,a.end-g);c&&f.push({type:a.type,value:c,data:a.data}),d=d.substring(a.end-g),g=a.end}),d&&(f.push({type:"text",value:d}),d=""),f=f.map(function(b,c){var d=f.length-1===c;return a.renderBlock(b,{padEOL:d})}),React.createElement("span",{style:c},f)}}]),b}(React.Component),m=function(){function a(){babelHelpers.classCallCheck(this,a);var b=this;b.textarea=null,b.dom=null,b.refs=null,b.metaBlocks=null,b.maxHeightActive=!1}return babelHelpers.createClass(a,[{key:"getTemplate",value:function(){return['<div ref="wrapper" class="zm_mention" style="color: transparent;">','<div ref="background" class="zm_mentionbg" />','<textarea ref="textarea" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>',"</div>"].join("")}},{key:"createDOM",value:function(){var a=this;a.dom=h(a.getTemplate()),a.refs=g(a.dom,!0)}},{key:"init",value:function(a){a=a||{};var b=this,c=null;b.createDOM(),c=b.refs,a.textarea?(b.textarea=a.textarea,d.mountBefore(c.wrapper,b.textarea),d.mountAfter(b.textarea,c.textarea),d.unmount(c.textarea,!0),c.textarea=b.textarea):b.textarea=c.textarea,a.text&&b.setText(a.text,{silent:!0}),a.metaBlocks?b.setMetaBlocks(a.metaBlocks,{silent:!0}):b.metaBlocks=[],b.syncText(),b.bindEvents()}},{key:"getCursorPositionWithBOM",value:function(a){var b=this,c=b.textarea;return a===!0?c.selectionEnd:"forward"===c.selectionDirection?c.selectionEnd:"backward"===c.selectionDirection?c.selectionStart:c.selectionEnd||c.selectionStart}},{key:"getCursorPosition",value:function(){var a=this,b=a.textarea,c=-1;"forward"===b.selectionDirection?c=b.selectionEnd:"backward"===b.selectionDirection&&(c=b.selectionStart),c=b.selectionEnd||b.selectionStart;var d=a.bomCountBeforeIndex(c);return c-d}},{key:"setCursorPosition",value:function(a){var b=this,c=b.textarea,d=c.value;a<0&&(a=0),a>d.length&&(a=d.length),c.setSelectionRange(a,a)}},{key:"checkCursorPositionAndAdjust",value:function(){var a=this,b=a.getCursorPositionWithBOM(),c=a.textarea.value,d=c.charAt(b-1);d===f&&a.setCursorPosition(b-1)}},{key:"deletePreviousCharacter",value:function(){var a=this,b=a.getCursorPositionWithBOM(),c=a.textarea.value;c=c.substring(0,b-1)+c.substring(b),a.textarea.value=c}},{key:"deleteNextCharacter",value:function(){var a=this,b=a.getCursorPositionWithBOM(),c=a.textarea.value;c=c.substring(0,b)+c.substring(b+1),a.textarea.value=c}},{key:"replaceSelectedTextWith",value:function(a){var b=this,c=b.textarea;b.replaceTextRangeWith(a,c.selectionStart,c.selectionEnd,{silent:!0})}},{key:"replaceTextRangeWith",value:function(a,b,c,e){var f=this,g=f.textarea;e=e||{};var h=g.value;h=h.substring(0,b)+a+h.substring(c);var i=g.selectionEnd;i+=a.length-(c-b),g.value=h,f.setCursorPosition(i),e.silent||setTimeout(function(){d.element(f).triggerHandler(k.textChanged)},0)}},{key:"insertTextAt",value:function(a,b){var c=this,d=c.textarea,e=d.value;e=e.substring(0,d.selectionStart)+a+e.substring(d.selectionEnd),b+=a.length,d.value=e,c.setCursorPosition(b)}},{key:"handleInputEvent",value:function(){var a=this;a.checkCursorPositionAndAdjust(),a.syncText(),setTimeout(function(){d.element(a).triggerHandler(k.textChanged)},0)}},{key:"handleKeyDownEvent",value:function(a){var b=this,c=a.keyCode||a.which,e=b.getCursorPositionWithBOM(),g=!1,h=a.metaKey,i=a.shiftKey,l=a.ctrlKey,m=b.textarea.value,n=m.charAt(e-1),o=m.charAt(e);c===j.LEFT&&n===f&&(h||l||(i?b.textarea.selectionStart-=1:(b.setCursorPosition(e-1),g=!0))),c===j.BACKSPACE&&n===f&&(l||h||(b.setCursorPosition(e-1),b.deletePreviousCharacter(),b.syncText(),g=!0,setTimeout(function(){d.element(b).triggerHandler(k.textChanged)},0))),c===j.RIGHT&&o===f&&(e=b.getCursorPositionWithBOM(!0),h||l||(i?b.textarea.selectionEnd+=1:(b.setCursorPosition(e+2),g=!0))),c===j.DELETE&&o===f&&!l&&h&&(b.setCursorPosition(e+1),b.deleteNextCharacter(),b.syncText(),g=!0,setTimeout(function(){d.element(b).triggerHandler(k.textChanged)},0)),g&&(a.preventDefault(),b.checkCursorPositionAndAdjust())}},{key:"handleKeyUpEvent",value:function(a){var b=this,c=a.shiftKey;c||b.checkCursorPositionAndAdjust()}},{key:"handleClickEvent",value:function(){var a=this;a.checkCursorPositionAndAdjust()}},{key:"handlePasteEvent",value:function(a){var b=this,c=b.textarea;a=a.originalEvent||a;var e=a.clipboardData||window.clipboardData,f=e.getData("text/plain")||e.getData("Text")||"";f=i(f),c.selectionStart!==c.selectionEnd?b.replaceSelectedTextWith(f):b.insertTextAt(f,b.getCursorPositionWithBOM()),b.syncText(),b.checkCursorPositionAndAdjust(),a.preventDefault(),setTimeout(function(){d.element(b).triggerHandler(k.textChanged)},0)}},{key:"bindEvents",value:function(){var a=this;a.handleInputEvent=a.handleInputEvent.bind(a),d.element(a.textarea).on("input",a.handleInputEvent),a.handleKeyDownEvent=a.handleKeyDownEvent.bind(a),d.element(a.textarea).on("keydown",a.handleKeyDownEvent),a.handleKeyUpEvent=a.handleKeyUpEvent.bind(a),d.element(a.textarea).on("keyup",a.handleKeyUpEvent),a.handleClickEvent=a.handleClickEvent.bind(a),d.element(a.textarea).on("click",a.handleClickEvent),a.handlePasteEvent=a.handlePasteEvent.bind(a),d.element(a.textarea).on("paste",a.handlePasteEvent),a.textAreaScrollHandler=a.textAreaScrollHandler.bind(a),d.element(a.textarea).on("scroll",a.textAreaScrollHandler)}},{key:"unbindEvents",value:function(){var a=this;d.element(a.textarea).off("input",a.handleInputEvent),d.element(a.textarea).off("keydown",a.handleKeyDownEvent),d.element(a.textarea).off("keyup",a.handleKeyUpEvent),d.element(a.textarea).off("click",a.handleClickEvent),d.element(a.textarea).off("paste",a.handlePasteEvent),d.element(a.textarea).off("scroll",a.textAreaScrollHandler)}},{key:"getText",value:function(){var a=this,b=a.textarea.value;return i(b)}},{key:"setText",value:function(a,b){b=b||{};var c=this;c.textarea.value=i(a),b.silent!==!0&&c.syncText(),setTimeout(function(){d.element(c).triggerHandler(k.textChanged)},0)}},{key:"sortMetaBlocks",value:function(){var a=this;a.metaBlocks=a.metaBlocks.sort(function(a,b){return a.start>b.start?1:a.start<b.start?-1:0})}},{key:"setMetaBlocks",value:function(a,b){b=b||{};var c=this;c.metaBlocks=[],a=a||[],a.forEach(function(a){c.addMetaBlock(a,b)}),b.silent!==!0&&c.syncText()}},{key:"getMetaBlocks",value:function(){var a=this,b=a.metaBlocks.map(function(a,b){return{text:a.text,id:a.id,type:a.type,data:a.data,start:a.start-a.bomOffset-1,end:a.end-a.bomOffset-1}});return b}},{key:"bomCountBeforeIndex",value:function(a){var b=this,c=b.textarea.value.substring(0,a),d=i(c);return c.length-d.length}},{key:"bomCountAfterIndex",value:function(a){var b=this,c=b.textarea.value.substring(a),d=i(c);return c.length-d.length}},{key:"addMetaBlock",value:function(a,b){var c=this;b=b||{};var e=c.textarea.value,g=i(e);if(!a.id)return!1;if(a.start>=a.end)return!1;if(a.text.length!==a.end-a.start)return!1;if(a.text!==g.substring(a.start,a.end))return!1;var h=c.bomCountBeforeIndex(a.start),j=h+a.start;e=e.substring(0,j)+f+e.substring(j);var l=j+1+a.text.length;return c.textarea.value=e,c.setCursorPosition(l),c.updateMetaBlocks({mode:"add-block"}),c.metaBlocks.push({start:a.start,end:a.end,text:a.text,data:a.data,type:a.type,id:a.id,bomOffset:h}),c.sortMetaBlocks(),b.silent!==!0&&c.syncText(),b.silent!==!0&&setTimeout(function(){d.element(c).triggerHandler(k.blockAdded,a)},0),c.checkCursorPositionAndAdjust(),!0}},{key:"removeMetaBlock",value:function(a,b){var c=this;b=b||{};var e=-1;c.metaBlocks.forEach(function(b,c){e===-1&&a===b.id&&(e=c)});var f=null;return e!==-1&&(f=c.metaBlocks.splice(e,1)),b.silent!==!0&&c.syncText(),b.silent!==!0&&setTimeout(function(){d.element(c).triggerHandler(k.blockRemoved,f)},0),f}},{key:"getBackgroundContentClass",value:function(){return l}},{key:"renderBackground",value:function(a){var b=this,c=b.refs,d=b.getBackgroundContentClass();ReactDOM.render(React.createElement(d,{text:b.getText(),metaBlocks:b.getMetaBlocks()}),c.background)}},{key:"updateMetaBlocks",value:function(a){var b=this;a=a||{};var c=b.textarea.value,d=0;b.metaBlocks.forEach(function(a,e){var g=a.text,h=c.indexOf(f+g,d);h===-1?a.invalid=!0:(a.start=h+1,a.end=h+1+g.length,a.bomOffset=b.bomCountBeforeIndex(h)),d=a.end});var e=b.metaBlocks.filter(function(a,b){return a.invalid});if(b.metaBlocks=b.metaBlocks.filter(function(a,b){return!a.invalid}),"add-block"!==a.mode){for(var g=[],h=new RegExp(f,"gm"),i=h.exec(c);null!==i;)g.push(i.index+1),i=h.exec(c);var j=b.metaBlocks.map(function(a){return a.start}),k=_.difference(g,j),l=0;k.forEach(function(a){a-=l,b.replaceTextRangeWith("",a-1,a),l++})}return e}},{key:"syncText",value:function(){var a=this,b=a.updateMetaBlocks();b.forEach(function(b){setTimeout(function(){d.element(a).triggerHandler(k.blockRemoved,b)},0)}),a.renderBackground();var c=a.textarea.getBoundingClientRect(),e=a.refs.background.getBoundingClientRect();d.setStyle(a.refs.textarea,{height:e.height+"px"}),c.height!==e.height&&setTimeout(function(){d.element(a).triggerHandler(k.heightChanged,{currentHeight:e.height,previousHeight:c.height,change:e.height-c.height})},0)}},{key:"destroy",value:function(){var a=this;a.unbindEvents(),ReactDOM.unmountComponentAtNode(a.refs.background),d.unmount(a.dom,!0),a.dom=null,a.textarea=null,a.refs=null,a.metaBlocks=null}},{key:"getCurrentTypingWord",value:function(){var a=this,b=a.getText().substr(0,a.getCursorPosition()),c=/(?:(?=\s*)([\S]+[^\S\n]*)$)/i,d=c.exec(b),e=d?d[1]:" ";return e}},{key:"getCurrentWordBounds",value:function(){var a=this;return c.findCursorPosition(a.textarea)}},{key:"textAreaScrollHandler",value:function(){var a=this,b=a.refs;a.maxHeightActive&&(b.background.scrollTop=b.textarea.scrollTop)}},{key:"setMaxHeight",value:function(a){var b=this;a=a||{};var c=a.maxHeight;!window.isFinite(c)||c<1||(d.setStyle(b.refs.textarea,{maxHeight:c+"px",overflowY:"auto"}),d.setStyle(b.refs.background,{maxHeight:c+"px",overflowY:"hidden"}),b.maxHeightActive=!0)}},{key:"resetMaxHeight",value:function(){var a=this;d.setStyle(a.refs.textarea,{maxHeight:"",overflowY:"hidden"}),d.setStyle(a.refs.background,{maxHeight:"",overflowY:"hidden"}),a.maxHeightActive=!1}}]),a}();return m.KEYS=j,m.EVENTS=k,m.BackgroundContent=l,e.BaseEditor=m,e.BaseEditor});