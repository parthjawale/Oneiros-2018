"use strict";window.zmStreamsApp=window.zmStreamsApp||{},window.zmStreamsApp.CommentModule=function(a){var b=a.models,c=a.views,d=zmStreamsApp.constants.notifications,e=function(a,c){var d=["commentAdd"],e=c.gid+"#"+c.pid;if(d.indexOf(c.key)!==-1&&b.comments){var f=_.find(b.comments.models,function(a){return a.id===c.pid});f||(f=_.find(b.comments.models,function(a){return a.id===e})),f&&(c.data&&c.data.cmnt?f.updateModel({comment:c.data.cmnt},f,"add"):f.getsinglecomment(c.cid,"","update"))}},f=function(a){var c;c=a.group?a.group.id?a.group.id:a.group:zmail.zuid,a.eid&&a.eid.indexOf("#")===-1&&c&&(a.eid=c+"#"+a.eid);var d;return b&&b.comments&&(d=_.find(b.comments.models,function(b){return b.id===a.eid})),d};a.updateInvitees=function(a){var b=f(a);if(b){var c="",d="";"addInvitee"===a.type?c=a.inviteeList:d=a.inviteeList,b.trigger("change:inviteeList",c,d)}},a.removeViews=function(a){var b,c;_.each(a,function(a){b=$(a).data();var d=f({eid:b.id});d&&(c=d.getView(b.commentviewid),c.onClose())})},a.retainComment=function(a){var b=$(a).find(".sc_cmdv.SCS_cmnt");if(b.length){var c,d=$(b[0]).data(),e=f({eid:d.id});if(e&&(c=e.getView(d.commentviewid))){var g=a.getElementsByTagName("TEXTAREA")[0];g&&c.saveUnpost(g)}}},$.subscribe("zmstreamsapp/postactions",e),"undefined"!=typeof zmComponent&&zmComponent.notifier&&zmComponent.notifier.addHandler("streams",function(a,b){b=b.data||{},b=_zm.copyOf(b),"string"==typeof b.group&&(b.group=$.parseJSON(b.group));var c=b.ntype,g=c===d.add_comment||c===d.comment_group_mention||c===d.comment_mention;g&&e("",{key:"commentAdd",pid:b.eid,cid:b.commentuuid,gid:b.group.id});var h=f(b);if(h){var i=c===d.like_comment,j=c===d.unlike_comment;if(i||j){var k=h.pickComment(b.commentuuid).index,l=_zm.copyOf(h.get("comments"));if(k!==-1){var m=l[k].liked;b.nby===zmail.zuid&&m!==i&&(l[k].liked=i);var n=l[k].likes;n=i?n+1:n-1,l[k].likes=n;var o=l[k].likeList||{},p=o.hasOwnProperty(b.nby);if(i)if(p)_.size(o)&&(l[k].likes=n-1);else{var q=_.isArray(b.nBy)?b.nBy[0]:JSON.parse(b.nBy)[0],r=q[b.nby]||"";o[b.nby]=r}else j&&(p?delete o[b.nby]:_.size(o)&&(l[k].likes=n+1));l[k].likeList=o,h.set("comments",l),h.trigger("change:like",b.commentuuid)}}if(c===d.add_private_comment){var s={parentuuid:b.parentuuid,by:b.nby};h.getsinglecomment(b.commentuuid,"","wmsprivatecomment",s)}c===d.delete_comment&&h.pickComment(b.commentuuid).index!==-1&&h.updateModel({comment:b},h,"del"),c===d.delete_post&&h.set("isDeleted",!0),c===d.delete_private_comment&&h.updateModel({comment:b},h,"deletePrivate")}});var g=function(a,b,d,e,f,g){var h=new c.Comment({model:a,postElm:b,highlightComment:d,viewJSON:e,isNewCollabUser:f,hideComponent:g});return h.$el};return a.init=function(c,d,e){"undefined"!=typeof zmStreamsApp.GroupApp&&zmStreamsApp.GroupApp.fetchHashTags(),b.comments||(b.comments=new b.CommentCollection({})),a.resizeFn=c.resizeComment,c.parentElm=d;var h,i,j,k=c.isNewCollabUser,l=c.hideComponent,m=f({eid:c.id,group:c.groupId});if(m){j=m,i=zmStreamsApp.CommentModule.parseInput(c,!0),j.set("attachIndex",i.attachIndex+1);var n=i.comments;if(m.set({privateToOwner:i.privateToOwner,mention:i.mention,inviteeList:i.inviteeList}),i.groupsMention&&m.set("groupsMention",i.groupsMention),c.cached)i=void 0;else if(n.length>m.get("comments").length||i.total!==m.get("total"))m.set({comments:n,total:i.total});else if(n.length){for(var o,p=_zm.copyOf(m.get("comments")),q=0;q<n.length;q++)o=m.pickComment(n[q].id),o.index!==-1&&(p[o.index]=_zm.copyOf(n[q]));m.set("comments",p)}}else j=new b.Comments(c,{parse:!0}),b.comments.add(j);return j.get("fetchData")&&j.listAll(),h=g(j,d,e,i,k,l)},a.getCommentTemplate=function(b){var c=a.templates.comments(b);$(b.elm).append(c)},a.sendPrivateToOwner=function(a,c,d){if(d)d.addNewPrivate(c);else{var e=_.find(b.comments.models,function(b){return b.id===a});e.trigger("add:commenttoowner",c)}},a.disableComments=function(a,c){var d=_.find(b.comments.models,function(b){return b.id===a});d.set("disableComment",c),d.trigger("change:disableComment",c)},a.setMentions=function(a,c){var d=_.find(b.comments.models,function(b){return b.id===a});d.set("mention",c,{silent:!0}),"org"!==c&&(c=_.without(c,zmail.zuid)),d.trigger("change:mentionData",c)},a.getLockValue=function(a){var c;b&&b.comments&&(c=_.find(b.comments.models,function(b){return b.id===a}));var d=!1;return c&&(d=c.get("lockInvites")),d},$.subscribe("/mail/selectMail",function(a,b){var c=$(b.containerDOM).find(".sc_cmdv.SCS_cmnt").data(),d=f({eid:c.id});if(d){var e=d.getView(c.commentviewid);e&&e.selectMail(b.mailID,b.mode)}}),a}(zmStreamsApp.CommentModule||Zmail.App.extend({})),function(){var a=zmText.get("streams");window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.CommentModule=function(a){return a}(zmStreamsApp.CommentModule||Zmail.App.extend({})),zmStreamsApp.CommentModule.unPost={},zmStreamsApp.CommentModule.models=function(b){var c=zmStreamsApp.CommentModule;return b.Comments=Zmail.Model.extend({defaults:{eid:0},url:zmail.conPath+"/comment.do",serialized:function(a,b){var c={},d=this,e=b.mentions,f=b.commentId,g=this.get("shId"),h=b.parent;switch(b.callback=this.updateModel,a){case"addComment":if(c={mode:"add",mentions:e.mention,comments:b.text,actionType:"addComment"},b.replyTo&&(c.replyTo=b.replyTo),e.mention.length){var i=e.offset;c.offsetstarts=i.from,c.offsetends=i.to,c.offsettexts=i.text}b.attTmpObj&&(c.attTmpObj=b.attTmpObj),b.attEntObj&&(c.attEntObj=b.attEntObj),b.linkData&&zmStreamsApp.linkPreview.addDataToParams(b.linkData,c),this.get("isSharedFolder")&&(c.shId=g);break;case"likeComment":c={mode:"like",like:b.like,actionType:b.actionType,authorZuid:b.author,commentId:f},b.setSessionId=!0;break;case"getAllComments":this.get("fetchData")?(c={accId:zmail.accId,comments:!0},b.url=zmail.conPath+"/mailComments.do"):(c={mode:"list",start:f,actionType:this.get("actionType"),count:11},b.extraParamObj={elm:b.elm});break;case"delete":c={mode:"del",actionType:"deleteComment",commentId:f},this.get("isSharedFolder")&&(c.shId=g),b.setSessionId=!0;break;case"addPrivate":c={mode:"add",actionType:"addComment",comments:b.comment,privateZuid:b.toZid,parentId:h},h&&"undefined"!==h||(c.isPrivateToPost=!0),b.setSessionId=!0;break;case"getLikes":c={mode:"like",actionType:"viewGroupEntity",commentId:f},b.extraParamObj={elm:b.elm};break;case"getsinglecomment":c={mode:"singlecomment",actionType:"viewGroupEntity",commentId:f},b.error=function(){};break;case"getRecipientsForMail":c={mailID:this.getUnparsedId(),useConversation:!1,zohoID:zmail.zuid,accountID:zmail.accId,requiredData:"recipientList",mode:"getMailShareData"},b.url=zmail.conPath+"/mailCollab.do"}var j;return b.url.indexOf("mailComments.do")===-1?c.streamsView=!0:j="list",b.success=function(a){b.callback(a,d,j,b.ep)},b.url.indexOf("mailCollab.do")===-1&&(c.groupId=this.get("groupId"),c.entityType=this.get("etype"),c.entityId=this.getUnparsedId()),c},getUnparsedId:function(){var a=this.id;return a&&a.indexOf("#")!==-1&&(a=a.substring(a.indexOf("#")+1,a.length)),a},setView:function(a,b){var c=this.get("views")||{};c[a]=b,this.set("views",c)},getView:function(a){var b=this.get("views")||{};return b[a]},removeView:function(a){var b=this.get("views")||{};delete b[a],_.isEmpty(b)&&this.trigger("destroy",this)},sendPrivate:function(a,b,c,d){this.sync("addPrivate",this,{parent:b,comment:a,toZid:c,error:d})},listAll:function(a,b,c){var d=this.pickComment(a).index,e=this.get("total");if(a&&d!==-1&&b!==e){var f=this.get("comments").length,g=b+11>e?e-b:11;if(f===e&&b+g<=f)return void this.trigger("change:listAll",a,c,!0)}return this.sync("getAllComments",this,{commentId:a,elm:c,error:function(a){_zm.succErrMsg("e",a.msg),c.removeClass("zmLock")}})},remove:function(a,b,c){return this.sync("delete",this,{commentId:a,isPrivate:b,parentId:c})},NewComment:function(b){var c=this,d=c.get("createEntityDeferredCallback");return b=b||{},b.error=b.error||function(){},"function"!=typeof d?void c.sync("addComment",c,b):(c.set("lockInvites",b.lockInvites),void d({mentions:b.sharedMailInvitees||b.mentions.mention,includeRecipients:b.includeRecipients,lockInvites:b.lockInvites,selectedMailIds:b.selectedMailIds}).done(function(){c.set("sharedApiCall",!1),c.set("createEntityDeferredCallback",void 0),c.set("entityExists",!0),c.get("isDraftShare")&&$.publish("/streams/draftShared",{draftId:c.getUnparsedId()}),c.sync("addComment",c,b)}).fail(function(c){c=c||{},c.error=c.error||{},c.error.message=c.error.message||a.common.labels.unknown,c.error.messageOpts=c.error.messageOpts||{},c.error.suppress=c.error.suppress||!1,c.error.messageOpts.suppress=c.error.suppress,b.error({message:c.error.message||a.common.labels.createCommentFail},c.error.messageOpts)}))},pickComment:function(a){var b=this.get("comments"),c=_.pluck(b,"id").indexOf(a),d=b[c];return{commentObj:d,index:c}},getsinglecomment:function(a,b,c,d){var e=this.pickComment(a),f=this.get("replyTo"),g=_.pluck(f,"id").indexOf(a);if(e.index!==-1)return e.commentObj;if("popup"===c&&g!==-1)return f[g];if("wmsprivatecomment"===c){var h=this.getPvtComments(d.parentuuid);d.parentuuid&&(h=h["private"]);var i=[];for(var j in h)i=i.concat(h[j]);if(g=_.pluck(i,"id").indexOf(a),g!==-1)return h[g]}this.sync("getsinglecomment",this,{commentId:a,ep:{elm:b,type:c,dataObj:d}})},likeComment:function(a,b){var c=this.pickComment(a).commentObj,d=!c.liked,e=c.by,f=d?"likecomment":"unlikecomment";return this.sync("likeComment",this,{commentId:a,like:d,author:e,actionType:f,error:function(){b.removeClass("zmLockLike")}})},getRecipientsForMail:function(){var a=this.get("recipientList");if(a){var b=a[0].orgUsers||[];return b}this.sync("getRecipientsForMail",this,{mailID:this.getUnparsedId(),useConversation:!1,zohoID:zmail.zuid,accountID:zmail.accId,requiredData:"recipientList"})},getPvtComments:function(a){var b={};return b=a?this.pickComment(a).commentObj:this.get("privateToOwner")},updateModel:function(a,b,c,d){if(c=c||this.data.mode,this.data){var e=this.data.mode;c="add"===e&&this.data.privateZuid||d&&"wmsprivatecomment"===d.type?"addPrivate":e,c="like"===e&&void 0===this.data.like?"getLikes":c}d&&"wmsprivatecomment"===d.type&&(this.data.parentId=d.dataObj.parentuuid,this.data.privateZuid=d.dataObj.by),"deletePrivate"===c&&(this.isPrivate=!0,c="del");var f,g=_zm.copyOf(b.get("comments")),h=this.data?this.data.commentId:"",i=b.get("miscData"),j=i&&i.mailID?i.mailID:"";switch(c){case"add":var k=a.comment,l=g;f=b.get("total"),l.push(k),f=isNaN(f)?l.length:f+1,b.set({total:f,comments:l}),$.publish("/streams/comment",{mode:"add",entityId:b.getUnparsedId(),etype:b.get("etype"),total:f,mailID:j}),b.get("sharedCall")||k.by!==zmail.zuid||b.get("isSharedFolder")||zmStreamsApp.PostApp.watchPost({gid:b.get("groupId"),pid:b.get("id")}),b.trigger("change:add");break;case"like":var m=b.pickComment(h).index,n=b.get("comments");n[m].liked=this.data.like;var o=n[m].likeList||{},p=o.hasOwnProperty(zmail.zuid),q=this.data.like;if(q&&!p||!q&&p){var r=n[m].likes;if(r=q?r+1:r-1,n[m].likes=r,q){var s=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid];o[zmail.zuid]=s.fn}else delete o[zmail.zuid];n[m].likeList=o}b.set("comments",n),b.trigger("change:like",h);break;case"list":var t=g;a=a.comment?a.comment:a;var u=a.order,v=a.comments,w=_(u).map(function(a,b){var c=v[a];return c.sequence=b+1,c});for(var x in t)u.indexOf(t[x].id)===-1&&w.push(t[x]);b.set("comments",w,{silent:!0}),b.trigger("change:listAll",h,this.extraParamObj.elm);break;case"del":var y,z,A=h;!h&&a.comment&&(A=a.comment.commentuuid,y=a.comment.parentuuid);var B=b.pickComment(A).index,C=this.isPrivate,D=this.parentId||y;if(B!==-1)f=b.get("total"),l=g,l.splice(B,1),f=isNaN(f)?l.length:f-1,b.set({total:f,comments:l}),$.publish("/streams/comment",{mode:"delete",entityId:b.getUnparsedId(),total:f,etype:b.get("etype"),mailID:j});else if(C){var E=g;z=!D;var F,G,H,I=z?{}:b.pickComment(D),J=z?b.get("privateToOwner"):I.commentObj["private"];for(var K in J)if(F=$.isArray(J[K])?J[K]:[J[K]],G=_.pluck(F,"id"),H=G.indexOf(A),H!==-1){F.splice(H,1),z?F.length?J[K]=F:delete J[K]:F.length?E[I.index]["private"][K]=F:delete E[I.index]["private"][K],b.set("comments",E);break}}b.trigger("change:removeComment",A,C,z);break;case"addPrivate":var L,M,N,O,P,Q=a.comment.isprivateToPost,R="private";if(Q?(L=b.get("privateToOwner")||{},M=b.get("owner")===zmail.zuid?this.data.privateZuid:zmail.zuid):(P=this.data.parentId,O=b.pickComment(P),M=O.commentObj.by===zmail.zuid?String(this.data.privateZuid):zmail.zuid,L=O.commentObj[R]||{}),N=$.isEmptyObject(L))L[M]=[],L[M].push(a.comment),Q||(l=g,O.commentObj[R]=L,l[O.index]=O.commentObj,b.set("comments",l));else{if(!$.isArray(L[M])){var S=L[M];void 0===S?L[M]=[]:L[M]=[S]}L[M].push(a.comment)}Q&&b.set("privateToOwner",L),b.trigger("add:privateComment",Q,a.comment,this.data.parentId,N,M);break;case"getLikes":var T=b.pickComment(h).index,U=b.get("comments"),V=U[T].likeList||{},W=a.users;V&&_.size(V)&&$.extend(W,V),U[T].likeList=W,U[T].likes=_.size(W),b.set("comments",U),b.trigger("change:getLikes",h,this.extraParamObj.elm);break;case"singlecomment":var X=a.comment;if("popup"===d.type)l=b.get("replyTo")||[],l.push(X),b.set({replyTo:l});else{var Y=b.pickComment(X.id).index;if(Y===-1){l=g,l.push(X);var Z=b.get("total");b.set({comments:l,total:Z+1}),$.publish("/streams/comment",{mode:"add",entityId:b.getUnparsedId(),etype:b.get("etype"),total:b.get("total"),mailID:j})}}b.trigger("change:singlecomment",h,d);break;case"getMailShareData":b.set("recipientList",a.recipientList)}},parse:function(a){var b=a.id;b.indexOf("#")===-1&&(a.id=a.groupId+"#"+b);var d=c.parseInput(a,!0);return d.attachIndex=0,d}}),b.CommentCollection=Zmail.Collection.extend({model:b.Comments,url:"/zm/stream.do",addModel:function(a,b,c){return this.remove(a,{silent:c}),this.add(a,{at:b,silent:c}),this}}),b}(zmStreamsApp.CommentModule.models)}(),zmStreamsApp.CommentModule.parseInput=function(a,b){var c=a.comments||{},d=c.comments,e=c.order||[],f=_(e).map(function(a,b){var c=d[a];return c.sequence=b+1,c});void 0===a.streamsEnabled&&(a.streamsEnabled=!0);var g=c.total||e.length||a.total,h={total:g,parentElement:a.parentElm,id:a.id,groupId:a.groupId,mention:a.mentions,etype:a.etype,owner:a.owner,privateToOwner:a.privateToOwner,actionType:a.actionType||"viewGroupEntity",sharedCall:a.sharedCall||!1,groupsMention:a.groupsMention||!1,placeHolder:a.placeHolder,isSharedFolder:a.isSharedFolder,shId:a.shId,disableComment:a.disableComment,fixedComment:a.fixedComment||!1,fixedElement:a.fixedElement,miscData:a.miscData||{},sharedApiCall:a.sharedApiCall||!1,createEntityDeferredCallback:a.createEntityDeferredCallback,isDraftShare:a.isDraftShare||!1,entityExists:a.entityExists||!1,fetchData:void 0===a.comments,shGroup:a.shGroup||[],shOwner:a.shOwner,inviteeList:a.inviteeList,recipientList:a.recipientList,openedId:a.openedId,sharedFolderUsers:a.sharedUsers,streamsEnabled:a.streamsEnabled,sharedToMe:a.sharedToMe};return f&&b&&(h.comments=f),h},window.zmStreamsApp=window.zmStreamsApp||{},zmStreamsApp.CommentModule.templates=function(){var a,b={},c=zmStreamsApp.template,d=zmText.get("streams"),e=!0;return b.comments=function(c,f,g,h){var i=c.id,j=c.comments,k=c.fixedComment||!1,l=c.isShare||!1,m=c.disableComment||!1,n=c.placeHolder;e=c.streamsEnabled,a=c.etype;var o=k?"fixedComment":"",p=["UL",{attrs:{"class":"Stcmt cmnt_ul","data-type":o,"data-sharedview":c.sharedCall}}],q=_zm.getDOM(p);if(c.notifyId=g,b.commentList(c,q),!k&&!m&&!c.isDisableAdd){var r=b.newcomment({cid:i,sharedCall:c.sharedCall,sharedApiCall:c.sharedApiCall,entityExists:c.entityExists,isDraftShare:c.isDraftShare,attId:f,placeHolder:n,fixedComment:!1,isShare:l});q.appendChild(_zm.getDOM(r))}var s=j.length,t=c.total-s,u=_zm.getDOM(["DIV",{attrs:{"class":"sc_cmdv SCS_cmnt"}}]);if((c.sharedCall||c.isSharedFolder)&&s&&!c.isDraftShare&&u.appendChild(b.commentHeader()),c.privateToOwner){var v=b.privateToOwner(c.privateToOwner,c.owner,g,c.disableComment,c.parentElement);u.appendChild(v)}if(c.isDraftShare&&!s&&h&&(c.entityExists?u.appendChild(b.draftNoComment()):u.appendChild(b.addInvComment())),t){var w=c.comments[0]?c.comments[0].id:"";u.appendChild(b.viewmore(zmText.applyArgs(d.common.labels.viewMoreComments,{count:t}),w,s))}return u.appendChild(q),u},b.draftNoComment=function(){return _zm.getDOM(["DIV",{attrs:{"class":"zmNoCmnt greyText"},child:[["I",{attrs:{"class":"msi-comment"}}],["DIV",{child:[["text",d.common.labels.nocomments]]}]]}])},b.addInvComment=function(){return zdom("div",{className:"zmNoCmnt greyText"},zdom("i",{className:"msi-addgroup"}),zdom("div",null,d.common.labels.draftShare),zdom("div",null,d.common.labels.draftShareMsg))},b.commentHeader=function(){return _zm.getDOM(["DIV",{attrs:{"class":"cmntLabel"},child:[["text",d.common.labels.comments]]}])},b.commentList=function(a,c){for(var e,f=a.comments,g=a.notifyId,h=a.disableComment||!1,i=0;i<f.length;i++)if(e=f[i],e.user)c.appendChild(b.comment(e,a)),e["private"]&&!a.isPrint&&b.privateCommentBlock(c,e,"","",g,h);else{var j=e.by||"",k=e.name||(zmStreamsApp.util.getContactDetails([j])[j]||{}).fn||d.common.labels.unknown,l=e.text||"";c.appendChild(b.systemComment(k,l))}},b.quotedCommentList=function(a,c,d){for(var e,f=0;f<a.length;f++)e=a[f],c.appendChild(b.quoteComment(e,a,d))},b.fixedComment=function(a){var c=a.isNewCollabUser?[]:["UL",{attrs:{"class":"Stcmt"}}],d=a.isNewCollabUser?" zmCmntFixed inputFocus":"";d=a.totalCount>0?d+" cmntInfoWra inputFocus":d;var e=["DIV",{attrs:{"class":"SCS_cmnt zms_fixed"+d,type:"notification"},child:[c]}],f=_zm.getDOM(e),g=b.newcomment(a);if(a.isNewCollabUser){a.totalCount>0&&f.appendChild(_zm.getDOM(b.commentInfo(a.totalCount))),f.appendChild(g);var h=b.commentActions(a);if(h.style.display="none",f.appendChild(h),!zmUtil.isChildWindow()&&!a.isDraftShare){var i,j=parseInt(zmAdHocSettings.getMailPreviewSize());i=zmsuite.getCenter()[0].$el.width(),j=zmsuite.getCenter()[1].$el.hasClass("SC_w100")?100:j,f.style.width=i*j/100-20+"px"}}else{var k=$(f).find(".Stcmt");$(k).append($(g))}return f},b.commentInfo=function(a){var b=["DIV",{attrs:{"class":"cmntInfo"},child:[["I",{attrs:{"class":"msi-comment zm_shrnk"}}],["SPAN",{attrs:{"class":"StCnt zm_dIB"},child:[["text",a]]}]]}];return b},b.commentActions=function(a){var c=a.entityExists||a.isDraftShare||a.isShare?[]:["SPAN",{attrs:{"class":"zm_dIB zm_inclr zm_shrnk SC_dyn"},child:[["I",{attrs:{"class":"msi-uncheck zm_shrnk"}}],["text",d.common.labels.includeEveryoneNew]]}],e={},f=a.entityExists?[]:["B",{attrs:{"class":"lockClass mailSharedLock zm_shrnk"},child:[["I",{attrs:{"class":"msi-Ainvitee inviteeColor zm_shrnk"}}]]}],g=a.totalCount?b.commentInfo(a.totalCount):[];e=a.entityExists?{}:a.placeHolder;var h="function"==typeof e.button?e.button():e.button;h=h||d.streams.common.comment;var i=a.isShare?a.sharedFolderUsers:a.inviteeList;i=i||[];var j=i?i.length:0,k=j?b.addInviteeList(zmStreamsApp.util.getContactDetails(i)):[],l=b.getInviteeFontDOM(j),m=["DIV",{attrs:{"class":"cmntActions"},child:[["DIV",{attrs:{"class":"SC_flt"},child:[["DIV",{attrs:{"class":"SCS_postAct zm_dIB"},child:[["DIV",{attrs:{"class":"cmAct"},child:[["DIV",{attrs:{"class":"mailAct"},child:[["I",{attrs:{"class":"msi-attachment zmst_attach zm_shrnk"}}],["DIV",{attrs:{"class":"SC_SLine"}}],g,["UL",{attrs:{"class":"inviteeList invitedList zm_shrnk"},child:[k]}],l,["DIV",{attrs:{"class":"SC_SDot SC_dyn"}}],c]}]]}]]}]]}],["DIV",{attrs:{"class":"SC_frt"},child:[["DIV",{attrs:{"class":"zm_dIB zm_slc"},child:[["DIV",{attrs:{style:"display:none;","class":"SC_SDot"}}],f]}],["DIV",{attrs:{"class":"SC_PUbtm zm_dIB"},child:[["SPAN",{attrs:{"class":"sel addcomnt zm_shrnk"},child:[["text",h]]}]]}]]}]]}];return _zm.getDOM(m)},b.privateCommentBlock=function(a,c,e,f,g,h,i,j,k){var l,m=_zm.getDOM(["LI",{attrs:{"class":"pvtMsg"}}]),n="private";i?a.after(m):a.appendChild(m);var o=e?c:c[n],p=e?f:c.by,q=e?"":c.id,r="",s={};for(r in o)o[r]&&(s.recepient=r,s.replyTo=zmail.zuid===r?p:r,m.appendChild(b.private_comments(q,s,o[r],!1,e,g,h)));var t=!1;if(g)for(var u in o)if(o[u]instanceof Array){for(var v=0,w=o[u].length;v<w;v++)if(o[u][v].id===g){t=!0;break}}else if(o[u].id===g){t=!0;break}if(j||t){if(e&&k)l=$(k).find(".ShwPrv"),l.length&&(l[0].childNodes[1].textContent=d.common.labels.hidePrivateComments);else if(l=$(a).find(".zms_comment"),l.length){var x=$(l[l.length-1]).find(".ShwPrv");x[0].childNodes[1].textContent=d.common.labels.hidePrivateComments}}else e?$(m).parent("ul.pvtOwn")[0].style.display="none":m.style.display="none"},b.newcomment=function(a){var b=a.cid,c=a.attId,e=a.fixedComment,f=a.placeHolder,g=a.entityExists,h=a.sharedApiCall,i=a.isDraftShare,j=a.isNewCollabUser,k=a.isShare;c="p"+b+c;var l=e?"fixed":"";c=c.substring(c.indexOf("#")+1,c.length),f=g?{}:f,f=f||{},f.button=f.button||d.streams.common.comment,f.textArea=f.textArea||d.common.labels.writeComment;var m="function"==typeof f.button?f.button():f.button,n="function"==typeof f.textArea?f.textArea():f.textArea,o=k?[]:["I",{attrs:{"class":"msi-attachment zmst_attach SC_flt zm_shrnk"}}],p=j?"":"display:none",q=!j||g||i?[]:["DIV",{attrs:{"class":"zm_inclr zm_dIB"},child:[["I",{attrs:{"class":"msi-uncheck"}}],["DIV",{attrs:{"class":"zm_dIB"},child:[["text",d.common.labels.includeEveryone]]}]]}],r=h||i&&!g?["DIV",{attrs:{"class":"SCmb mailSharedLock"},child:[["UL",{child:[["LI",{attrs:{"class":"SC_lbr"},child:[["B",{attrs:{"class":"lockClass"},child:[["I",{attrs:{"class":"msi-Ainvitee inviteeColor zm_shrnk"}}],["DIV",{attrs:{"class":"SC_hd"}}]]}]]}]]}]]}]:[],s=!e||!j||i||zmUtil.isChildWindow()||a.sharedToMe?[]:["DIV",{attrs:{"class":"zmCmntSC"},child:[["I",{attrs:{"class":"msi-comment mailCmnt zm_shrnk",style:"display:none"}}],["I",{attrs:{"class":"msi-notes noteCmnt zm_shrnk"}}],["I",{attrs:{"class":"msi-task taskcmnt zm_shrnk"}}]]}],t=["DIV",{attrs:{"class":"cmntText"},child:[["TEXTAREA",{attrs:{placeholder:n,id:"comnt_"+b,"data-attach":c,autocomplete:"off",autocorrect:"off","class":"zms_cmTxt",autocapitalize:"off","data-type":l}}],s,["I",{attrs:{"class":"msi-smiley zm_shrnk"}}]]}],u=["LI",{attrs:{type:"commentbox","class":"zms_txtLI"},child:[["DIV",{attrs:{"class":"zmImg"}}],t,["DIV",{attrs:{"class":"SC_PUbtm",style:p},child:[o,q,r,["SPAN",{attrs:{"class":"addcomnt sel"},child:[["text",m]]}]]}]]}],v=_zm.getDOM(u);if(e&&j)v=_zm.getDOM(t);else{var w=$(v).find(".zmImg"),x=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid];if(x.avatar)$(w[0]).replaceWith(x.avatar);else{var y=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(zmail.IAMFullName),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(w[0]).replaceWith(y)}}return v},b.groupDom=function(){return _zm.getDOM(["DIV",{attrs:{"class":"SCmb zm_dIB appGroup","data-grp":String(zmail.zuid)},child:[["UL",{child:[["LI",{attrs:{"class":"SCtxt"},child:[["B",{child:[["DIV",{attrs:{"class":"SC_hd"}}],["SPAN",{attrs:{"class":"zm_grptxt zm_shrnk"},child:[["text","Select a Group"],["I",{attrs:{"class":"msi-barrow"}}]]}]]}]]}]]}]]}])},b.getInviteeFontDOM=function(a){return a=a||0,zmStreamsApp.PostActions.template.getFontDOM(a,!0,!1,"inviteeList")},b.addInviteeList=function(a,c){var d,e=[],f=Object.keys(a).length,g=0;if(!$.isEmptyObject(a))for(d in a)g<3&&(e.push(["IMG",{attrs:{src:a[d].photo}}]),g++);var h=["LI",{child:e}];return c?(c=c.querySelector(".zms_fixed .inviteeList"),c.innerHTML="",c.appendChild(_zm.getDOM(h)),$(c).siblings("font.fontClass").remove(),$(c).after(_zm.getDOM(b.getInviteeFontDOM(f))),void 0):h},b.viewmore=function(a,b,c){var d=["DIV",{attrs:{"class":"cmntMore","data-cid":b,"data-count":c},child:[["I",{attrs:{"class":"msi-comment"}}],["text",a]]}];return _zm.getDOM(d)},b.createPrivate=function(a,b,c,e){var f=zmStreamsApp.util.getContactDetails([String(b)])[String(b)].fn,g=zmText.applyArgs(d.streams.post.pvtReply,{userName:f}),h="display:none",i="";c||(i="display:none",h="");var j=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid],k=[["LI",{attrs:{"class":"pvtRlyLi",style:i},child:[["DIV",{attrs:{"class":"zmImg"},child:[["IMG",{attrs:{src:j.photo}}]]}],["DIV",{child:[["DIV",{attrs:{"class":"cmntText"},child:[["INPUT",{attrs:{"class":"sfocus",placeholder:g,"data-z":b,"data-cid":a,autocomplete:"off",autocorrect:"off",autocapitalize:"off"}}]]}]]}]]}],["LI",{attrs:{"class":"pvtRlyLink",style:h},child:[["SPAN",{attrs:{"class":"SndPrvRep"},child:[["text",d.common.labels.reply]]}]]}]],l=_zm.getDOM(k),m=$(l).children().find(".zmImg");if(j.avatar)$(m[0]).replaceWith(j.avatar);else{var n=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(zmail.IAMFullName),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(m[0]).replaceWith(n)}var o,p=l;if(c){if(o=_zm.getDOM(["LI",{attrs:{"class":"pvtMsg"},child:[["UL",{attrs:{"class":"pvtOwn"}}]]}]),p=o,e){var q=_zm.getDOM(["UL",{attrs:{"class":"pvtOwn"}}]);q.appendChild(o),p=q}o.children[0].appendChild(l)}return p},b.comment=function(a,b){var e,f=a.id,g=a.by,h=zmStreamsApp.util.getContactDetails([String(g)])[g],i=a.text,j=h.zid===zmail.zuid?d.common.labels.me:h.fn||a.name,k=a.tags,l=b.id,m=b.notifyId,n=b.shOwner,o=b.isShare,p=b.groupId,q=[],r=":",s="";if("13"===b.etype&&a.commentType||(e={text:i,offset:k,group:l,span:a.replyTo,shGroup:b.shGroup,inviteeList:b.inviteeList},s=c.setOffsetValues(e)),a.replyTo){var t=a.replyToDisplayName+d.common.labels.apostrophes||"";a.replyToZuid===zmail.zuid&&(t=d.common.labels.your),q=_zm.getDOM(["SPAN",{attrs:{},child:[["text",d.common.labels.repliedTo+" "+t+" "],["SPAN",{attrs:{style:"text-decoration: underline;cursor:pointer","class":"zm_replyto","data-cid":a.replyTo},child:[["text",d.common.labels.commentSmall]]}],s]}]),r="",h.zid===zmail.zuid&&(j=d.common.labels.you)}else q=_zm.getDOM(s);if("13"===b.etype&&a.commentType){r="",e={text:i,offset:k},s=zmStreamsApp.twitter.setOffsetValues(e),h.zid===zmail.zuid&&(j=d.common.labels.you);var u="";1===a.commentType?(u=h.zid===zmail.zuid?d.twitter.retweetText:d.twitter.retweeted,i.length&&(u=h.zid===zmail.zuid?d.twitter.quoteTweet:d.twitter.quotedTweet)):2===a.commentType&&(u=h.zid===zmail.zuid?d.twitter.replyText:d.twitter.replied),q=_zm.getDOM(["SPAN",{attrs:{},child:[["text",u]]}]),q.appendChild(s)}var v=a.on,w=d.common.labels.sendPrivateReply,x=[],y=[],z=[],A=[],B=[];if(!o&&!b.isSharedFolder){z=b.disableComment?[]:["SPAN",{attrs:{"class":"SndRep","data-cid":f,"data-z":g},child:[["text",d.common.labels.reply]]}];var C=!a.likes&&!b.streamsEnabled&&"1"!==b.etype,D=b.streamsEnabled===!1?"pointerEventsNone":"";A=C?[]:["I",{attrs:{"class":"msi-love zmcnt "+D,"data-cmid":f}}],B=["FONT",{attrs:{style:a.likes?"":"display:none","data-cid":f,"class":"zm_lcnt"},child:[["text",a.likes?a.likes:""]]}],x=b.disableComment?[]:["SPAN",{attrs:{"class":"SndPrv SndPrvCmt","data-cid":f,style:a["private"]?"display:none":"","data-z":g},child:[["text",w]]}],y=["SPAN",{attrs:{"class":"SndPrv ShwPrv zmShowV",style:a["private"]?"":"display:none","data-z":g},child:[["I",{attrs:{"class":"msi-comment"}}],["text",d.common.labels.showPrivateComments]]}]}var E,F="";b.isSharedFolder&&n===zmail.zuid&&(E=!0),o||b.isSharedFolder||a.by!==zmail.zuid||(E=!0),"13"===b.etype&&a.commentType&&a.by===zmail.zuid&&(E=!1),E&&(b.streamsEnabled||"1"===b.etype)&&(x="",z=[],F=["I",{attrs:{"class":"msi-close delCmnt","data-cid":f}}]);var G=l.indexOf("#")!==-1?l.substring(l.indexOf("#")+1,l.length):l,H=zmail.conPath+"/#stream/tab/"+b.groupId+"/"+G+"/"+b.etype+"/"+b.actionType+"/"+a.id,I=b.isSharedFolder?["text",v]:["A",{child:[["text",v]],attrs:{href:H,target:"_blank","class":"dateTime",title:zmStreamsApp.util.getFullDateFormat(parseInt(a.time))}}],J=(a.likes?" contentLiked":"")+(a.liked?" contentILiked":""),K=["DIV",{attrs:{"class":"cmntDet"+J},child:[["SPAN",{attrs:{"class":"time"},child:[I]}],["DIV",{attrs:{"class":"SC_SDot"}}],A,B,["DIV",{attrs:{"class":"SC_SDot",style:z.length?"":"display:none"}}],z,x,y]}],L=m===f?"zms_comment highlightClass":"zms_comment",M=["LI",{attrs:{"class":L,"data-cid":f},child:[F,["DIV",{attrs:{"class":"SC_avtr"}}],["DIV",{attrs:{"class":"cmntMsg"},child:[["STRONG",{attrs:{"class":"zm_susr","data-zid":g},child:[["text",j+r]]}]]}]]}],N=_zm.getDOM(M);$(N).find(".cmntMsg").append(q);var O=zmStreamsApp.util.getContactDetails([a.by])[a.by],P=$(N).find(".SC_avtr");if(O.avatar)$(P[0]).replaceWith(O.avatar);else{var Q=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(a.name),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(P[0]).replaceWith(Q)}if(a.attachments){var R=c.RenderAttachment({attArr:a.attachments,groupId:p,pid:l,type:b.etype,actionType:b.actionType});N.appendChild(R)}return a.link&&zmStreamsApp.linkPreview.addLinkPreviewToComment(a,N,l),N.appendChild(_zm.getDOM(K)),N},b.quoteComment=function(a,b,e){var f=a.id,g=a.by,h=zmStreamsApp.util.getContactDetails([String(g)])[g],i=a.text,j=h.zid===zmail.zuid?d.common.labels.me:h.fn||a.name,k=a.tags||[],l=b.id,m=b.notifyId,n=[],o=":",p={text:i,offset:k,group:l,span:a.replyTo},q=c.setOffsetValues(p);a.replyTo?(n=["SPAN",{attrs:{},child:[["text"," - "+d.common.labels.repliedTo+" "],["SPAN",{attrs:{style:"text-decoration: underline;cursor:pointer","class":"zm_replyto","data-cid":a.replyTo},child:[["text",d.common.labels.commentSmall]]}],q]}],o=""):n=q;var r=a.on,s=(a.likes?" contentLiked":"")+(a.liked?" contentILiked":""),t=["DIV",{attrs:{"class":"cmntDet"+s},child:[["SPAN",{child:[["text",r]]}]]}],u=m===f?"highlightClass":"",v=["LI",{attrs:{"class":u,"data-cid":f},child:[["DIV",{attrs:{"class":"SC_avtr"}}],["DIV",{attrs:{"class":"cmntMsg"},child:[["STRONG",{attrs:{"class":"zm_susr","data-zid":g},child:[["text",j+o]]}],n]}]]}],w=_zm.getDOM(v),x=zmStreamsApp.util.getContactDetails([a.by])[a.by],y=$(w).find(".SC_avtr");if(x.avatar)$(y[0]).replaceWith(x.avatar);else{var z=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(a.name),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(y[0]).replaceWith(z)}var A=e.gnrl;if(a.attachments){var B=c.RenderAttachment({attArr:a.attachments,groupId:A.group.id,pid:A.id,type:A.type,actionType:zmStreamsApp.events.getActionType(A.group)});w.appendChild(B)}return a.link&&zmStreamsApp.linkPreview.addLinkPreviewToComment(a,w,l),w.appendChild(_zm.getDOM(t)),w},b.systemComment=function(a,b){b=(b||"").replace(/\\n/gim,"\n");var c=["LI",{attrs:{"class":"Sactvty"},child:[["DIV",{child:[["B",{child:[["text",a]]}],["text"," : "],["SPAN",{child:[["text",b]],attrs:{style:"word-break: break-all; white-space: pre-wrap;"}}]],attrs:{title:d.common.labels.systemComment}}]]}];return _zm.getDOM(c)},b.selectMailDOM=function(a){var b=["SPAN",{attrs:{"class":"selMail zm_shrnk",style:"cursor:pointer"},child:[["SPAN",{attrs:{"class":"StCnt zm_dIB"},child:[["text",a]]}],["SPAN",{attrs:{"class":"zm_dIB mailSelec zm_shrnk"},child:[["text",d.common.labels.mailsSelected]]}]]}];return _zm.getDOM(b)},b.privateToOwner=function(a,c,d,e,f,g){var h=_zm.getDOM(["UL",{attrs:{"class":"pvtOwn"}}]);return b.privateCommentBlock(h,a,!0,c,d,e,void 0,g,f),h},b.private_comments=function(a,c,d,e,f,g,h,i){var j,k=f?"pvtOwn":"",l=e?["LI",{attrs:{"class":"pvtMsg"},child:[["UL",{attrs:{"class":"Spvt "+k,"data-zid":c.recepient}}]]}]:["UL",{attrs:{"class":"Spvt "+k,"data-zid":c.recepient}}],m=_zm.getDOM(l),n=e?m.children[0]:m;if(d instanceof Array)for(var o=0,p=d.length;o<p;o++)j=b.private_comments.comment(d[o]),d[o].id===g&&_zm.addClass(j,"highlightClass"),n.appendChild(j);else j=b.private_comments.comment(d,h),d.id===g&&_zm.addClass(j,"highlightClass"),n.appendChild(j);if(!h&&!i){var q=b.createPrivate(a,c.replyTo,e,f);n.appendChild(q)}return e?m:n},b.replyComment=function(a,b){return _zm.getDOM(["DIV",{attrs:{"data-cid":a,"class":"zms_rep"},child:[["text",zmText.applyArgs(d.common.labels.replyToUser,{userName:b})],["I",{attrs:{"class":"msi-close"}}]]}])},b.private_comments.comment=function(b){
var f,g=zmStreamsApp.util.getContactDetails([b.by])[b.by];if(g){var h=g.zid===zmail.zuid?d.common.labels.me:g.fn,i={text:b.text,offset:[]},j=c.setOffsetValues(i),k=b.on,l=zmStreamsApp.util.updateTime(parseInt(b.time));l&&(k=l);var m="";b.by!==zmail.zuid||!e&&"1"!==a||(m=["I",{attrs:{"class":"msi-close delCmnt delPvtCmnt","data-cid":b.id}}]),f=["LI",{attrs:{"data-cid":b.id},child:[m,["DIV",{attrs:{"class":"SC_avtr"}}],["DIV",{attrs:{"class":"cmntMsg"},child:[["STRONG",{child:[["text",h+":"]]}],j]}],["DIV",{attrs:{"class":"cmntDet"},child:[["SPAN",{attrs:{title:zmStreamsApp.util.getFullDateFormat(parseInt(b.time))},child:[["text",k]]}]]}]]}]}var n=_zm.getDOM(f),o=$(n).find(".SC_avtr");if(g.avatar)$(o[0]).replaceWith(g.avatar);else{var p=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(b.name),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(o[0]).replaceWith(p)}return n},b}(),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.CommentModule.views=function(a){var b,c=zmText.get("streams"),d=c.streams.common,e=d.comment,f=d.commenting,g=zmStreamsApp.CommentModule,h=zmail.Streams.Components.StreamsEditor,i=zmStreamsApp.util;return a.Comment=Zmail.View.extend({attCmpRef:"",saveContent:!0,template:g.templates,events:{"click .zmcnt.msi-love":"like","focus textArea.zms_cmTxt":function(){var a=this.$el.find(".SC_PUbtm");if($(a).show(),this.fixedComment&&this.isNewCollabUser){var b=$(this.$el);b.find(".cmntInfoWra").removeClass("cmntInfoWra").children(".cmntInfo").addClass("zmHideD"),b.find(".cmntActions").show(),this.model.get("sharedCall")&&this.model.getRecipientsForMail(),this.setBottom()}this.reSize()},"keydown textArea.zms_cmTxt":function(a){zmail.mailOpt.isKey&&a.ctrlKey&&13===a.keyCode&&(a.preventDefault(),this.publish(a))},"click .addcomnt":"publish","click .cmntMore":function(a){var b=$(a.currentTarget);if(!b.hasClass("zmLock")&&!b.hasClass("postCmnt")){b.addClass("zmLock");var c=b.data("cid"),d=b.siblings(".zms_comment").length;this.model.listAll(c,d,b)}},"click .SndRep":"attachReplyTo","click .delCmnt":function(a){var b=$(a.currentTarget),c=b.hasClass("delPvtCmnt"),d=$(b).parents(".pvtMsg").prev(".zms_comment");this.model.remove(b.data("cid"),c,$(d).data("cid"))},"click .SndPrvCmt":function(a){var b=a.currentTarget;$(b).hide(),this.addNewPrivate(b)},"click .zms_comment .zm_susr,.zms_comment .zms_mention":"showUserPost","mouseover .zms_comment .zm_susr,.zms_comment .zms_mention":"showUserDropdown","mouseout .zms_comment .zm_susr,.zms_comment .zms_mention":function(a){var b=a.currentTarget;clearTimeout(zmStreamsApp.events.cardTime),$(b).data("show","false")},"click .zms_comment .zm_HTag":"showHashTag","click .ShwPrv":"showHidePrivateComment","click .zms_rep .msi-close":function(a){var b=$(a.currentTarget).parent();$(this.textAreaInstance.textarea).data("cid",""),b.remove();var c=this.model.get("id");zmStreamsApp.util.storeUnposted(c,{replyTo:{}}),this.reSize()},"click .zmst_attach":"addAttachment","keypress .pvtRlyLi input":function(a){13===a.keyCode&&this.sendPrivate(a)},"click .SndPrvRep":function(a){var b=a.currentTarget;$(b).parent().hide().siblings(".pvtRlyLi").show().find("input").focus()},"click .zm_lcnt":function(a){var b=a.currentTarget,c=this.model,d=$(b).data("cid"),e=c.pickComment(d).commentObj,f=e.likeList||{},g=_.size(f);g&&e.likes===g?this.showCommentLikes(d,b):c.sync("getLikes",this.model,{commentId:d,elm:b})},"click .zm_inclr i":function(a){var b=a.currentTarget;$(b).removeClass("zm_shrnk").toggleClass("msi-check msi-uncheck").addClass("zm_shrnk"),this.model.get("sharedCall")&&this.fixedComment&&this.updateInviteeList("recipientList")},"click .zm_inclr .zm_dIB":function(a){var b=a.currentTarget;$(b).parent().find("i").trigger("click")},"click .zm_replyto":function(a){this.showSingleComment(a.currentTarget)},"click .lockClass":function(a){var b=$(a.currentTarget).filter(".lockClass"),d=$(b).find("i"),e="";d.hasClass("msi-Ainvitee")?(d.removeClass().addClass("msi-Dinvitee"),e=c.common.labels.allowInvites):(d.removeClass().addClass("msi-Ainvitee inviteeColor"),e=c.common.labels.denyInvites),zmComponent.tooltip({elm:b[0],text:e,arrow:"top"})},"mousedown .zmCmntFixed":function(a){var b=this.textAreaInstance;if($(b.textarea).data("shrinkValue",!0),this.isNewCollabUser&&!$.trim(b.getText())){var c=$(a.target);$(c).hasClass("zm_shrnk")&&$(b.textarea).data("shrinkValue",!1)}},"focusout textArea.zms_cmTxt":function(a){this.saveUnpost(a);var b=this.textAreaInstance;if(this.isNewCollabUser&&!$.trim(b.getText())){if($(b.textarea).data("shrinkValue")===!1)return;this.$el.find(".cmntActions").hide();var c=this.$el.find(".cmntInfo"),d=this.model.get("comments").length;c.length&&d&&(this.$el.find(".cmntInfo").removeClass("zmHideD"),this.$el.find(".zmCmntFixed").addClass("cmntInfoWra")),this.setBottom()}},"click .cmntInfo":function(){zmUtil.setPreviewScroll($(this.$el).find(".cmntLabel")[0],this.$el.parents(".SC_Twpr")[0])},"click .inviteeList":"showInviteeList","click .taskcmnt":"convertTaskComment","click .noteCmnt":"convertNoteComment","click .appGroup":"showGroupDropdown","click .mailCmnt":function(){this.switchBackMail()},"click .selMail":"scrollSelectedMail"},saveUnpost:function(a){var b=a.currentTarget||a;if(this.saveContent&&this.textAreaInstance){var c={},d=$(b).parent().siblings(".zms_rep");if(d.length){var e=d.data("cid"),f="",g=this.model.pickComment(e);g.commentObj&&(f=g.commentObj.name);var h={id:e,name:f};c.replyTo=h}var i=this.textAreaInstance.getText(),j=this.textAreaInstance.getMetaBlocks();c.text=i,j&&j.length&&(c.mentions=j);var k=this.model.get("id");zmStreamsApp.util.storeUnposted(k,c)}},convertTaskComment:function(a){var b=this;this.$el.find(".mailAct").hide(),$(a.currentTarget).parent().siblings(".msi-smiley").hide(),$(a.currentTarget).siblings(".msi-comment").show().siblings(".taskcmnt").hide().siblings(".noteCmnt").show(),$(this.$el).find(".addcomnt").text("Add Task").addClass("addTsk");var c=$(this.$el).find(".appGroup").show();if(!c.length){var d=this.template.groupDom();this.$el.find(".cmAct").append(d)}$(this.$el).find(".ms_note").hide(),$(this.$el).find(".zm_mention").show();var e=this.textAreaInstance.textarea;if(e.placeholder="Task title @task owner",this.ComSmiley.disable=!0,this.hashTagInstance.disable=!0,!this.mentionsInstance&&this.isNewCollabUser&&this.model.get("isSharedFolder")&&!this.model.get("sharedToMe")){var f={input:e,inputInstance:b.textAreaInstance,exclude:function(){for(var a=b.textAreaInstance.getMetaBlocks(),c=[],d=0,e=a.length;d<e;d++)c.push(a[d].id);return c},onSelect:function(a,b){b=b.item.attributes;var c={id:b.zid,text:b.firstName};this.inputInstance.replaceCurrentWordWithMention(c,this.trigger.currentText)},contactType:"org",setDebounce:0,hideEmailId:!0};b.mentionsInstance=zmContactsAutoComplete.autoComplete(f)}b.mentionsInstance&&(b.mentionsInstance.excludeMe=!1,b.mentionsInstance.disable=!1),this.$el.find(".zms_aAtt").hide(),zmUtil.requireTaskModule("taskUtil").done(function(a){$(e).on("keypress",function(b){var c={mentionObj:zmStreamsApp.util.getMentionsFromTextArea(e),position:zmStreamsApp.util.getCaretPosition(e),fromMail:!0};a.extendMention(e,b,void 0,c)})})},convertNoteComment:function(a){var b=this.$el;b.find(".mailAct").hide();var c=this.textAreaInstance;if(b.find(".msi-note").length)b.find(".msi-note").show();else{b.find(".zms_fixed").children(":eq(0)").before("<div class='ms_note'></div>");var d=this,e=function(a){a&&(d.noteAddCallback=a,a.onHeightChange($(d.$el).find(".cmntText").css("maxHeight"),function(){d.setBottom()})),d.setBottom()},f=$(c.textarea).focus().data("selMailIds"),g=$.isEmptyObject(f)?this.model.get("openedId"):f[0];g=g?g:zmUtil.getSelectedMails()[0];var h=zmUtil.getMailObj(g).F;zmUtil.loadNotes("commentNote",{groupId:zmail.zuid,desc:_zm.escapeTags(c.getText()),addparams:{msgid:g,accid:zmail.defAccId,senderid:h}},{ele:b.find(".ms_note"),callback:e})}b.find(".zm_mention").hide(),b.find(".addcomnt").text("Add Note").addClass("addNote").removeClass("addTsk");var i=b.find(".zmCmntSC");i.children(".taskcmnt").show(),i.children(".msi-comment").show(),i.children(".noteCmnt").hide(),i.siblings(".msi-smiley").hide();var j=b.find(".appGroup").show();if(!j.length){var k=this.template.groupDom();b.find(".cmAct").append(k)}b.find(".zms_aAtt").hide()},hideMailIcons:function(){var a=$(this.$el).find(".zmCmntSC");a.siblings(".msi-smiley").hide(),a.children(".msi-comment").show()},showHashTag:function(a){var b=a.currentTarget,c=$(b).text();zmUtil.publishCloseNotif(),0===c.indexOf("#")&&(c=c.substring(1,c.length));var d=this.model.get("groupId");zmStreamsApp.events.listHashTags({tag:c,gid:d})},showUserDropdown:function(a){var b=a.currentTarget,c=String($(b).data("zid")),d=this.model.get("groupId");zmStreamsApp.events.showContactCard({zid:c,elm:b,groupId:d,eType:this.model.get("etype")})},showUserPost:function(a){var b=a.currentTarget,c=String($(b).data("zid")),d=this.model.get("groupId");zmUtil.isGroupMember(c,d)&&zmStreamsApp.events.listUserPosts(void 0,{zid:c,gid:d,name:$(b).text(),data:"post"})},showGroupDropdown:function(a){var b=[],d=$(this.$el).find(".appGroup"),e=String($(d).data("grp"));e!==zmail.zuid&&b.push({name:c.common.labels.myStream,id:zmail.zuid,photo:zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid].photo}),b=b.concat(_.toArray(zmStreamsApp.util.getGroupDetails())),zmStreamsApp.util.showGroupDetails({groupInfo:b,elm:$(d).find("b"),fn:function(a){$(d).data("grp",a.id),$(d).find(".zm_grptxt").text(a.name),zmUtil.hideMenu()},showUnread:!1},{type:"popup"})},scrollSelectedMail:function(){var a=this.$el.parents(".SC_Twpr")[0];zmUtil.setPreviewScroll($(a).find(".js-shareicon")[0],a)},hasAttachment:function(){var a=!1,b=this.attCmpRef;return"undefined"!=typeof b&&""!==b&&(a=Boolean(b.getAllAttachedList().length)),a},attachFiles:function(a){var b=this;if(b.attCmpRef)b.attCmpRef.configJSON.eleId=a,b.attCmpRef.init();else{var c=this.callAttachment(a);zmUtil.initAttachComponent(c,function(a){b.attCmpRef=a})}},callAttachment:function(){var a=this,b=a.model.get("id"),c=zmStreamsApp.util.retrieveUnposted(b),d=c.attachment||[],e={componentId:"streams",isNewImp:!0,attachFrom:["desktop","myAttachchment","zDocs","otherCloud"],currentAttachedSize:0,eleId:a.$el.find(".zmCAt"),preAttachedFile:d,renameSupport:!0,onAddAttachment:a.saveAttachment,onRemoveAttachment:a.saveAttachment,updateAttachment:a.saveAttachment,onAddElement:function(){a.reSize()},onRemoveElement:function(){a.reSize()},deferredUpload:!0};return zmUtil.isNettyUploadEnabled()&&(e.updateVirus=a.saveAttachment),a.model.get("isDraftShare")&&(e.onAddElement=function(){g.resizeFn(),a.reSize()},e.onRemoveElement=function(){g.resizeFn(),a.reSize()}),e},saveAttachment:function(){var a=this.getAllAttachedList(),c=b.get("id");zmStreamsApp.util.storeUnposted(c,{attachment:a})},like:function(a){var b=a.currentTarget,d=$(b).data("cmid"),e="",f=$(b).next().text();if(!$(b).hasClass("zmLockLike")&&!$(b).hasClass("pointerEventsNone")){$(b).addClass("zmLockLike"),""!==f&&(f=parseInt(f));var g=_zm.copyOf(this.model.get("comments")),h=this.model.pickComment(d).index,i=g[h].likeList||{},j=g[h].likes;if($(b).parent().hasClass("contentILiked"))$(b).parent().removeClass("contentILiked"),e=c.streams.tooltip.likeComment,f-=1,0!==f&&""!==f||$(b).parent().removeClass("contentLiked"),delete i[zmail.zuid],f<=0&&(f=""),j-=1;else{$(b).parent().addClass("contentILiked"),e=c.streams.tooltip.unlikeComment,0!==f&&""!==f||$(b).parent().addClass("contentLiked");var k=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid];i[zmail.zuid]=k.fn,f+=1,j+=1}1===f?$(b).parent().addClass("contentLiked"):0!==f&&""!==f||$(b).parent().removeClass("contentLiked"),g[h].likeList=i,g[h].likes=j,this.model.set("comments",g),$(b).next().show().text(f<=0?"":f),zmComponent.tooltip({elm:$(b)[0],text:e,arrow:"top"}),this.model.likeComment(d,$(b))}},showCommentLikes:function(a,b){var c=$(this.$el).find(".zm_lcnt[data-cid='"+a+"']"),d=this.model.pickComment(a).commentObj,e=d.likeList||{};if($(b).is(c)){var f,g=[];for(var h in e)f=zmStreamsApp.util.getContactDetails([h])[h],f.isDummyObj&&(f.fn=e[h]),g.push(f);g.length?(i.createPopup({items:g,parent:c,ulclass:"SC_Pr",parentClass:"SC_Slke",type:"oneLine"}),$(b).text(g.length)):$(b).text("")}},sendPrivate:function(a){var b=a.currentTarget,d=this.model,e=$(b).val();if(""!==$.trim(e)&&!$(b).hasClass("zm_snd")){var f=$(b).data("cid"),g=$(b).addClass("zm_snd").data("z");d.sendPrivate(e,f,g,function(a){d.get("isDeleted")?_zm.succErrMsg("e",c.common.messages.deletedPost):a.msg&&_zm.succErrMsg("e",a.msg),$(b).removeClass("zm_snd")})}},showHidePrivateComment:function(a){var b=a.currentTarget,d=$(b).parents(".zms_comment");if(d.length){var e=$(d[0]).next("li.pvtMsg");e.length&&("none"===e[0].style.display?(e[0].style.display="",b.childNodes[1].textContent=c.common.labels.hidePrivateComments):(e[0].style.display="none",b.childNodes[1].textContent=c.common.labels.showPrivateComments))}},showSingleComment:function(a){var b=$(a).data("cid"),c=this.model.getsinglecomment(b,a,"popup");c&&i.createPopup({items:c,type:"comment",parent:a,ulclass:"rplyCmnt"})},addNewPrivate:function(a){var b=$(a).data("cid"),c=!b,d=c?this.model.get("owner"):$(a).data("z"),e=this.template.createPrivate(b,d,!0,c);c?$(a).children().first().hasClass("pvtRlyLi")||$(a).children().first().before(e):$(a).parents("li").after(e),$(e).find("input").focus(),this.model.get("isDraftShare")&&zmStreamsApp.events.publishKeyEvent(this.model.get("miscData"))},attachReplyTo:function(a){var b=$(a.currentTarget).data("cid"),c=String($(a.currentTarget).data("z")),d=zmStreamsApp.util.getContactDetails([c])[c].fn,e=this.template.replyComment(b,d),f=this.textAreaInstance;f&&(f=$(f.textarea),f.parent().before(e),$(e).data("setHeight",!0).siblings(".zms_rep").remove(),f.data("cid",b).focus(),this.reSize())},updateLike:function(a){var b=this.$el.find('.msi-love[data-cmid="'+a+'"]'),d=this.model.pickComment(a).commentObj,e="";b.removeClass("zmLockLike");var f=d.likes?parseInt(d.likes):0;f<0&&(f=0),d.liked!==b.parent().hasClass("contentILiked")&&(d.liked?(b.parent().addClass("contentILiked"),e=c.streams.tooltip.unlikeComment):(b.parent().removeClass("contentILiked"),e=c.streams.tooltip.likeComment),b.length&&zmComponent.tooltip({elm:b[0],text:e,arrow:"top"})),1===f?$(b).parent().addClass("contentLiked"):0!==f&&""!==f||($(b).parent().removeClass("contentLiked"),f=""),b.next().show().text(f)},setBottom:function(){if(this.isNewCollabUser){var a=this.$el,b=$(a).find(".zmCmntFixed")[0];if(b&&$(b).is(":visible")){var c=b.getBoundingClientRect().height+10;$(a).parents(".SC_Twpr").css("bottom",c+"px")}}},updPrivateComment:function(a,b,d,e,f){var g,h,i,j,k,l,m=this.$el,n={recepient:f};if(d=d||"",g=this.model.getPvtComments(d),a?(j=this.model.get("owner"),k=$(m),h=$(k).find('ul.pvtOwn[data-zid="'+f+'"]')[0]):(j=g.by,l=$(m).find('.zms_comment[data-cid="'+d+'"]'),k=l.next(),h=$(k).find('ul.Spvt[data-zid="'+f+'"]')[0]),n.replyTo=f===zmail.zuid?j:f,e)if(a){var o=this.template.privateToOwner(g,this.model.get("owner"),"",this.model.get("disableComment"),void 0,!0);h=$(k).find(".cmntMore").length?$(k).find(".cmntMore"):$(k).find(".cmnt_ul"),$(k).find(".pvtOwn").length&&$(k).find(".pvtOwn").remove(),$(h).before(o);var p=$(k).parent().find(".SCSpostAct");if(p.length){$(p).find(".SndPrvO").hide();var q=$(p).find(".ShwPrv").show();q[0].childNodes[1].textContent=c.common.labels.hidePrivateComments}}else{k.hasClass("pvtMsg")&&k.remove(),this.template.privateCommentBlock(l,g,!1,"","",this.model.get("disableComment"),!0,e);var r=$(l).find(".ShwPrv").show();r[0].childNodes[1].textContent=c.common.labels.hidePrivateComments}else if(h){var s,t,u,v;v=$(h).find(".pvtRlyLi"),b.by!==zmail.zuid&&v.length&&(t=!("none"===v[0].style.display),u=$(h).find(".pvtRlyLink")),s=a?g[f]:g["private"][f],i=this.template.private_comments(d,n,s,e,a,"",this.model.get("disableComment"),t),t&&$(i).append(v[0]).append(u[0]),$(h).replaceWith(i),_zm("<","INPUT",v[0])[0].focus()}else i=this.template.private_comments(d,n,[b],e,a,"",this.model.get("disableComment")),a?$(k).find("ul.pvtOwn").find("li.pvtMsg").append(i):$(k).append(i)},updateMentions:function(a){this.mentionsInstance&&(this.mentionsInstance.includeOnly=a)},reSize:function(){var a=this,b=a.$el,c=$(b).find(".cmnt_ul"),d=a.model.get("disableComment"),e="fixedComment"===$(c).data("type");if(e&&!d){var f=a.textAreaInstance,h=zmStreamsApp.events.commentBoxMaxHeight(f.textarea),i=f.textarea.scrollHeight;h>0&&(i<h?f.resetMaxHeight():f.setMaxHeight({maxHeight:h}));var j=$(b).find(".SCS_cmnt"),k=this.isNewCollabUser?$(b).filter(".SCS_postWra"):$(b).find(".SCS_postWra");k.parent().hasClass("SCS_postMail")&&(k=k.parent()),zmStreamsApp.events.setMaxHeight($(b),j[1],k[0])}a.model.get("isDraftShare")&&g.resizeFn&&g.resizeFn()},showHideRecipient:function(){var a=this.model.getRecipientsForMail();a&&a.length&&$(this.$el).find(".zm_inclr").removeClass("SC_dyn").prev().removeClass("SC_dyn")},initialize:function(a){var b=this,c=b.model;b.render(a.postElm,a.highlightComment,a.viewJSON,a.isNewCollabUser,a.hideComponent),b.listenTo(c,"change:add",b.addNew),b.listenTo(c,"change:recipientList",b.showHideRecipient),b.listenTo(c,"change:like",b.updateLike,b),b.listenTo(c,"change:listAll",b.listAll),b.listenTo(c,"change:removeComment",b.removeComment),b.listenTo(c,"add:commenttoowner",b.addNewPrivate),b.listenTo(c,"add:privateComment",b.updPrivateComment),b.listenTo(c,"change:getLikes",b.showCommentLikes),b.listenTo(c,"change:singlecomment",b.singlecomment),b.listenTo(c,"change:disableComment",b.disableCommentUpdate),b.listenTo(c,"change:mentionData",b.updateMentions),a.isNewCollabUser&&b.listenTo(c,"change:inviteeList",b.addInviteeForMail)},addUnposted:function(a,b){if(this.textAreaInstance){var c=this.model.id,d=this.textAreaInstance.textarea,e=zmStreamsApp.util.retrieveUnposted(c),f=e.replyTo||"",g=e.text||"",h=e.mentions||[],i=e.attachment||[],j=!1,k=this.$el.find(".SC_PUbtm");if(f&&f.id){var l=f.id,m=f.name,n=this.template.replyComment(l,m);$(d).data("cid",l).parent().before(n),a&&$(d).focus(),j=!0}g.trim()&&(this.fixedComment&&this.textAreaInstance.setMaxHeight({maxHeight:200}),this.textAreaInstance.setText(g),this.textAreaInstance.setMetaBlocks(h),a&&(this.isNewCollabUser?(this.updateInviteeList("mention"),setTimeout(function(){$(d).focus()},300)):$(d).focus()),j=!0),i&&i.length>0&&(this.addAttachment(!0),j=!0),j&&$(k).show()}},render:function(a,b,d,e,f){var g=this.model;b&&$.isArray(b)&&(b=b[0]);var h=g.id,i=g.get("attachIndex"),j=d||g.toJSON(),k=this.template.comments(j,i,b,e),l=j.fixedComment;this.fixedComment=l||!1,a?$(a).append(k):a=k,e&&(this.isNewCollabUser=!0);var m,n;if(l)n=e?$(a):$(a).parent().parent(),m=this.template.fixedComment({cid:h,sharedCall:j.sharedCall,isNewCollabUser:e,sharedApiCall:j.sharedApiCall,entityExists:j.entityExists,totalCount:j.total,isDraftShare:j.isDraftShare,attId:i,isShare:j.isSharedFolder,placeHolder:j.placeHolder||{},fixedComment:!0,inviteeList:j.inviteeList,sharedFolderUsers:j.sharedFolderUsers,sharedToMe:j.sharedToMe}),j.isSharedFolder&&j.sharedFolderUsers&&j.sharedFolderUsers.length<3&&$(m).find("font.inviteeList").remove(),j.disableComment||($(n).find(".zms_fixed.zmCmntFixed").remove(),$(n).append(m)),this.$el=$(n),a.parent().hasClass("SCS_postMail")&&(a=a.parent());else{this.$el=$(k);var o=$(this.$el).find(".zmst_attach");o.length&&zmComponent.tooltip({elm:o[0],text:c.streams.tooltip.addattachmentComm,arrow:"top"})}var p=j.comments;void 0!==p&&this.setToolTip(p),this.setDefaultEvents(m);var q=this;if(l?q.addUnposted(l,n):setTimeout(function(){q.addUnposted(l,n)},0),b&&this.$el.find(".highlightClass").length){var r=this.$el;setTimeout(function(){var a=r.find(".highlightClass")[0];a.scrollIntoView(!1)},500)}var s=$(a).siblings(".SCS_postWra").length?$(a).siblings(".SCS_postWra"):$(a).find(".SCS_postWra");return s.length||(s=$(a).filter(".SCS_postWra").length?$(a).filter(".SCS_postWra"):$(a).find(".SCSpostAct")),s&&s.find(".SndPrvO").data("commentView",this),l&&!f&&zmStreamsApp.events.setMaxHeight(n,m,a[0],e,!0),zmUtil.addSelectMenu({applyDOM:$(k),ignoreSelector:[".SC_avtr",".cmntDet",".zm_susr",".cmntLabel",".zms_txtLI"]},{groupId:g.get("groupId")}),$(k).attr("data-commentviewid",this.cid).attr("data-id",g.id),g.setView(this.cid,this),f&&(l?($(m).hide(),$(k).parent().hide()):$(k).hide()),this},onClose:function(){var a=this;a.model.removeView(a.cid),a.fixedComment&&(this.noteAddCallback&&zmUtil.removeComponentsFromView("removeNoteFromView",{mountingElem:$(this.$el).find(".ms_note")[0]}),a.undelegateEvents(),a.unbind(),a.stopListening(),$(a.$el).find("div.sc_cmdv").remove(),this.model.get("sharedCall")&&$(this.$el).find(".zms_fixed").remove()),a.destroyTextArea(),a.remove()},destroyTextArea:function(){var a=this;a.textAreaInstance&&(a.textAreaInstance.destroy(),a.textAreaInstance=null,a.mentionsInstance&&(a.mentionsInstance.destroy(),a.mentionsInstance=null),a.hashTagInstance&&(a.hashTagInstance.destroy(),a.hashTagInstance=null),a.ComSmiley&&(a.ComSmiley.destroy(),a.ComSmiley=null))},removeComment:function(a,b,c){var d,e=this.$el,f=e.find('.delCmnt[data-cid="'+a+'"]'),g=$(f).closest("li"),h=$(e).hasClass("SCS_cmnt")||$(e).find(".SCS_cmnt").length;if(!f.length&&h&&(g=e.find('.zms_comment[data-cid="'+a+'"]'),g.length||(g=e.find('li[data-cid="'+a+'"]'))),d=$(g).next(),b&&2===$(g).siblings().length){var i;g=$(g).parent("ul.Spvt"),0===$(g).siblings().length&&(g=$(g).parent("li.pvtMsg"),c?(g=$(g).parent("ul.pvtOwn"),i=$(g).parents(".sc_cmdv.SCS_cmnt").siblings()):i=$(g).prev(),i.find(".SndPrv").show(),i.find(".ShwPrv").hide())}$(g).hasClass("zms_comment")&&$(d).hasClass("pvtMsg")&&d.remove(),g.remove(),this.model.get("isDraftShare")&&zmStreamsApp.events.publishKeyEvent(this.model.get("miscData"));var j=this.model.get("comments").length;if(this.model.get("sharedCall")&&this.fixedComment&&(j?this.$el.find(".StCnt").text(j):($(this.$el).find(".cmntLabel").hide(),this.$el.find(".cmntInfo").addClass("zmHideD"),this.$el.find(".cmntInfoWra").removeClass("cmntInfoWra"))),this.model.get("isDraftShare")&&!j){var k=this.template.draftNoComment();this.$el.find(".sc_cmdv").append(k)}this.isNewCollabUser&&this.setBottom()},disableCommentUpdate:function(){var a=this,b=a.model,c=a.$el,d=a.template,e=b.get("attachIndex");if(a.fixedComment){if(b.get("disableComment"))$(c).children(".SCS_cmnt").remove();else if($(c).find(".SCS_cmnt").length<=1){var f=d.fixedComment(b.toJSON());$(c).append(f)}}else{var g=d.comments(b.toJSON(),e);$(c).empty().append(g.children)}b.get("disableComment")?a.destroyTextArea():a.setDefaultEvents(c)},setDefaultEvents:function(a){var b=this;a=a||b.$el;var c=$(a).find("textArea"),d=b.model.get("groupId");!zmUtil.isGroup(d)&&b.model.get("shGroup").length&&(d=b.model.get("shGroup")[0].id);var e=zmUtil.isGroup(d)?d:"";if(c.length){b.textAreaInstance=new h,b.textAreaInstance.init({textarea:c[0]}),$(b.textAreaInstance).on("HEIGHT_CHANGED",function(){b.reSize(),b.model.get("isDraftShare")&&zmStreamsApp.events.publishKeyEvent(b.model.get("miscData")),b.isNewCollabUser&&setTimeout(function(){b.reSize(),b.setBottom()},300)}),c=b.textAreaInstance.textarea;var f=$(c).parent(".zm_mention")[0];if($(b.textAreaInstance).on("TEXT_CHANGED",function(){var a=b.textAreaInstance.getText(),c=!1,d=_zm.hasClass(f,"zmMentionOn");a.length&&!d?(_zm.addClass(f,"zmMentionOn"),c=!0):!a.length&&d&&(_zm.removeClass(f,"zmMentionOn"),c=!0),c&&b.fixedComment&&b.reSize()}),!b.model.get("isSharedFolder")){var g={input:c,excludeMe:!0,inputInstance:b.textAreaInstance,exclude:function(){for(var a=b.textAreaInstance.getMetaBlocks(),c=[],d=0,e=a.length;d<e;d++)c.push(a[d].id);return c},onSelect:function(a,b){b=b.item.attributes;var c={id:b.zid,text:b.firstName};this.inputInstance.replaceCurrentWordWithMention(c,this.trigger.currentText)},contactType:"org",setDebounce:0,hideEmailId:!0};b.model.get("groupsMention")&&(g.includeAllGroups=!0),e&&(g.showGroup=e);var i=b.model.get("mention");Array.isArray(i)&&i.length&&(g.includeOnly=i),b.mentionsInstance=zmContactsAutoComplete.autoComplete(g),b.model.get("sharedCall")&&!b.model.get("isDraftShare")&&b.fixedComment&&b.isNewCollabUser&&!b.model.get("entityExists")&&($(b.textAreaInstance).on("MENTION_REMOVED",function(a,c){b.updateInviteeList("mention")}),$(b.textAreaInstance).on("MENTION_ADDED",function(a,c){b.updateInviteeList("mention")}))}b.hashTagInstance=zmHashTagAutoComplete.HashTagAutoComplete({input:c,inputInstance:b.textAreaInstance,onSelect:function(a,b){var c=b.item.attributes,d=this.userInput.getCurrentTypingWord();this.inputInstance.replaceTextBeforeCursorWith(d,"#"+c.text+" ")}}),b.ComSmiley=zmSmiley.SmileyAutoComplete({input:c,inputInstance:b.textAreaInstance,onSelect:function(a,b){var c=b.item.attributes.id+" ",d=this.userInput.getCurrentTypingWord();this.inputInstance.replaceTextBeforeCursorWith(d,c)}}),$(a).find(".msi-smiley").click(function(a){zmSmiley.showList(c,this,a,b.textAreaInstance)});var j=$(a).find(".cmntText")[0];if(b.linkPreview=zmLinks.PreviewManager(c).setComponentReadyCallback(function(a){$(j).append(a.getDOM()),b.reSize()}).setProgressDisplayDOM(j),b.model.get("isDraftShare")){window.onresize=function(){var c=$(a).parents(".zmScMask")[0];c||b.reSize()};var k=$(b.$el).find(".msi-addgroup");k.length&&(k.mousedown(function(a){a.preventDefault()}),k.click(function(){c.focus();var a=$(b.$el).find(".zmCmntFixed");_zm.hasClass(a[0],"highlightClass")&&_zm.hasClass(f,"highlightClass")||(a.addClass("highlightClass"),_zm.addClass(f,"highlightClass"),setTimeout(function(){a.removeClass("highlightClass"),_zm.removeClass(f,"highlightClass")},5e3))}))}}},getInviteesListForMail:function(a){a=a||{};var b=this.sharedMailInvitees,c=a.refreshData||"all",d="all"===a.refreshData||!b,e=this.textAreaInstance,f=e.textarea;if(!b||d||c){if(b=b||{},d||"mention"===c){var g=zmStreamsApp.util.getMentionDataEditor(e.getMetaBlocks());b.mentions=g.offset.text}if(d||"recipientList"===c){var h=this.$el.find(".zm_inclr .msi-check").length?this.model.getRecipientsForMail():[];h&&(b.recipientList=h)}if(d||"inviteePop"===c){var i=$(f).data("dzids");b.dzids||(b.dzids=[]),b.dzids=_.uniq(b.dzids.concat(i||[])),$(f).data("dzids","")}b.inviteeList=[],this.model.get("entityExists")&&this.model.get("inviteeList")&&(b.inviteeList=this.model.get("inviteeList")),this.sharedMailInvitees=b}if(a.removeIds){for(var j,k=a.removeIds,l=0;l<k.length;l++)j=String(k[l]),b.mentions&&b.mentions.indexOf(j)!==-1&&(b.mentions.splice(b.mentions.indexOf(j),1),e.removeMetaBlock(j)),b.recipientList&&b.recipientList.indexOf(j)!==-1&&b.recipientList.splice(b.recipientList.indexOf(j),1),b.dzids&&b.dzids.indexOf(j)!==-1&&b.dzids.splice(b.dzids.indexOf(j),1),b.inviteeList&&b.inviteeList.indexOf(j)!==-1&&b.inviteeList.splice(b.inviteeList.indexOf(j),1);this.sharedMailInvitees=b}var m=[].concat(b.inviteeList,b.mentions,b.recipientList,b.dzids);return m},updateInviteeList:function(a,b){if("mention"!==a||!this.model.get("entityExists")){b&&"string"==typeof b&&(b=[b]);var c=this.getInviteesListForMail({removeIds:b,refreshData:a}),d={};c&&c.length&&(d=zmStreamsApp.util.getContactDetails(c)),this.template.addInviteeList(d,this.$el[0])}},invCloseAction:function(a,b){var c=$(a.$els.$contentWrapper).find("input"),d=zmAutoFill.getAddress(c,"id"),e=c.data("removedZid")||[];d.length&&b.model.get("entityExists")&&zmStreamsApp.PostActions.updateInviteeForMail({type:"addInvitee",inviteeList:d,eid:b.model.id}),!d&&!e||b.model.get("entityExists")||b.addInviteeForMail(d,e)},showInviteeList:function(){if(this.model.get("isSharedFolder"))return void this.$el.parent().find(".SCShowinvite").click();var a=this.getInviteesListForMail(),b={};_.each(a,function(a){b[a]=String(zmail.zuid)});var d={items:b,isOwner:!0,showInvite:!0,type:"invitee_popup",invite:!0},e=this;d.closeAction=function(a){e.invCloseAction(a,e)},d.buttons=[{name:"Add",callback:function(a){e.invCloseAction(a,e),i.hideMenu(),a.remove()}},{name:c.common.labels.cancel,callback:function(a){a.remove(),i.hideMenu()},isCancel:!0}],d.dialogDidMount=function(a){e.bindInvitee(e,a.$els.$contentWrapper)},i.createDialog(d)},addInviteeForMail:function(a,b){var c=this.textAreaInstance.textarea;(b.length||a.length)&&(a&&a.length&&(a=a.split(","),$(c).data("dzids",a)),this.updateInviteeList("inviteePop",b))},bindInvitee:function(a,b){var c=$(b).find(".zm_sgst"),d=a.getInviteesListForMail(),e={contentArray:"org",compare:["fn","","nn","eid"],LType:"3",OType:"2",display:"fn",eliminateAt:!0,restrict:d,groupId:!0,addtolist:!0};zmAutoFill.setAutofill(e,c),zmAutoFill.resizeInput(c),$(b).find(".SC_cs .msi-close").click(function(){var b=$(this).parent(),d=$(b).data("uid");$(b).parent().remove();var e=$(c).data("removedZid")||[];e.push(d),a.model.get("entityExists")&&zmStreamsApp.PostActions.updateInviteeForMail({type:"removeInvitee",inviteeList:d,eid:a.model.id}),$(c).data("removedZid",e)})},switchBackMail:function(a){var b=this.$el,d=this.textAreaInstance;$(b).find(".zmBTCmnt").removeClass("zmBTCmnt");var e=this.model.get("placeHolder")?this.model.get("placeHolder").button:c.common.labels.comment,f=$(b).find(".addcomnt"),g=f.hasClass("addTsk"),h=f.hasClass("addNote");if($(b).find(".mailAct").show().siblings(".appGroup").hide(),a&&this.clearText(!0),h){$(b).find(".ms_note").hide(),f.text(e).removeClass("addNote");var i=$.trim(this.noteAddCallback.getNoteValues().textContent);i&&d.setText(i),$(b).find(".noteCmnt").show(),$(b).find(".zm_mention").show()}g&&(this.ComSmiley.disable=!1,this.hashTagInstance.disable=!1,$(d.textarea).off("keypress"),$(b).find(".taskcmnt").show(),d.textarea.placeholder=this.model.get("entityExists")&&this.model.get("placeHolder")?this.model.get("placeHolder").textArea:c.common.labels.writeComment,f.text(e).removeClass("addTsk")),this.mentionsInstance&&(this.mentionsInstance.excludeMe=!0,this.isNewCollabUser&&this.model.get("isSharedFolder")&&!this.model.get("sharedToMe")&&(this.mentionsInstance.disable=!0)),b.find(".msi-smiley").show(),b.find(".zmCmntSC .msi-comment").hide(),b.find(".zms_aAtt").show(),this.setBottom()},publishNote:function(){var a=$(this.$el).find(".appGroup").data("grp"),b=this.noteAddCallback;b.setGroup(a);var c=this;b.quickAddList().done(function(){b.clearValues(),c.setBottom(),c.switchBackMail(!0),zmStreamsApp.util.removeUnposted(c.model.get("id"))})},publish:function(a){var b=this,d=b.model,g=b.$el.hasClass("sc_cmdv")?b.$el:$(b.$el).find(".sc_cmdv.SCS_cmnt"),h=g.data("id");if(this.model.get("sharedCall")||this.fixedComment){if(d.id!==h)return;if(this.model.get("sharedCall")&&this.model.get("entityExists")===!1&&!this.model.get("isDraftShare")){var j=this.model.get("miscData");if(!zmUtil.isChildWindow()&&"undefined"!=typeof zmPrev&&!zmPrev.isEntityOpenedInPreview(j.mailID,j.openedTab))return}}b.linkPreview&&b.linkPreview.removeLoadingBar();var k=b.$el,l=this.textAreaInstance,m=l.textarea,n=l.getText().replace(/\s+$/,""),o=zmStreamsApp.util.getMentionDataEditor(l.getMetaBlocks()),p=$(k).find(".addcomnt");b.saveContent=!1,k.length||(k=d.get("fixedElement"));var q=k.find(".lockClass"),r="";q.length&&(r=q.find("i").hasClass("msi-Dinvitee"));var s=$(m).data("selMailIds");if(this.isNewCollabUser&&$(a.currentTarget).hasClass("addTsk")){if($(p).hasClass("taskSel"))return void zmUtil.succErrMsg("e","Previous request in progress");if(!n)return void zmUtil.succErrMsg("e","Task cannot be empty");var t=$(this.$el).find(".appGroup").data("grp"),u="",v=n;if(!$.isEmptyObject(o.offset)){var w=o.offset;u=w.text[0],v=v.substring(0,w.from[0])}var x=$.isEmptyObject(s)?this.model.get("openedId"):s[0];x=x?x:zmUtil.getSelectedMails()[0];var y={title:v,groupId:t,taction:"addTaskSubtask",actionType:"addEntity"};y.assignee=u||zmail.zuid,r&&(y.lockinvites=r);var z=zmUtil.getMailObj(x);if(x&&z){var A=z.F;y.msgid=x,y.accid=zmail.defAccId,y.senderid=A,y.summary=z.SM||""}return $(p).addClass("taskSel"),
void zmUtil.requireTaskModule("taskReq").done(function(a){a.taskReq(y,"",function(a){zmStreamsApp.util.removeUnposted(d.get("id")),$(p).removeClass("taskSel");var c=a?a.TASKID:"";c&&(zmUtil.succErrMsg("s","Task added successfully"),b.switchBackMail(!0),$.publish("/zm/task/addTask",[a]))},!0)})}return this.isNewCollabUser&&$(a.currentTarget).hasClass("addNote")?void this.publishNote():void i.getAttachments(this.attCmpRef,!0).done(function(a){var g=b.hasAttachment();if(!n&&!g||$(p).hasClass("zs_snd")){if(""===n&&!g){_zm.succErrMsg("e",c.common.messages.emptyComment);var h=e;d.get("sharedCall")&&(h=d.get("entityExists")===!0?e:d.get("placeHolder").button),i.sendRemove(p,!0,h)}}else{var j=d.get("entityExists")===!0?{}:d.get("placeHolder");if($.isEmptyObject(j)?i.sendRemove(p,!1,f):i.sendRemove(p,!1,j.changeText),a.error)return 11===a.errorCode?_zm.succErrMsg("e",c.common.messages.commentVirusFound):12===a.errorCode&&_zm.succErrMsg("i",c.common.messages.virusPending),i.sendRemove(p,!0,e),!1;var k=$(b.$el).find(".zm_inclr i"),l=k.length&&k.hasClass("msi-check")||!1,q="";b.isNewCollabUser&&(q=b.getInviteesListForMail(),q=q&&q.length?q.join(","):"");var t=zmStreamsApp.linkPreview.getLinkInfoFromComponentData(zmLinks.PreviewManager(m).getPreviewData());zmStreamsApp.util.removeUnposted(d.get("id"));var u={text:n,mentions:o,replyTo:$(m).data("cid"),includeRecipients:l,linkData:t,lockInvites:r,selectedMailIds:s,sharedMailInvitees:q,error:function(a,b){if(b=b||{},!b.suppress&&!d.get("isDeleted")){var f=a.message||a.msg;zmUtil.succErrMsg("e",f,b)}d.get("isDeleted")&&zmUtil.succErrMsg("e",c.common.messages.deletedPost);var g=e;d.get("sharedCall")&&(g=d.get("entityExists")===!0?e:d.get("placeHolder").button),i.sendRemove(p,!0,g)}};a&&a.attTmpObj&&(u.attTmpObj=a.attTmpObj),a&&a.attEntObj&&(u.attEntObj=a.attEntObj),b.model.NewComment(u)}}).fail(function(a){_zm.succErrMsg("e",a.msg);var b=e;d.get("sharedCall")&&(b=d.get("entityExists")===!0?e:d.get("placeHolder").button),i.sendRemove(p,!0,b)})},clearText:function(a){var b=this.textAreaInstance,c=b.textarea;$(c).data("cid",""),this.saveContent=!0,b.setText(""),b.setMetaBlocks();var d=$(c).parents(".zms_txtLI");if(d.length||(d=$(c).parents(".cmntText").siblings(".cmntActions")),a||(i.sendRemove($(d).find(".addcomnt"),!0,e),this.$el.find(".zms_rep").remove(),$(d).find(".zm_inclr").remove(),$(d).find(".mailSharedLock").remove(),this.clearAttachment(c,"attach"),zmLinks.PreviewManager(c).reset()),this.isNewCollabUser){var f=this;setTimeout(function(){f.setBottom()},400)}},clearAttachment:function(a){var b=$(a).parents("li.zms_txtLI");b.length||(b=$(a).parents(".SCS_cmnt")),$(b).find(".zms_aAtt .zmL").remove(),this.clearFiles()},clearFiles:function(){var a=this;"undefined"!=typeof a.attCmpRef&&""!==a.attCmpRef&&a.attCmpRef.clearStoreAttachments()},addNew:function(a){var b,d,e,f,g,h=_.last(this.model.get("comments")),i=this,j=this.model.get("comments").length,k=this.$el;b=i.template.comment(h,i.model.toJSON());var l=$(b).attr("data-cid");d=$(k).find(".cmnt_ul"),e=this.textAreaInstance,f=$(d).find(".addcomnt");var m="fixedComment"===$(d).data("type");if(m)g=$(d).last().children().last().attr("data-cid"),g!==l&&$(d).append(b);else{var n=$(d).children();g=$(n).eq($(n).length-2).attr("data-cid"),g!==l&&$(n).last().before(b)}!e.getText()&&!$(k).find(".zms_aAtt .zmL").length||a||this.clearText();var o=this.model.get("entityExists")===!0?{}:this.model.get("placeHolder");if(o=o||{},o.textArea=o.textArea||c.common.labels.writeComment,o.button=o.button||c.common.comment,$(e.textarea).attr("placeholder",o.textArea),f.text(o.button),1!==j||this.model.get("isDraftShare")||$(d).siblings(".cmntLabel").length||!this.model.get("sharedCall")&&!this.model.isSharedFolder||$(d).parent().prepend(this.template.commentHeader()),this.setToolTip([h]),this.model.get("isDraftShare")&&(this.$el.find(".zmNoCmnt").remove(),zmStreamsApp.events.publishKeyEvent(this.model.get("miscData"))),h.tags.length){var p=_.pluck(h.tags,"type"),q=p.indexOf("HASHTAG");p.indexOf("HASHTAG")!==-1&&zmStreamsApp.GroupApp.updateHashTag(h.tags[q])}if(this.fixedComment&&this.isNewCollabUser){var r=this.$el.find(".selMail");r.next().remove(),this.$el.find(".selMail").remove();var s=this.model.get("comments").length;if(1===s&&($(this.$el).find(".cmntLabel").show(),this.$el.find(".cmntActions").find(".cmntInfo").removeClass("zmHideD")),this.$el.find(".cmntInfo").length)this.$el.find(".StCnt").text(s);else{var t=_zm.getDOM(this.template.commentInfo(s));this.$el.find("ul.inviteeList").before(t)}}},addAttachment:function(a){var c=this,d=c.$el,e=$(d).find(".sc_cmdv.SCS_cmnt").data("id");if(!this.isNewCollabUser||c.model.id===e){b=c.model;var f=d.find("textArea"),g=f.data("attach");if(!d.find(".zms_aAtt").length){var h=$(d).find(".zms_txtLI .cmntText");h.length||(h=$(d).find(".cmntText")),$(h).after(zmStreamsApp.template.addAttachment(g))}var i={id:g};if(c.model.get("isDraftShare")&&(i.share_draft=!0,i.draftID=c.model.get("id"),i.onComponentChange=(c.model.get("miscData")||{}).uploadCallback),a!==!0)i.accId=zmUtil.getDefaultAccountID(),c.attachFiles(g);else{i.accId=zmUtil.getDefaultAccountID();var j=c.callAttachment(g);j.autoLaunch=!1,zmUtil.initAttachComponent(j,function(a){c.attCmpRef=a})}}},setToolTip:function(a){var b,d,e,f,g=$(this.$el);if(a=$.isArray(a)?a:[a],a.length)for(var h in a)b=a[h],d=$(g).find('.msi-love[data-cmid="'+b.id+'"]'),d.length&&(e=b.liked?c.streams.tooltip.unlikeComment:c.streams.tooltip.likeComment,zmComponent.tooltip({elm:d[0],text:e,arrow:"top"})),f=$(g).find('.msi-close[data-cid="'+b.id+'"]'),f.length&&zmComponent.tooltip({elm:f[0],text:c.streams.tooltip.delComm,arrow:"top"});if(this.isNewCollabUser&&g.find(".zmCmntSC").length){var i=g.find(".zmCmntSC");zmComponent.tooltip({elm:i.find(".msi-notes")[0],text:c.common.labels.noteComment,arrow:"bottom"}),zmComponent.tooltip({elm:i.find(".msi-task")[0],text:c.common.labels.taskComment,arrow:"bottom"}),zmComponent.tooltip({elm:i.find(".msi-comment")[0],text:c.common.labels.commentIcon,arrow:"bottom"})}if(g.find(".lockClass").length){var j=g.find(".lockClass");zmComponent.tooltip({elm:j[0],text:c.common.labels.denyInvites,arrow:"top"})}},selectMail:function(a,b){var d=$(this.textAreaInstance.textarea),e=d.data("selMailIds");e=e||[];var f="",g=this.model;"add"===b?e.push(a):e.splice(e.indexOf(a),1),d.data("selMailIds",e);var h=this.$el.find(".selMail");if(h.length)e.length?(h.show().find(".StCnt").text(e.length),f=zmText.applyArgs(c.streams.common.shareEmails,{num:e.length}),h.next().show(),d.trigger("focus").trigger("change")):(f=c.streams.common.shareConvo,h.hide().next().hide());else{var i=this.template.selectMailDOM(e.length);d.trigger("focus").trigger("change"),f=zmText.applyArgs(c.streams.common.shareEmails,{num:e.length}),this.$el.find(".zm_slc").prepend(i),$(i).next().show()}this.$el.find(".addcomnt").text(f);var j=g.get("placeHolder");j.button=f,g.set("placeHolder",j)},listAll:function(a,b,d){var e=this.$el,f=e.find(".cmntMore");if(f.removeClass("zmLock"),$(b).is(f)){var g=_zm.copyOf(this.model.get("comments")),h=e.find(".zms_txtLI"),j=e.find("ul.Stcmt"),k=this.fixedComment,l=h.parents(".SCS_cmnt"),m=j.parents(".SCS_postWra"),n=m.parents(".SCS_popUp");k?$(j[0]).empty():this.model.get("disableComment")?$(j).children().remove():(h.siblings().remove(),h=h.detach());var o=this.model.toJSON(),p=f.data("count"),q=g.length;if(p+10<q&&(g=g.slice(q-(p+10),q)),d){var r,s;for(var t in g)r=g[t].time,s=i.updateTime(parseInt(r)),s&&(g[t].on=s)}if(o.comments=g,this.template.commentList(o,j[0]),k?zmStreamsApp.events.setMaxHeight(n,l[0],m[0]):j.append(h),g.length<10)f.remove();else{var u=this.model.get("total"),v=u-g.length;if(0===v)f.remove();else{var w=e.find(".cmntMore").parent();w.find(".cmntMore").remove(),$(j[0]).prepend(this.template.viewmore(zmText.applyArgs(c.common.labels.viewMoreComments,{count:v}),g[0].id,g.length))}}this.setToolTip(g)}},singlecomment:function(a,b){var c=b.type,d=b.elm;"popup"===c?this.showSingleComment(d):"update"===c&&this.addNew(!0)}}),a}(zmStreamsApp.CommentModule.views);