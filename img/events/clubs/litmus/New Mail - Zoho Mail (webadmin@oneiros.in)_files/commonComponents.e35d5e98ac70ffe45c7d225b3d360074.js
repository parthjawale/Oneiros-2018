"use strict";define([],function(a){var b,c=a("zmComponent.keybindings"),d="navigatorScope",e=function(){var a=b.focused;return a=++a%b.dom.length},f=function(){var a=b.focused;return a-=1,a<0&&(a=b.dom.length-1),a},g=function(a,b){if(a)return!(a.isValidToFocus&&!a.isValidToFocus(a,b)||!a.onFocus)&&(a.onFocus(a,b),!0)},h=function p(a){if(b){var c=b.dom,d=c[b.focused]||{};d.onBlur&&d.onBlur(d),a?b.focused=e():b.focused=f(),d=b.dom[b.focused],g(d,a)||p(a)}},i=h,j=h.bind(null,!0),k=function(){if(b){var a=b.dom[b.focused]||{},c=!a.onEscape||a.onEscape(a);c&&b.onEscape&&b.onEscape()}},l=function(){var a;b&&(a=b.dom[b.focused]||{},a.isValidToEnter&&!a.isValidToEnter(a)||a.onEnter&&a.onEnter(a))},m=[{uid:"next_tab",keyStr:"tab",actions:[j]},{uid:"previous_tab",keyStr:"shift+tab",actions:[i]},{uid:"clear",keyStr:"esc",actions:[k]},{uid:"onEnter",keyStr:"enter",preventDefault:!0,actions:[l]}],n=function(a){a=a||{},this.dom=a.dom||[],this.focused=a.focused||-1,this.onEscape=a.onEscape,this.previousScope=void 0},o=n.prototype;return o.setThisAsCurrentNavigator=function(){b=this,b.previousScope=c.getScope(),c.setScope(d)},o.clearTrace=function(){b===this&&(b.dom=[],b.focused=-1,c.getScope()===d&&b.previousScope&&(c.setScope(b.previousScope),b.previousScope=void 0),b=void 0)},c.registerAll({scope:d,allowDefaultScope:!1,shortcuts:m}),zmail.Navigator=n,zmail.Navigator}),define([],function(a,b){var c=function(a,b,c){return c=c||a.indexOf(b),c!==-1&&a.splice(c,1),a},d=function(a,b){var c,d,e=[],f=a.length;for(d=0;d<f;d++)c=a[d],c in b||e.push(c);return e},e=function(a,b){c(a.stack,b,void 0).push(b)},f=function(a,b){c(a.stack,b,void 0)},g=function(a){var b,c,e=a.store,f=a.isObjectInUse,g=a.stack,h=g.length,i=a.objectCount,j=a.evictCount,k=0,l={};for(j=h>=j?j:h,c=0;k<j&&c<h;c++)b=g[c],f(b)?(g.splice(c,1),g.push(b),h-=1):(delete e[b],l[b]=c,i-=1,k+=1);a.stack=d(g,l),a.objectCount=i},h=function(a){a=a||{},this.idName=a.idName||"id",this.store=a.store||{},this.objectCount=0,this.containerSize=a.containerSize||500,this.evictCount=a.evictCount||Math.ceil(.05*this.containerSize),this.considerAsHitOnRetrieval=void 0!==a.considerAsHitOnRetrieval&&a.considerAsHitOnRetrieval,this.isObjectInUse=a.isObjectInUse||function(a){return!1},this.stack=[]},i=h.prototype;return i.addObject=function(a){var b,c=this.store;this.objectCount>=this.containerSize&&g(this),b=a[this.idName],b in c||(this.objectCount+=1),this.store[b]=a,e(this,b)},i.rememberAsRecent=function(a){e(this,a)},i.addObjects=function(a){var b,c;for(c=0,b=a.length;c<b;c++)this.addObject(a[c])},i.getObject=function(a){var b=this.store[a];return b&&this.considerAsHitOnRetrieval&&e(this,a),b},i.removeObject=function(a){var b=this.store,c=b[a];return c&&(delete b[a],f(this,a),this.objectCount-=1),c},i.removeObjects=function(a){var b,c=a.length;for(b=0;b<c;b++)this.removeObject(a[b])},i.filter=function(a){var b,c=this.store,d=[];for(b in c)a(c[b])&&d.push(b);return d},zmail.Container=h,zmail.Container}),define([],function(a){var b=a("zmail.Core.Namespaces"),c=a("zmail.Utils.DOM"),d=b.create("zmail.Components.AutoFill.Helper"),e=function(){var a=c.element(c.selector("#topBar"),!0),b=c.element(c.selector("#wmstoolbar"),!0),d=c.element(c.selector(".zsw-enclosure.shw"),!0),e=document.body.getBoundingClientRect(),f={top:e.top,right:e.right,bottom:e.bottom,left:e.left};return a&&(f.top=a.getBoundingClientRect().bottom),b&&(f.bottom=b.getBoundingClientRect().top),d&&(f.right=d.getBoundingClientRect().left),f},f=function(a){if(!a||"TEXTAREA"!==a.nodeName)return null;var b=a.getBoundingClientRect(),c=zmail.Utils.TextArea.findCursorPosition(a),d={top:b.top+c.top,right:b.left+c.left+c.width,left:b.left+c.left,bottom:b.top+c.top+c.height,height:c.height,width:c.width};return a.scrollTop>0&&(d.top-=a.scrollTop,d.bottom-=a.scrollTop),d},g=function(a){var b=null,d=null,g=null,h=null,i=null,j=null,k=0,l=0,m=0,n=0,o=!0;if(a=a||{},g={left:0,top:0},b=a.dom,b&&(d=a.anchor||c.getData(b,"anchor")),b=c.element(b,!0),d=c.element(d,!0),b&&d){var p=f(d);i=e(),h=d.getBoundingClientRect(),p&&(h=p),c.setStyle(b,{height:"auto"}),c.setStyle(c.selector(".content-wrapper",b),{height:"auto"}),j=b.getBoundingClientRect(),g.left=h.left,g.top=h.bottom,k=Math.abs(h.top-i.top),l=Math.abs(h.bottom-i.bottom),m=Math.abs(h.left-i.left),n=p?Math.abs(h.right-i.right):Math.abs(h.left-i.right),l<j.height&&k>l&&(g.top=h.top-j.height,g.top<i.top&&(g.top=i.top),o=!1),n<j.width&&m>n&&(g.left-=Math.abs(j.width-h.width));var q=c.element(b).outerHeight()-c.element(b).height();o&&l<j.height&&(c.setStyle(b,{height:l-q+"px"}),c.setStyle(c.selector(".content-wrapper",b),{height:l-q+"px"}),c.addClass(b,"scroll-active")),!o&&k<j.height&&(c.setStyle(b,{height:k-q+"px"}),c.setStyle(c.selector(".content-wrapper",b),{height:k-q+"px"}),c.addClass(b,"scroll-active")),c.setStyle(b,{top:g.top+"px",left:g.left+"px"}),a.hidden||c.addClass(b,"shw")}},h=function(a,b){g(b)},i=function(){$.subscribe("autofill/open",h),$.subscribe("autofill/items/change",h)};return d.init=i,d.getAutofillViewPort=e,d.positionMenu=g,d}),define([],function(a){var b=a("zmText"),c=a("zmail.Core.Namespaces"),d=a("zmMention"),e=a("zmConUtil"),f=a("_zm"),g=a("zmail.Utils.DOM"),h=c.create("zmAutoFill"),i=zmail.Components.AutoFill.Helper,j=b.get("commonComponents","autofill"),k={},l={},m={key:100},n=null,o=null,p=null,q=null,r=null,s=null,t=null,u=null,v=null,w=null,x=null,y="keypress.zmAutoFill",z=10,A=null,B=function(a,b,c,d){c=!1,setTimeout(function(){$.publish("autofill/items/change",{dom:a,anchor:b,hidden:d})},0)},C=function(a,b){var c={"#":{code:51,shiftKey:!0}},e=n(g.element(a));if(e.hashTag){if(b&&(b.keyCode===c["#"].code||b.which===c["#"].code)&&b.shiftKey)return!0;var f=d.getCaretPosition(a),h=g.getValue(a).substring(0,f),i=h.lastIndexOf("#"),j=h.substring(i+1,h.length-1),k=/[ \n\r]+/gim,l=null===j.match(k),m=h.lastIndexOf(" ");if(i>=0&&m<=i&&l)return!0}return!1},D=function(a,b){if(C(a)){var c=d.getCaretPosition(a),e=o(a).substring(0,c),f=e.lastIndexOf("#"),h=g.getValue(a).substring(0,f);g.setValue(a,h+"#"+b+" "+g.getValue(a).substr(c));var i=("#"+h+b+" ").length;d.setCaretPosition(a,i)}},E=function(b,c,d,i,j){j=j||{};var k=a("zmComp"),l="",m="",v=g.getAttribute(b,"data-ty")?g.getAttribute(b,"data-ty"):"",w="",x=!0,y=n(g.element(b));if(y.callback)return void y.callback(c);if(!c){if(!o(b).length)return!1;l=$.trim(g.getValue(b));var z=e.splitncheck(l,"object",j);if(z.length>1)return void h.contactFill("",b,i,z);c=z[0],x=Boolean(c.photo),c["class"]+=x?"":" SC_np"}w=c["class"]||"SC_cs",l="1"!==String(y.OType)||c.gid?c.fn||c.name||c[y.display]||c.eid:(c.fn?c.fn:"")+(c.ln?" "+c.ln:"")||c.eid;var A,B={};"1"===String(y.OType)&&(B["data-eid"]=c.eid),(c.zid||c.id||c.gid)&&(B["data-uid"]=c.zid?c.zid:c.id),A={attr:B,name:l,img:x,ph:c.photo,iclass:"msi-close",cls:w,eid:c.eid},"function"==typeof y.onBubbleDOMCreate&&(j.modifyDOM=y.onBubbleDOMCreate),m=e.bubbleUtil(A,j);var C;if(m){"string"==typeof m&&(m=g.__dangerouslyParseHTML(m)),C="edit"===v?g.mountAfter(m,b):g.mountBefore(m,b);var D=C.find("img"),E=function K(){D=g.element(this),setTimeout(function(){D.attr("src",zmResource.get("image","SC-Photo.png"))},100),D.off("error",K)};D.on("error",E);var F=p(b,c,g.getAttribute(b,"tabindex")),G=g.getData(b);g.setData(C,{store:G.store,afill:G.afill}),g.element(C).on({keydown:function(a){q(this,a)},dblclick:function(a){"1"===String(y.OType)&&(r(this),f.stopEvents(a))},click:function(a){s(a,g.element(C))}}).attr("tabindex",F),g.selector(".msi-close",C).click(function(a){t(C),f.stopEvents(a)});var H=void 0===y.drag||y.drag;"1"===String(y.OType)&&!C.hasClass("zmerr")&&H&&u(b,C)}var I=g.element(b).parent(),J=g.getAttribute(I,"id");"edit"===v&&(g.unmount(b,!0),b=g.show(g.selector("input",I))),J&&J.indexOf("Cmp")!==-1&&g.element(I).height()>61&&"1"===String(y.OType)&&(g.setStyle(I,{overflow:"auto",height:"61px"}),k.resetHeight(I)),y.maxLength&&y.maxLength===g.element(b).siblings(".SC_cs").length?g.hide(b):h.resizeInput(b),d=void 0===d||d,g.setValue(b,""),d&&setTimeout(function(){document.activeElement===g.element(b,!0)&&g.focus(b)},0),y.actionCallback&&!i&&y.actionCallback(g.element(b),{type:"add",data:c,elm:g.element(C)})};n=function(a){var b=g.getData(a,"store");return!!b&&f.copyOf(m[b].data)};var F=function(a,b){var c=g.getData(a);c&&(k[c.store]&&k[c.store][c.afill]&&("reuse"===b?k[c.store][c.afill]=[]:delete k[c.store]),m[c.store]&&"reuse"!==b&&delete m[c.store])};p=function(a,b,c,d){var e=$(a).data(),f=e.store,g=e.afill;return k[f]||(k[f]=[]),k[f][g]||(k[f][g]=[]),d?void(k[f][g]=b):(c?k[f][g][c-1]=b:(k[f][g].push(b),c=k[f][g].length),c)};var G=function(a){var b=$(a).data(),c=$(a).attr("tabindex");return k[b.store][b.afill][c-1]},H=function(a){var b=$(a).data(),c=$(a).attr("tabindex");return k[b.store][b.afill].splice([c-1],1)},I=function(a,b){var c=m.key;$(b).data("store",c),m[c]={ele:b,data:a},m.key=c+1,b.length>1?$(b).each(function(a){$(this).data("afill",a)}):$(b).data("afill",0)},J=function(a){var b=$(a).data();return k[b.store]&&k[b.store][b.afill]?k[b.store][b.afill]:""},K=function(a,b,c,d){var e,g;if(40===b.keyCode||38===b.keyCode)return e=$("#zm_afill li.sel"),e.removeClass("sel"),g=40===b.keyCode?e.next().length?e.next():$("#zm_afill li").first():e.prev().length?e.prev():$("#zm_afill li").last(),g.addClass("sel"),$("#zm_afill").hasClass("scroll-active")&&($("#zm_afill")[0].scrollTop=Math.abs($("#zm_afill")[0].getBoundingClientRect().top-g[0].getBoundingClientRect().top)),!0;if(13===b.keyCode)return"searchByItem"===$("#zm_afill .sel").data("type")?(v(b,a,n($(a)),"up",!0),!0):(w(a,c,d),b.preventDefault(),b.stopImmediatePropagation(),!0);if(8===b.keyCode){if(!o(a).length&&("1"===String(c)||"2"===String(c)))return"1"===String($(a).attr("data-kydn"))?($(a).removeAttr("data-kydn"),!0):($(a).prev(".SC_cs").addClass("zmfc").focus(),f.stopEvents(b),!0)}else if(!(39!==b.keyCode&&37!==b.keyCode||""!==o(a)||"1"!==String(c)&&"2"!==String(c)))return f.stopEvents(b,!1),q(a,b),!0;return!1},L=function(a,b){b=b.replace(/\./gi,"\\.").replace(/\+/gi,"\\+");var c,d=[],e=new RegExp(b,"i"),f=a.length;for(c=0;c<f&&!(a[c].match(e)&&""!==a[c].match(e)&&(d.push(a[c]),d.length>z));c++);return d},M=function(a,b,c,d,e){var f,g,h=[],i=a.length,j=b.length;for(f=0;f<i;f++){for(g=0;g<j;g++){if(!e&&b[g]&&a[f][b[g]]&&a[f][b[g]].toLowerCase().indexOf(c.toLowerCase())!==-1){h.push(a[f]);break}if(e&&b[g]&&a[f][b[g]]&&a[f][b[g]].toLowerCase().startsWith(c.toLowerCase())){h.push(a[f]);break}}if(h.length>z&&!d)break}return h},N=["display: inline-block","position: absolute","right: 12px","top: 7px","font-size: 16px"].join(";"),O=["margin-right: 20px"].join(";"),P={crmIcon:['<i class="msi-crm" title="CRM" style="'+N+'"></i>'],primaryEmailIcon:['<i class="msi-fav" title="Primary email address" style="'+N+'"></i>'],suggestionWithPhoto:['<li ref="wrapper">','<div ref="nameContainer" style="'+O+'">','<span ref="name" text-placeholder></span>',"<span>",'<span ref="email" text-placeholder></span>',"</span>","</div>",'<img ref="photo" />',"</li>"].join(""),listOneLinePhoto:['<li ref="wrapper">',"<div>",'<span ref="name" text-placeholder></span>',"</div>",'<img ref="photo" />',"</li>"].join(""),listSuggestions:['<li ref="wrapper">','<span ref="name" text-placeholder></span>',"</li>"].join("")},Q=function(a){return a=a||{},zmail.ContactBook.Templates.avatar({isValidPhoto:!1,initials:zmail.ContactBook.Utils.initials(a.name||""),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})},R=function(a,b,c){var d=null,e=function(){$(b).replaceWith(d)},f=(zmail.ContactBook.getGroups(a)||[])[0];if(f)return d=f.avatar(),void e();var g=(zmail.ContactBook.getCategories(a)||[])[0];if(g)return d=Q({name:c}),void e();var h=zmail.Utils.EmailValidator.validate(a).status===!0;return h?void zmail.ContactBook.get({eid:a}).done(function(b){var f=b[0];b.length>1&&(f=b.filter(function(b){return b.attrs.eid===a})[0]),d=f?f.avatar():Q({name:c}),e()}):(d=Q({name:c}),void e())},S=function(a,b,c,d){b=b||[],l=b;var e,g=n($(a)),h=b.length,i=f("#","zm_afill"),j="",k="",m="",o=i.querySelector("ul"),p=document.createDocumentFragment();o.innerHTML="";var q={};b.forEach(function(a){var b=a.contid?String(a.contid):null;b&&(q[b]=q[b]?q[b]+1:1)});for(var r=0;r<h;r++){var s=$(P.suggestionWithPhoto),t=f.getDOMReferenceMap(s,!0);j="",0===r&&"onDemand"!==g.selection&&(j="sel"),k=b[r][c[0]]?b[r][c[0]]:"",k+=" "+(b[r][c[1]]?b[r][c[1]]:""),m=b[r][c[3]]?b[r][c[3]]:"",e=b[r].photo?b[r].photo:zmResource.get("image","SC-Photo.png");var u=null;$(t.wrapper).attr({id:"pos"+r}),j&&$(t.wrapper).addClass(j),$(t.name).replaceWith(document.createTextNode(k)),$(t.email).replaceWith(document.createTextNode(m||" ")),u=t.photo,$(t.wrapper).data("cdata",{id:String(b[r].zid),fn:k,eid:m,photo:e}),$(u).hide(),R(m||b[r].zid,$(u),k);var v=b[r].contid?String(b[r].contid):null;b[r].isPrimary&&q[v]>1&&$(t.nameContainer).append($(P.primaryEmailIcon)[0]),b[r].isCRMContact&&$(t.nameContainer).append($(P.crmIcon)[0]),p.appendChild(s[0])}o.appendChild(p),B(i,a)},T=function(a,b,c,d){var e=n($(a));l=b;var g,h=b.length,i=f("#","zm_afill"),j="",k="",m=i.querySelector("ul");m.innerHTML="";for(var o=document.createDocumentFragment(),p=0;p<h;p++){var q=$(P.listOneLinePhoto),r=f.getDOMReferenceMap(q,!0);j="",0===p&&"onDemand"!==e.selection&&(j="sel"),g=b[p].eid||"",k=b[p][e.display]||b[p][c[0]],$(r.wrapper).attr({id:"pos"+p,title:g}),j&&$(r.wrapper).addClass(j),$(r.name).replaceWith(document.createTextNode(k));var s=r.photo;$(s).hide(),R(g||b[p].zid,$(s),k),o.appendChild(q[0])}m.appendChild(o),B(i,a)},U=function(a,b,c,d,e){l=b;var g,h,i="",j=f("#","zm_afill"),k=j.querySelector("ul"),m=n($(a)),o=b.length;k.innerHTML="";var p=document.createDocumentFragment();for(g=0;g<o;g++){var q=$(P.listSuggestions),r=f.getDOMReferenceMap(q,!0);i=0===g&&"onDemand"!==m.selection?"sel":"",h=m.display||"name",$(r.wrapper).attr({id:"pos"+g}),i&&$(r.wrapper).addClass(i),$(r.name).replaceWith(document.createTextNode(b[g][h])),p.appendChild(q[0])}k.appendChild(p),B(j,a)},V=function(a,b){for(var c=!0,d=[],e=a.length,f=b.length,g=0;g<e;g++){c=!0;for(var h=0;h<f;h++){var i=a[g].name?"name":"fn";String(a[g][i])===String(b[h][i])&&(c=!1)}c===!0&&d.push(a[g])}return d};o=function(a){var b;return b="DIV"===a.tagName?$(a).text():$(a).val(),$.trim(b)};var W=function(a,b){"DIV"===a.tagName?$(a).text(b):$(a).val(b)},X=function(a,b,c){var d;if(!b&&$("#zm_afill .sel").length&&(b=$("#zm_afill .sel")[0]),b){var e=b.id,f=e.slice(3,e.length),g=n($(a));d=l[f],g.text||C(a)?(C(a)?D(a,d.name):W($(a)[0],d.name),$(a).data("uid",d.id)):E(a,d)}c&&c(d)},Y=function(a){var b,c=[];return $(a).siblings(".SC_cs").each(function(){b=$(this).data("uid"),b&&c.push(b)}),c},Z=function(a){var b=$(a).siblings("input");$(a).remove(),$(b).show(),h.resizeInput($(b))};w=function(a,b,c,e){if(!$(e).hasClass("content-wrapper")){if(e=$(e).closest("li")[0],"1"===String(b))e?h.appContact(e,a):h.fillContacts(a,"zm_afill");else if("2"===String(b)||"3"===String(b)&&C(a))X(a,e,c);else if("3"===String(b)&&$("#zm_afill").is(":visible")){e||(e=$("#zm_afill .sel")[0]);var f=e.id,g=f.slice(3,f.length),i=n(a);d.getVal(a,e,l[g],i.aliasPlusForAt)}h.removeMenu()}};var _=function(a,b,c,d,e,g){var h=A;return h?$(h).find(".zmDDScroll.content-wrapper ul").removeClass().addClass(d).html(""):(h=$(['<div id="zm_afill" class="SC_dd SC_zi900">','<div class="content-wrapper zmDDScroll">','<ul class=""></ul>',"</div>","</div>"].join(""))[0],$(h).find("ul").addClass(d),A=h),$(h).data({anchor:$(a)[0]}),$(h).off("mousedown").on("mousedown",function(b){w(a,c,e,b.target),setTimeout(function(){$(a).focus()},0),f.stopEvents(b,!0)}),$(document.body).append(h),B(h,a,!0,!0),h},aa=/\w/,ba=function(a,b,c,e,f,g,i,j){var k,l=null,m="",p="SC_P2r";f=String(f),g=String(g);var q,r,s,t;if("3"!==String(g)||C(b)){m=o(b);var u=n($(b));u.eliminateAt&&("@"===m.charAt(0)||u.aliasPlusForAt&&"+"===m.charAt(0))?m=m.substring(1,m.length):C(b)&&(q=d.getCaretPosition(b),r=o(b).substring(0,q),s=r.lastIndexOf("#"),t=r.charAt(s-1),0!==s&&" "!==t&&"\n"!==t||(m=r.substr(s+1),m=" "===m.charAt(0)||"\n"===m.charAt(0)?"":m.trim()))}else{q=d.getCaretPosition(b),r=o(b).substring(0,q),s=r.lastIndexOf("@");var v=n(b);t=r.charAt(s-1),t&&" "!==t&&"\n"!==t&&(s=-1),s<0&&v.aliasPlusForAt&&(s=r.lastIndexOf("+")),t=r.charAt(s-1),0!==s&&" "!==t&&"\n"!==t||(m=r.substr(s+1),m=" "===m.charAt(0)||"\n"===m.charAt(0)?"":m.trim());var w=r.charAt(s-1);aa.lastIndex=0;var x=null!==w.match(aa);s>0&&x&&(m=""),c=V(c,$(b).data("mentions"))}k=e.length?M(c,e,m,"",j):L(c,m),k.length?(""!==$.trim(m)&&c.length&&("2"===f?p="SC_Phr":"3"===f&&(p="SC_Pr"),"1"===g?(l=_(b,[],g,p,i,a),$(l).removeClass("shw")):l=_(b,["text"],g,p,i,a),"1"===f?S(b,k,e,g):"2"===f?U(b,k,e,g,i):"3"===f&&T(b,k,e,g)),B(l,b)):h.removeMenu(),null!==l&&$(l).find("li").off("mouseenter").on("mouseenter",function(a){$(this).one("mousemove",function(){$(this).parent().children().removeClass("sel"),$(this).addClass("sel")})}).off("mouseleave").on("mouseleave",function(a){$(this).removeClass("sel")})},ca=function(a,b,c,d,e,g,i,j){var k=K(b,a,g,i),l=f("#","zm_afill");o(b).length?k||ba(a,b,c,d,e,g,i,j):h.removeMenu(),$(b).off("focusout.autofill").on("focusout.autofill",function(){h.removeMenu()}),B(l,b)},da=function(a,b,c){"3"===String(c)&&d.updateElements(b)},ea=function(a,b){I(a,b)},fa=function(a,b,c){"3"===String(c)&&setTimeout(function(){d.updateElements(b)},100)},ga=function(a){if(a){var b=a.value;b=b||"",b.trim(),b=b.replace(/\n+/gim,","),b=b.replace(/\t+/gim,","),b=b.replace(/(?!@[^@ ]+)( +)/gim," "),b=b.replace(/([^@]+@[^@ ;,"]+)(?:(?: *, *)|(?: *; *)|(?: +))/gim,"$1, "),a.value=b}},ha=function(a){var b=a.target;$(b).data({contentPasted:!0})},ia=function(a){var b=a.target,c=$(b).data();c.contentPasted===!0&&($(b).data({contentPasted:!1}),ga(b));var d=n(b);if("keyup"===a.type){var e=a.which||a.keyCode;if(27===e&&"function"==typeof d.onEscKeyPress&&d.onEscKeyPress({event:a,elem:b}),[37,38,39,40,27,30,16,17,18,91,93].indexOf(e)!==-1)return}var f=d.onInputChange,g=$(b).val();"function"==typeof f&&f({type:"change",event:a,elem:b,text:g,length:g.length,isEmpty:0===g.length})},ja=function(a){var b=$(a).parents(".cmntText"),c=$(a).parents(".zm_mention"),d=$(a).parents(".SCS_popUp"),e=0;if(d.length){var f=$(d).find(".SC_ptit");f.length&&(e=f[0].clientHeight)}if(!b.length||!c.length)return 0;var g=b.siblings(".cmntActions"),h=0;g.length&&(h=g[0].clientHeight);var i=b.find(".zms_rep"),j=0;i.length&&(j=i[0].clientHeight);var k=b.find(".SC_linkpreview"),l=0;k.length&&(l=k[0].clientHeight);var m=window.parseInt(b.css("max-height"));m=window.isFinite(m)?m:0;var n=window.parseInt(c.css("padding-top"));n=window.isFinite(n)?n:0;var o=window.parseInt(c.css("padding-bottom"));return o=window.isFinite(o)?o:0,m-(n+o+j+l+e+h)},ka=function(a,b){b=b||{};var c,d,e;if(a=$(a)[0]){c=b.height,d=b.maxHeight,e=$(a).prev(".zm_mentionbg"),e.css({overflow:"hidden",height:c+"px","max-height":d+"px"});var f=function(){e.scrollTop(a.scrollTop)};f(),$(a).off("scroll.mentions").on("scroll.mentions",f)}},la=function(a,b){if(b=b||{},zmail.Utils.TextAreaResizer.resize(a,{maxHeight:ja(a),onResize:function(b){b=b||{},ka(b.element,{height:b.height,maxHeight:b.maxHeight,overflow:b.overflow,heightChange:b.change}),$(a).triggerHandler("resize")},heightPadding:b.heightPadding||0}),b.resizeMentionsBG){var c=a.getBoundingClientRect();ka(a,{height:c.height,maxHeight:c.height})}},ma=function(a,b){b=b||{},a=$(a)[0];var c,e=a.value,f=a.selectionStart,g=a.selectionEnd,h=e.substring(0,f)||"",i=e.substring(g)||"";c=h+"\n"+i,a.value=c;var j=Math.abs(c.length-1-e.length);a.selectionStart=g-j+1,a.selectionEnd=a.selectionStart,d.updateElements(a),la(a,{heightPadding:b.heightPadding||0}),a.scrollTop>0&&a.scrollHeight>a.clientHeight&&a.selectionEnd===c.length&&(a.scrollTop=a.scrollHeight-a.clientHeight)},na=function(a){var b={},c=[];return a.forEach(function(d,e){return d?d.cid?void c.push(d):void(b[d.eid]||(b[d.eid]=!0,c.push(d))):void a.splice(e,1)}),c},oa=function(a,b,c,e){if("3"===String(c)&&(64===a.keyCode||64===a.which)&&(d.isAtPressed=!0,e))if(d.getMentions(b)&&d.getMentions(b).length)d.isAtPressed=!1;else{var g=b.value;d.getCaretPosition(b)<g.replace(/\s+$/,"").length&&(a.preventDefault(),f.succErrMsg("e",j.errors.placedNotAtEnd))}},pa=function(a){var b=a.which||a.keyCode,c=",".charCodeAt(0);return b===c},qa=function(a,b,c){if(b=$(b),a&&b.length&&(c=String(c),"1"===c)){var d=n(b),e="onDemand"===d.selection;!pa(a)||a.shiftKey||e||(a.preventDefault(),w(b,c))}},ra=function(a,b,c){var e=a.keyCode||a.which;if(c=String(c),"1"===c){if((a.ctrlKey||a.metaKey)&&a.shiftKey&&65===e)return $(b).parent().find(".SC_cs").addClass("zmfc").last().focus(),a.preventDefault(),void a.stopPropagation();1===$(b).val().length&&8===a.keyCode&&$(b).attr("data-kydn","1")}else if("2"===c)13===a.keyCode?a.preventDefault():1===$(b).val().length&&8===a.keyCode?$(b).attr("data-kydn","1"):34!==a.keyCode&&33!==a.keyCode||$(b).blur();else if("3"===c&&$("#zm_afill").length){var f,g;38===a.keyCode||40===a.keyCode?$("#zm_afill").length&&a.preventDefault():13===a.keyCode||32===a.keyCode||39===a.keyCode?(f=d.getCaretPosition(b),g=$(b).val(),"%EF%BB%BF"===encodeURIComponent(g.charAt(f))&&d.setCaretPosition(b,f+1),13===a.keyCode&&$("#zm_afill").length&&a.preventDefault()):37!==a.keyCode&&8!==a.keyCode||(f=d.getCaretPosition(b),g=$(b).val(),"%EF%BB%BF"===encodeURIComponent(g.charAt(f-1))&&d.setCaretPosition(b,f-1))}},sa=function(a){var b=n(a);return b.contentArray=b.hashArray(),b.compare=["name"],b.LType="2",b};v=function(a,b,c,e,f){var g=C(b,a);c=n(b),g&&(c=sa(b));var i,k=[],l=c.contentArray,m=function(){"3"===String(c.OType)&&la(b,{heightPadding:c.heightPadding||0})},p=function(){f?ba(a,b,k,c.compare,c.LType,c.OType,c.callback):ca(a,b,k,c.compare,c.LType,c.OType,c.callback,g)};if("3"!==String(c.OType)||d.isAtTyped(b)||c.aliasPlusForAt&&d.isPlusTyped(b)||g){if(l.length||"1"!==String(c.OType)){var q=Y(b);q=c.restrict?q.concat(c.restrict):q;var r=o(b);if(c.eliminateAt&&"@"===r.charAt(0)&&(r=r.substring(1,r.length)),"org"===l){if("3"===String(c.OType)){var s=d.getCaretPosition(b),t=o(b).substring(0,s),u=t.lastIndexOf("@"),v=t.charAt(u-1);v&&" "!==v&&"\n"!==v&&(u=-1),u<0&&c.aliasPlusForAt&&(u=t.lastIndexOf("+")),v=t.charAt(u-1),0!==u&&" "!==v&&"\n"!==v||(r=t.substr(u+1),r=" "===r.charAt(0)||"\n"===r.charAt(0)?"":r.trim())}var w={org:!0,list:q,grpId:""};c.addtolist&&(w.addtolist=c.addtolist,w.groupId=c.groupId);var x=[];w.addtolist&&(x=w.groupId===!0?zmail.ContactBook.getGroups(r):zmail.ContactBook.getGroups(w.groupId));var y=[];if(!r.trim())return;return void $.Deferred().resolve(zmail.ContactBook.get({str:r,type:["org"],expected:z,exclude:q||[],excludeMe:!c.hasOwnProperty("excludeMe")||c.excludeMe,promise:!1})).promise().done(function(a){if(i=a.map(function(a,b){var c=$.extend({},a.attrs);return zmail.ContactBook.isGroup(a)&&(c.fn=c.name),c.photo=a.photo(!0),c}),x.length){zmUtil.isNewGroupUser()&&(x=x.filter(function(a){return a.get("disabled")!==!0}));for(var b=0,c=0;i.length<z&&b<x.length;){var d=$.extend({},x[b].attrs);d.fn=d.name,d.photo=x[b].photo(!0),d.zid=x[b].id,i.push(d),b++}x.forEach(function(a){y=a.attrs.members.concat(y)}),i.forEach(function(a,b){y.indexOf(a.zid)!==-1&&i.splice(c++,0,i.splice(b,1)[0])})}i.length>z&&(i=i.splice(0,z)),k=i||[],p(),m()})}if(parseInt(l))return void zmail.ContactBook.get({groupid:l}).done(function(a){k=a.map(function(a){var b=$.extend({},a.attrs);return b.photo=a.photo(!0),b}),p(),m()});if(l.indexOf("org")!==-1&&l.indexOf(":")!==-1){var A=l.substring(l.indexOf(":")+1,l.length),B=zmail.ContactBook.getGroups(A)[0],D=q||[];if(B&&(D=D.concat(B.attrs.members)),!r.trim())return;return void $.Deferred().resolve(zmail.ContactBook.get({str:r,type:["org"],expected:z,exclude:D,excludeMe:!c.hasOwnProperty("excludeMe")||c.excludeMe,promise:!1})).promise().done(function(a){i=a.map(function(a){var b=$.extend({},a.attrs);return zmail.ContactBook.isGroup(a)&&(b.fn=b.name),b.photo=a.photo(!0),b}),i.length>z&&(i=i.splice(0,z)),k=i||[],p(),m()})}k=l}else if(o(b)){var E=["personal"];zmail.isCRMServiceUser&&zmail.IntegrationStatus.CRM&&E.push("crm");var F={str:o(b),includeEmailedGroups:!0,includeCategories:!0,expected:z,type:E,excludeOrgUsers:!0};return void zmail.ContactBook.get(F).done(function(a){a=a||[],i=a.map(function(a){var b=$.extend({},a.attrs),c=!1;return zmail.ContactBook.isCategory(a)?(b.fn=b.cname,b.eid="["+j.category+"]",c=!0):zmail.ContactBook.isGroup(a)&&(b.fn=b.name),c?b.photo=zmResource.get("image","SC-Photo.png"):b.photo=a.photo(!0),"crm"===a.type&&(b.isCRMContact=!0),b}),i.length>z&&(i=i.splice(0,z)),k=i||[],k=na(k),p(),m()})}p()}else h.removeMenu();m()},s=function(a,b){if("IMG"===a.target.nodeName)return e.showContactCard({dom:$(b)[0],email:$(b).data("eid"),event:a,source:"compose"}),void f.stopEvents(a);if($(b).siblings("input").blur(),a.shiftKey)if($(b).siblings(".zmfc").length){var c=$(b).siblings(".zmfc").index(),d=$(b).index();c>d?$(b).parent().children().slice(d,c).addClass("zmfc"):$(b).parent().children().slice(c,d+1).addClass("zmfc")}else $(b).addClass("zmfc");else a.ctrlKey||a.metaKey?$(b).toggleClass("zmfc"):($(b).parent().children(".zmfc").removeClass("zmfc"),$(b).addClass("zmfc"));$(b).focus(),f.stopEvents(a)},r=function(a){$(a).siblings("input").hide();var b="",c=$("<input type='text' ></input>").insertBefore(a),d=$(a).attr("tabindex"),g=G($(a));return b=e.constructContact({firstName:g.fn,lastName:g.ln,email:g.eid}),$(c).val(b).attr("size",b.length).attr("tabindex",d).data($(a).data()).on("keydown",function(a){x(this,a)}).on("focusout.autofill",function(a){h.fillContacts(c,"edit"),f.stopEvents(a)}).focus(),$(a).remove(),$(c)[0].setSelectionRange(0,0),$(c).select(),$(c)},x=function(a,b){13===b.keyCode&&(h.fillContacts(a,"edit"),f.stopEvents(b));var c=n($(a).siblings("input"));8===b.keyCode&&ra(b,a,c.OType),""===$.trim($(a).val())&&(t($(a)),$(a).attr("data-ty","edit"),$(a).off("keyup").keyup(function(b){v(b,$(a),c,"up")}),$(a).off("keydown").keydown(function(b){ra(b,$(a),"1")}),$(a).off(y).on(y,function(b){qa(b,$(a),"1")}),$(a).off("blur.autofill").on("blur.autofill",function(){h.fillContacts($(a),"edit")}))},q=function(a,b){var c,d=b.keyCode||b.which;if(13===b.keyCode)return f.stopEvents(b),void r(a);if((b.ctrlKey||b.metaKey)&&65===d)return $(a).parent().find(".SC_cs").addClass("zmfc"),void f.stopEvents(b);if((b.ctrlKey||b.metaKey)&&b.target&&"DIV"===b.target.tagName){var e=f("#","zmafill_hid");null===e&&(e=$("<textarea />").attr({id:"zmafill_hid"})[0],$(e).css({opacity:0}),document.body.appendChild(e));var g,h=$(a).parent().find(".zmfc"),i=0,j=h.length||0,k="";for(i=0;i<j;i++)g=G(h[i]),0!==i&&(k+=","),g.fn&&(k+=g.fn),k+="<"+g.eid+">";e.value=k,e.select();try{document.execCommand("copy")}catch(l){}return void setTimeout(function(){$(e).remove(),$(a).focus()},0)}if(39===b.keyCode){$(a).removeClass("zmfc");var m=$(a).next(".SC_cs");0===$(a).next(".SC_cs").length&&(m=$(a).next("input")),c=$(m).focus()}else if(37===b.keyCode)1===$(a).prev(".SC_cs").length&&$(a).removeClass("zmfc"),c=$(a).prev(".SC_cs");else if(8===b.keyCode){if("INPUT"===$(a)[0].tagName&&1===$(a).val().length)return $("#zm_afill").hide(),void f.stopEvents(b);var n=$(a).siblings("input");0===$(a).siblings(".SC_cs").length?($(n).focus(),c=$(n)):(c=$(a).prev(".SC_cs"),!c.length&&$(a).next(".SC_cs")&&(c=$(a).next(".SC_cs"))),$(a).parent().children(".zmfc").each(function(){t($(this))}),f.stopEvents(b,!1)}$(c).hasClass("zm_sgst")||$(c).addClass("zmfc").focus(),b.ctrlKey||b.metaKey||f.stopEvents(b)},t=function(a){var b=$(a).siblings("input"),c=n($(a)),d=H($(a));"INPUT"!==$(a)[0].tagName&&$(a).remove(),$(b).siblings(".SC_cs").each(function(a){$(this).attr("tabindex",a+1)}),c.maxLength&&c.maxLength>$(a).siblings(".SC_cs").length&&!$(b).is(":visible")&&$(b).show(),c.actionCallback&&c.actionCallback($(b),{type:"remove",data:d[0]}),h.resizeInput(b)};var ta=function(a,b,c){var d=$(a).data("store");c&&(m[d].data.restrict=c),b&&(m[d].data.contentArray=b)};u=function(a,b){var c=$(a).parent().attr("id"),d=c.substring(c.indexOf("Cmp")+3,c.length);$(b).draggable({revert:"invalid",containment:"#zmdArea_Cmp"+d+".zmdrop",scroll:!1,helper:function(){var a=$(this).clone().css({width:this.offsetWidth,position:"relative","z-index":"1"})[0];return a},addClasses:!1,drag:function(a,b){a.stopPropagation()},start:function(){$(this).hide()},stop:function(a,b){$(b.helper[0]).remove(),$(this).show()}}),$("#zmdArea_Cmp"+d+" .zmdrop").each(function(){$(this).droppable({drop:function(a,b){var c=b.draggable,d={};d=G($(c)),d["class"]=$(c).attr("class"),E($(this).children("input"),d),t($(c)),f.stopEvents(a,!0)}})})};var ua=function(a){a=a||{};var b,c=a,d=/(?:@[^@>]+>) *(,{1})/gim,e=/(.*)(?=<)/i,f=null,g=[],h='"';for(f=d.exec(c);null!==f;)g.push(c.substr(0,f.index+f[0].length)),c=c.substr(f.index+f[0].length),d.lastIndex=0,f=d.exec(c);return c=c.trim(),c&&g.push(c),g=g.map(function(a){return e.lastIndex=0,(f=e.exec(a))?(b=(f[0]||"").trim(),b&&b.charAt(0)!==h&&b.charAt(b.length-1)!==h&&(b=b.replace(/"/i,'\\"'),b=h+b+h,a=a.substr(f[0].length),a=b+" "+a),a):a}),a=g.join(" ")},va={appContact:function(a,b){var c=$(a).data("cdata");if(c&&c.hasOwnProperty("crm"))E(b,c);else{var d=$(a).attr("id");d=d.substring(3,d.length);var e=l[d];e.cid?($(b).val(""),zmail.ContactBook.get({categoryid:e.cid,includeOnlyPrimary:!0}).done(function(a){a.forEach(function(a){E(b,a.attrs)})}).fail(function(){window.console.log("Error while fetching contacts for category !")})):E(b,e)}},fillContacts:function(a,b,c,d){var f,g=0;""===b&&(b="zm_afill");var i=n($(a));if(c)for(var j in c){Array.isArray(c[j])||(c[j]=[c[j]]),f=c[j],g=f.length;for(var k=0;k<g;k++)E(a,f[k],!1)}else if(!d)if(1===e.parseContacts($(a).val()).length||i.supressBlur)if("edit"!==b||$("#"+b).is(":visible"))if($("#"+b).is(":visible")){var m=$("#"+b+" .sel"),p=m.attr("id"),q=m.data("cdata");if(q&&q.hasOwnProperty("crm"))E(a,q);else if(i=n($(a)),p){p=p.substring(3,b.length);var r=l[p];r.cid?zmail.ContactBook.get({categoryid:String(r.cid),includeOnlyPrimary:!0}).done(function(b){b.forEach(function(b){E(a,b.attrs)})}).fail(function(){window.console.log("Error while fetching contacts for category !")}):E(a,r)}else i.callback&&i.callback()}else o($(a)[0])&&E(a);else""===$(a).val()&&(t($(a)),Z($(a))),$(a).attr("data-ty","edit"),E(a);else"edit"===b&&""===$(a).val()?(t($(a)),Z($(a))):h.contactFill($(a).val(),a);return $("#"+b).hide(),!0},getAddress:function(a,b,c){var d,f,g,h,i=J(a),j=[],k=!1,l=0,m=i.length;if(k=0!==$(a).siblings(".zmerr").length,"String"===b||"id"===b){for(l=0;l<m;l++)g=i[l],"id"===b?(d=g.id?g.id:g.zid,j.push(d)):g["class"]&&g["class"].indexOf("zmerr")!==-1||(h=e.constructContact({email:g.eid,firstName:g.fn,lastName:g.ln}),j.push(h));j=j||[],f=j.join(",");var n=c?{address:f,count:m,error:k}:f;return n}return i},clearData:function(a,b){F(a,b)},clearView:function(a){$(a).parent().find(".SC_cs").remove()},resizeInput:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};b.resetWidth&&$(a).css({width:"auto"});var c=$(a).parent(),d=$(c).width(),e=$(c).children(".SC_cs").length,f=0,g=0;$(c).children(":not(.SC_cs)").each(function(){$(a)[0]!==$(this)[0]&&(g+=$(this).width())});var h=!1;if(e>0){var i=$(c).children(".SC_cs:last"),j=$(c).offset().left,k=$(i).width(),l=$(i).offset().left;h=d-(l-j+k)-g<50,f=h?d-g-30:d-(l-j+k)-g-30}else f=d-g-30;return $(a).attr("placeholder")&&$(a).data("placeholder",$(a).attr("placeholder")),0===e&&$(a).data("placeholder")?$(a).attr("placeholder",$(a).data("placeholder")):$(a).attr("placeholder",""),$(c).height()>=61&&($(c).scrollTop($(c).scrollTop()+61),$(c).css({height:"61px","overflow-y":"auto"}),$(c)[0].scrollTop=$(c)[0].scrollHeight),0===$(c).scrollTop()&&$(c).height("auto"),$(a).width(f),{isNextLine:h}},mentionData:function(a,b){var c=null;return b?p(a,b,"",!0):(d.updateElements(a),c=J(a)),c},updateArray:ta,removeContact:t,contactFill:function(a,b,c,d,f){var g,i,j;for(f=f||{},d=d||[],!a&&d.length?g=d:("compose"===f.source&&(a=ua(a)),
g=e.splitncheck(a,"object",f)),i=g.length,j=0;j<i;j++)E(b,g[j],!1,c,f);h.resizeInput(b)},addGroupData:function(a,b){var c;for(c in b)E(a,b[c],!1);h.resizeInput(a)},setAutofill:function(a,b,c){c=c||{};var d=String(m.key-1);if(a.keyID=d,"1"===String(a.OType)&&($(b).on("paste.emailInput",function(a){ha(a,b)}),$(b).on("keyup.emailInput",function(a){ia(a,b)}),$(b).on("change.emailInput",function(a){ia(a,b)}),$(b).on("focus.emailInput",function(b){var c=a.onInputFocusBlur;"function"==typeof c&&c({type:"focus",event:b,elem:b.target})}),$(b).on("blur.emailInput",function(b){var c=a.onInputFocusBlur;"function"==typeof c&&c({type:"blur",event:b,elem:b.target})})),"3"===String(a.OType)){if($(b).parent().hasClass("zm_mention"))return;$(b).wrap('<div class="zm_mention" style="color: transparent;" />'),$(b).before('<div class="zm_mentionbg"/>'),$(b).on("change",function(){la(this,{heightPadding:a.heightPadding||0})}),$(b).on("input",function(b){da(b,this,a.OType)}),$(b).on("paste.autofill",function(b){fa(b,this,a.OType)}),a.resize&&$(b).focusin(function(){la(this,{heightPadding:a.heightPadding||0})}),a.resize||$(b).on("focusout.autofill",function(){""===$(this).val().trim()&&$(this).removeAttr("style")}),$(b).on("paste",function(b){fa(b,this,a.OType)})}else $(b).hasClass("zm_sgst")||$(b).addClass("zm_sgst");ea(a,b);var e=function(b){v(b,this,a,"up")};return $(b).off("keyup.autofill").on("keyup.autofill",e),$(b).off("keydown.autofill").on("keydown.autofill",function(b){ra(b,this,a.OType)}),"1"!==String(a.OType)||a.supressBlur||$(b).off("blur.autofill").on("blur.autofill",function(){h.fillContacts(this,"zm_afill",null)}),$(b).off(y).on(y,function(c){qa(c,this,a.OType),oa(c,this,a.OType,a.oneMention),a.keyCallback&&a.keyCallback(a.keyParam),"3"!==String(a.OType)||13!==c.which&&13!==c.keyCode||(c.preventDefault(),ma(b,{heightPadding:a.heightPadding||0}))}),m.key-1},removeAutoFill:function(a){var b,c=m[a],d="change input paste focusout keyup keydown blur";c&&(delete m[a],b=c.ele,b&&($(b).off(d),$(b).off(y)))},filterArray:M,showAutoFill:function(a,b){_(a,b.contentArray,b.OType,"SC_Phr",b.callback),U(a,b.contentArray,b.compare,b.OType,b.callback)}};return va._dataStore={cacheData:function(){return k},fillData:function(){return l},storeData:function(){return m}},va.removeMenu=function(){A&&(g.unmount(A,!0),A=null)},va.isVisible=function(){return Boolean(A)},va.resizeTextArea=la,i.init(),$.extend(!0,h,va)}),define([],function(a){var b=a("zmail.Core.Namespaces"),c=zmail.Utils.DOM,d=b.create("zmMention"),e=function(a){return a.replace(/\$/gim,"$$$$")},f=function(a){return c.getData(a,"mentions")||[]},g=function(b,d){var e=a("_");d=d||[];var f=c.getData(b,"prevMentions")||[],g=d.length-f.length,h=!1,i=function(a){return a.zid},j=f.map(i),k=d.map(i),l=[];g>0?(h=!0,l=e.difference(k,j)):l=e.difference(j,k),g=Math.abs(g),c.setData(b,"mentions",d),g>0&&c.element(b).triggerHandler("mentions/change",{mode:h?"add":"remove",count:g,zidList:l}),c.setData(b,"prevMentions",[].concat(d))},h=function(a,b,e){var h=d.getCaretPosition(a),i=c.getValue(a).substring(0,h),j=i.lastIndexOf("@"),k=i.charAt(j-1);k&&" "!==k&&"\n"!==k&&(j=-1),j<0&&e&&(j=i.lastIndexOf("+")),k=i.charAt(j-1),k&&" "!==k&&"\n"!==k&&(j=-1);var l=b.name||b.fn;if(j>=0){var m=c.getValue(a).substring(0,j);c.setValue(a,m+l+"\ufeff"+c.getValue(a).substr(h));var n=(m+l+"\ufeff").length;d.setCaretPosition(a,n),b.from=m.length,b.to=n}var o=f(a);o.length&&o[0].from>=b.from?o.unshift(b):o.push(b),g(a,o),d.updateElements(a)},i={isAtPressed:!1,getCaretPosition:function(a){var b=0;if(document.selection){a.focus();var c=document.selection.createRange();c.moveStart("character",-a.value.length),b=c.text.length}else(a.selectionStart||0===a.selectionStart)&&(b=a.selectionStart);return b},getSelection:function(a){var b={};return b.start=a.selectionStart,b.end=a.selectionEnd,b},setSelection:function(a,b){a.focus(),a.setSelectionRange(b.start,b.end)},insertAtCursor:function(a,b){var c;if(document.selection)a.focus(),c=document.selection.createRange(),c.text=b;else if(a.selectionStart||0===a.selectionStart){var d=a.selectionStart,e=a.selectionEnd;a.value=a.value.substring(0,d)+b+a.value.substring(e,a.value.length),a.selectionStart=d+b.length,a.selectionEnd=d+b.length}else a.value+=b},insertNodeAtCaret:function(a){var b=window.getSelection();if(b.rangeCount){var c=b.getRangeAt(0);c.collapse(!1),c.insertNode(a),c.selectNodeContents(a),c.collapse(!1),b.setSingleRange(c)}},getMentions:function(a){return f(a)},getUserText:function(a){return d.updateElements(a,!0)},setCaretPosition:function(a,b){if(null!==a)if(a.createTextRange){var c=a.createTextRange();c.move("character",b),c.select()}else"undefined"!=typeof a.selectionStart?(a.focus(),a.setSelectionRange(b,b)):a.focus()},isCharTyped:function(a,b){var e=d.getCaretPosition(b),f=$.trim(c.getValue(b)).substring(0,e),g=f.lastIndexOf(a),h=f.lastIndexOf(" "),i=f.lastIndexOf("\n");return g>=0&&(h<=g||g>=i)},isAtTyped:function(a){return d.isCharTyped("@",a)},isPlusTyped:function(a){return d.isCharTyped("+",a)},getVal:function(a,b,e,f){!b&&c.selector(".SC_Psli").length&&(b=c.element(c.selector(".SC_Psli"),!0)),b&&h(a,e,f),d.isAtPressed=!1},placeCaretAfterNode:function(a){var b,c;window.getSelection&&(b=window.getSelection(),b.rangeCount&&(c=b.getRangeAt(0),c.setStartAfter(a),c.setEndAfter(a),b.removeAllRanges(),b.addRange(c)))},placeCaretBeforeNode:function(a){var b,c;window.getSelection&&(b=window.getSelection(),b.rangeCount&&(c=b.getRangeAt(0),c.setStartBefore(a),c.setEndBefore(a),b.removeAllRanges(),b.addRange(c)))},updateElements:function(b,d){var h,i,j,k,l,m=a("zmCont"),n=a("zmAutoFill"),o=c.getValue(b)||"",p=c.element(b).siblings(".zm_mentionbg"),q=f(b),r=0,s=[],t=[],u=[],v=[];for(r=0;r<q.length;r++)h=q[r].name||q[r].fn,i=q[r].id||q[r].zid;k=o.replace(/</g,"&lt;").replace(/>/g,"&gt;");var w=c.getData(b,"gid")||"",x="";for(r=0;r<q.length;r++){h=q[r].name||q[r].fn,i=q[r].id||q[r].zid,l=o.indexOf(h+"\ufeff"),l!==-1&&s.push(q[r]),x="zm_groupMember",w&&w!==q[r].zid&&(x=m.isGroupMember(q[r].zid,w)?"zm_groupMember":"zm_otherMember"),j=l,t.push(j),u.push(j+h.length),v.push(i);var y=zdom("b",{className:x,z:i},e(h));y=c.element(y,!0).outerHTML,k=k.replace(h+"\ufeff",y)}t.length&&n.mentionData(c.element(b),{from:t,to:u,text:v}),"\n"===k.charAt(k.length-1)&&(k+=" "),c.__dangerouslySetInnerHTML(p,k),g(b,s);var z=d?o.replace(/\uFEFF/gi," "):c.getValue(b);return z},clearMention:function(a){c.removeData(a,"mentions"),c.removeAttribute(a,"style"),c.clearHTML(c.element(a).siblings(".zm_mentionbg"))},resizeTArea:function(a,b,d){d||(a.style.height="auto");var e=a.offsetHeight-a.clientHeight,f=a.scrollHeight+e+"px";a.style.height=f,b||""!==c.getValue(a).trim()||c.removeAttribute(a,"style")}};return $.extend(!0,d,i)}),define([],function(a){var b,c=a("zmText"),d=a("zmail.Core.Namespaces"),e=a("zmail.Utils.DOM"),f=d.create("zmComponent"),g={topAnn:"SC_topAnnBan",slideUp:"slideUp"},h={ANN_SHOW:"/announcement/show",ANN_HIDE:"/announcement/hide"},i="200",j=c.get("commonComponents","announcement"),k=['<div ref="wrapper" class="zmTopAnnBan show">','<div class="zmTopAnnBanWra">','<span ref="contentArea" class="zmTopAnnBanMsg">',"</span>",'<i ref="slideUp" class="msi-prev slideHit" />','<span ref="close" class="zmBanDis"></span>',"</div>",'<div ref="toggler" class="zmTopAnnBanTog"></div>',"</div>"].join(""),l=function(a){var b="";"s"===a?b=h.ANN_SHOW:"h"===a&&(b=h.ANN_HIDE),setTimeout(function(){$.publish(b)},i)},m=function(){e.removeClass(document.body,g.topAnn),e.unmount(b.wrapper,!0),b=void 0,l("h")},n=function(){e.addClass(document.body,g.topAnn)},o=function(a){e.hasClass(b.wrapper,g.slideUp)?(e.removeClass(b.wrapper,g.slideUp),e.addClass(document.body,g.topAnn),l("s")):(e.addClass(b.wrapper,g.slideUp),e.removeClass(document.body,g.topAnn),l("h"))},p=function(a,b){e.setText(a.close,j.doNotShow),e.element(a.slideUp).on("click",o),e.element(a.close).on("click",function(a){m(),"function"==typeof b.closeAction&&b.closeAction()}),e.element(a.toggler).on("click",o)},q=function(c){var d,f=a("_zm");c=c||{},b&&b.wrapper&&m(),d=f.getDOMReferenceMap(k,!0),"html"===c.contentType?e.__dangerouslySetInnerHTML(d.contentArea,c.content):"text"===c.contentType&&e.setText(d.contentArea,c.content),p(d,c),n(),e.mount(d.wrapper,document.body),l("s"),b=d};return f.showAnnouncementBanner=q,f}),define([],function(a){var b=a("zmail.Core.Namespaces"),c=b.create("zmail.Components.InputSuggestionMenu"),d={SHOW_LIST:"shw",SELECTED_ITEM:"SC_Psli"},e={itemSelected:"itemSelected",escapeKeyDown:"escapeKeyDown",selectionChanged:"selectionChanged"},f={LIST:['<div class="SC_dd SC_zi900" ref="wrapper">','<div class="content-wrapper" ref="contentWrapper">','<ul class="SC_P2r" ref="listWrapper">',"</ul>","</div>","</div>"].join(""),LIST_ITEM:['<li class="list-item" ref="wrapper">',"<div>",'<span style="font-weight: 600;" ref="name"></span>','<span ref="email"></span>',"</div>",'<img ref="profile" />',"</li>"].join("")},g=function(){function a(b){babelHelpers.classCallCheck(this,a);var c=this;b=b||{},c.dom=null,c.refs=null,c.targetInput=null,c.list=[],c.containerDOM=document.body,c.initialized=!1,c.selectedItem=null,c.visible=!1}return babelHelpers.createClass(a,[{key:"_throwErrorIfNotInit",value:function(){var a=this;if(!a.initialized)throw new Error("Not initialized !")}},{key:"getTemplate",value:function(){return f.LIST}},{key:"getListItemTemplate",value:function(){return f.LIST_ITEM}},{key:"init",value:function(a){var b=this;if(a=a||{},b.list=a.list||[],b.containerDOM=a.container||document.body,b.targetInput=a.input||null,!b.targetInput)throw new Error("Input element is required !");b.initDOM(),b.render(),b.bindEvents(),b.initialized=!0}},{key:"destroy",value:function(){var a=this;a.unbindEvents(),$(a.dom).remove(),a.clearSelection(),a.dom=null,a.list=null,a.containerDOM=null,a.targetInput=null,a.initialized=!1,a.selectedItem=null,a.visible=!1}},{key:"_handleItemClick",value:function(a){var b=this,c=a.currentTarget;b.setSelection($(c).data().id),$(b).triggerHandler(e.itemSelected,{id:$(c).data().id}),a.stopPropagation()}},{key:"_moveSelectionUp",value:function(){var a=this;if(!a.selectedItem){var b=$(a.refs.listWrapper).find("li").last();return void a.setSelection($(b).data().id)}var c=$(a.refs.listWrapper).find("."+d.SELECTED_ITEM),e=$(c).prev();e.length?a.setSelection(e.data().id):a.setSelection($(a.refs.listWrapper).find("li").last().data().id)}},{key:"_moveSelectionDown",value:function(){var a=this;if(!a.selectedItem){var b=$(a.refs.listWrapper).find("li").first();return void a.setSelection($(b).data().id)}var c=$(a.refs.listWrapper).find("."+d.SELECTED_ITEM),e=$(c).next();e.length?a.setSelection(e.data().id):a.setSelection($(a.refs.listWrapper).find("li").first().data().id)}},{key:"_handleInputKeydown",value:function(a){var c=this;if(c.visible){var d=b.get("zmail.Components.AutoComplete.Constants"),f=d.KEYS,g=a["while"]||a.keyCode,h=!1;switch(g){case f.UP:c._moveSelectionUp(),h=!0;break;case f.DOWN:c._moveSelectionDown(),h=!0;break;case f.ENTER:c.selectedItem&&$(c).triggerHandler(e.itemSelected,{id:c.selectedItem}),h=!0;break;case f.ESC:$(c).triggerHandler(e.escapeKeyDown,{}),h=!0}h&&(a.stopPropagation(),a.preventDefault())}}},{key:"_handleMouseDown",value:function(a){a.stopPropagation()}},{key:"_handleClick",value:function(a){a.stopPropagation()}},{key:"bindEvents",value:function(){var a=this;$(a.dom).on("mousedown",a._handleMouseDown),$(a.dom).on("click",a._handleClick),a._handleItemClick=a._handleItemClick.bind(a),$(a.dom).on("mousedown","li.list-item",a._handleItemClick),a._handleInputKeydown=a._handleInputKeydown.bind(a),$(a.targetInput).on("keydown",a._handleInputKeydown)}},{key:"unbindEvents",value:function(){var a=this;$(a.dom).off("mousedown",a._handleMouseDown),$(a.dom).off("click",a._handleClick),$(a.dom).off("mousedown","li.list-item",a._handleItemClick),$(a.targetInput).off("keydown",a._handleInputKeydown)}},{key:"initDOM",value:function(){var a=this,c=b.get("zmail.Components.AutoComplete.Utils");a.initialized||a.dom||(a.dom=c.constructDOM(a.getTemplate()),a.refs=c.getDOMReferenceMap(a.dom,!0))}},{key:"setSelection",value:function(a){var b=this,c=!1;b.clearSelection(),$(b.refs.listWrapper).find("li").each(function(b,e){$(e).data().id===a&&($(e).addClass(d.SELECTED_ITEM),c=!0)}),c&&(b.selectedItem=a,$(b).triggerHandler(e.selectionChanged,{id:b.selectedItem}))}},{key:"clearSelection",value:function(){var a=this;$(a.refs.listWrapper).find("."+d.SELECTED_ITEM).removeClass(d.SELECTED_ITEM),a.selectedItem=null}},{key:"renderListItem",value:function(a){var c=this,e=b.get("zmail.Components.AutoComplete.Utils");if(!a.email)return null;var f=e.constructDOM(c.getListItemTemplate()),g=e.getDOMReferenceMap(f,!0);$(g.name).text(a.name),$(g.email).text(a.email),$(g.profile).attr({src:zmResource.get("image","SC-Photo.png")}),zmail.Utils.Image.load(a.photo).done(function(){$(g.profile).attr({src:a.photo}).fadeIn()});var h=a.id||a.email;return $(f).data({id:h}),h===c.selectedItem&&(c.clearSelection(),c.selectedItem=h,$(f).addClass(d.SELECTED_ITEM)),f}},{key:"render",value:function(){var a=this,b=a.refs,c=a.list;$(b.listWrapper).html("");var d=document.createDocumentFragment();c.forEach(function(b){var c=a.renderListItem(b);c&&d.appendChild(c)}),$(b.listWrapper).append(d)}},{key:"positionList",value:function(){var a=this,c=b.get("zmail.Components.AutoComplete.Utils");$(a.dom).css({visibility:"hidden",display:"inline-block"}),c.positionDOM({dom:a.dom,viewPortBounds:c.getListComponentViewPort(),anchorBounds:a.targetInput.getBoundingClientRect()}),$(a.dom).css({visibility:"",display:""})}},{key:"show",value:function(){var a=this;a._throwErrorIfNotInit(),a.positionList(),$(a.dom).addClass(d.SHOW_LIST),a.visible=!0}},{key:"hide",value:function(){var a=this;a._throwErrorIfNotInit(),$(a.dom).removeClass(d.SHOW_LIST),a.clearSelection(),a.visible=!1}},{key:"mount",value:function(){var a=this;a._throwErrorIfNotInit(),$(a.dom).appendTo(a.containerDOM)}},{key:"unmount",value:function(){var a=this;a._throwErrorIfNotInit(),a.hide(),$(a.dom).detach(),a.clearSelection()}}]),a}(),h=function(b){var c=a("zmAppLoader"),d=$.Deferred();return setTimeout(function(){c.load("autoComplete").done(function(){d.resolve(new g(b))})},0),d.promise()};return c.createMenu=h,c.Events=e,c.BaseClass=g,c});