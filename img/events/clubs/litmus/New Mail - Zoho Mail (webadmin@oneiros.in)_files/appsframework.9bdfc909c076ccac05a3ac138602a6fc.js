"use strict";define([],function(a){var b,c,d=a("_zm"),e=a("$"),f=a("zmText"),g=a("zmAjq"),h=a("zmAppLoader"),i=a("zmail.Core.Namespaces"),j=a("zmail.Utils.DOM"),k=i.create("zmApp"),l=!1;zmail.extAppsDeferred={},zmail.extAppsDeferred.contacts={},zmail.extAppsDeferred.calendar={};var m=function(a){if(a=(a||"").trim()){var b=a.indexOf("//");return b>=0&&(b+=2,a=a.substring(b)),"//"+a}},n=function(a){var b=e.Deferred(),c=zmComponent.loadingMasks({maskText:a});b.done(function(){setTimeout(function(){c.remove()},500)}),zmsuite.appLoadingBand=b},o=function(){var b=a("zmsuite"),c=a("zmInit"),d=a("zmTab");if(b.isWorkspaceAvailable("zm_Container")){var e=b.getAppObj("zm_Container");d.setTabForApp(e.obj),b.showApp("zm_Container"),b.getLeft().setListener("click",function(a){c.bindLeftActions(a)}),b.getLeft().setListener("contextmenu",function(a){c.bindLeftActions(a)}),b.getLeft().getNodes()[0].getLayer("zmlTreeH").setChildToggle(c.viewChild)}else c.initMailSuite()},p=function(b){var c,d=a("zmsuite"),e=a("zmTab");if(d.isWorkspaceAvailable("zm_notes")){var g=d.getAppObj("zm_notes");c=a("znNote"),e.setTabForApp(g.obj),d.showApp("zm_notes"),c.showNotesApp(b)}else n(f.get("appsframework","switchingBand.notes")),h.load("notes").then(function(){c=a("znNote"),zmail.ContactBook.fetchProcess.done(function(){c.notesLoad(b)})})},q=function(){var b,c=a("zmsuite");c.isWorkspaceAvailable("zm_task")?(b=a("zmTask"),b.init()):(n(f.get("appsframework","switchingBand.tasks")),h.load("task").then(function(){b=a("zmTask"),b.init()}))},r=function(){var b=a("zmsuite"),c=a("zmLink");b.isWorkspaceAvailable("zm_link")?c.App.Core.init():(n(f.get("appsframework","switchingBand.links")),h.load("links").then(function(){zmail.ContactBook.fetchProcess.done(function(){c.App.Core.init()})}))},s=function(){var a,c;if(a=e.Deferred(),b)a.resolve(b);else{c="/zm/ncal/loadjs.do",c+="?lang="+f.currentLang.substr(0,2),f.displayedVariant&&(c+="&country="+f.displayedVariant);var h=function(){d.succErrMsg("e",f.get("appsframework","calendarError")),a.reject()};g.XHR({u:c,t:"GET",fn:function(b){a.resolve(b)},onerror:h})}return a},t=function(){var a;return a=e.Deferred(),e.when(s()).then(function(c){b=c,a.resolve()}),a},u=function(a){if(zmail.extAppsDeferred.calendar[a])return zmail.extAppsDeferred.calendar[a].promise();var c=e.Deferred();return t().then(function(){var d,e;d=b.jsPath||zmail.urls.calURL,e=b.cssPath||zmail.urls.calURL,b[a].css&&h.loadFiles("extcss",(b[a].css||[]).map(function(a){var b=e+a;return m(b)})),h.loadFiles("extjs",(b[a].js||[]).map(function(a){var b=d+a;return m(b)})).then(c.resolve)}),zmail.extAppsDeferred.calendar[a]=c,c.promise()},v=function(){s().then(function(a){var b=a.cssPath||zmail.urls.calURL;a.calendar.css&&h.loadFiles("extcss",(a.calendar.css||[]).map(function(a){var c=b+a;return m(c)}))})},w=function(){var a;if(a=e.Deferred(),c)a.resolve(c);else{var b="/zm/zc/new/jsp/loaded.jsp";g.XHR({u:b,t:"GET",fn:function(b){a.resolve(b)},xhr:!1})}return a},x=function(){var a;return a=e.Deferred(),w().then(function(b){c=b,a.resolve()}),a},y=function(a){if(zmail.extAppsDeferred.contacts[a])return zmail.extAppsDeferred.contacts[a].promise();var b=e.Deferred();return x().then(function(){var d,f;d=c.jsPath,f=c.cssPath,c[a].css&&h.loadFiles("extcss",(c[a].css||[]).map(function(a){var b=f+a;return m(b)})),h.loadFiles("extjs",(c[a].js||[]).map(function(a){var b=d+a;return m(b)})).then(function(){e.publish("contacts/metaDataLoaded",{data:c.metaJson}),b.resolve()})}),zmail.extAppsDeferred.contacts[a]=b,b.promise()},z=function(a){u("streamEvent").done(function(){"function"==typeof a&&a()})},A=function(a,b){u("calendar").done(function(){e.publish(a,[b])})},B=function(a){l?a&&e.publish(a):y("contacts").done(function(){l=!0,a&&e.publish(a)})},C=function(){u("picker"),B()},D=function(){var a=e.Deferred();return u("setting").done(a.resolve).fail(a.reject),a.promise()};e.extend(!0,k,{selectionClass:"SC_mailApp",currentApp:"m",selectApp:function(a){if(a&&!zmail.fromOtherService)switch(a){case"m":zmail.accId===zmail.defAccId&&zmail.appList.appObj.mail.selectApp();break;case"n":zmail.appList.appObj.notes.selectApp();break;case"t":zmail.appList.appObj.task.selectApp();break;case"c":zmail.appList.appObj.cal.selectApp();break;case"cn":zmail.appList.appObj.contacts.selectApp();break;case"l":zmail.appList.appObj.links.selectApp()}},showApp:function(b,c){var e=a("zmUtil");e.hideMenu();var g=f.get("appsframework","createText"),h="SC_mailApp";k.selectedApp=b,"m"===b?(g=d.isSmartComposeEnabled()?f.get("appsframework","smartCompose"):f.get("appsframework","composeText"),o()):"n"===b?(g=f.get("appsframework","createNote"),p(c),h="SC_noteApp"):"t"===b?(g=f.get("appsframework","createTask"),q(),h="SC_taskApp"):"c"===b?(g=f.get("appsframework","createEvent"),A("/calendar/load"),h="SC_calApp"):"cn"===b?(g=f.get("appsframework","createContact"),B("/contacts/load"),h="SC_contApp"):"l"===b&&(g=f.get("appsframework","createLink"),r(),h="SC_linkApp"),k.selectApp(b);var i=j.selector(".zm_comp span").eq(0);j.setText(i,g),j.removeClass(document.body,k.selectionClass),j.addClass(document.body,h),k.selectionClass=h,k.currentApp=b},loadCalendar:A,loadCalendarJS:t,loadPicker:C,loadStreamEvent:z,loadCalendarCSS:v,loadCalendarSettingsResources:D});var E=function(){zmail.postJsDeffered.promise.then(function(){k.loadPicker()})};return E(),k});