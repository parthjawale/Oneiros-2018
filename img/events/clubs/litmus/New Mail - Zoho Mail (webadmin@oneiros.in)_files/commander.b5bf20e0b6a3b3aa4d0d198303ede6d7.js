"use strict";!function(a){a.call(zmail.Core.Namespaces.create("zmail.Commander.Views"),zmail.Core.Namespaces.get)}(function(a){var b,c,d,e,f,g,h,i,j,k=a("_"),l=a("$.Deferred"),m=a("$.when"),n=!0,o=this;this.isDefaultPrevented=function(){return n===!1},this.init=k.once(function(){g=a("zmail.Paginator"),f=a("zmail.SearchComponents.ListView"),e=a("zmail.Search.ModeKeeper"),h=a("zmail.Search.Utils.CommonUtil"),b=a("zmail.Search.ViewInstance.SearchBox"),c=a("zmail.Search.ViewInstance.SearchBoxContainer"),d=new f({$for:b.$el,$top:c.$els.$el,$parent:c.$els.$el,pageSize:10,hideOnRemove:!0,selectionStartIndex:0,onEscape:function(){e.mode=e.MODES.COMMANDS},onMouseDown:function(){e.mode=e.MODES.COMMANDS},text:function l(a,b){if(k.isString(a))return a;if(j){var l=j.text||"description";if(k.isFunction(l))return l(a);if(k.isObject(a)&&k.isString(l)){var c=a[l];if(k.isString(c))return c;if(k.isArray(c)){var d=(b.query||"").toLowerCase();return k(c).find(function(a){return 0===a.toLowerCase().indexOf(d)})}return""}}},paginator:new g({pageSize:10,provider:function(a){if(j){if(k.isFunction(j.provider))return j.provider(a.query);if(k.isArray(j.provider)){var b=(a.query||"").toLowerCase(),c=j.filterProps||k.isString(j.text)&&j.text;return c&&(c=k.isArray(c)?c:[c]),j.provider.filter(function(a){return k.isString(a)?a.toLowerCase().indexOf(b)!==-1:!k.isObject(a)||!c||h.isStartsWith(a,b,c,!0)})}}return[]}}),onSelect:function(a){i&&i.resolve(a),o.clearText().reset()}}).unbind(),b.registerModeHandler(e.MODES.COMMAND_EXECUTION,{autofill:function(){return d}})}),this.showList=function(a){return j=a,i=l(),d.reset(),k.defer(function(){e.mode=e.MODES.COMMAND_EXECUTION,m(d.change(b.getText())).then(function(){b.select()})}),i.promise()},this.setText=function(a){return b.setText(a),this};var p=this.clearText=function(){return b.setText(""),this};this.setPlaceholder=function(a){return b.setPlaceholder(a),this},this.preventDefault=function(){return n=!1,this},this.reset=function(b){if(n||b){n=!0,i=j=void 0;var d=a("zmail.Search.Models.Contexts.Commands"),f=a("zmail.Search.SearchWatcher").getCurrentContext(),g=a("zmTab.currentTab");f===d&&d.tabRegexp.test(g)?e.mode=e.MODES.COMMANDS:e.mode=e.MODES.SEARCH,p(),k.defer(function(){c.hideCloseIcon().unselect()})}}}),function(a){a.call(zmail.Core.Namespaces.create("zmail.Commander"),zmail.Core.Namespaces.get)}(function(a){var b=a("_"),c=this.Command=function(a){return this instanceof c?(a=a||{},void b.extend(this,this.defaults(),a)):new c(a)};c.prototype={defaults:function(){return{name:"",group:"",description:"",action:b.noop,searchable:!0}},getDescription:function(a){var c=this.description;return b.isEmpty(c)?"":(b.isArray(c)||(c=[c]),b.isEmpty(a)?c[0]:(a=a.toLowerCase(),b(c).find(function(b){return 0!==b.toLowerCase().indexOf(a)})))},getDisplayValue:function(a){return a}}}),function(a){a.call(zmail.Core.Namespaces.create("zmail.Commander"),zmail.Core.Namespaces.get)}(function(a){var b=a("_"),c=a("zmUtil"),d=a("zmail.Maps.Map"),e=a("zmail.Maps.DelimitedMap"),f=a("zmail.Commander.Views"),g=a("zmail.Commander.Command"),h=a("zmail.ValueTypeInferrer.TYPE_NAMES"),i=new e,j=new d,k={},l=[],m={},n=this,o=function(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},p=function(){return{execute:n.execute,getByGroupName:n.getByGroupName,showList:f.showList,setText:f.setText,clearText:f.clearText,setPlaceholder:f.setPlaceholder,preventDefault:f.preventDefault,reset:f.reset.bind(this,!0)}},q=function(a){return a?(b.isArray(a)||(a=[a]),a):[]};this.serialize=function(a){if(a){var b=a.command;a.description||(a.description=b.getDescription(a.qry)),a.value&&!a.displayValue&&b.type&&(a.displayValue=b.getDisplayValue(a.value)),a.command=b,a.__command=!0}return a},this.register=function(a){return q(a).reduce(function(a,b){var d=b.name;return d in m&&c.debugLog("command-name: "+d+" already exits"),n.isCommand(b)||(b=new g(b)),m[d]=b,b.searchable&&q(b.description).forEach(function(a){l.push(a),k[a]=d}),q(b.group).forEach(function(a){i.add(a,d)}),b.type&&j.add(b.type,d),a},this),l.sort(),this},this.deRegister=function(a){var b=m[a];return b&&(delete m[a],b.searchable!==!1&&q(b.description).forEach(function(a){a=a.toLowerCase();var b=l.indexOf(a);b!==-1&&a.splice(b,1),delete k[a]}),q(b.group).forEach(function(b){i.remove(b,a)})),this},this.get=function(a){if(!a)return[];a=a.toLowerCase();var b={},c=new RegExp("\\s+\\w*\\W*"+o(a),"i");return l.filter(function(b){return b=b.toLowerCase(),b.indexOf(a)>=0||b.match(c)}).reduce(function(c,d){var e=m[k[d]];return e.name in b||(b[e.name]=e.name,c.push(n.serialize({qry:a,command:e,description:d}))),c},[])},this.getCommand=function(a){return m[a]},this.getByGroupName=function(a){return i.get(a).map(function(a){return m[a]})},this.getCommandsBasedOnTypes=function(a){return h.reduce(function(b,c){var d=a[c];return d?b.concat(j.get(c).map(function(a){return n.serialize({value:d,command:n.getCommand(a)})})):b},[])};var r=this.isCommand=function(a){return a instanceof g};this.isSerializedCommand=function(a){return a&&a.__command},this.execute=function(c){if(b.isString(c)&&(c=m[c]),r(c)){a("zmail.Commander.Views").reset();var d=[].slice.call(arguments);return d.splice(0,1),c.action.apply(b.extend(p(),c),d)}}});