"use strict";!function(){var a,b,c,d,e={},f=zmail.Core.Namespaces.create("zmAttach"),g=zmText.get("attachmentUtil"),h={},i=function(a){var b=zmUtil.getMailObj(a,"FD");return b&&zmUtil.isSharedFolder(b)},j=function(a){if(!a.selInfo.iList.length||a.selInfo.iList.length===a.attList.length)return a.attList;var b=[];return a.selInfo.iList.forEach(function(c){b.push(a.attList[c])}),b},k=function(a){try{var b=zmUtil.getMailObj(a,"SB");return b&&zmUtil.replaceHtmlInSubject(b)}catch(c){return!1}},l=function(a){var b;if(b=k(a))return b=b.substring(0,75),b=b.replace(/\s/g,"_")},m={openLinkedMail:{text:g.attachmentmenu.linkedMail,elem:'<span data-msg="linkedMail">'+g.attachmentmenu.linkedMail+"</span>"},addEvent:{text:g.attachmentmenu.addevent,elem:'<span data-msg="addEvent">'+g.attachmentmenu.addevent+"</span>"},download:{text:g.attachmentmenu.download,elem:'<span data-msg="download">'+g.attachmentmenu.download+"</span>"},view:{elem:'<span data-msg="view">'+g.attachmentmenu.view+"</span>",text:g.attachmentmenu.view},"delete":{elem:'<span data-msg="delete">'+g.attachmentmenu["delete"]+"</span>",text:g.attachmentmenu["delete"]},cloud:{elem:'<span data-msg="addtocloud">'+g.attachmentmenu.addtocloud+"</span>",text:g.attachmentmenu.addtocloud},newMail:{elem:'<span data-msg="newMail">'+g.attachmentmenu.attachInMail+"</span>",text:g.attachmentmenu.attachInMail},newPost:{elem:'<span data-msg="newPost">'+g.attachmentmenu.attachInPost+"</span>",text:g.attachmentmenu.attachInPost},noteAtt:{elem:'<span data-msg="newPost">'+g.attachmentmenu.attachToNotes+"</span>",text:g.attachmentmenu.attachToNotes},taskAtt:{elem:'<span data-msg="newPost">'+g.attachmentmenu.attachToTask+"</span>",text:g.attachmentmenu.attachToTask},tag:{icon:'<span class="SC_ldot zm_lbl"><i class="msi-label" title="'+g.attachmentmenu.addTag+'" data-msg ="addTag"></i>'},saveAsHtml:{elem:'<span data-msg="saveAsHtml">'+zmText.applyArgs(g.attachmentmenu.save,{format:"HTML"})+"</span>",text:zmText.applyArgs(g.attachmentmenu.save,{format:"HTML"})},selectIcon:{elem:'<i class="msi-tick" title="Select" data-msg = "select"></i>'},dragTemplate:{elem:'<div class="zm_dragger"><div class="zm_dragCount dragtheme"></div><div class="zm_dragTxt"></div></div>'}},n=[{getElem:function(a){return m.download.elem}},{action:"view",getElem:function(b){var c=b.fileExtn,d=b.filename;if(!(a.isEmlView&&"msi-atteml"===c||"msi-attdoc"!==c&&"msi-atteml"!==c&&"msi-attppt"!==c&&"msi-atthtml"!==c&&"msi-attsheet"!==c&&"msi-attpdf"!==c&&"msi-attimg"!==c&&"msi-attaudio"!==c&&("msi-attothers"!==c||d.indexOf(".txt")===-1&&d.indexOf(".htm")===-1&&d.indexOf(".xml")===-1)))return"more"===b.from?m.view.text:m.view.elem}},{action:"addEvent",getElem:function(a){var b=a.filename;if(b.indexOf(".ics")!==-1)return"more"===a.from?m.addEvent.text:m.addEvent.elem}},{action:"delete",getElem:function(c){if("task"===b.appName&&a["delete"])return"more"===c.from?m["delete"].text:m["delete"].elem}},{action:"linkedMail",getElem:function(a){if(b&&"ML_popup"===b.appName&&b.entityInfo.isThd)return"more"===a.from?m.openLinkedMail.text:m.openLinkedMail.elem}},{action:"addtocloud",getElem:function(b){if(!a.isEmlView&&zmUtil.isAddToCloudAllowed())return"more"===b.from?m.cloud.text:m.cloud.elem}},{action:"newPost",getElem:function(b){if(!zmUtil.isChildWindow()&&!a.isEmlView)return"more"===b.from?m.newPost.text:m.newPost.elem}},{action:"newMail",getElem:function(b){if(!zmUtil.isChildWindow()&&!a.isEmlView)return"more"===b.from?m.newMail.text:m.newMail.elem}},{action:"noteAtt",getElem:function(b){if(!zmUtil.isChildWindow()&&!a.isEmlView)return"more"===b.from?m.noteAtt.text:m.noteAtt.elem}},{action:"taskAtt",getElem:function(b){if(!zmUtil.isChildWindow()&&!a.isEmlView)return"more"===b.from?m.taskAtt.text:m.taskAtt.elem}},{action:"saveAsHtml",getElem:function(b){var c=zmUtil.fileTyp(a.fn)[2];if(!a.isEmlView&&!_zm.isSecureDownloadEnabled()&&("eml"===c||"msg"===c)&&zmComponent.downloadAsFile.isSupported())return"more"===b.from?m.saveAsHtml.text:m.saveAsHtml.elem}}];h.save=function(a,b,c){if(a&&c){var d=$("<div></div>");d.append(a),zmComponent.downloadAsFile.download(d.html(),{contentType:"text",fileType:"html",fileName:c})}},h.removeMAct=function(){var a=Object.getOwnPropertyNames(e);a.forEach(function(a){e[a].remove(),delete e[a]})},h.getEMLContent=function(a,b){var c={attachId:a.Id,entityType:a.et,entityId:a.e};1!==a.et||void 0!==a.gId&&a.gId!==zmail.zuid||(c.partId=a.p,void 0===a.sid&&(c.accId=zmail.accId)),a.sid?(c.groupId=a.sid,a.gId===zmail.zuid?c.actionType="viewSelfData":c.actionType="viewGroupEntity",c.streamsView=!0):a.type?(c.groupId=a.gId,c.actionType=a.type,c.streamsView=!0):a.gId&&a.gId!==zmail.zuid&&(c.groupId=a.gId,c.actionType="viewGroupData",c.streamsView=!0),a.shId?c.shId=a.shId:i(a.e)&&(c.shId=zmUtil.getShareId(zmUtil.getMailObj(a.e,"FD"))),zmAjq.XHR({u:zmail.conPath+"/FileDownload?mode=mailview",t:"GET",fn:b,p:c,ep:{msgId:a.Id+a.e}})},h.constMailFromEml=function(a,b){var c,d=a.Id+a.e,e=function(a,b){var c=$(zmPreviewTemplate.getTemplate("content",{data:b,prms:{opentype:2,type:"plainContent"}}));zmPreviewTemplate.showImageDisplayElem(b.msgId,c,{prefix:"T"}),zmPreviewTemplate.showProfilePhoto({msgId:b.msgId,type:"lt"},c);var d;return b.NEWATT&&b.NEWATT.length&&(d=f.build({appName:"mail",attList:b.NEWATT,zipType:"",showMOpt:!1,showTag:!1,supportDrag:!0,attClass:"zmAch",attListClass:"zmPAtt",fileNameLen:23,entityInfo:{id:a}})),d&&c.find(".zmPCnt").after(d),c};zmUtil.getMailObj(d)&&zmContentCache.isCached(d)?setTimeout(function(){c=zmContentCache.get(d),b(e(d,c))},100):h.getEMLContent(a,function(a,f){var g;c=a.mdata,c.RDT=c.DATE,delete c.DATE,c.NEWATT&&c.NEWATT.length&&(c.NEWATT.forEach(function(a){a.parentEId=f.msgId,a.isEmlView=!0}),g=1);var h=f.msgId;zmUtil.addMailData({M:d,FD:"",T:"",TAG:"",NFG:"",SM:"",SB:"",TH:0,AT:g},d),c.msgId=h,zmUtil.prevCache(d,a),b(e(h,c))})};var o=function(a){var b=document.createElement("div"),c=a.selInfo.iList.length||1;return b.innerHTML=m.dragTemplate.elem,b.querySelector(".zm_dragCount").textContent=c,b.querySelector(".zm_dragTxt").textContent=1===c?g.attachmentmenu.dragMsg:zmText.applyArgs(g.attachmentmenu.attachSelMsg,{count:""}),b.innerHTML},p=function(b,f){$(b).closest(".zmL, ."+c).addClass("sel"),$(b).addClass("active"),h.removeMAct();var g,i=$(b).attr("data-showFrom")||$(b.children).attr("data-showFrom"),j=n.slice(i,n.length),k=[];a=f;for(g in j){var l=j[g].getElem({from:"more"});l&&k.push({htm:l,data:{attData:f,action:j[g].action}})}var m={divId:"moreAttachMenu",par:b,showArrow:!0,list:k,onHide:function(){$(b).parents(".zmL.zmAch").removeClass("sel"),$(b).removeClass("active")},clk:function(a,b){d(b,a),e.moreOpt.remove(),delete e.moreOpt}};if(zmUtil.isChildWindow()){var o=new zmDropDownMenu;o.setDropObj(m),o.paint(),e.moreOpt=o}else e.moreOpt=zmsuite.showMenu(m)},q=function(a,b){var c=function(a,b,c){var d=a.action;if(e.attachall.remove(),delete e.attachall,c)switch(d){case"attachInStreams":zmUtil.loadNewPostDialog("",c);break;case"attachInMail":zmUtil.openComposeWithAtt(c),zmUtil.publishCloseNotif();break;case"attachInNote":zmUtil.loadNotes("popup",{attEntObj:c});break;case"attachInTask":zmUtil.loadTask({action:"addCTask",tasks:{attEntObj:c}})}};h.removeMAct();var d=[{data:{action:"attachInStreams"},htm:g.attachmentmenu.attachAllToPost},{data:{action:"attachInMail"},htm:g.attachmentmenu.attachAllToMail},{data:{action:"attachInNote"},htm:g.attachmentmenu.attachAllToNotes},{data:{action:"attachInTask"},htm:g.attachmentmenu.attachAllToTask}];a=a.hasClass("msi-rarrow")?a:a.find(".msi-rarrow");var f={divId:"moreoptions",par:a,list:d,direction:"left",onHide:function(){a.removeClass("SC_ddn")},showArrow:!0,clk:function(a,d){var e=j(b);c(a,d,e)}};e.attachall=zmsuite.showMenu(f)},r=function(a,c){zmUtil.secureDownloader().then(function(d){var e,f="",g={},h=zmUtil.getMailObj(a.e||a.id),i=d.password;if(h&&zmUtil.isSharedFolder(h.FD)&&(e=zmUtil.getShareId(h.FD)),"dwn"===c)g={accId:zmail.accId,attachId:a.Id,entityType:a.et,entityId:a.e,partId:a.p},a.isEmlView&&(g.internalAttachId=a.IId||a.Id,c="mvAttachDwn"),f+=zmail.conPath+"/FileDownload?mode="+c,101===a.ft&&(g.isImg=!0);else if("downloadall"===c||"downloadconv"===c){f+=zmail.conPath+"/FileDownload?mode="+c,g={accId:zmail.accId,entityId:a.e||a.id,entityType:a.et||1,mode:c};var j=l(a.e||a.id);j&&(g.fName=j)}else"tmpdwn"===c&&(f+=zmail.conPath+"/FileDownload?mode=tmpdwn",g={accId:zmail.accId,fpath:a.fP,fstorename:a.sN,entityType:a.et});i&&"mvAttachDwn"!==c&&(g.pswd=i),f.length&&(e&&(g.shId=e),h?h.streams&&(delete g.accId,g.streamsView=!0,g.groupId=h.groupId,g.actionType="viewGroupEntity"):"streams"===b.appName&&("1"===a.et&&delete g.accId,g.streamsView="2"!==a.et||"Notes",g.groupId=a.groupId,g.actionType=a.actionType,g.fName="Attachments")),zmAjq.formSubmit(g,f)},function(){})},s=function(a,b,c,d){if(zmUtil.isChildWindow()&&("eml"===c||"msg"===c))return void $(d).find(".zmImg").trigger("click");var e,f;"view"===b?e="OpenDocument":"web"===b&&(e="FileDownload"),f=zmUtil.getTheSrc(e,a),f.length&&window.open(f)},t=function(a){var b="",c="";b+=zmail.conPath+"/FileDownload",b+="?mode=view&accId="+zmail.accId+"&attachId="+a.Id+"&entityType="+a.et,b+="&entityId="+a.e+"&partId="+a.p,i(a.e)&&(c=zmUtil.getShareId(zmUtil.getMailObj(a.e,"FD")),b+="&shId="+c),window.open(b)},u=function(a,b,c){var d,e,f,i=_zm.escapeTags(a.fn),j="zm_viewatt_"+a.Id+a.e,k="",l=zmUtil.fileTyp(a.fn);if(a.isEmlView&&(j+=j+a.IId),zmsuite.isWorkspaceAvailable(j)&&"restore"!==a.src)e=zmsuite.getCenter(j),zmsuite.showWorkSpace(j);else{c=c||l[1],zmUtil.publishCloseNotif();var m={appname:i,appId:j,faqKey:"attach",data:{CNodes:"3"},appIcon:c},n=$.extend({},m),o=[];"restore"!==a.src&&zmsuite.setWorkSpace(m),e=zmsuite.getCenter(j);var p,q=e[0].getNodes();p="eml"!==l[2]&&"msg"!==l[2]||_zm.isSecureDownloadEnabled()||!zmComponent||!zmComponent.downloadAsFile.isSupported()?"download":"eml"===l[2]?"eml-down":"msg-down",a.isEmlView||o.push({iconList:["msi-addcloud"],data:"addcloud",tooltip:g.attachmentmenu.addtocloud},{iconList:["msi-download"],data:p,tooltip:g.attachmentmenu.download}),"eml"!==l[2]&&"msg"!==l[2]&&"FileDownload"===zmUtil.isPreviewAvailable(a.fn).apiName&&o.push({iconList:["msi-print"],data:"print",tooltip:g.attachmentmenu.print}),a.isEmlView||o.push({iconList:["msi-action"],data:"more",tooltip:g.attachmentmenu.moreact});var r={list:{left:[],right:[{actionArr:o}]},clk:function(b,c,d){if("download"===d)zmUtil.downloadAttachment(a);else if("addcloud"===d)zmUtil.cloudUploader(a);else if("print"===d){var f=e[0].getNodes()[2].$el.find("iframe")[0];"visible"===f.style.visibility&&f.contentWindow.print()}else if("more"===d){var i=$(b.target||b.srcElement),j=i.closest("li"),k=[{htm:g.attachmentmenu.attachInMail,data:{action:"send email"}},{htm:g.attachmentmenu.attachInPost,data:{action:"share"}},{htm:g.attachmentmenu.attachToNotes,data:{action:"addNote"}},{htm:g.attachmentmenu.attachToTask,data:{action:"addTask"}}];j.find("b").addClass("SC_ddn"),zmsuite.showMenu({par:j,list:k,clk:function(b){zmUtil.hideMenu(),"send email"===b.action?zmUtil.openComposeWithAtt([a]):"share"===b.action?zmUtil.loadNewPostDialog("",[a]):"addNote"===b.action?zmUtil.loadNotes("popup",{attEntObj:[a]}):"addTask"===b.action&&zmUtil.loadTask({action:"addCTask",tasks:{attEntObj:[a]}})}})}else if("eml-down"===d||"msg-down"===d){var l=$(b.target||b.srcElement),m=l.closest("li"),n="eml-down"===d?"EML":"MSG";n=zmText.applyArgs(g.attachmentmenu.save,{format:n});var o=[{htm:n,data:{action:"eml"}},{htm:zmText.applyArgs(g.attachmentmenu.save,{format:"HTML"}),data:{action:"html"}}];m.find("b").addClass("SC_ddn"),zmsuite.showMenu({par:m,list:o,clk:function(b){if("eml"===b.action)zmUtil.downloadAttachment(a);else if("html"===b.action){var c=e[0].getNodes()[2].$el.find("#zmConT"+a.Id+a.e);c=c.html();var d=a.fn;d=d.substring(0,d.lastIndexOf(".")),h.save(c,"html",d)}zmUtil.hideMenu()}})}}},s={list:{left:{leftText:i,centerAlign:!0}}};if(q[0].push(r.list),q[0].setListener("click",r.clk),q[1].push(s.list),"eml"===l[2]||"msg"===l[2])f=zmComponent.loadingBand({container:q[2].$el[0],type:"loading"}),k=h.constMailFromEml(a,function(a){f(),q[2].$el.append(a)});else{var t;"view"===b?t="OpenDocument":"web"===b&&(t="FileDownload"),d=zmUtil.getTheSrc(t,a),k=$('<iframe style="background:white; visibility:hidden;" frameborder="0"  width="100%" height="100%" scrolling="auto" src="'+d+'"></iframe>'),f=zmComponent.loadingBand({container:q[2].$el[0],type:"loading"}),(window.ActiveXObject||"ActiveXObject"in window)&&"msi-attpdf"===zmUtil.fileTyp(a.fn)[1]?window.setTimeout(function(){f(),k.css("visibility","visible")},2e3):k.load(function(){f(),k.css("visibility","visible")})}zmsuite.renderCenter(),zmsuite.showWorkSpace(j),k&&q[2].$el.append(k),$.publish("zmail/SaveTabState",[{appId:j,app:"m",appObj:n,category:"mail_attachment",data:{attObj:a,fileExtn:c,mode:b}}])}e[0].$el.addClass("SC_attachviewer")},v=function(a,b){var c,d=zmUtil.fileTyp(b.fn),e={txt:!0,js:!0,java:!0,css:!0,jsp:!0,jspf:!0,c:!0,cpp:!0,html:!0,htm:!0,xml:!0,go:!0,eml:!0,msg:!0,sh:!0,bat:!0,log:!0},f={xml:!0,js:!0,css:!0};if("msi-attimg"!==d[1]&&zmUtil.hideMenu(),b)if("msi-attdoc"!==d[1]&&"msi-attppt"!==d[1]&&"msi-attsheet"!==d[1]&&"msi-atteml"!==d[1]||e[d[2]]||"xml"===d[2])if("msi-attpdf"===d[1]||("msi-attdoc"===d[1]||"msi-atteml"===d[1]||"msi-attothers"===d[1]||"msi-atthtml"===d[1])&&e[d[2]])if((window.ActiveXObject||"ActiveXObject"in window)&&f[d[2]])$(a).find(".zmImg").trigger("click");else{c="web";var g=zmUtil.isChildWindow();g?s(b,c,d[2],a):u(b,c,d[1])}else"msi-atthtml"===d[1]&&d[2].indexOf("htm")!==-1||"msi-attdoc"===d[1]&&"xml"===d[2]?t(b,"html"):"msi-attimg"!==d[1]&&"msi-attaudio"!==d[1]&&"msi-attvideo"!==d[1]||$(a).find(".zmImg").trigger("click");else c="view",zmUtil.isChildWindow()?s(b,c,d[2],a):u(b,c,d[1])},w=function(a,b){b=b||a.e;var c={entityId:a.e,attachId:a.Id,entityType:a.et},d=zmUtil.getMailObj(b);d?(d.streams?(c.groupId=d.groupId,c.streamsView=!0,c.actionType="viewGroupEntity"):c.accId=zmail.accId,zmUtil.isSharedFolder(d.FD)&&(c.shId=zmUtil.getShareId(d.FD))):c.accId=zmail.accId;var e=function(a){var b={added:g.attachmentmenu.eventadded,exist:g.attachmentmenu.eventupdated,error:g.attachmentmenu.eventerror};"error"===a.msg?zmUtil.succErrMsg("e",b[a.msg]):a.msg&&zmUtil.succErrMsg("s",b[a.msg])};zmAjq.XHR({u:zmail.conPath+"/OpenDocument",t:"GET",fn:e,p:c,ep:{}})},x=function(a,b){var d=function(a){$(a).closest(".zmL, ."+c).removeClass("sel")};if(zmUtil.isZohoAccount(zmail.accId)){h.removeMAct(),$(a).closest(".zmL, ."+c).addClass("sel");var f=zmAttachUtility.showLabelPopup(a,b,"",d);e.tagRef=f}},y=function(a,b,c){var d,e,f=a.e;zmContentCache.isCached(f)&&(d=zmContentCache.get(f).NEWATT,e=d.find(function(b){return b.Id===a.Id}),e[b]=c);var g=zmUtil.getMailObj(f),h=g&&g.T||g&&f;!zmUtil.isChildWindow()&&h&&zmail.mailAttachments[h]&&(d=zmail.mailAttachments[h].data.attData[f].attData,e=d.find(function(b){return b.Id===a.Id}),e[b]=c)},z=function(a){var b=a.attObj,c=a.labId,d=b.Id+b.e,e=$("div[data-refId='"+d+"']");e.length&&e.each(function(a,b){$(b).find(".zmLblGrp").append(zmsTemplates.constructTagListHTML([c],!1,"","",{constructOuterDiv:!1}))}),b.l.push(c),1===b.et&&y(b,"l",b.l)},A=function(a){var b,c=a.attObj,d=a.labId,e=c.l,f=e.indexOf(d),g=c.Id+c.e,h=$("div[data-refId='"+g+"']");e.splice(f,1),1===c.et&&y(c,"l",e),h.each(function(a,c){b=$(h).find(".zm_lbl"),b.find("div[data-mid='"+d+"']").remove()})};$.subscribe("attachment/addLabel",function(a,b){z(b)}),$.subscribe("attachment/removeLabel",function(a,b){A(b)});var B={};B.updateOptHeader=function(a){if(a.elem.headerElem){var b=a.selInfo.iList.length,c=a.elem.headerElem.querySelector("#optHeader"),d=1===b?g.attachmentmenu.singleAttSelection:"";b?b<a.attList.length?(a.elem.headerElem.querySelector("#optHeader #count").textContent=d||zmText.applyArgs(g.attachmentmenu.attachSelMsg,{count:b}),c.querySelector(".msi-tick").className="msi-tick partcheck"):b===a.attList.length&&(a.elem.headerElem.querySelector("#optHeader #count").textContent=d||zmText.applyArgs(g.attachmentmenu.attachSelMsg,{count:a.attList.length}),c.querySelector(".msi-tick").className="msi-tick SC_check"):(c.querySelector("#count").textContent=d||zmText.applyArgs(g.attachmentmenu.attachcount,{count:a.attList.length}),c.querySelector(".msi-tick").className="msi-tick")}},B.select=function(a,b,c){return b.selInfo.refList.length>=10?void _zm.succErrMsg("i",g.attachmentmenu.att_selection):(a.classList.add("SC_check"),b.selInfo.iList.push(a.dataset.detail),b.selInfo.refList.push(a),void(c||B.updateOptHeader(b)))},B.unSelct=function(a,b){var c;a.classList.remove("SC_check"),c=b.selInfo.iList.indexOf(a.dataset.detail),b.selInfo.iList.splice(c,1),b.selInfo.refList.splice(c,1),B.updateOptHeader(b)},B.selectAll=function(a){var b,c,d;for(c=a.elem.attElem.childNodes||[],d=c.length,a.selInfo.iList=[],b=0;b<d;b++)B.select(c[b],a);B.updateOptHeader(a)},B.unSelectAll=function(a){a.selInfo.refList.forEach(function(a){a.classList.remove("SC_check")}),a.selInfo.iList=[],a.selInfo.refList=[],B.updateOptHeader(a)};var C={};C.addMask=function(a,b){return a.selInfo.iList.length?void a.selInfo.refList.forEach(function(a){a.classList.add("zm_drag")}):void b.classList.add("zm_drag")},C.removeMask=function(a,b){return a.selInfo.iList.length?void a.selInfo.refList.forEach(function(a){a.classList.remove("zm_drag")}):void b.classList.remove("zm_drag")},C.onDragStart=function(a,b){var c={};return a.selInfo.iList.length?(c.allowDrag=!0,c.type={attList:j(a)},c.element=a.elem.attElem):(c.allowDrag=!0,c.type={attList:[a.attList[b.dataset.detail]]},c.element=b),c.id="draggingAtt",c.html=o(a),c.cursorPosition="left",C.addMask(a,b),$.publish("mail/draggingStarted",{text:g.attachmentmenu.dropMsg}),c},C.onDragEnd=function(a,b){C.removeMask(a,b),$.publish("mail/draggingEnded",{})},C.init=function(a){var b=new zmail.dndComp.dragSourceSibling;b.init(a.elem.attElem,{onDragStart:function(b){return C.onDragStart(a,b)},onDragEnd:function(b){return C.onDragEnd(a,b)},setDragInstance:function(a){var b=a.target,c=$(b).closest(".zmAch");return c.length?{element:c[0],setDrag:!0}:{setDrag:!1}}}),a.dragInstance=b},d=function(a,b){var c,d=a.srcElement||a.target||a,e=$(d).attr("data-msg")||b.action;if(!e)return void h.removeMAct();var f,g;switch(b.attData?f=b.attData:(c=$(d).closest(".zmAch"),g=$(c).attr("data-detail"),f=b.attList[g]),e){case"imgView":var i={attObjList:b.attList,startIndex:Number(g),hideIcons:["msi-send","msi-mail","msi-attsearch"]};zmUtil.isChildWindow()&&(i.hideIcons=["msi-send","msi-mail","msi-attsearch"]),zmUtil.initAttSlideShow(i);break;case"download":f&&("streams"===b.appName||"task"===b.appName?zmUtil.downloadAttachment(f):r(f,"dwn"));break;case"addtocloud":f&&zmUtil.cloudUploader(f);break;case"view":v($(d).closest(".zmAch"),f);break;case"addEvent":"streams"===b.appName?f.et===zmStreamsApp.constants.streamTypeName.mail?w(f,f.eId):zmUtil.addEventsToCal(f):w(f);break;case"linkedMail":zmList.getMailData({msgId:f.e,opentype:2,type:"th",src:"external"}),zmUtil.hideMenu();break;case"showMore":p(d,f);break;case"newMail":zmUtil.openComposeWithAtt([f]),zmUtil.publishCloseNotif();break;case"newPost":zmUtil.loadNewPostDialog("",[f]);break;case"noteAtt":zmUtil.loadNotes("popup",{attEntObj:[f]});break;case"taskAtt":zmUtil.loadTask({action:"addCTask",tasks:{attEntObj:[f]}});break;case"close":zmUtil.hideMenu();break;case"addTag":x(d,f);break;case"delete":zmTask.Util.deleteTaskAttachment(f);break;case"saveAsHtml":h.constMailFromEml(f,function(a){var b=a.html(),c=f.fn;c=c.substring(0,c.lastIndexOf(".")),h.save(b,"html",c)});break;case"select":c.hasClass("SC_check")?B.unSelct(c[0],b):B.select(c[0],b)}};var D=function(a,b){var c=a.target||a.srcElement,d=$(c).attr("data-msg");if("downloadall"===d||"downloadconv"===d){if(b.selInfo&&b.selInfo.iList.length){var e=j(b);return void zmUtil.downloadSelected(e,{fName:l(b.entityInfo.id||b.entityInfo.e)})}r(b.entityInfo,d)}else"moreOptions"===d?q($(c),b):"selAll"===d?c.classList.contains("SC_check")||c.classList.contains("partcheck")?B.unSelectAll(b):B.selectAll(b):h.removeMAct()},E=function(a){var b=zmAttachComponent.hugeAttachment.constructHugeAttList({name:a.fn,size:a.fs,digest:a.digest,attObj:a});return b},F=function(d,e){var f,h,i,j=d.fn,k=b.entityInfo.isThd?"zmAchLbl":"",l=zmUtil.getSubString(b.fileNameLen||25,j),m=zmUtil.fileTyp(d.fn),o=m[1],p=zmUtil.sizeValueUnround(d.fs)||"",q=d.fn.toLowerCase(),r=[],s=2;if(a=d,!b.hideOptions){for(i in n)if(h=n[i].getElem({filename:q,fileExtn:o}),h&&r.push(h),r.length>s)break;r.length>s&&(r=r.slice(0,2),r.push("".concat('<i class = "msi-action" title='+g.attachmentmenu.more+' data-msg="showMore" data-showFrom =',i,"></i>")))}r=r.join("");var t;f=zdom("div",{"data-refId":d.Id+d.e,className:"zmL "+c+" "+k,"data-detail":String(e)},zdom("div",{className:"zmLst"}));var u=_zm(".","zmLst",f)[0];b.showChkBox&&u.appendChild(zdom("div",{className:"zmFlt"},zdom("i",{className:"msi-tick",title:"Select","data-msg":"select"})));var v=zdom("div",{className:"zmDtl"});return"ML_popup"===b.appName&&d.ts&&v.appendChild(zdom("div",{className:"zmDate"},zdom("span",null,d.ts))),d.thn?v.appendChild(zdom("div",{"data-msg":"imgView",className:"zmImg"},zdom("img",{src:d.thn,"data-msg":"imgView"}))):v.appendChild(zdom("div",{"data-msg":"imgView",className:"zmImg"},zdom("i",{className:o+" zm-attIcn","data-msg":"imgView"}))),t=zdom("div",{className:"zmFrm"}),t.appendChild(zdom("span",{title:d.fn,"data-msg":"reader"===b.appName?"imgView":"view"},l)),"ML_popup"===b.appName&&d.dn&&t.appendChild(zdom("div",{className:"zmAtt_sender"},d.dn)),v.appendChild(t),r&&(t=zdom("div",{className:"zmSub"}),t.innerHTML=r,v.appendChild(t)),v.appendChild(zdom("div",{className:"zmSze"},zdom("span",{className:"sum"},p))),b.showTag&&!d.isEmlView&&(t=zdom("span",{className:"SC_ldot zm_lbl"},zdom("i",{className:"msi-label",title:g.attachmentmenu.addTag,"data-msg":"addTag"})),t.insertAdjacentHTML("beforeend",zmsTemplates.constructTagListHTML(d.l,!1,"","",{constructOuterDiv:!0})),v.appendChild(t)),u.appendChild(v),f.outerHTML},G=function(a){var b=zmAttachComponent.hugeAttachment.constructHugeAttHeader(a);return b},H=function(a){var b,c,d,e=a.attList.length;c=a.showMOpt&&e>1&&!zmUtil.isChildWindow()?'<span class="SC_plnk" data-msg ="moreOptions">'+g.attachmentmenu.addTo+'<i class="msi-rarrow SC_thm" data-msg = "moreOptions"></i></span>':"";var f=a.showChkBox?'<i class="msi-tick" data-msg = "selAll"></i>':"";d=document.createElement("div"),d.id="optHeader";var h=e&&e>1?zmText.applyArgs(g.attachmentmenu.attachcount,{count:e}):g.attachmentmenu.oneAttachment,i=a.zipType&&"none"!==a.zipType?'<span class="SC_plnk" data-msg="'+a.zipType+'">'+g.attachmentmenu.downloadaszip+"</span>":"";return d.innerHTML=f+'<b><span id = "count">'+zmText.applyArgs(h,{count:e})+"</span></b>"+i+c+"</div>",b=document.createElement("div"),b.className="SC_tp10",b.appendChild(d),b},I=function(a){try{if(!Array.isArray(a.attList))return;var e,f,g=document.createDocumentFragment(),h=!1,i=[],j=!0;b=a||{},a.entityInfo=a.entityInfo||{},a.elem={},c=a.attClass||"zmAch";var k,l,m,n,o=[],p={},q=a.attList.length;if(e=document.createElement("div"),e.className=a.attListClass||"zmPAtt",q){var r=_.pluck(a.attList,"attType");if(h=r.indexOf(4)!==-1)if(zmUtil.loadHugeAttachComponent(),f=document.createElement("div"),f.className="zmPAtt",i=_.filter(a.attList,function(a){return 4===a.attType}),i.length===q)j=!1;else{var s=_.filter(a.attList,function(a){return 4!==a.attType});a.attList=_zm.copyOf(s),q=a.attList.length}}if(a.attList.length>1&&a.supportDrag&&(a.showChkBox=!0),a.selInfo={iList:[],refList:[]},a&&a.zipType){if(h){k=document.createDocumentFragment();var t=G(i.length);a.elem.hugeHeaderElem=t,f.appendChild(t)}j&&(m=H(a),m.addEventListener("click",function(c){b=a,D(c,a),_zm.stopEvents(c)}),a.elem.headerElem=m,e.appendChild(m))}for(n=0;n<q;n++)p=a.attList[n],o.push(F(p,n));if(h){for(n=0;n<i.length;n++)p=i[n],k.appendChild(E(p,n));a.elem.hugeAttListElm=k;var u=zdom("div",{className:"zmAttGrp hugeListMap"});u.appendChild(k),g.appendChild(f),f.appendChild(u)}return j&&(o=o.join(""),l=document.createElement("div"),l.className="zmAttGrp",l.innerHTML=o,l.addEventListener("click",function(c){b=a,d(c,a),"streams"!==a.appName&&_zm.stopEvents(c)}),a.elem.attElem=l,e.appendChild(l),a.supportDrag&&!zmUtil.isChildWindow()&&zmAppLoader.load("dragNDropUtil").then(function(){C.init(a)}),g.appendChild(e)),g}catch(v){zmUtil.debugLog(v)}};h.viewAttachment=u,f.build=I,f.util=h}();