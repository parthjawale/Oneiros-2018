"use strict";define([],function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.WebSocket"),c={};return c.ERROR_CODES={INTERNAL_SERVER_ERROR:1011,AUTH_FAILED:4001,TOO_MANY_CONNECTIONS:4002,TOO_MANY_SESSIONS:4004,EMPTY_TICKET:4006},c.SERVICE_NAME="VirtualOffice",c.SERVER_NAME="ws",c.IDLE_MSG="?-",c.isSupported="WebSocket"in window||"MozWebSocket"in window,b.constants=c,c}),define([],function(a){var b=a("zmail.Components.WebSocket"),c=100,d=function(){function b(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:c;babelHelpers.classCallCheck(this,b);var d=this;d.maxSize=a,d._logs=[],d._currentSize=0}return babelHelpers.createClass(b,[{key:"push",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=this;c._currentSize>=c.maxSize&&c.pop(),c._logs.push({msg:a,time:new Date,opts:b}),c._currentSize++}},{key:"pop",value:function(){var a=this;if(a._currentSize>0)return a._currentSize-=1,a._logs.shift()}},{key:"getLogs",value:function(){var a=this;return a._logs}},{key:"clear",value:function(){var a=this;a._logs.splice(0),a._currentSize=0}},{key:"toString",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},b=this,c=a.separator||"\n",d="";return b._logs.forEach(function(a){d+=a.time+"--> "+a.msg+c}),d}},{key:"downloadLog",value:function(){var b=this,c=a("zmComponent.downloadAsFile");c.download(b.toString(),{fileName:Date.now()})}},{key:"sendLogInMail",value:function(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},c=this,d=b.mailId;a("zmUtil").compose({TO:d,CONTENT:c.toString({separator:"<br>"})})}}]),b}();return b.logger=d,d}),define([],function(a){var b=a("zmail.Components.WebSocket"),c={};return c.PUBSUB=a("zmail.Framework.Utils.PUBSUB"),b.Util=c,c.PUBSUB}),define([],function(a){var b=a("zmUtil"),c=a("zmComponent"),d=zmail.Core.Namespaces,e=d.create("zmail.Components.WebSocket"),f=e.logger,g=e.Util.PUBSUB,h={PONG_MSG:"--/--",REFRESH_VIEW:"FRH"},i={SEQ_NO:"s",MSG_DATA:"m",SET:"set",MODULE:"mod",LATEST_SEQ:"ls",PUSH_MSG_TYPE:"type"},j=function(){function a(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};babelHelpers.classCallCheck(this,a);var c=this;c._latestSeqNo=Number(b.latestSeqNo)||-1,c._refreshReceived=!1,c._pubsub=new g,c._logger=new f(200)}return babelHelpers.createClass(a,[{key:"setLatestSeqNo",value:function(a){b.debugLog("WS :: Seq number updated: "+a),this._latestSeqNo=Number(a)}},{key:"getLatestSeqNo",value:function(){return this._latestSeqNo}},{key:"subscribePushMsg",value:function(a,b){var c=this;c._pubsub._subscribeHandler(a,b)}},{key:"unsubscribePushMsg",value:function(a,b){var c=this;c._pubsub._unsubscribeHandler(a,b)}},{key:"isSeqNumReceivedValid",value:function(a){var c=this,d=c._refreshReceived,e=c.getLatestSeqNo();return a=Number(a),d&&(c._refreshReceived=!1),b.debugLog("WS :: New Seq num received "+a),!(e!==-1&&e!==a-1&&!d)}},{key:"parseAndReturnValidJSON",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",c={};try{c=$.parseJSON(a)}catch(d){b.debugLog("WS :: Invalid msg format")}return c}},{key:"_processSeqNumber",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},d=this,e=d.getLatestSeqNo();return d.isSeqNumReceivedValid(a)?(d.setLatestSeqNo(a),b.hasOwnProperty(i.MODULE)&&d.handleNotificationPush(b)):e>=Number(a)?c.duplicateNotification=!0:(c.invalidSeqNo=!0,c.lastAckedSeqNo=d.getLatestSeqNo()),c}},{key:"_processLatestSeqMessage",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=this,d=c.getLatestSeqNo();d===-1?c.setLatestSeqNo(a):Number(a)>d||Number(a)<d?(b.invalidSeqNo=!0,b.lastAckedSeqNo=c.getLatestSeqNo()):b.duplicateNotification=!0}},{key:"_handlePushMessages",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=(arguments[2],this);if("push"===a){var d=b[i.MODULE];d&&c._pubsub.publish(d,b)}}},{key:"handleNotificationPush",value:function(a){var d={};if(a.hasOwnProperty(i.MSG_DATA))try{d=$.parseJSON(a[i.MSG_DATA])}catch(e){b.debugLog("Invalid format Received")}d&&("object"===("undefined"==typeof d?"undefined":babelHelpers["typeof"](d))&&(d.newWS=!0),c.notifier.push(d,{module:a[i.MODULE]}))}},{key:"processMsg",value:function(a){var c,d,e,f,g=this,j={},k=a.data;return k!==h.PONG_MSG&&g._logger.push(k),k===h.PONG_MSG?(b.debugLog("WS :: Pong Messsage Received"),j):k===h.REFRESH_VIEW?(g._refreshReceived=!0,j.refreshView=!0,j):0===k.indexOf(h.REFRESH_VIEW)?(j.refreshView=!0,g.setLatestSeqNo(k.split(":")[1]),j):(c=g.parseAndReturnValidJSON(k),c[i.SET]&&(j.sessionId=c[i.SET].cid),d=c[i.SEQ_NO],d||(e=c[i.LATEST_SEQ],f=c[i.PUSH_MSG_TYPE]),"undefined"!=typeof d?(b.debugLog("WS :: Msg Notifier publisher"+k),g._processSeqNumber(d,c,j)):"undefined"!=typeof e?g._processLatestSeqMessage(e,j):f&&g._handlePushMessages(f,c,j),j)}}]),a}();return e.WSMessageHandler=j,e}),define([],function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.WebSocket"),c=b.WSMessageHandler,d=b.logger,e={WSS:"wss",WS:"ws",TIMEOUT_VAL:3e4,PING_MSG:"-?-",PONG_MSG:"--/--",REQ_MSG:"req",MAX_RECONNECT_PERIOD:90},f=function(){function a(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};babelHelpers.classCallCheck(this,a);var f=this;f.serverName=b.serverName,f.path=b.path,f.idleMsg=b.idleMsg,f.callbacks=b.callbacks||{},f.protocol=b.secure?e.WSS:e.WS,f.pingTimeout=null,f.sessionId=null,f._retry=Boolean(b.handleRetry),f._messageHandler=new c,f.ws=null,f._logger=new d(100),f.isRebranded=b.isRebranded,f._consecutiveFailCount=0,f._reconnectPeriod=0,f._reconnectTimer=null,this.requestedSeqMap={},this._lastReceivedMsgTime=-1,this._idleConnectingTimer=null}return babelHelpers.createClass(a,[{key:"getSessionId",value:function(){return zmUtil.debugLog("session Id: "+this.sessionId),this.sessionId}},{key:"updateSessionId",value:function(a){var b=this,c=b.callbacks;b.sessionId=a,"function"==typeof c.onSessionIdUpdate&&c.onSessionIdUpdate(a)}},{key:"subscribePushMsg",value:function(a,b){var c=this;c._messageHandler.subscribePushMsg(a,b)}},{key:"unsubscribePushMsg",value:function(a,b){var c=this;c._messageHandlergeHandler.unsubscribePushMsg(a,b)}},{key:"getReconnectPeriod",value:function(){return this._reconnectPeriod}},{key:"setReconnectPeriod",value:function(a){zmUtil.debugLog("WS :: Set reconnect period: "+a),this._reconnectPeriod=a}},{key:"getLastReceivedMsgTime",value:function(){return this._lastReceivedMsgTime}},{key:"_setLastReceivedMsgTime",value:function(a){this._lastReceivedMsgTime=a}},{key:"_onOpen",value:function(a){var b=this,c=b.callbacks,d=b.getSessionId();b._onopenCalled=!0,b._clearTimeout(b._idleConnectingTimer),b._logger.push("WS :: Websocket connection opened"),zmUtil.debugLog("WS :: Websocket connection opened"),b._setLastReceivedMsgTime(-1),b.pingServer(),"function"==typeof c.onOpen&&c.onOpen(d,a)}},{key:"_onClose",value:function(a){var b=this,c=b.callbacks,d=b._retry;b._logger.push("closeEvent triggered",a),zmUtil.debugLog("WS :: Websocket connection closed"),b._clearTimeout(b._idleConnectingTimer),b._consecutiveFailCount+=1,"function"==typeof c.onClose&&(d=c.onClose(a)),d.retryStatus&&b.handleConnectionRetry(),d.closeStatus&&(b._lastClosedStatus=d.closeStatus)}},{key:"_onMessage",value:function(a){var b=this,c=b.callbacks;b._setLastReceivedMsgTime(Date.now()),0!==b._consecutiveFailCount&&(b._consecutiveFailCount=0,b.updateReconnectPeriod("reset"));var d=b._messageHandler.processMsg(a);b.handleMsgObject(d),"function"==typeof c.onMsg&&c.onMsg(a)}},{key:"disableRetry",value:function(){var a=this;a._retry=!1}},{key:"enableRetry",value:function(){var a=this;a._retry=!0}},{key:"updateReconnectPeriod",value:function(a){var b=this,c=b.getReconnectPeriod();"reset"===a?c=0:"inc"===a&&(0===c?c=1:c*=3),c>e.MAX_RECONNECT_PERIOD&&(c=e.MAX_RECONNECT_PERIOD),b.setReconnectPeriod(c)}},{key:"handleConnectionRetry",value:function(a){var b,c=this,d=c.getSessionId(),e=c.ws.readyState;return e!==WebSocket.CONNECTING&&e!==WebSocket.CONNECTED&&(b=0,a||(b=c.getReconnectPeriod(),c.updateReconnectPeriod("inc")),c._logger.push("WS :: Current Reconnect period "+b+"seconds"),zmUtil.debugLog("WS :: Current Reconnect period "+b+"seconds"),void(c._reconnectTimer=setTimeout(function(){return delete c._reconnectTimer,!c.isConnected()&&void c._initializeConnection(d)},1e3*b)))}},{key:"removeFromRequestedSeqMap",value:function(a){var b=this;delete b.requestedSeqMap[a]}},{key:"requestMissingNotifcations",value:function(a){var b,c=this;return!c.requestedSeqMap[a]&&(c._logger.push("request Missing Notification : "+a),b=c.send(e.REQ_MSG+":"+a),void(b&&(c.requestedSeqMap[a]=!0,setTimeout(function(){c.removeFromRequestedSeqMap(a)},3e3))))}},{key:"handleMsgObject",value:function(a){var b=this,c=b.callbacks;a.sessionId&&(b.updateSessionId(a.sessionId),zmUtil.debugLog("WS :: Session Id updated")),a.invalidSeqNo&&b.requestMissingNotifcations(a.lastAckedSeqNo),a.refreshView&&"function"==typeof c.onRefreshView&&c.onRefreshView()}},{key:"send",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",b=this;return!(!a||!b.isConnected())&&(b.ws.send(a),b.pingServer(),!0)}},{key:"_clearTimeout",value:function(a){clearTimeout(a)}},{key:"pingServer",value:function(){var a=this,b=a.getLastReceivedMsgTime();b>-1&&Date.now()-b>2*e.TIMEOUT_VAL&&(zmUtil.debugLog("No response from server for past 60 seconds"),a.close(!0)),a.pingTimeout&&a._clearTimeout(a.pingTimeout),a.pingTimeout=setTimeout(function(){a.send(e.PING_MSG)},e.TIMEOUT_VAL)}},{key:"close",value:function(a){var b=this;b.ws.onclose=void 0,b._reconnectTimer&&b._clearTimeout(b._reconnectTimer),b.ws.close(),a&&b._initializeConnection()}},{key:"_initializeEvents",value:function(){var a=this,b=a.ws;b.onopen=a._onOpen.bind(a),b.onclose=a._onClose.bind(a),b.onmessage=a._onMessage.bind(a)}},{key:"_initializeConnection",value:function(){var a=this,b=a.getConnectionPath();a._onopenCalled=!1;var c=new WebSocket(b);a._logger.push("Initialize connection called"),a._idleConnectingTimer=setTimeout(function(){a._logger.push("In Connecting state for too long. Closing and reconnecting"),a.close(),a._initializeConnection()},2e4),a.ws=c,a._initializeEvents()}},{key:"getConnectionPath",value:function(){var a=this,b=a.protocol+"://"+a.path+"/";return b+=a.serverName+"?zuid="+zmail.zuid,a.sessionId&&(b+="&cid="+a.sessionId),a.isRebranded&&(b+="&isrbuser=true"),b}},{key:"isConnected",value:function(){var a=this,b=a.ws;if(b){var c=b.readyState;if(WebSocket.OPEN===c||WebSocket.CONNECTING===c)return!0}return!1}},{key:"init",value:function(){var a=this;if(a.ws){if(a.isConnected())return!1;a.close()}a._initializeConnection()}}]),a}();return b.WebSocketComponent=f,b}),define([],function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.WebSocket.Module.Mail"),c=function(a,b){var c,d;try{c=$.parseJSON(b.m);var e=c.act;"MAIL_CONTENT"===e&&(d=$.parseJSON(c.res),zmContentCache.processResponse(d,d.M),zmContentCache.getCacheStore().put(d.MSGID,d))}catch(f){zmUtil.debugLog("Invalid format")}zmUtil.debugLog("In mail push msg handler : Data pushed from WS server "+b)},d=function(a,b){if(b){var c=$.parseJSON(b.m),d=$.parseJSON(c.res);if("V_STATUS"===c.act){var e=zmAttachComponent.virusCheckStatus[d.FILEPATH]||{};e.reference?(zmAttachComponent.virusCheckStatusUpdate.call(e.reference,d),delete zmAttachComponent.virusCheckStatus[d.FILEPATH]):zmAttachComponent.virusCheckStatus[d.FILEPATH]={value:d.STATUS}}else if("DOWNLOAD_AS_ZIP"===c.act){var f=d.FILEPATH,g=zmail.conPath+"/FileDownload",h={mode:"getzipstream",accId:zmail.accId,fpath:f};zmAjq.formSubmit(h,g,"get")}zmUtil.debugLog("In attachment push msg handler : Data pushed from WS server "+JSON.stringify(b))}},e=function(){var a=zmail._ws;a.subscribePushMsg("mail",c),a.subscribePushMsg("attachment",d)};return b.init=e,b}),define([],function(a){var b,c,d=a("zmUtil"),e=a("zmail.Utils.DOM"),f=zmail.Core.Namespaces,g=f.get("zmail.Components.WebSocket"),h=g.constants,i=zmail.wsServerURL,j=h.SERVICE_NAME,k=h.SERVER_NAME,l=h.IDLE_MSG,m=h.ERROR_CODES,n=!1,o=2e4,p=g.logger,q=new p(100),r=0,s=2e3,t=9e5,u=0,v=function(a){d.debugLog("Server Error"+a)},w=function(){d.debugLog("Too May Connections. Retry Connection will be initiated after dur: "+t),setTimeout(function(){zmail._ws.init()},t)},x=function(){var a=document.getElementById("zmwsconnect");a&&a.parentElement.removeChild(a),a=zdom("iframe",null),a.id="zmwsconnect",a.style.display="none",a.src=zmail.urls.accURL+"/clogin?client_auth=true&servicename="+j+"&serviceurl="+location.protocol+"//"+i+"/connector?pd="+location.host+"&t="+Date.now(),a.onload=b,e.mountAtEnd(a,document.body)};b=function(a){q.push("iframe load success"),setTimeout(function(){return!(r>8)&&void(n?(q.push("Ticket generation success"),r=0,s=2e3):(r++,3*s>o?s=o:s*=3,q.push("Accounts Login Failure : Retry timer"+s),x()))},s)};var y=function(a){u=0},z=function(a){var b={},c=!0,d=a.code;if(d===m.AUTH_FAILED)c=!1,q.push("WS :: Authentication Failed"),n=!1,x();else if(d===m.TOO_MANY_CONNECTIONS)q.push("WS :: TOO MANY CONNECTIONS"),c=!1,b.closeStatus="TOO MANY CONNECTIONS",w();else if(d===m.INTERNAL_SERVER_ERROR)q.push("WS :: Internal Server Error"),b.closeStatus="INTERNAL SERVER ERROR",v(a);else if(d===m.TOO_MANY_SESSIONS)q.push("WS: Too Many user sessions"),b.closeStatus="TOO MANY SESSIONS",c=!1;else if(d===m.EMPTY_TICKET){q.push("WS: Empty ticket"),b.closeStatus="EMPTY TICKET";var e,f=document.getElementById("zmwsconnect");f?(e=2*u*1e3,e>9e4&&(q.push("WS: Empty ticket counter crossed 90s"),e=9e4),setTimeout(function(){f.contentWindow.postMessage("updTic",location.protocol+"//"+i)},e),u++):x(),c=!1}return d!==m.EMPTY_TICKET&&(u=0),b.retryStatus=c,b},A=function(){},B=function(a){$.publish("/ws/sessionIdUpdate",a)},C=function(a){var b,d=a.origin||a.originalEvent.origin;d==="https://"+i&&(b=a.data,"init"===b?(n=!0,zmail._ws.init()):0===b.indexOf("tic$$")&&(c=b.split("tic$$")[1]))},D=function(){window.addEventListener("message",C,!1)},E=function(){$.publish("zmailReconnect")},F=function(){D(),x()};return zmail._ws=new g.WebSocketComponent({serverName:k,path:i,idleMsg:l,secure:!0,isRebranded:zmail.isRebranded,callbacks:{onOpen:A,onClose:z,onMsg:y,onSessionIdUpdate:B,onRefreshView:E},handleRetry:!0}),h.isSupported&&F(),g.getWSTicket=function(){return c},g.Module.Mail.init(),g._connectionLogger=q,g}),define([],function(a){var b=zmail.Core.Namespaces.create("uiStateSyncer"),c=a("zmAdHocSettings"),d=a("zmInit"),e=a("zmApp"),f=a("zmUtil"),g={theme:{_handler:function(a){c.getThemeValidValues().indexOf(a)!==-1&&c.setTheme(a,{sync:!1})}},listingDisplayDensity:{_handler:function(a){c.getListingDisplayDensityValidValues().indexOf(a)!==-1&&d.customizeDisplayDensity(a,"WS")}},nightMode:{_handler:function(a){c.getNightModeValidValues().indexOf(a)!==-1&&_zm.toggleNightModeTheme({set:a},{sync:!1})}},font:{_handler:function(a){c.getFontValidValues().indexOf(a)!==-1&&c.setFont(a,{sync:!1})}},appOrderChange:{_handler:function(a){c.setAppOrder(a,{sync:!1}),zmail.appList.reRenderAppArea(),e.selectApp(e.currentApp)}},leftOrderChange:{_handler:function(a){c.setLeftOrder(a,{sync:!1}),"m"===e.currentApp&&zmail.mailLeft.render()}},helperBlockVisibility:{_handler:function(a){c.setHelperBlockVisibility(a.value,{sync:!1}),zmail.mailOpt.ff=a.type}},composeOpenType:{_handler:function(a){zmail.mailOpt.compTab=a,1===a?zmail.allowInline=!1:zmail.allowInline=!0}},streamsListType:{_handler:function(a){c.setStreamsListType(a)}},notes:{_handler:function(a){c.setNotes(a,{sync:!1}),$.publish("notes/wshandler")}},bookMarks:function(a){c.setBookMarks(a,{sync:!1})},mailSoundNotifier:{_handler:function(a){c.getMailSoundNotifierValidValues().indexOf(a)!==-1&&c.setMailSoundNotifier(a,{sync:!1})}},securedownload:{_handler:function(a){c.setSecuredownload(a,{sync:!1})}}};return b.updProperties=function(a){try{var b=a.settingsName;if(b in g){var c=a.settingsValue;g[b]._handler(c)}}catch(d){f.debugLog(d)}},b});