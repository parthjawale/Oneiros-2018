"use strict";window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupApp=function(a){var b=zmText.get("streams"),c=a.models,d=a.views,e=zmStreamsApp.constants.notifications,f=zmStreamsApp.constants.groupEvents;a.GroupId="",a.requestGroupId="";var g,h,i="",j=!1,k=zmStreamsApp.constants.maxLimit.MAX_ALLOWED_MEMBERS,l=function(a){var b=zmsuite.getCenter()[0].$el;b.find("#viewmembers").text(zmStreamsApp.GroupApp.template("groupMemberText",{grpInfo:zmStreamsApp.util.getGroupDetails(a)}));var c=zmStreamsApp.util.getGroupDetails(a);c.isOwner?b.find(".msi-add").parents("li").show():b.find(".msi-add").parents("li").hide()},m=function(a){var b;return a&&c.groups&&(b=_.find(c.groups.models,function(b){return String(b.id)===String(a)})),b};a.updateUnreadCount=function(a){a=a||{};var b=m(a.groupId);b&&b.set("scount",a.count)},a.correctUnread=function(a){var b=m(a);b||(zmStreamsApp.GroupApp.init(),b=m(a)),b&&b.correctUnread()},a.emailGroup=function(a){zmUtil.compose({TO:zmStreamsApp.util.getGroupDetails(a).eid})},a.loadGroup=function(a){var b=zmail.mailLeft.getNodes()[0].getLayer("zmStreamTree");if(b.el.length){var c="grid"===zmAdHocSettings.getStreamsListType(),d={view:"all",gridview:c,addTitleHeader:!0};zmStreamsApp.PostApp.init("",a.id,d,!0,!0),zmStreamsApp.util.removeCommentClass(a.id,b)}zmUtil.hideMenu()},a.showDropDown=function(b,c){var d=[],e=[];_.each(i,function(a){if(a){var b=zmStreamsApp.util.getGroupDetails(a.id),f=!b.disabled,g=b.hidden;a&&a.id===zmail.zuid&&a.id!==String(c)?(b.photo=zmStreamsApp.util.selfPhotoUrl(),d.push(b)):_.size(b)&&a.id!==String(c)&&!g&&f?d.push(b):g&&f&&e.push(b)}}),d=d.concat(e),zmStreamsApp.util.showGroupDetails({groupInfo:d,elm:b,fn:a.loadGroup})},a.removeGroup=function(a){if(a){if(c.groups){var b=m(a);c.groups.remove(b)}zmStreamsApp.util.removeGroup(a);var d,e="zmStreamTree";d=zmail.mailLeft.getNodes()[0].getLayer(e);var f=d.listObject[a];_.isEmpty(f)||d.deleteNode(d.getRowObj(a));var g=d.listObject.more,h=!_.isEmpty(g)&&!g.hideNode;zmUtil.constructStreamLHS(!h)}},a.updateGroupListing=function(b){if(c.groups||zmStreamsApp.GroupApp.init(),a.requestGroupId&&c.groups){var d=a.requestGroupId;b?c.groups.sync("getgroups",c.groups).done(function(a){if(a=a[1]){var b=a.list?a.list:a.groups;zmStreamsApp.util.addGroup(b[d]);for(var c in b)zmUtil.changeUnread(String(c),"",b[c].scount)}}):a.removeGroup(a.requestGroupId),$.publish("streams/addRemGroupSelf",{isAdd:b,gid:a.requestGroupId})}};var n=function(a,b){if(b=b.data||{},c.groups||zmStreamsApp.GroupApp.init(),c.groups){"string"==typeof b.group&&(b.group=$.parseJSON(b.group)),"string"==typeof b.shgroups&&(b.shgroups=$.parseJSON(b.shgroups)),b.group=b.group||{};var d=_.size(b.shgroups)?b.shgroups:[b.group];if(!d||!_.size(d))return;var f,g,h,j=b.ntype,k=[e.mail_type,e.post_mention,e.unshared,e.invite,e.add_post,e.add_comment,e.comment_mention,e.add_task,e.post_group_mention,e.comment_group_mention,e.add_event,e.update_event,e.add_group_member,e.mail_share,e.add_attachment,e.add_tweet,e.change_task_due_date,e.change_task_assignee,e.change_task_status,e.change_task_priority,e.change_task_category,e.change_task_title,e.change_task_description,e.remove_attachment,e.draft_share,e.draft_shareupdate,e.draft_autosave,e.draft_mailmention,e.mail_share,e.add_link];for(var n in d){if(h=d[n],f=h.id,g=m(f))if(j===e.add_group_member||j===e.remove_group_member){var o=j===e.add_group_member,p=o?"addMember":"removeMember",q=o?b.memberzuid.split(","):b.memberzuid;zmStreamsApp.util.groupManagement({mode:p,groupId:g.id,members:q});var r=g.get("members");r=o?r.concat(b.memberzuid):_.without(r,b.memberzuid),g.set("members",r),zmsuite.isWorkspaceAvailable("zmStreamsApp")&&zmStreamsApp.GroupApp.getCurrentGroup()===f&&zmsuite.getCenter("zmStreamsApp")[0].$el.find("#viewmembers").text(zmStreamsApp.GroupApp.template("groupMemberText",{grpInfo:zmStreamsApp.util.getGroupDetails(f)})),zmStreamsApp.events.getCurrentGroupId()===f&&l(f),o?$.publish("streams/addGroupMember",{gid:f,zid:b.memberzuid}):$.publish("streams/removeGroupMember",{gid:f,zid:q})}else if(j===e.change_moderator){var s="removeModerator";"Moderator"===b.memberrole&&(s="addModerator"),zmStreamsApp.util.groupManagement({mode:s,groupId:g.id,members:b.memberzuid}),$.publish("streams/changeMemberRole",{mode:s,gid:g.id,zid:b.memberzuid}),zmStreamsApp.events.getCurrentGroupId()===f&&b.memberzuid===zmail.zuid&&l(f)}if(k.indexOf(j)!==-1&&b.nby!==zmail.zuid&&h.isGroup||j===e.add_tweet){if(zmUtil.isGroupMember(zmail.zuid,f)){var t,u=_.pluck(i,"id").indexOf(f);u!==-1&&(t=i[u],i.splice(u,1),i.splice(1,0,t))}var v=zmail.mailLeft.getNodes()[0].getLayer("zmStreamTree"),w=zmList.getRowInfo(f,"zmStreamTree");if(v&&w&&w[f]){w[f].hideNode=!1,v.moveNode(w,void 0,zmail.zuid);var x=$(v.el).find("#more");if(x.is(":visible")&&x.index()>5){var y=$(v.el).find("#more").prev().attr("id");w=zmList.getRowInfo(y,"zmStreamTree"),v.moveNode(w,void 0,"more"),v.hideNode(y)}}}}}};"undefined"!=typeof zmComponent&&zmComponent.notifier&&zmComponent.notifier.addHandler("streams",n);var o=function(a){var b,c,d="zmStreamTree";b=zmail.mailLeft.getNodes()[0].getLayer(d);var e=b.listObject[a];if(_.isEmpty(e)){c=zmStreamsApp.util.getGroupDetails(a),b.listObject[a]=c;var f=zmList.getRowInfo(c.id,d);f[c.id].hideNode=!1,b.insertNodeAfter(f,b.listObject,zmail.zuid);var g=b.listObject.createGrp;_.isEmpty(g)||b.deleteNode(b.getRowObj("createGrp"))}};$.subscribe(f.groupAdded,function(a,b){var d=zmStreamsApp.util.getGroupDetails(b.groupID);if(c.groups||zmStreamsApp.GroupApp.init(),c.groups){var e=c.groups.add(d),f=d.scount;d.scount=f?f:0,i.splice(1,0,d),o(e.id)}}),$.subscribe(f.groupEdit,function(a,b){var c=b.props,d=b.id;if(c.hasOwnProperty("name")){var e,f="zmStreamTree";e=zmail.mailLeft.getNodes()[0].getLayer(f);var g=_.isEmpty(e.listObject[d]);if(!g){var h=zmList.getRowInfo(d,f);h[d].name=c.name,e.editNode(h,e.mapObject)}if(zmsuite.isWorkspaceAvailable("zmStreamsApp")){var i=zmsuite.getWorkSpace("zmStreamsApp");if(i&&i[0].$el){var j=i[0].$el;j.find(".gName")[0].childNodes[0].textContent=c.name}}}}),$.subscribe("group/showHideGroup",function(a,b){var c,d=b.id,e="zmStreamTree";if(c=zmail.mailLeft.getNodes()[0].getLayer(e),b.hidden){var f=c.listObject[d];_.isEmpty(f)||c.deleteNode(c.getRowObj(d))}else{o(d);var g=zmStreamsApp.util.getGroupDetails(d);zmUtil.streamUpdate({groupId:d,count:g.scount})}var h=c.listObject.more,i=!_.isEmpty(h)&&!h.hideNode;zmUtil.constructStreamLHS(!i)}),$.subscribe("group/streamsenabled",function(a,b){var c,d,e="zmStreamTree";if(c=zmail.mailLeft.getNodes()[0].getLayer(e),b.id){d=c.listObject[b.id],_.isEmpty(d)&&o(b.id);for(var f=zmail.ContactBook.getGroups(),g=_.pluck(f,"attrs"),h=!1,i=0;i<g.length;i++)if(g[i].disabled){h=!0;break}!h&&zmUtil.isNewGroupUser()&&(d=c.listObject.disabledGrp,_.isEmpty(d)||c.deleteNode(c.getRowObj("disabledGrp")))}}),$.subscribe("group/streamsdisabled",function(a,b){var c=b.id;if(c){var d,e="zmStreamTree";d=zmail.mailLeft.getNodes()[0].getLayer(e);var f=d.listObject[c];if(!_.isEmpty(f)){d.deleteNode(d.getRowObj(c));var g=d.listObject.more,h=!_.isEmpty(g)&&!g.hideNode;zmUtil.constructStreamLHS(!h)}if(f=d.listObject.disabledGrp,_.isEmpty(f)){d.listObject.disabledGrp={name:zmText.get("commonUtils","streams.disGrp"),id:"disGrp",txtNodeClass:"SC_thm",hideNode:!1,rowTitle:zmText.get("commonUtils","streams.stDisGrp")};var i=d.listObject.less;d.listObject.disabledGrp.hideNode=!(_.isEmpty(i)||!i.hideNode);var j=zmList.getRowInfo("disabledGrp",e);_.isEmpty(i)?d.appendNode(j,d.mapObject):d.insertNodeBefore(j,d.listObject,d.listObject.less.id)}}}),a.getCurrentGroup=function(){return a.GroupId},a.getAllUnread=function(){c.groups||zmStreamsApp.GroupApp.init(),c.groups.updateUnread()},a.updateHashTag=function(a,b){b=b||String(zmail.zuid);var c=m(b);c||(zmStreamsApp.GroupApp.init(),c=m(b));var d=a.text;d=d.indexOf("#")!==-1?d.substring(1):d,c.updateHashTagforAutofill(d)},a.init=function(e,f){d.groupHolder=e;var g=zmUtil.getGroupOrder(),h=zmail.zuid;g.indexOf(h)===-1&&g.unshift(h);var j={list:zmStreamsApp.util.getGroupDetails(void 0,!0),order:g};if(_.each(j.list,function(a,c){a.id===zmail.zuid&&(a.name=b.common.labels.home,a.photo=zmStreamsApp.util.selfPhotoUrl())}),i=zmStreamsApp.util.orderComments(j.list,j.order),void 0===c.groups)c.groups=new c.GroupCollection(j,{parse:!0});else{var k=j.list;_.each(k,function(b){a.updateUnreadCount({groupId:b.id,count:b.scount})})}a.fetchHashTags()},$.subscribe("group/unread",function(b,c){a.updateUnreadCount(c)}),a.markAllRead=function(a){var b=m(a);b||(zmStreamsApp.GroupApp.init(),b=m(a)),b&&b.markPostsRead("markallread",b,{}),zmUtil.isGroup(zmStreamsApp.events.getCurrentGroupId())&&zmStreamsApp.PostApp.markPostRead(a)},a.getModel=function(a){var b=m(a);return b||(zmStreamsApp.GroupApp.init(),b=m(a)),b},a.clearTags=function(a,b){a=a||zmail.zuid,b=b||"trendingtags";var c=m(a);if(c||(zmStreamsApp.GroupApp.init(),c=m(a)),c){var d=c.get("type");d&&c.unset(b)}},a.bindGroupEvents=function(a){var c=zmsuite.getCenter(zmStreamsApp.constants.workspaceId)[0].$el,d=$(c).find(".zms_addMem"),e=$(c).find("#viewmembers"),f=$(c).find(".gdrop"),g=$(c).find("#createChat"),h=$(c).find("#geid"),i=$(c).find(".moreOpt");d.length&&$(d).click(function(){zmStreamsApp.GroupApp.addMember(a)}),e.length&&$(e).click(function(){zmStreamsApp.util.loadMemberPopup(a)}),f.length&&$(f).click(function(){zmStreamsApp.GroupApp.showDropDown(f,a)}),g.length&&(zmComponent.tooltip({elm:g[0],text:b.streams.tooltip.chat,arrow:"top"}),$(g).click(function(){zmStreamsApp.GroupApp.createGroupChat(a)})),h.length&&$(h).click(function(){zmStreamsApp.GroupApp.openCompose(a)}),i&&i.length&&(zmComponent.tooltip({elm:i[0],text:b.groupSubscription.moreOpt,arrow:"top"}),$(i).click(function(c){c.stopPropagation(),$(c.currentTarget).parent().addClass("show");var d=[];d.push({txt:b.groupSubscription.grpEdit,data:"editGrp"}),d.push({txt:b.common.labels.addNewMember,data:"addMem"});var e=function(b,c,d){zmStreamsApp.util.hideMenu(),"editGrp"===b.item?zmUtil.loadGroupManagement().then(function(){zmStreamsApp.GroupManageApp.triggerEditGroup(a)}):"addMem"===b.item&&zmStreamsApp.GroupApp.addMember(a)};zmStreamsApp.util.createPopup({items:d,parent:$(c.currentTarget),parentClass:"SC_Sopt",type:"oneLine",noArrow:!0,avoidScroll:!0,align:"pleft",hoverElm:$(c.currentTarget),onhide:function(){$(c.currentTarget).parent().removeClass("show")},callback:e})}))},a.fetchHashTags=function(a,b,c){if(a=a||zmail.zuid,zmUtil.getGroupOrder().length){var d=m(a);if(d)return d.getHashTags(b,c)}return[]};var p=function(a,c){var d="add"===c?b.common.messages.membersAdded:c;zmUtil.succErrMsg("s",d),l(a)},q=function(a){var b,c=[];for(b=0;b<a.length;b+=99)c.push(a.slice(b,b+99));return c};a.constructMemberPopup=function(a,c,d,e,f){h=0,g=[];var i=zmStreamsApp.util.getGroupDetails(c),k=i.members;k=zmStreamsApp.util.reOrderMembers(i),k.length>100&&(k=q(k),g=k,k=g[0]),k=zmStreamsApp.util.getContactDetails(k),a.append(zmStreamsApp.GroupApp.template("popupConstruction",{members:k,owner:i.owner,moderator:i.moderator})),a.css("max-height",.6*$(window).height());var l=_zm.getDOM(["BR",{}]),m=$(a).get(0).scrollHeight>$(a).height();if(j=!0,m||i.isOwner){if(e)$(e).removeClass("SC_dyn");else{var n=d.$els;$(n.$positionWrapper).addClass("SC_PopTop");var o="40px";$(n.$positionWrapper).css("top",o),e=zmStreamsApp.GroupApp.template("searchBox",{isOwner:i.isOwner}),$(n.$header).append(e),$(e).find("input").css("width","400px")}var p=zmStreamsApp.GroupApp.template("memberHeader",{name:b.groupSubscription.memberActions.addGroupTitle,mode:"isAdd"});a.append(p),a.append(zmStreamsApp.GroupApp.template("popupConstruction",{isAdd:!0,gid:c}));var r=function(b){return 13!==b.keyCode&&(27===b.keyCode?(d.remove(),!1):void zmStreamsApp.GroupApp.searchResults({content:a,grpInfo:i,gid:c,breakPoint:l,textValue:$(e).find("input").val(),dialog:d,eparam:f}))};$(e).unbind(),$(e).find("input").off("keyup").on("keyup",r),$(e).find("input").focusin(function(){$(this).parent().addClass("inputFocus")}).focusout(function(){$(this).parent().removeClass("inputFocus")}),$(e).find("input").focus()}zmStreamsApp.GroupApp.bindDialogEvents(f,d)},a.bindDialogEvents=function(c,d){var e,f,i=c.gid,k=zmStreamsApp.util.getGroupDetails(i),l=$(d.$els.$content).find("ul.zm_action"),n=$(d.$els.$content).find("li.loadPost"),o=$(d.$els.$content).find("ul.viewMem");for(f=0;f<l.length;f++)e=l[f],e&&zmComponent.tooltip({elm:e,text:b.groupSubscription.memberActions.mreact,arrow:"top"});for(f=0;f<n.length;f++)e=n[f],e&&$(e).find("strong").attr("title",c.title);o.off("click").on("click",function(a){var b=$(a.target).parents("li");if(b&&b.hasClass("loadPost")&&c.callback){var e={zid:b.data("id"),dialog:d,gid:i};c.callback(e)}}),$(d.$els.$content).off("scroll").on("scroll",function(){zmStreamsApp.util.hideMenu();var b=$(d.$els.$content)[0],e=Math.round(100*(b.scrollTop+b.offsetHeight)/b.scrollHeight);if(j&&e>=90)if(h||(h=0),h+=1,g&&g[h]&&g[h].length){var f=zmStreamsApp.util.getContactDetails(g[h]);zmStreamsApp.GroupApp.template("viewmembers",{members:f,owner:k.owner,moderator:k.moderator,ulDOM:o}),a.bindDialogEvents(c,d)}else j=!1}),l.off("click").on("click",function(a){a.stopPropagation(),$(a.currentTarget).parent().addClass("show");var c,e,f,g=[],h=m(i);h||(zmStreamsApp.GroupApp.init(),h=m(i)),h&&(e=h.get("moderator")),!h&&zmUtil.isNewGroupUser()&&(h=zmStreamsApp.GroupManageApp.getGroupAppModel(i),h&&(e=_.pluck(h.get("moderators"),"id")));var j=$(a.currentTarget).parents(".zm_mem_post"),k=String(j.data("id")),l=zmStreamsApp.util.getContactDetails([k])[k].fn,n=e.indexOf(k)!==-1;f=n?b.groupSubscription.memberActions.makemem:b.groupSubscription.memberActions.makeadmin,g.push({txt:f,data:"changeAdmin"}),g.push({txt:b.groupSubscription.memberActions.remmember,data:"removeMem"});var q=function(e,f,g){if(zmStreamsApp.util.hideMenu(),"changeAdmin"===e.item){if(h){var m;m=n?"removeModerator":"addModerator",c=function(){var c="";"addModerator"===m?(j.find("i.SC_Otxt").text(b.common.labels.moderator),c=zmText.applyArgs(b.groupSubscription.memberActions.modSuccess,{member:l})):"removeModerator"===m&&(j.find("i.SC_Otxt").text(""),c=zmText.applyArgs(b.groupSubscription.memberActions.modRemove,{member:l})),$(a.currentTarget).parent().removeClass("show"),zmUtil.succErrMsg("s",c),$.publish("streams/changeMemberRole",{mode:m,gid:i,zid:k})},h.changeModerator({mode:m,zuid:k},c)}}else"removeMem"===e.item&&(c=function(){$.publish("streams/removeGroupMember",{gid:i,zid:k});var a=zmStreamsApp.GroupApp.template("groupMemberText",{grpInfo:zmStreamsApp.util.getGroupDetails(i),isAllow:!0});$(d.$els.$contentWrapper).find("#isMem").text(a),j.remove(),o.children().length||o.append(_zm.getDOM(["LI",{attrs:{"class":"nohr",style:"padding-left: 0px;text-align: center;padding-right: 0px;"},child:[["SPAN",{child:[["text",b.common.labels.nomemfound]]}]]}])),p(i,zmText.applyArgs(b.groupSubscription.memberActions.memRemove,{member:l}))},h&&h.removeMember(k,c))};zmStreamsApp.util.createPopup({items:g,parent:$(a.currentTarget).find("b"),parentClass:"SC_Sopt",type:"oneLine",noArrow:!0,avoidScroll:!0,align:"pright",hoverElm:$(a.currentTarget).find("b"),container:d.$els.$contentWrapper[0],onhide:function(){$(a.currentTarget).parent().removeClass("show")},callback:q})})},a.searchResults=function(c){var d=c.content,e=c.textValue,f=c.gid,i=c.breakPoint,l=c.dialog,n=zmStreamsApp.util.getGroupDetails(f),o=zmStreamsApp.util.membersFilter(f,e);""===e&&g.length?(j=!0,o=g[0],o=zmStreamsApp.util.getContactDetails(o),h=0):j=!1;var q=d.find(".viewMem");if(q.html(""),zmStreamsApp.GroupApp.template("viewmembers",{members:o,owner:n.owner,moderator:n.moderator,ulDOM:q}),n.isOwner){var r;r=zmail.ContactBook.get({str:e,type:"org"}),d.find("br").remove(),q.after(i),r.done(function(e){var g,h=e;e=[];for(var i=0;i<h.length&&(g=h[i].attrs,g.avatar=h[i].avatar(),zmUtil.isGroupMember(g.zid,f)||zmStreamsApp.GroupManageApp.isGroupMember(g.zid,f)||e.push(g),10!==e.length);i++);if(e&&e.length){var j=e.length,n=j+(1===j?" "+b.common.labels.match:" "+b.common.labels.matches);d.find(".isAddCount").text(n),d.find("#isAdd").show(),q=d.find(".addMem"),q.html(""),zmStreamsApp.GroupApp.template("viewmembers",{members:e,isAdd:!0,gid:f,ulDOM:q}),q.show(),$(l.$els.$content).find(".addButton").off("click").on("click",function(){var e=$(this),g=$(this).find("span"),h=m(f);h||(zmStreamsApp.GroupApp.init(),h=m(f)),!h&&zmUtil.isNewGroupUser()&&(h=zmStreamsApp.GroupManageApp.getGroupAppModel(f));var i=k;if(h.get("members").length>=i)return void _zm.succErrMsg("e",zmText.applyArgs(b.groupSubscription.errmaxmem,{max:i}));if(!$(this).hasClass("zmLock")){var o=$(this).parents("li");g.text(b.groupSubscription.memberActions.adding),$(this).addClass("zmLock");var q=o.data("id");if(h){q=String(q);var r=function(){$.publish("streams/addGroupMember",{gid:f,zid:q});var e=zmStreamsApp.util.getGroupDetails(f),g=zmStreamsApp.GroupApp.template("getLIView",{contactObj:zmStreamsApp.util.getContactDetails([q])[q],mod:"",info:e}),h=$("ul.viewMem").children();h&&1===h.length&&$(h[0]).hasClass("nohr")&&$("ul.viewMem").html(""),$("ul.viewMem").append(g),n=zmStreamsApp.GroupApp.template("groupMemberText",{grpInfo:e,isAllow:!0}),j-=1,d.find("#isMem").text(n),n=j+(1===j?" "+b.common.labels.match:" "+b.common.labels.matches),$(l.$els.$contentWrapper).find(".isAddCount").text(n),o.siblings().length||(o.parent().prev().hide(),o.parent().hide()),o.remove(),p(f,"add"),a.bindDialogEvents(c.eparam,l)},s=function(){g.text(b.groupSubscription.memberActions.addButton),e.removeClass("zmLock")};h.addMember(q.split(","),r,s)}}})}else d.find("#isAdd").hide(),d.find(".addMem").hide()})}a.bindDialogEvents(c.eparam,l)};var r=function(a){var b=["H3",{child:[["text",a]]}];return _zm.getDOM(b)},s=function(b,c){zmUtil.loadGroupManagement();var d=c.gid,e={ignoreMouseDown:!1,closeAction:function(){},dialogDidMount:function(e){var f=e.$els,g=f.$header,h=$(f.$content),i="";if(b.isDisabled&&b.totalMembers!==b.members.length){var j=zmStreamsApp.GroupManageApp.getMembers(d),k=zmComponent.loadingBand({container:h[0],type:"pagination"});j.done(function(f){f&&f.length&&"error"!==f&&(b.members=_zm.copyOf(f)),k(),i=zmStreamsApp.GroupApp.template("groupMemberText",{grpInfo:b,isAllow:!0}),h.prepend(zmStreamsApp.GroupApp.template("memberHeader",{name:i,members:b.members})),$(g).append(r(b.name)),a.constructMemberPopup(h,d,e,"",c)})}else i=zmStreamsApp.GroupApp.template("groupMemberText",{grpInfo:b,isAllow:!0}),h.prepend(zmStreamsApp.GroupApp.template("memberHeader",{name:i,members:b.members})),$(g).append(r(b.name)),a.constructMemberPopup(h,d,e,"",c)}};Dialog["new"](e)};a.showMemberDialog=function(a){var b=a.gid;if(b&&(!zmsDialog.elemId||"zms_memView"!==zmsDialog.elemId)){var c;c=zmStreamsApp.util.getGroupDetails(b),s(c,a)}};var t=function(a,c,d){var e=_zm("<","input",_zm("#","zms_AMember"))[0],f=zmAutoFill.getAddress(e),g=f?f.length:0,h=zmStreamsApp.util.getGroupDetails(a),i=h.members,j=k;if(!g||e.value.trim())return e.value.trim()&&_zm.succErrMsg("e",b.groupSubscription.memberActions.addValidUser),$(e).focus(),void zmStreamsApp.util.sendRemove(d,!0,b.groupSubscription.memberActions.addButton);if(i.length>=j||i.length+g>j)return _zm.succErrMsg("e",zmText.applyArgs(b.groupSubscription.errmaxmem,{max:j})),$(e).focus(),void zmStreamsApp.util.sendRemove(d,!0,b.groupSubscription.memberActions.addButton);var l=0,n=[];for(l=0;l<g;l++)n.push(f[l].zid);var o=m(a);if(o||(zmStreamsApp.GroupApp.init(),o=m(a)),n.length&&o){var q=function(){c(),p(a,"add")},r=function(){zmStreamsApp.util.sendRemove(d,!0,b.groupSubscription.memberActions.addButton)};o.addMember(n,q,r)}};return a.createGroupChat=function(a){var b=m(a);b||(zmStreamsApp.GroupApp.init(),b=m(a)),b.sync("createChat",b,{})},a.openCompose=function(a){var b=m(a);b||(zmStreamsApp.GroupApp.init(),b=m(a)),zmUtil.compose({TO:zmStreamsApp.util.getGroupDetails(b.id).eid})},a.addMember=function(a){var c,d=zmStreamsApp.GroupApp.template("addMember"),e=_zm.getDOM(d),f=zmStreamsApp.util.getGroupDetails(a).name,g=zmStreamsApp.util.getGroupDetails(a),h=g.members,i=k;if(h.length>=i)return void _zm.succErrMsg("e",zmText.applyArgs(b.groupSubscription.errmaxmem,{max:i}));var j=function(){c.remove()},l={title:b.common.labels.addNewMember+" - "+f,$content:e,buttons:[{name:b.groupSubscription.memberActions.addButton,callback:function(c){var d=$(c.$els.$buttonContainer).children()[0];$(d).hasClass("zs_snd")||(zmStreamsApp.util.sendRemove(d,"",b.groupSubscription.memberActions.adding),t(a,j,d))}},{name:b.common.labels.cancel,isCancel:!0,callback:j}],ignoreMouseDown:!1};c=Dialog["new"](l);var m=_zm("<","input",e)[0],n={contentArray:"org:"+a,compare:["fn","ln","nn","eid"],LType:"3",OType:"2",eliminateAt:!0};zmAutoFill.setAutofill(n,$(m)),setTimeout(function(){m.focus()},700)},a.showtrendingTags=function(a,b){var c=m(b);c||(zmStreamsApp.GroupApp.init(),c=m(b)),c.getHashTags("trendingtags",function(){var b=c.get("trendingtags");zmStreamsApp.util.createPopup({items:b,parent:a,type:"trendingtags",liHover:!1,parentClass:"SC_tTags",callback:function(a,b){var c=$(b).data("text");if(zmStreamsApp.util.hideMenu(),c){var d=zmStreamsApp.events.getCurrentView(),e=zmStreamsApp.PostApp;e.showOtherTab("#"+c,"hashTag",c,zmStreamsApp.events.getCurrentGroupId()),e.fetchPosts({type:"other",ele:d.elm,previous:d.tab})}}})})},!zmail.isPopupMail&&zmail.ContactBook&&zmail.ContactBook.groupsFetched.done(function(){zmAppLoader.load("streamsGroup").done(function(){zmStreamsApp.GroupApp.init()})}),a}(zmStreamsApp.GroupApp||Zmail.App.extend({})),window.zmailStreamsApp=window.zmailStreamsApp||Zmail.App.extend({}),zmailStreamsApp.GroupApp=function(a){return a}(zmailStreamsApp.GroupApp||Zmail.App.extend({})),zmailStreamsApp.GroupApp.constants=function(a){a=a||{},a.methods={correctUnread:"correctUnread",createchat:"createGChat",getAllUnread:"getAllUnread",getGroups:"groups"}}(zmailStreamsApp.GroupApp.constants),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupApp=function(a){return a}(zmStreamsApp.GroupApp||Zmail.App.extend({})),zmStreamsApp.GroupApp.models=function(a){return a.Group=Zmail.Model.extend({defaults:{ladt:"",name:"",owner:"",scount:"",users:""},markPostsRead:function(){var a=this;this.sync("markallread",this).done(function(){if(_zm.isAllUnreadEnabled()){var b;if(a.id===zmail.zuid){var c=zmStreamsApp.util.getGroupDetails();for(var d in c)zmUtil.changeUnread(d,"",0)}else if(b=zmStreamsApp.GroupApp.getModel(zmail.zuid)){var e=a.get("scount"),f=b.get("scount"),g=f-e;g=g<0?0:g,zmUtil.changeUnread(zmail.zuid,"",g)}}zmUtil.changeUnread(a.id,"",0),zmStreamsApp.events.clearList(a.id)})},addMember:function(a,b,c){var d=this;this.sync("addmember",this,{zuid:a}).done(function(e){if(e[0]){zmStreamsApp.util.groupManagement({mode:"addMember",groupId:d.id,members:a});var f=d.get("members");f=f.concat(a),d.set("members",f),b()}else c&&c()}).error(function(){c&&c()})},removeMember:function(a,b){var c=this;this.sync("removeMember",this,{zuid:a}).done(function(){zmStreamsApp.util.groupManagement({mode:"removeMember",groupId:c.id,members:a});var d=c.get("members");d=_.without(d,a),c.set("members",d);var e=_.indexOf(c.get("moderator"),a)!==-1;if(e){var f=c.get("moderator");f=_.without(f,a),c.set("moderator",f),$.publish("streams/changeMemberRole",{mode:"removeModerator",gid:c.id,zid:a}),zmStreamsApp.util.groupManagement({mode:"removeModerator",groupId:c.id,members:a})}b()})},changeModerator:function(a,b){var c=this,d=a.zuid;this.sync("changeModerator",this,a).done(function(){zmStreamsApp.util.groupManagement({mode:a.mode,groupId:c.id,members:d});var e=c.get("moderator");"addModerator"===a.mode?e=e.concat(d):"removeModerator"===a.mode&&(e=_.without(e,d)),c.set("moderator",e),b()})},updateHashTagforAutofill:function(a){var b=this.getHashTags("loadhashtags"),c=_.pluck(b,"name");c.indexOf(a)===-1&&(b.push({name:a}),this.set("loadhashtags",b))},getHashTags:function(a,b,c){var d=this;a=a||"loadhashtags";var e=d.get(a);return e?"request"===e?[]:(b&&b(e),e):(d.set(a,"request"),void this.sync("fetchTags",this,{actionType:a,startsWith:c}).done(function(c){var e=c[1].hashTags||[],f=[];return e.length?(e=_.unique(e.map(function(a){return a.trim()})),_.each(e,function(a){f.push({name:a})})):f=[],d.set(a,f),b&&b(f),this}).error(function(){d.set(a,"request")}))},correctUnread:function(){var a=this;this.sync("correctUnread",this).done(function(b){b=b[1];var c=b.count;if(void 0!==c){if(c=parseInt(c),_zm.isAllUnreadEnabled()){var d;if(a.id!==zmail.zuid)d=parseInt(b.aucount),zmUtil.changeUnread(zmail.zuid,"",d);else if(b.gcount)for(var e in b.gcount)d=parseInt(b.gcount[e]),zmUtil.changeUnread(e,"",d)}zmUtil.changeUnread(a.id,"",c)}})},url:"/zm/stream.do",serialized:function(a,b){var c=this,d=null;if("correctUnread"===a)d={actionType:"viewGroupData",streamsView:!0,mode:"correctUnread",groupId:c.get("id")},_zm.isAllUnreadEnabled()&&(d.allUnreadView=!0);else if("createChat"===a)d={mode:"createGroupChat",groupId:c.get("id")},b.url=zmail.conPath+"/util.do",b.type="GET";else if("markallread"===a){var e=c.get("id");d={groupId:e,actionType:"markallAsRead",mode:"markallread",streamsView:!0},e===zmail.zuid&&_zm.isAllUnreadEnabled()&&(d.mode="hmarkallread"),b.url=zmail.conPath+"/post.do"}else"addmember"===a?(d={gid:c.get("id"),mode:"addMember",mzuid:b.zuid},b.setSessionId=!0,b.url=zmail.conPath+"/groupSubscription.do"):"fetchTags"===a?(d={groupId:c.get("id"),actionType:b.actionType||"loadhashtags",mode:"hashTags"},b.startsWith&&(d.startsWith=b.startsWith,d.actionType="autocomplete")):"removeMember"===a?(d={gid:c.get("id"),mode:"removeMember",mzuid:b.zuid},b.setSessionId=!0,b.url=zmail.conPath+"/groupSubscription.do"):"changeModerator"===a&&(d={gid:c.get("id"),mode:"changeRole",mzuid:b.zuid,moderator:"addModerator"===b.mode},b.setSessionId=!0,b.url=zmail.conPath+"/groupSubscription.do");return d}}),a.GroupCollection=Zmail.Collection.extend({model:a.Group,url:"/zm/stream.do",addModel:function(a,b,c){return this.remove(a,{silent:c}),this.add(a,{at:b,silent:c}),this},updateUnread:function(){this.sync("getAllUnread",this).done(function(a){a=a[1];var b,c=0;for(b in a)c+=a[b],zmUtil.changeUnread(String(b),"",a[b]);_zm.isAllUnreadEnabled()&&zmUtil.changeUnread(zmail.zuid,"",c)})},serialized:function(a,b){var c=null;return"getgroups"===a?(b.url=zmail.conPath+"/getGroups.do",c={mode:"groups"}):"getAllUnread"===a&&(c={mode:"allucount"}),c},parse:function(b){var c=b.list?b.list:b.groups,d=b.order;return a.groupOrder=d,_(d).map(function(a,b){var d=c[a];return d.sequence=b+1,d})}}),a}(zmStreamsApp.GroupApp.models),zmStreamsApp.GroupApp.template=function(){var a=zmText.get("streams"),b=function(b,c){var d="",e=b.members;return e&&(e=e.length,d="isAdd"!==b.mode?e+(1===e?" "+a.common.labels.person:" "+a.common.labels.members):e+(1===e?" "+a.common.labels.match:" "+a.common.labels.matches)),d},c=function(b,c,d){var e=[],f=d.moderator,g=d.owner;e=f&&f.indexOf(zmail.zuid)!==-1&&b.zid!==zmail.zuid&&b.zid!==String(g)?["DIV",{attrs:{"class":"SCmb"},child:[["UL",{attrs:{"class":"zm_action"},child:[["LI",{attrs:{"class":""},child:[["B",{child:[["I",{attrs:{"class":"msi-action"}}],["DIV",{attrs:{"class":"SC_hd"}}]]}]]}]]}]]}]:[];var h=d.isAdd?["DIV",{attrs:{"class":"SC_PUbtm addButton"},child:[["SPAN",{child:[["text",a.groupSubscription.memberActions.addButton]]}]]}]:["I",{attrs:{"class":"SC_Otxt"},child:[["text",c]]}],i=["SPAN",{child:[["text",b.eid]]}],j=d.isAdd?"":"loadPost",k=["LI",{attrs:{"data-id":b.zid,"class":"zm_mem_post "+j},child:[["DIV",{child:[["STRONG",{child:[["text",b.fn]]}],h,i]}],e]}];k=_zm.getDOM(k);var l;return l=b&&b.avatar?b.avatar:_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(b.fn),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]),$(k).prepend(l),k},d=function(b,d){var e=b.members,f=b.owner,g=b.moderator,h=b.gid;d=b.ulDOM||d;var i,j,k,l,m,n,o,p=[];if(!b.isAdd&&_.size(e)){var q,r=[],s=[],t=[];for(i in b.members)q=b.members[i],q.zid===String(f)?s.push(q):g.indexOf(q.zid)!==-1?r.push(q):t.push(q);b.members=[],b.members=b.members.concat(s).concat(r).concat(t);for(j in b.members)l=b.members[j],l.fn&&(o=g.indexOf(l.zid)!==-1,n=o?a.common.labels.moderator:"",k=l.zid===String(f)?a.common.labels.owner:n,m=c(l,k,b),$(d)[0].appendChild(m))}else if(b.isAdd&&_.size(e))for(i=0;i<e.length;i++)l=e[i],zmUtil.isGroupMember(l.zid,h)||(m=c(l,"",b),$(d)[0].appendChild(m));else p=_zm.getDOM(["LI",{attrs:{"class":"nohr",style:"padding-left: 0px;text-align: center;padding-right: 0px;"},child:[["SPAN",{child:[["text",a.common.labels.nomemfound]]}]]}]),$(d)[0].appendChild(p);return p},e=function(a){var b=a.isAdd?"addMem":"viewMem SC_PhrTxt",c=a.isAdd?"display : none":"",e=["UL",{attrs:{"class":"SC_P2r P2rBlkGery "+b,id:"zms_memView",style:c}}],f=_zm.getDOM(e);return a.members&&d(a,f),f},f=function(b){var c=b.isOwner?a.groupSubscription.memberActions.searchModerator:a.groupSubscription.memberActions.searchUser,d=["DIV",{attrs:{"class":"SC_sch"},child:[["I",{attrs:{"class":"msi-search"}}],["INPUT",{attrs:{type:"text",placeholder:c}}]]}];return _zm.getDOM(d)},g=function(a){var c=[];if(a){var d="isAdd"===a.mode,e=d?["DIV",{attrs:{"class":"SC_SDot"}}]:[],f=d?"isAdd":"isMem",g=d?"display : none":"",h=d?["SPAN",{attrs:{"class":"memText isAddCount"},child:[["text",b(a,!0)]]}]:[];c=["H4",{attrs:{id:f,style:g},child:[["text",a.name+" "],e,h]}]}return _zm.getDOM(c)},h=function(){var b=["DIV",{attrs:{id:"zms_AMember"},child:[["DIV",{attrs:{"class":"SC_input",id:"zms_invPop",style:"width:calc(100% - 2px);"},child:[["INPUT",{attrs:{type:"text","class":"zm_sgst",placeholder:a.common.labels.addNewMember}}]]}]]}];return b};return function(a,i){var j;return"viewmembers"===a?j=d(i):"addMember"===a?j=h():"groupMemberText"===a?j=b(i.grpInfo,i.isAllow):"searchBox"===a?j=f(i):"memberHeader"===a?j=g(i):"getLIView"===a?j=c(i.contactObj,i.mod,i.info):"popupConstruction"===a&&(j=e(i)),j}}(),window.zmGroupSubscription=function(a){var b,c,d=zmStreamsApp.constants.maxLimit.MAX_ALLOWED_MEMBERS,e=300,f=100,g=200,h="data-marker",i={SUBSCRIBE:"subscribe",CREATE_GROUP:"creategroup"},j=zmail.conPath+"/groupSubscription.do",k=zmResource.get("image","SC-Photo.png"),l={},m={},n=[],o=[],p="",q=!1,r={},s=zmText.get("streams","groupSubscription"),t={groupItem:["DIV",{attrs:{"class":"zmL"},child:[["DIV",{attrs:{"class":"zmLst"},child:[["DIV",{attrs:{"class":"zmDtl"},child:[["DIV",{attrs:{"class":"zmImg"},child:[["IMG",{attrs:{"data-marker":"logo",src:""}}]]}],["DIV",{attrs:{"data-marker":"streamsdiv","class":"zmSze",style:"padding: 10px;"},child:[["SPAN",{child:[["I",{attrs:{"data-marker":"streams",style:"line-height: 10pt; vertical-align: middle;"}}],["SPAN",{attrs:{"data-marker":"streamstxt",style:"text-transform: capitalize; font-size: 10pt; line-height: 10pt; vertical-align: middle;"},child:[["text",s.lbl_enablestreams]]}]]}]]}],["DIV",{attrs:{"data-marker":"maildiv","class":"zmFdr",style:"padding: 10px;"},child:[["SPAN",{child:[["I",{attrs:{"data-marker":"mail",style:"line-height: 10pt; vertical-align: middle;"}}],["SPAN",{attrs:{"data-marker":"mailtxt",style:"text-transform: capitalize; font-size: 10pt; line-height: 10pt; vertical-align: middle;"},child:[["text",s.lbl_includemail]]}]]}]]}],["DIV",{attrs:{"class":"zmFrm"},child:[["SPAN",{attrs:{"data-marker":"name"}}]]}],["DIV",{attrs:{"class":"zmSub"},child:[["SPAN",{attrs:{"data-marker":"email","class":"sum"}}]]}]]}]]}]]}],emptyGroupList:["DIV",{attrs:{"class":"SC_nmsg"},child:[["text",s.msg_nogroups]]}],groupLogoInput:["INPUT",{attrs:{type:"file",accept:"image/*"}}],groupList:["DIV",{attrs:{"class":"SC_mc"}}],tabs:["DIV",{attrs:{"class":"SC_phd",style:"padding: 0; padding-top: 29px;"},child:[["UL",{attrs:{"class":"SCS_tab"},child:[["LI",{attrs:{"data-marker":"subscribeTab"},child:[["text",s.tab_subscribe]]}],["LI",{attrs:{"data-marker":"createTab"},child:[["text",s.tab_create]]}]]}]]}],createGroup:["DIV",{
child:[["TABLE",{attrs:{width:"98%",cellspacing:"5","class":"SC_pvtbl",cellpadding:"5"},child:[["TBODY",{child:[["TR",{child:[["TD",{attrs:{rowspan:"3",width:"60px",valign:"top"},child:[["DIV",{attrs:{style:"cursor: pointer;","data-marker":"logodiv","class":"Sphoto",title:s.msg_imgsize_ttip},child:[["IMG",{attrs:{"data-marker":"logoimg",style:"width:100%;",src:""}}]]}]]}],["TD",{child:[["DIV",{attrs:{"class":"SC_txt SC_tranbdr"},child:[["INPUT",{attrs:{"data-marker":"name",type:"text",placeholder:s.ph_grpname}}]]}]]}]]}],["TR",{child:[["TD",{child:[["DIV",{attrs:{"class":"SC_txt SC_tranbdr"},child:[["INPUT",{attrs:{"data-marker":"description",type:"text",placeholder:s.ph_grpdesc}}]]}]]}]]}],["TR",{child:[["TD",{child:[["DIV",{attrs:{"class":"SC_txt SC_tranbdr"},child:[["INPUT",{attrs:{"data-marker":"memberbox","class":"zm_sgst",type:"text",placeholder:s.ph_grpmems,autocomplete:"off"}}]]}]]}]]}]]}]]}],["DIV",{attrs:{"class":"SC_PUbtm",style:"padding: 10px; width: auto;"},child:[["SPAN",{attrs:{"class":"sel","data-marker":"createbtn"},child:[["text",s.btn_create]]}],["SPAN",{attrs:{"data-Val":"Cancel","data-marker":"cancelbtn"},child:[["text",s.btn_cancel]]}]]}]]}],tabContents:["DIV",{attrs:{style:"overflow: hidden; overflow-y: auto;"},child:[["DIV",{attrs:{"data-marker":"listdiv",style:"display: none;"}}],["DIV",{attrs:{"data-marker":"creatediv",style:"display: none;"}}]]}]},u=function(a,b,c){b=b||{};for(var d=$("["+h+"]",a),e=0,f=d.length;e<f;e++)b[_zm.attr(d[e],h)]=d[e],c||d[e].removeAttribute(h);return a.hasAttribute(h)&&(b[_zm.attr(a,h)]=a,c||a.removeAttribute(h)),b},v=function(a){return _zm.getDOM(a)},w=function(a,b,c,d){zmsDialog.confirm(a,{onOk:b,onCancel:c,onHide:d})},x=_zm.succErrMsg,y=function(a){var b={name:a.name,desc:a.desc,photo:a.photo,members:a.memberids,moderator:a.moderator,isOwner:a.isOwner,owner:a.owner,eid:a.email,id:a.id};zmStreamsApp.util.addGroup(b)},z=function(){return zmsuite.isWorkspaceAvailable("zm_stream")||zmsuite.isWorkspaceAvailable("zmStreamsApp")},A=function(a,b,c,d){zmAjq.XHR({u:j,p:a,fn:b,efn:c,ep:d,t:"post"})},B=function(a,b,c,d){var e,f=function(a){if("string"==typeof a)try{a=$.parseJSON(a)}catch(e){}a=a||[],a[0]&&1===a[0]?b(a[1],d):c(a[1],d)};if(window.FormData&&window.FileList){var g=new FormData;for(e in a)a[e].fileInput?a[e].fileInput.files.length&&g.append(e,a[e].fileInput.files[0]):g.append(e,a[e]);g.append("zmrcsr",zmAjq.getCookie("zmcsr")),$.ajax({url:j,data:g,processData:!1,contentType:!1,cache:!1,type:"POST",success:f,error:f})}else{for(e in a)a[e].fileInput&&delete a[e];A(a,b,c,d)}},C=function(){var a,b,c,d=["emptyGroupList","groupList","tabs","createGroup","tabContents"];for(a=0,b=d.length;a<b;a++)c=d[a],l[c]=v(t[c]),u(l[c],l);l.listdiv.appendChild(l.groupList),l.creatediv.appendChild(l.createGroup),l.groupLogo=v(t.groupLogoInput),l.tempLogo=v(t.groupLogoInput)},D=function(){l.previewCard=zmsuite.getCenter()[1],l.previewCardDOM=$(l.previewCard.$el),l.previewHeader=l.previewCard.getNodes()[0],l.previewContent=l.previewCard.getNodes()[1],l.previewHeader.push({text:[],rIcons:[[{tooltip:s.lbl_close,iconClass:"msi-close",data:"close"}]]}),l.previewContent.push(l.tabContents)},E=function(){l.previewHeader.push({text:[],rIcons:[[{tooltip:s.lbl_close,iconClass:"msi-close",data:"close"}]]}),l.previewContent.push(""),l.previewCard.getNodes()[0].setListener("click",b),l.previewCardDOM.removeClass("groupSubscription")},F=function(){var a=l.previewCard.getNodes()[0].getDOMNode()[0];a.childNodes[1].appendChild(l.tabs)},G=function(){zmUtil.setScrollShadow($(l.previewContent.getDOMNode()))},H=function(a){var b=m[a].elemMap,c=m[a].data;_zm.clearHTML(b.name),_zm.setTextContent(b.name,c.name),_zm.setAttr(b.name,{title:c.name}),b.logo.src=p+c.id,_zm.clearHTML(b.email),_zm.setTextContent(b.email,c.email),_zm.setAttr(b.email,{title:c.email}),b.streams.className=c.streams?"msi-check":"msi-uncheck",c.isorggroup||_zm.hide(b.maildiv),b.mail.className=c.mail?"msi-check":"msi-uncheck"},I=function(a){var b=m[a],c=b.data;if(b.requestInProgress)return void x("i",s.msg_reqinprocess);if(!c.streams&&c.memberids.length>d)return void x("e",s.msg_cantenable+". "+s.err_excessmems+"( "+d+" )");if(c.streams&&!zmail.showFeature)return void x("e",[s.msg_cantdisable,s.msg_disablenotsupported].join(". "));var e=function(d){var e,f="";b=m[a],b.requestInProgress=!1,b.data=d.group||b.data,c=b.data,c.streams?(f=s.msg_streamsenabled+' "'+c.name+'". '+s.msg_streamsenabled_2,e="group/streamsenabled"):(f=s.msg_streamsdisabled+' "'+c.name+'"',e="group/streamsdisabled"),x("s",f),y(c),$.publish(e,{id:a,name:c.name,membercount:c.memberids.length,members:c.memberids}),H(a)},f=function(d){b=m[a],b.requestInProgress=!1,d=d||{};var e=(c.streams?s.msg_cantdisable:s.msg_cantenable)+". "+(d.msg||s.msg_support);x("e",e)},g=function(){b.requestInProgress=!0;var d=c.streams?"disable":"enable";A({mode:"stream",gid:a,state:d},e,f)},h=(c.streams?s.msg_disableconf:s.msg_enableconf)+' "'+c.name+'"';c.streams?g():w(h,g)},J=function(a,b){var c=m[a],d=c.data;if(c.requestInProgress)return void x("i",s.msg_reqinprocess);var e=function(b){c=m[a],c.requestInProgress=!1,c.data=b.group||c.data,d=c.data,x("s",s.msg_mailboxcreated+' "'+d.email+'"'),H(a),$.publish("group/mailboxcreated",{id:a,email:d.email})},f=function(b){c=m[a],c.requestInProgress=!1,b=b||[];var d=s.msg_mbcreateerror+". "+b.msg||s.msg_support;x("e",d)};c.requestInProgress=!0,A({mode:"createmb",gid:a,email:b},e,f)},K=function(a){var b=m[a],c=b.data;if(!o||!o.length)return void x("e",s.err_nodomains+". "+s.msg_support);var d=c.name.toLowerCase(),e=d.replace(/ /gi,"_"),f=[];o.forEach(function(a){f.push(["OPTION",{attrs:{value:a},child:[["text",a]]}])});var g="mailbox_create",h=["H4",{child:[["text",s.msg_yourgroup+" '"+c.name+"' "+s.msg_creatembconf],["DIV",{child:[["INPUT",{attrs:{type:"text","data-marker":"email",value:e}}],["text"," @ "],["DIV",{attrs:{"class":"SC_select"},child:[["SELECT",{attrs:{"data-marker":"domain"},child:f}]]}]]}]]}],i=["DIV",{attrs:{id:g,style:"display: none;"},child:[h]}],j=_zm.getDOM(i),k=u(j),l=function(){zmsDialog.remove(),$("#"+g).remove()},n=function(){var b=k.email.value,c=k.domain.value,d=b+"@"+c;b&&d?(J(a,d),l()):x("e",s.err_invalidemail)},p={style:{width:"500px"},buttons:[{txt:s.txt_ok,callback:n},{isCancel:!0,txt:s.txt_cancel,callback:l}],mask:!0,hideclose:!1,pos:"center",closeaction:function(){$("#"+g).remove()},title:s.txt_mbcreatetitle};document.body.appendChild(j),zmsDialog.create(g,p)},L=function(a){var b,c,d=m[a],e=d.data;if(d.requestInProgress)return void x("i",s.msg_reqinprocess);var f=function(b){var c="";d=m[a],d.requestInProgress=!1,d.data=b.group||d.data,e=d.data,c=(e.mail?s.msg_mailincluded:s.msg_mailexcluded)+" "+e.name,x("s",c),H(a),$.publish(e.mail?"group/streamsmailincluded":"group/streamsmailexcluded",{id:d.id})},g=function(b){d=m[a],d.requestInProgress=!1,b=b||[];var c=e.mail?s.msg_cantexclude+". "+b.msg||s.msg_support:s.msg_cantinclude;x("e",c)},h=function(){d.requestInProgress=!0;var b=e.mail?"exclude":"include";A({mode:"mail",state:b,gid:a},f,g)};e.isorggroup?e.streams?e.hasmailbox?(b=(e.mail?s.msg_excludeconf:s.msg_includeconf)+' "'+e.name+'"',w(b,h)):e.email?(c=(e.mail?s.msg_cantdisable:s.msg_cantenable)+". "+s.msg_support,x("e",c)):q?K(a):x("e",s.err_mborgadmin):x("e",s.err_streamsnotenabled):x("e",s.err_notorggroup+". "+s.msg_support)},M=function(){var a=l.tempLogo;try{var b=a.files[0];if(Math.round(b.size/1024)>e)return!1}catch(c){}return!0},N=function(a){var b=m[a].elemMap;_zm.bind(b.streams,"click",I,[a]),_zm.bind(b.streamstxt,"click",I,[a]),_zm.bind(b.mail,"click",L,[a]),_zm.bind(b.mailtxt,"click",L,[a])},O=function(a){var b=function(a){_zm.removeClass(a.parentNode,"SC_tranbdr")},c=function(a){_zm.addClass(a.parentNode,"SC_tranbdr")};for(var d in a)_zm.bind(a[d],"focus",b,a[d]),_zm.bind(a[d],"blur",c,a[d])},P=function(){return!0},Q=function(){M()&&P()?(c(),x("i",s.msg_logopvwupd)):x("e",s.err_invalidlogo+" "+e+"KB")},R=function(){_zm.bind(l.tempLogo,"change",Q,[])};c=function(){l.groupLogo=l.tempLogo;try{var a=l.groupLogo.files[0],b=new FileReader;_zm.bind(b,"loadend",function(a){l.logoimg.src=a.result},[b]),b.readAsDataURL(a),l.tempLogo=v(t.groupLogoInput),R()}catch(c){x("e",s.err_photopreview)}};var S=function(a){var b={contentArray:"org",compare:["fn","","nn","eid"],LType:"3",OType:"2",display:"fn",eliminateAt:!0};zmAutoFill.setAutofill(b,$(a))},T=function(){l=null,m=null},U=function(){l.previewCard.close(),E(),T()},V=function(a){return!!a&&(!(0===a.length||a.length>f)&&!zmUtil.hasXSSChars(a))},W=function(a){return!(a&&a.length>g)&&(!a||!zmUtil.hasXSSChars(a))},X=function(a){return!!(a&&a.length>0&&a.length<=d)},Y=function(a){return V(a.name)?W(a.description)?X(a.members)?!(!P(a.logo)||!M(a.logo))||(x("e",s.err_invalidlogo+" "+e+"KB"),!1):(!a.members||a.members.length<0?x("e",s.errminmem):a.members.length>d&&x("e",zmText.applyArgs(s.errmaxmem,{max:d})),!1):(x("e",s.err_invalidgdesc+" "+g),!1):(x("e",s.err_invalidgname+" "+f),!1)},Z=function(){return{name:l.name.value||"",description:l.description.value||"",members:zmAutoFill.getAddress(l.memberbox),logo:l.groupLogo}},_=function(a,b){var c,d={},e={},f={};for(c in a.members)a.members[c]!==zmail.zuid&&(d[a.members[c]]=a.members[c],f[a.members[c]]=a.members[c]);for(c in b)b[c].zid!==zmail.zuid&&(e[b[c].zid]=b[c].zid,f[b[c].zid]=b[c].zid);var g=Object.keys(d).length,h=Object.keys(e).length,i=Object.keys(f).length;return g===h&&g===i},aa=function(a){var b,c=[],d=zmStreamsApp.util.getGroupDetails();for(var e in d)b=d[e],_(b,a)&&c.push(b.name);return c},ba=function(a){var b;"creating"===a?(_zm.addClass(l.createbtn,"sel"),b=s.btn_creating):"default"===a&&(_zm.removeClass(l.createbtn,"sel"),b=s.btn_create),_zm.clearHTML(l.createbtn),_zm.setTextContent(l.createbtn,b)},ca=function(){l.logoimg.src=k,l.tempLogo=v(t.groupLogoInput),l.groupLogo=l.tempLogo,R()},da=function(){ca(),l.name.value="",l.description.value="",l.memberbox.value="",_zm.remove(_zm(".","SC_cs",l.memberbox.parentNode)),zmAutoFill.clearData($(l.memberbox),""),S(l.memberbox),l.memberbox.placeholder=s.ph_grpmems},ea=function(a){var b,c,d,e=l.groupList;if(_zm.clearHTML(e),a)zmComponent.loadingBand({container:e,type:"pagination"});else if(Object.keys(m).length)for(d in n)b=n[d],m[b].dom||(c=v(t.groupItem),m[b].dom=c,m[b].elemMap=u(c),N(b),H(b)),e.appendChild(m[b].dom);else e.appendChild(l.emptyGroupList)},fa=function(a){m[a.id]={data:a},n.push(a.id),ea()},ga=function(a){r.createRequestInProgress=!0,ba("creating");var b=[];for(var c in a.members)b.push(String(a.members[c].zid));b=b.join(",");var d=function(a){r.createRequestInProgress=!1,ba("default");var b=a.group;b.photo=b.photo||p+b.id,fa(b),y(b),$.publish("group/streamsenabled",{id:b.id,name:b.name,membercount:b.memberids.length,members:b.memberids}),da(),x("s",s.msg_groupcreated)},e=function(a){r.createRequestInProgress=!1,ba("default"),a=a||{};var b=s.err_creategroup+". "+(a.msg||s.msg_support);x("e",b)};B({mode:"create",name:a.name,desc:a.description,mzuid:b,logo:{fileInput:a.logo}},d,e)},ha=function(){if(r.createRequestInProgress)return void x("i",s.msg_reqinprocess);var a=Z();if(Y(a)){var b=aa(a.members);if(b.length>0){var c=[s.msg_cnfnewgroup1,"( "+b.join(", ")+" )",s.msg_cnfnewgroup2].join("\n");w(c,function(){ga(a)})}else ga(a)}},ia=function(){O([l.name,l.description,l.memberbox]),S(l.memberbox),_zm.bind(l.createbtn,"click",ha,[]),_zm.bind(l.cancelbtn,"click",U,[]),_zm.bind(l.logodiv,"click",function(){l.tempLogo.click()},[]),R()},ja=function(){l.previewCard.getNodes()[0].setListener("click",U)},ka=function(a){_zm.removeClass(l.subscribeTab,"stSel"),_zm.removeClass(l.createTab,"stSel"),_zm.hide(l.listdiv),_zm.hide(l.creatediv),a===i.SUBSCRIBE?(_zm.addClass(l.subscribeTab,"stSel"),_zm.show(l.listdiv)):a===i.CREATE_GROUP&&(_zm.addClass(l.createTab,"stSel"),_zm.show(l.creatediv))},la=function(){_zm.bind(l.subscribeTab,"click",ka,[i.SUBSCRIBE]),_zm.bind(l.createTab,"click",ka,[i.CREATE_GROUP])},ma=function(){ja(),la(),ia(),G()},na=function(){var a=function(a){var b,c;q=a.isorgadmin,o=a.domains,p=a.photoURLPrefix,m={},n=[];for(b in a.groups)c=a.groups[b],c.photo=p+c.id,m[c.id]={data:c},n.push(c.id);ea()},b=function(a){var b=a&&a.msg||s.msg_support;x("e",s.err_groupslist+" - "+b+". "+s.err_groupslist_2),ea()};A({mode:"list"},a,b,[]),ea(!0)},oa=function(){l={},m={},n=[],o=[],p="",r={},C(),D(),l.previewCard.show(),l.previewCardDOM.addClass("groupSubscription"),F(),ma(),ca()},pa=function(a){b=a.onPreviewClose,z()&&b&&(oa(),ka(i.SUBSCRIBE),na())};return a=a||{},a.showPage=pa,a}();