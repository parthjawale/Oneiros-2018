"use strict";window.zmfolAction=function(a){var b={},c={},d={},e=zmText.get("zmFolder"),f=function(a,b,c){zmAjq.XHR({u:zmail.conPath+"/folAction.do",t:"POST",fn:c,p:a,csr:"s",ep:b})},g=function(a,b,c,d){var f;b=b.toLowerCase();for(f in a)if(a[f].FN.toLowerCase()===b&&f!==c)return zmUtil.succErrMsg("e",e.folderCreateRename.folexist,d),!1;return!0},h=function(a,c){if("success"===a.status){b[a.folId]=Date.now(),zmail.MailPreUtils.updateCount({fId:a.folId,mode:"upd",count:0});var d=[a.folId];c.mailId&&d.push(c.mailId),$.publish("folder/read",d)}},i=function(){$("#emptyfolpopup").remove()},j=function(){var a,b,c=[];for(a in zmail.shrTree[0])b=zmail.shrTree[0][a],c.push({fId:a,shId:b.SHID,path:b.FN});return c},k=function(a){if(a&&zmUtil.isSharedFolder(a)){var b,c,d=zmfolAction.getSharedFolPaths(),e=d.length;for(b=0;b<e;b++)if(c=d[b],c.fId===a)return c}return""},l=function(a,b){b=b||{};var c=b.maxLength||50,d=b.filler||"...",e=d.length,f=b.separator||"/";a=a&&a.trim()||"";for(var g=a.split(f),h=0;h<g.length;h++)g[h]=g[h].trim(),g[h].length||(g.splice(h,1),h--);if(1===g.length)a.length>c&&(a=a.substr(0,c-e)+d);else if(2===g.length)a.length>c&&(a=d+f+g[1].substr(0,c-(e+1+e))+d);else{var i=g[0].length+g[g.length-1].length+2+e;a=i>c?d+f+g[g.length-1].substr(0,c-(e+1+e))+d:g[0]+f+d+f+g[g.length-1]}return a},m=function(){var a,b,c,d=0;c=zmail.folTree[0];for(a in c)c[a].SE>d&&(b=a,d=c[a].SE);return b};zmfolAction.updateFolSortType=function(a,b){try{if(!a||!zmUtil.isFolderId(a))return;var c=zmail.folTree;if(zmfolAction.isChildFol(a)){var d=zmfolAction.getParentFolderId(a);c[1][d].CH[a].SMIF=b}else c[0][a].SMIF=b}catch(e){return zmUtil.debugLog(e),!1}},zmfolAction.getFolProperties=function(a){try{if(a&&zmail.folTree[0][a])return zmail.folTree[0][a];var b=zmfolAction.getParentFolderId(a);return b&&zmail.folTree[1][b].CH[a]}catch(c){return void zmUtil.debugLog(c)}},zmfolAction.hasChild=function(b,c){var d;return d=a.getParentFolderId(c),d===b||0!==d&&void(c=d)},zmfolAction.hasObjLength=function(a){var b;for(b in a)return!0;return!1},zmfolAction.insertNewFolder=function(a,b){var c=a.prefolId,d=a.folId,e=a.fName;if("success"===a.status){if(!zmInit.findFolName(d)){var f,g=[],h="zmlTreeH";f=zmail.mailLeft.getNodes()[0].getLayer(h),g[d]={E:0,FN:e,HC:0,SH:"-1",count:"0",IA:0,CV:zmail.folviewThread,SMIF:0,VW:!0},f.insertNodeAfter(g,f.mapObject,c),$.publish("folder/added",{folderID:d})}}else zmUtil.succErrMsg("e",a.emsg);b&&b.reqDoneClbk&&b.reqDoneClbk("success"===a.status,d)},zmfolAction.insertNewSubFolder=function(a,b){var c=a.prefolId,d=a.pfolId,e=a.folId,f=a.fName;if("success"===a.status){if(!zmInit.findFolName(e)){var g,h=[],i="zmlTreeH";g=zmail.mailLeft.getNodes()[0].getLayer(i),h[e]={E:0,FN:f,HC:0,SH:"-1",count:"0",IA:0,CV:zmail.folviewThread,SMIF:0,VW:!0},c?g.insertNodeAfter(h,g.mapObject,c,d):g.appendNode(h,g.mapObject,d),$.publish("folder/added",{folderID:e})}}else zmUtil.succErrMsg("e",a.emsg);b&&b.reqDoneClbk&&b.reqDoneClbk("success"===a.status,e)},zmfolAction.renameFolder=function(a){var b=a.folId;if("success"===a.status){var c=a.fName;if(zmInit.findFolName(b)!==c){var d,e=[],f="zmlTreeH";d=zmList.getRowInfo(b,f,"info"),d.FN=c,e[b]=d,zmList.editLeftRow(e,f),$.publish("folder/renamed",{folderID:b}),$.publish("/folder/rename")}}else zmUtil.succErrMsg("e",a.emsg)},zmfolAction.markAsReadFolder=function(a){var b,c,d,e=zmInit.getListingDetObj();b=a?a:e.fId,c={accId:zmail.accId,mode:"read",folId:b};var g=[],i=zmUtil.getListMap(b);i&&(g=i.MO.slice()),d={action:"read",mailId:g},f(c,d,h)};var n=function(a){var b=a.id,c=zmList.getMailObj(b);c&&c.FD===zmail.folId.tId&&0===c.TH&&zmContentCache.remove(b)};zmfolAction.emptyFolder=function(b,f,g){if("success"===b.status){c[b.folId]=Date.now(),zmsDialog.remove();var h=b.folId,i=zmUtil.getFolId(),j=zmInit.getListingDetObj();if(i===h&&zmPrev.clsPreview(),$("#emptyfolpopup").remove(),zmUtil.getListMap(h)?$.publish("/mail/discardFromThread",{fId:h}):zmUtil.getListMap(i)&&$.publish("/mail/discardFromThread",{fId:h,viewId:i}),$.publish("folder/archived",[h,b.isArchived]),h===zmail.folId.spId)j.fId===zmail.folId.spId&&$(zmail.mailCenter.listElem).html(zmInit.emptyRow()),zmail.MailPreUtils.updateCount({fId:h,mode:"upd",count:0}),g||zmUtil.succErrMsg("s",e.emptyfolder.emptyspammsg);else if(h===zmail.folId.tId){j.fId===zmail.folId.tId?$(zmail.mailCenter.listElem).html(zmInit.emptyRow()):a.isDeletedFolder(j.fId)&&$.publish("/mail/listMails",{fId:zmail.folId.iId}),zmail.MailPreUtils.updateCount({fId:h,mode:"upd",count:0});var k=zmail.mailLeft.getNodes()[0].getLayer("zmlTreeH");k.clearChild(zmail.folId.tId),g||zmUtil.succErrMsg("s",e.emptyfolder.emptytrashmsg),zmail.mailContainer.filter(n),$.publish("folder/trashemptied",{})}else if(h===zmail.folId.sId)j.fId===zmail.folId.sId&&$(zmail.mailCenter.listElem).html(zmInit.emptyRow()),g||zmUtil.succErrMsg("s",e.emptyfolder.emptysentmsg);else if(g||zmUtil.succErrMsg("s",zmText.applyArgs(e.emptyfolder.emptyfol,{foldername:zmInit.findFolName(h)})),zmUtil.removeListMap(h),j.fId===h?(zmInit.reInitListing(),f.selDate||f.leaveCount?(zmInit.setListingDetObj({}),zmInit.foldView({folId:h})):$(zmail.mailCenter.listElem).html(zmInit.emptyRow())):j.fId===zmail.folId.tId?$.publish("/mail/listMails",{fId:zmail.folId.tId}):zmUtil.isFolderId(i)||$.publish("/mail/listMails",{}),b.foltree){zmail.folCount=b.foltree;var l=zmail.mailLeft.getNodes()[0].getLayer("zmlTreeH");l.setCountObject(zmail.folCount),zmail.MailPreUtils.updateCount({fId:h,mode:"upd",count:zmail.folCount[h].c}),zmail.MailPreUtils.updateCount({fId:zmail.folId.tId,mode:"upd",count:zmail.folCount[zmail.folId.tId].c})}}else g||zmUtil.succErrMsg("e",b.emsg);d[b.folId]="1",zmInit.listingBand.SpamTrashBand.setBand()},zmfolAction.deleteTrashFolder=function(a,b){if("success"!==a.status)return!1;var c,d,e=a.folderId,f=zmfolAction.getParentFolderId(e),g=zmUtil.getFolId(),h=zmInit.getListingDetObj(),i="zmlTreeH";c=zmList.getRowInfo(e,i),Object.keys(c).length&&(d=zmail.mailLeft.getNodes()[0].getLayer(i),d.deleteNode(c,f),g===e&&zmPrev.clsPreview(),h.fId===e&&$.publish("/mail/listMails",{fId:zmail.folId.iId}))},zmfolAction.getEmptyFolderStatus=function(a){return void 0!==d[a]?d[a]:""},zmfolAction.resetEmptyFolderStatus=function(a){d[a]=""},zmfolAction.sendEmptyFolderReq=function(b){var c,d,f;if(c=b?b:a.rgtFolId,!$("#emptyfolpopup").length){var g=[];zmUtil.getFolderObject(c).IA&&g.push(["DIV",{attrs:{"class":"zm_formLne"},child:[["DIV",{attrs:{"class":"SC_lne"}}]]}],["DIV",{attrs:{"class":"zm_formFld zm_formTxt"},child:[["DIV",{attrs:{"class":"zm_formCell"},child:[["I",{attrs:{"class":"msi-uncheck",id:"selArchive",onclick:"zmfolAction.selectOption(this);"}}],["SPAN",{attrs:{id:"selArchiveText",onclick:"zmfolAction.selectOption(this);"},child:[["text",e.emptyfolderdialog.includeArchive]]}]]}]]}]);var h=["DIV",{attrs:{id:"emptyfolpopup",style:"display:none","class":"zm_formArea zm_Formflex"},child:[["DIV",{attrs:{"class":"zm_formFld zm_formTxt"},child:[["DIV",{attrs:{"class":"zm_formCell"},child:[["I",{attrs:{"class":"msi-option",id:"optionAll",onclick:"zmfolAction.selectOption(this);"}}],["SPAN",{attrs:{onclick:"zmfolAction.selectOption(this);"},child:[["text",e.emptyfolderdialog.deleteall]]}]]}]]}],["DIV",{attrs:{"class":"zm_formFld"},child:[["DIV",{attrs:{"class":"zm_formCell"},child:[["I",{attrs:{"class":"msi-unoption",id:"optionRange",onclick:"zmfolAction.selectOption(this);"}}],["SPAN",{attrs:{onclick:"zmfolAction.selectOption(this);"},child:[["text",e.emptyfolderdialog.deletebydate]]}]]}],["DIV",{attrs:{"class":"zm_formCell"},child:[["INPUT",{attrs:{"class":"SC_tiput",type:"text",id:"delDateVal",disabled:"true",d_format:zmail.userDateFormat}}]]}]]}],["DIV",{attrs:{"class":"zm_formFld"},child:[["DIV",{attrs:{"class":"zm_formCell"},child:[["I",{attrs:{"class":"msi-unoption",id:"optionCount",onclick:"zmfolAction.selectOption(this);"}}],["SPAN",{attrs:{onclick:"zmfolAction.selectOption(this);"},child:[["text",e.emptyfolderdialog.deletebycount]]}]]}],["DIV",{attrs:{"class":"zm_formCell"},child:[["INPUT",{attrs:{"class":"SC_tiput",type:"text",value:"100",id:"delMailCount",disabled:"true"}}]]}]]}],g[0],g[1]]}],j=_zm.getDOM(h);$("body").append(j),d=zmInit.findFolName(c),d=d?" - "+d:"",$("#emptyfolpopup").attr("data-id",c),f=$("#delDateVal"),f.attr("value",(new Date).getDateBy(zmail.userDateFormat)),f.attr("readonly",!0);var k=ZEVENTS(f[0]).picker("date",{dform:zmail.userDateFormat.toUpperCase(),mode:"popup"}).bind(),l={title:zdom("span",null,e.emptyfolderdialog.title+" "+d).innerHTML,style:{width:"500px"},buttons:[{txt:e.dialogMenu.ok,selected:!0,callback:function(){zmfolAction.emptyMailsFromFolder(b),zmsDialog.remove(),$("#emptyfolpopup").remove()}},{isCancel:!0,txt:e.dialogMenu.cancel,callback:function(){zmsDialog.remove(),$("#emptyfolpopup").remove()}}],drag:!0,mask:!0,hideclose:!1,pos:"center",closeaction:function(){i(),ZEVENTS.remove(k),$("#"+k._cont).remove()}};zmsDialog.create("emptyfolpopup",l)}},zmfolAction.selectOption=function(a){var b=$(a).attr("id")||$(a).prev().attr("id");b.indexOf("selArchive")!==-1&&(b="selArchive",$("#"+b).hasClass("msi-uncheck")?$("#"+b).removeClass().addClass("msi-check"):$("#"+b).removeClass().addClass("msi-uncheck")),$("#"+b).hasClass("msi-unoption")&&($("#emptyfolpopup i").each(function(a,b){($(b).hasClass("msi-option")||$(b).hasClass("msi-unoption"))&&$(b).removeClass("msi-option").addClass("msi-unoption")}),$("#"+b).removeClass("msi-unoption").addClass("msi-option"),"optionRange"===b?($("#delDateVal").attr("disabled",!1),$("#delDateVal").focus(),$("#delMailCount").attr("disabled",!0).blur()):"optionCount"===b?($("#delMailCount").attr("disabled",!1),$("#delMailCount").val("100").focus(),$("#delDateVal").unbind("click").blur(),$("#delDateVal").attr("disabled",!0)):($("#delDateVal").unbind("click").blur(),$("#delMailCount").attr("disabled",!0).blur(),$("#delDateVal").attr("disabled",!0)))},zmfolAction.emptyMailsFromFolder=function(b){var c=$("#emptyfolpopup i.msi-option").attr("id"),f=$("#emptyfolpopup #selArchive").hasClass("msi-check");if(!c||!b)return!1;var g={accId:zmail.accId,mode:"emptyfolder",folId:b},h={};if("optionRange"===c)g.selDate=h.selDate=$("#delDateVal").val();else if("optionCount"===c){var i=$("#delMailCount");g.leaveCount=h.leaveCount=i.val();var j=parseInt(g.leaveCount)||0;if(j<1)return i.val("0"),zmUtil.succErrMsg("e",e.emptyfolder.emptycount),!1}f&&(g.includeArchiveMails=!0),d[b]="0",zmAjq.XHR({u:zmail.conPath+"/folAction.do",t:"POST",fn:a.emptyFolder,p:g,csr:"s",ep:h})},zmfolAction.deleteFolder=function(a,b){if("success"===a.status){var c,d,e=a.folId,f="zmlTreeH";if(c=zmList.getRowInfo(e,f),!Object.keys(c).length)return;"-1"!==c[e].SH&&b&&b.toTrash&&(c[e].SH="-1"),d=zmail.mailLeft.getNodes()[0].getLayer(f),"move"===b?d.moveNode(c,d.mapObject,a.prefolId,a.pfolId):d.moveNode(c,d.mapObject,null,zmail.folId.tId,!0),$.publish("folder/moved",{folderID:e,toTrash:"move"!==b})}else zmUtil.succErrMsg("e",a.emsg)},zmfolAction.isValidFolder=function(b,c){var d,e=b.text(),f=c&&c.length&&c[0].id;return e=$.trim(e),"zmLTMenu_Rf"===b[0].id?d="rename":"zmLTMenu_Nf"!==b[0].id&&0!==f||(d="new"),!!a.isValidName(e,f,d)||(setTimeout(function(){b.focus()},100),!1)},zmfolAction.isValidName=function(b,c,d){var f,h,i,j,k,l=zmail.folTree[0],m=zmail.folTree[1];if(f=$.trim(b),h=f.toLowerCase(),k=d.opType||d.mode,!f.length)return zmUtil.succErrMsg("e",e.folderCreateRename.folnull,d),!1;if(zmUtil.hasSpecialChars(f,"folderName"))return zmUtil.succErrMsg("e",e.folderCreateRename.folsplchar,d),!1;if("null"===h)return zmUtil.succErrMsg("e",e.folderCreateRename.folnull,d),!1;if("inbox"===h||"drafts"===h||"draft"===h||"templates"===h||"template"===h||"sent"===h||"spam"===h||"trash"===h||"outbox"===h)return zmUtil.succErrMsg("e",e.folderCreateRename.folnameerr,d),!1;if("rename"===k){if(i=a.getParentFolderId(c),m[i]?j=m[i].CH:l[c]&&(j=l),!g(j,f,c,d))return!1}else if("new"===k){if(c){if(!m[c])return!0;j=m[c].CH}else j=l;if(!g(j,f,c,d))return!1}else if("move"===k){if(i=a.getParentFolderId(c),!m[i])return!0;if(j=m[i].CH,!g(j,f,c,d))return!1}return!0},zmfolAction.sendNewFolderReq=function(b,c){var d,e,f={};b||($("#zmLTMenu_Nf[contentEditable='true']").length?b=$.trim($("#zmLTMenu_Nf").text()):$("#zmActionNewfolder[contentEditable='true']").length&&(b=$.trim($("#zmActionNewfolder").text()))),b.length&&(e={accId:zmail.accId,mode:"add",fName:b},a.rgtFolId?(d=a.insertNewSubFolder,e.pfolId=a.rgtFolId,a.rgtFolId=""):d=a.insertNewFolder,c&&"function"==typeof c.reqDoneClbk&&(f.reqDoneClbk=c.reqDoneClbk),zmAjq.XHR({u:zmail.conPath+"/folAction.do",t:"POST",fn:d,p:e,csr:"s",ep:f}))},zmfolAction.sendFolderMoveReq=function(b){var c,d;b.prefolId!==b.srcFolId&&(b.accId=zmail.accId,b.mode="move",c=a.deleteFolder,d="move",zmAjq.XHR({u:zmail.conPath+"/folAction.do",t:"POST",fn:c,p:b,csr:"s",ep:d}))},zmfolAction.sendRenameFolderReq=function(b){var c,d;b=b||{},c=b.fName||$.trim($("#zmLTMenu_Rf").text()),c!==$("#"+a.rgtFolId).text()&&(d={accId:zmail.accId,folId:a.rgtFolId,mode:"edit",fName:c},zmAjq.XHR({u:zmail.conPath+"/folAction.do",t:"POST",fn:a.renameFolder,p:d,csr:"s"}))},zmfolAction.onDrop=function(b,c,d,e){var f,h,i,j={},k=zmail.folTree[1];for(h in c)j.srcFolId=h;for(h in d)f=h;if("inside"===e){if(j.desFolId=f,zmfolAction.getParentFolderId(j.srcFolId)===f)return!1;if(k[f]&&(i=k[f].CH,!g(i,zmInit.findFolName(j.srcFolId),j.srcFolId)))return!1}else if("header"===e)j.prefolId=m();else{if(j.prefolId=f,f===zmail.folId.iId||f===zmail.folId.dId||f===zmail.folId.teId||f===zmail.folId.sId||f===zmail.folId.spId||f===zmail.folId.tId)return!1;"-1"!==zmail.folCount[f].p&&(j.desFolId=zmail.folCount[f].p)}a.sendFolderMoveReq(j)},zmfolAction.getShortFolderPath=l,zmfolAction.getSharedFolPaths=j,zmfolAction.getSharedFolPath=k,zmfolAction.getFolderPath=function(a){if(zmUtil.isFolderId(a)){var b,c,d=zmfolAction.getMailFolderPaths(),e=d.length;for(b=0;b<e;b++)if(c=d[b],c.id===a)return c}return""};var o=function(a,b){return zmfolAction.isValidFolder(a,$("#"+zmfolAction.rgtFolId))?(b(),!0):(a.focus(),!1)};zmfolAction.newFolderMenuHandler=function(){return o(this.activeMenu.activeMenuElement,zmfolAction.sendNewFolderReq)},zmfolAction.renameFolderMenuHandler=function(){return o(this.activeMenu.activeMenuElement,zmfolAction.sendRenameFolderReq)},zmfolAction.showCreateFolderPopUp=function(b){var c,d,f,g,h,i,j,k,l,m,n="new",o="",p="",q=[],r=e.folderCreateRename.nestunder;b=b||{},g=b.mode||"new",j=zmsuite.getAppLeft().getNodes()[0].getLayer("zmlTreeH").el,l=$(".zm_compose"),m=l.offset(),h=m.left+l.width(),i=j.position().top<0?$(".zm_compose").offset().top:j.offset().top;var s=i+250-$(document.body).height();s>0&&(i-=s),"rename"===g?(f=e.folderCreateRename.editfolname,r=e.folderCreateRename.nestunder,o=zmInit.findFolName(a.rgtFolId)||"/"):"new"===g&&(f=e.folderCreateRename.Createfol),"rename"===g?k=a.getParentFolderId(a.rgtFolId):"new"===g&&(k="subfolder"===b.type?a.rgtFolId:0),q=zmfolAction.getMailFolderPaths(),q=q.filter(function(a){return a.id===k}),q.length&&(p=q[0].path),p=p||"/",c={title:f,style:{width:"200px"},posParent:{top:i,left:h},customClass:"noanim",buttons:[{txt:e.dialogMenu.save,selected:!0,callback:function(){var c,d,e={};c=$("#zm_createfolpopup").find("input:first").val(),d="new"===b.mode?k:a.getParentFolderId(a.rgtFolId),"new"!==n&&d!==n?"new"===b.mode&&(n?a.rgtFolId=n:a.rgtFolId=""):"new"===b.mode&&"new"===n&&"subfolder"!==b.type&&(a.rgtFolId=""),zmfolAction.isValidName(c,a.rgtFolId,{mode:b.mode,parElem:$("#zm_createfolpopup")[0]})&&("new"===b.mode?zmfolAction.sendNewFolderReq(c):"rename"===b.mode?a.sendRenameFolderReq({fName:c}):"move"===b.mode&&(e.srcFolId=a.rgtFolId,n&&(e.desFolId=n),a.sendFolderMoveReq(e)),zmsDialog.remove())}},{isCancel:!0,txt:e.dialogMenu.cancel,callback:function(){zmsDialog.remove()}}],closeaction:function(){$("#zm_createfolpopup").remove()},afterDisplay:function(){$("#zm_createfolpopup").find("input")[0].focus()}};var t="text",u="50",v="true",w="SC_tiput";o=_zm.escapeTags(o),d=zdom("div",{id:"zm_createfolpopup"},zdom("ul",{className:"tempFormList"},zdom("li",null,zdom("input",{type:t,maxLength:u,"data-enableshortcuts":v,className:w,value:o,placeholder:e.folderCreateRename.folname})),zdom("li",null,zdom("div",null,r),zdom("span",null,zdom("input",{type:"text",className:"SC_tiput",value:p}))))),d=$(d),"new"!==b.mode?d.find("input")[1].disabled=!0:d.find("span").click(function(a){var b,c={};zmUtil.stopEvents(a,!0),zmUtil.hideMenu(!1,!0),c.parentDOM=$(this),c.displayAs="dropdown",c.excludeList=[zmail.folId.dId,zmail.folId.teId,zmail.folId.sId,zmail.folId.tId,zmail.folId.spId,zmail.folId.oId],c.showAllItem=!0,c.showAllItemText="/",c.onSelect=function(a){var d=c.parentDOM.find("input");"all"!==a?(n=a,d[0].value=zmInit.findFolName(a)):(n=0,d[0].value="/"),b.hide()},b=zmUtil.createFLComp("folder-path",c),b.show(),b.elem.zIndex(102)}),$("#zm_createfolpopup").length||$(document.body).append(d),zmsDialog.create("zm_createfolpopup",c),$("#zmsdialog_zm_createfolpopup").mousedown(function(a){zmUtil.stopEvents(a,!0)}),$("#zmsdialog_zm_createfolpopup").click(function(){zmUtil.hideMenu(!1,!0)})},zmfolAction.archiveFolder=function(a,b){if("success"===a.status){zmsDialog.remove();var c=a.folId,d=zmUtil.getFolId(),f=zmInit.getListingDetObj(),g=!1;d===c&&zmPrev.clsPreview(),$("#archivefolpopup").remove(),"emptyArchivefolder"===b.mode?zmUtil.succErrMsg("s",zmText.applyArgs(e.archivefolder.deletearchive,{foldername:zmInit.findFolName(c)})):"unArchivefolder"===b.mode?zmUtil.succErrMsg("s",zmText.applyArgs(e.archivefolder.unarchivefol,{foldername:zmInit.findFolName(c)})):zmUtil.succErrMsg("s",zmText.applyArgs(e.archivefolder.archivefol,{foldername:zmInit.findFolName(c)})),$.publish("folder/archived",[c,a.isArchived]),"emptyArchivefolder"===b.mode&&(zmUtil.getListMap(c)?$.publish("/mail/discardFromThread",{fId:c}):zmUtil.getListMap(d)&&$.publish("/mail/discardFromThread",{fId:c,viewId:d})),"optionAll"!==b.mode&&zmUtil.removeListMap(c),f.fId===c?b.archDate||b.archCount||"unArchivefolder"===b.mode?(zmInit.reInitListing(),zmInit.setListingDetObj({}),zmInit.foldView({folId:c}),g=!0):"archive"===f.view&&"emptyArchivefolder"===b.mode?(zmInit.reInitListing(),$(zmail.mailCenter.listElem).html(zmInit.emptyRow())):"emptyArchivefolder"!==b.mode&&(zmInit.reInitListing(),$(zmail.mailCenter.listElem).html(zmInit.emptyRow()),zmail.MailPreUtils.updateCount({fId:c,mode:"upd",count:0})):"unread"!==f.view&&($.publish("/mail/listMails",{}),g=!0),g&&zmInit.getFolderTreeCount()}else zmUtil.succErrMsg("e",a.emsg)},zmfolAction.sendArchiveFolderReq=function(b){var c,d,f;if(c=b?b:a.rgtFolId,!$("#archivefolpopup").length){var g,h=zmList.getRowInfo(c,"zmlTreeH","info")||{};g=h.IA?["DIV",{attrs:{id:"archivefolpopup","class":"zm_formArea zm_Formflex"},child:[["DIV",{attrs:{"class":"zm_formFld zm_formTxt"},child:[["DIV",{attrs:{"class":"zm_formCell"},child:[["I",{attrs:{"class":"msi-option",id:"archiveAll"}}],["SPAN",{child:[["text",e.archivefolderdialog.archiveall]]}]]}]]}],["DIV",{attrs:{"class":"zm_formSubFld",id:"archiveoptions"},child:[["DIV",{attrs:{"class":"zm_formFld zm_formTxt"},child:[["DIV",{attrs:{"class":"zm_formCell"},child:[["I",{attrs:{"class":"msi-option",id:"optionAll"}}],["SPAN",{child:[["text",e.archivefolderdialog.archivefol]]}]]}]]}],["DIV",{attrs:{"class":"zm_formFld"},child:[["DIV",{attrs:{"class":"zm_formCell"},child:[["I",{attrs:{"class":"msi-unoption",id:"optionRange"}}],["SPAN",{child:[["text",e.archivefolderdialog.archivebydate]]}]]}],["DIV",{attrs:{"class":"zm_formCell"},child:[["INPUT",{attrs:{"class":"SC_tiput",type:"text",id:"delDateVal",disabled:"true",d_format:zmail.userDateFormat,readonly:"readonly"}}]]}]]}],["DIV",{attrs:{"class":"zm_formFld"},child:[["DIV",{attrs:{"class":"zm_formCell"},child:[["I",{attrs:{"class":"msi-unoption",id:"optionCount"}}],["SPAN",{child:[["text",e.archivefolderdialog.archivebycount]]}]]}],["DIV",{attrs:{"class":"zm_formCell"},child:[["INPUT",{attrs:{"class":"SC_tiput",type:"text",value:"100",id:"delMailCount",disabled:"true"}}]]}]]}]]}],["DIV",{attrs:{"class":"zm_formFld zm_formTxt"},child:[["DIV",{attrs:{"class":"zm_formCell"},child:[["I",{attrs:{"class":"msi-unoption",id:"unarchiveAll"}}],["SPAN",{child:[["text",e.archivefolderdialog.unarchiveall]]}]]}]]}],["DIV",{attrs:{"class":"zm_formFld zm_formTxt"},child:[["DIV",{attrs:{"class":"zm_formCell"},child:[["I",{attrs:{"class":"msi-unoption",id:"deleteArchives"}}],["SPAN",{child:[["text",e.archivefolderdialog.deletearchived]]}]]}]]}]]}]:["DIV",{attrs:{id:"archivefolpopup","class":"zm_formArea zm_Formflex"},child:[["DIV",{attrs:{"class":"zm_formFld zm_formTxt"},child:[["DIV",{attrs:{"class":"zm_formCell"},child:[["I",{attrs:{"class":"msi-option",id:"optionAll"}}],["SPAN",{child:[["text",e.archivefolderdialog.archivefol]]}]]}]]}],["DIV",{attrs:{"class":"zm_formFld"},child:[["DIV",{attrs:{"class":"zm_formCell"},child:[["I",{attrs:{"class":"msi-unoption",id:"optionRange"}}],["SPAN",{child:[["text",e.archivefolderdialog.archivebydate]]}]]}],["DIV",{attrs:{"class":"zm_formCell"},child:[["INPUT",{attrs:{"class":"SC_tiput",type:"text",id:"delDateVal",disabled:"true",d_format:zmail.userDateFormat,readonly:"readonly"}}]]}]]}],["DIV",{attrs:{"class":"zm_formFld"},child:[["DIV",{attrs:{"class":"zm_formCell"},child:[["I",{attrs:{"class":"msi-unoption",id:"optionCount"}}],["SPAN",{child:[["text",e.archivefolderdialog.archivebycount]]}]]}],["DIV",{attrs:{"class":"zm_formCell"},child:[["INPUT",{attrs:{"class":"SC_tiput",type:"text",value:"100",id:"delMailCount",disabled:"true"}}]]}]]}]]}];var i=_zm.getDOM(g);$("body").append(i),d=zmInit.findFolName(c),d=d?" - "+d:"",$("#archivefolpopup").attr("data-id",c),f=$("#delDateVal"),f.attr("value",(new Date).getDateBy(zmail.userDateFormat)),f.attr("readonly",!0);var j=ZEVENTS(f[0]).picker("date",{dform:zmail.userDateFormat.toUpperCase(),mode:"popup"}).bind(),k={title:zdom("span",null,e.archivefolderdialog.title+" "+d).innerHTML,style:{width:"500px"},buttons:[{txt:e.dialogMenu.ok,selected:!0,callback:function(){zmfolAction.archiveMailsFromFolder(b)}},{isCancel:!0,txt:e.dialogMenu.cancel,callback:function(){zmsDialog.remove(),$("#archivefolpopup").remove()}}],drag:!0,mask:!0,hideclose:!1,pos:"center",closeaction:function(){$("#archivefolpopup").remove(),ZEVENTS.remove(j),$("#"+j._cont).remove()}};zmsDialog.create("archivefolpopup",k),$("#archivefolpopup").off("click").on("click","i, span",function(){zmfolAction.selectArchiveOption(this,$("#archivefolpopup"))})}},zmfolAction.selectArchiveOption=function(a,b){var c=$(a).attr("id")||$(a).prev().attr("id"),d=b.find("#"+c),e=b.find("#delDateVal"),f=b.find("#delMailCount"),g=b.find("#archiveoptions"),h=b.find("#unarchiveAll"),i=b.find("#deleteArchives"),j=b.find("#archiveAll");if(g.length||(g=b),$("#"+c).hasClass("msi-unoption"))switch(c){case"optionRange":g.find("i").removeClass("msi-option").addClass("msi-unoption"),d.removeClass("msi-unoption").addClass("msi-option"),e.attr("disabled",!1),e.focus(),f.attr("disabled",!0).blur();break;case"optionCount":g.find("i").removeClass("msi-option").addClass("msi-unoption"),d.removeClass("msi-unoption").addClass("msi-option"),f.attr("disabled",!1),f.val("100").focus(),e.unbind("click").blur(),e.attr("disabled",!0);break;case"optionAll":g.find("i").removeClass("msi-option").addClass("msi-unoption"),d.removeClass("msi-unoption").addClass("msi-option"),e.unbind("click").blur(),f.attr("disabled",!0).blur(),e.attr("disabled",!0);break;case"archiveAll":g.slideDown(),h.removeClass("msi-option").addClass("msi-unoption"),i.removeClass("msi-option").addClass("msi-unoption"),d.removeClass("msi-unoption").addClass("msi-option");break;case"unarchiveAll":g.slideUp(),j.removeClass("msi-option").addClass("msi-unoption"),i.removeClass("msi-option").addClass("msi-unoption"),d.removeClass("msi-unoption").addClass("msi-option");break;case"deleteArchives":g.slideUp(),j.removeClass("msi-option").addClass("msi-unoption"),h.removeClass("msi-option").addClass("msi-unoption"),d.removeClass("msi-unoption").addClass("msi-option")}},zmfolAction.archiveMailsFromFolder=function(b){var c=$("#archivefolpopup i.msi-option");if(c=c.length>1?"archiveAll"===c[0].id?$("#archiveoptions i.msi-option").attr("id"):c[1].id:$("#archivefolpopup i.msi-option").attr("id"),!c||!b)return!1;var d=function(a,b){a&&b&&("unArchivefolder"===b.mode&&"Error while empty spam folder (Internal Error occurs)"===a?zmUtil.succErrMsg("e",e.archivefolder.errormessage):"emptyArchivefolder"===b.mode&&"Error while empty spam folder (Internal Error occurs)"===a&&zmUtil.succErrMsg("e",e.archivefolder.errormessage))},f={accId:zmail.accId,mode:"archivefolder",folId:b},g={};switch(c){case"optionRange":f.archDate=g.archDate=$("#delDateVal").val();break;case"optionCount":var h=$("#delMailCount"),i=h.val()||0;if(i=parseInt(i),f.archCount=g.archCount=i,i<1)return h.val("0"),zmUtil.succErrMsg("e",e.archivefolder.emptycount),!1;break;case"archiveAll":case"optionAll":g.mode="optionAll";break;case"unarchiveAll":f.mode=g.mode="unArchivefolder";break;case"deleteArchives":f.mode=g.mode="emptyArchivefolder"}zmAjq.XHR({u:zmail.conPath+"/folAction.do",t:"POST",fn:a.archiveFolder,p:f,csr:"s",ep:g,efn:d}),zmsDialog.remove()};var p=function(a,b){var c,d=$.Deferred();return a?("string"==typeof a&&(a=[a]),c=b?"addFoldersToSuppressList":"removeFoldersFromSuppressList",zmAjq.XHR({u:zmail.conPath+"/mailNotification.do",t:"POST",fn:function(){zmInit.updateSuppressedFolders(a,b),d.resolve()},p:{mode:c,accId:zmail.accId,folderIds:a.join(",")},csr:"s",efn:function(){d.reject()}}).fail(function(){d.reject()})):d.reject(),d.promise()};return zmfolAction.suppressNotification=function(a){return p(a,!0)},zmfolAction.allowNotification=function(a){return p(a,!1)},zmfolAction.handleWMSEvents=function(a,d,e){var f,g,i,j,k,l,m,n=Date.now();if(k=zmail.isWSEnabled?["EMPTY_FOLDER","FOLDER_READ","ADD_FOLDER","DELETE_FOLDER","MOVE_FOLDER","RENAME_FOLDER"]:["addFolder","renameFolder","moveFolder","deleteFolder","emptyFolder","folderRead"],k.indexOf(a)!==-1)switch(i=e.FD&&"null"!==e.FD?e.FD:"",g=e.PID&&"null"!==e.PID?e.PID:"",f=e.PREVID&&"null"!==e.PREVID?e.PREVID:"",j=e.FN||"",l={prefolId:f,pfolId:g,folId:i,fName:j,status:"success"},a){case"addFolder":case"ADD_FOLDER":(g?zmfolAction.insertNewSubFolder:zmfolAction.insertNewFolder)(l);break;case"renameFolder":case"RENAME_FOLDER":zmfolAction.renameFolder(l);break;case"deleteFolder":case"DELETE_FOLDER":zmfolAction.isDeletedFolder(i)||zmfolAction.deleteFolder(l,"delete");break;case"moveFolder":case"MOVE_FOLDER":zmfolAction.getParentFolderId(i)!==g&&zmfolAction.deleteFolder(l,"move");break;case"folderRead":case"FOLDER_READ":if(b[i]&&(m=n-b[i],m<=2e3))return;h(l,{});break;case"emptyFolder":case"EMPTY_FOLDER":if(c[i]&&(m=n-c[i],m<=2e3))return;zmfolAction.emptyFolder(l,{},!0)}},zmfolAction.updateFolProps=function(a){var b,c=a.mode,d=a.FD;"updateSortOption"===c&&(b=a.SMIF,zmfolAction.updateFolSortType(d,b))},zmfolAction}(zmfolAction||{}),function(){var a=zmail.Core.Namespaces,b=zmText.get("zmFolder").leftTree,c=a.create("zmail.Folder.EventHandlers");c.allowFolderOperation=function(a){var b=!0;if(!a)return!1;for(var c in zmail.folId)if(zmail.folId[c]===a){b=!1;break}return b},c.nwFolContextMenu=function(){var a=$("#zmLTMenu_Nf"),b=zmfolAction.rgtFolId;zmUtil.setEditable({ele:a,target:$("#"+b),callback:zmUtil.hideMenu,allowCondition:function(){return zmail.folId.iId===b||"zmlTreeH"===b,!0},parentdiv:$("#zmCntxtMenu"),hideMenu:zmUtil.hideMenu}),$.publish("/mail/activeMenu",[{activeMenuElement:a,activeMenuHandler:zmfolAction.newFolderMenuHandler}])},c.rnFolContextMenu=function(){var a=zmfolAction.rgtFolId,b=c.allowFolderOperation(a),d=$("#zmLTMenu_Rf");zmUtil.setEditable({ele:d,target:$("#"+a),callback:zmUtil.hideMenu,initialize:!0,allowCondition:function(){return!(!a||zmfolAction.getParentFolderId(a)===zmail.folId.tId)&&b},parentdiv:$("#zmCntxtMenu"),hideMenu:zmUtil.hideMenu}),$.publish("/mail/activeMenu",[{activeMenuElement:d,activeMenuHandler:zmfolAction.renameFolderMenuHandler}])},c.delFolContextMenu=function(){var a=zmfolAction.rgtFolId,d="delete",e=c.allowFolderOperation(a);if(!e||!a)return void zmUtil.hideMenu(!0);zmfolAction.isDeletedFolder(a)&&(d="deleteTrashFolder");var f;f=zmail.folTree[1][a]?"deleteTrashFolder"===d?b.emptyfolconfmsg.perDelWitSubFol:b.emptyfolconfmsg.delWithSubFol:"deleteTrashFolder"===d?b.emptyfolconfmsg.permanentDel:b.emptyfolconfmsg.delFol,zmsDialog.confirm(zmText.applyArgs(f,{foldername:'"'+zmInit.findFolName(a)+'"'}),{onOk:function(){var b=zmfolAction.deleteFolder,c={accId:zmail.accId,mode:d,folId:a};"deleteTrashFolder"===d&&(b=zmfolAction.deleteTrashFolder),zmAjq.XHR({u:zmail.conPath+"/folAction.do",t:"POST",fn:b,p:c,ep:{toTrash:"delete"===d?1:0,mode:d},csr:"s"})}}),$("#zmCntxtMenu").hide()},c.mrkReadContextMenu=function(){var a=zmfolAction.rgtFolId;return a?void zmfolAction.markAsReadFolder(a):void zmUtil.hideMenu(!0)},c.emptyFolContextMenu=function(a){var c,d=a||zmfolAction.rgtFolId;return d!==zmail.folId.dId&&d!==zmail.folId.teId&&d!==zmail.folId.oId&&(d===zmail.folId.spId?zmsDialog.confirm(b.emptyfolconfmsg.spammsg,{onOk:function(){c={accId:zmail.accId,mode:"emptyspam",folId:d},zmAjq.XHR({u:zmail.conPath+"/folAction.do",t:"POST",fn:zmfolAction.emptyFolder,p:c,csr:"s"})}}):d===zmail.folId.tId?zmsDialog.confirm(b.emptyfolconfmsg.trashmsg,{onOk:function(){c={accId:zmail.accId,mode:"emptytrash",folId:d},zmAjq.XHR({u:zmail.conPath+"/folAction.do",t:"POST",fn:zmfolAction.emptyFolder,p:c,csr:"s"})}}):d===zmail.folId.sId?zmsDialog.confirm(b.emptyfolconfmsg.sentmsg,{onOk:function(){c={accId:zmail.accId,mode:"emptysent",folId:d},zmAjq.XHR({u:zmail.conPath+"/folAction.do",t:"POST",fn:zmfolAction.emptyFolder,p:c,csr:"s"})}}):zmfolAction.sendEmptyFolderReq(d),void zmUtil.hideMenu(!0))},c.archiveFolderContextMenu=function(a){var b=a||zmfolAction.rgtFolId;b===zmail.folId.dId||b===zmail.folId.teId||b===zmail.folId.spId||b===zmail.folId.oId||b===zmail.folId.tId||zmfolAction.isDeletedFolder(b)||zmfolAction.sendArchiveFolderReq(b)},c.markFolderAsReadHandler=function(a,b){b=b||[];var c,d,e,f,g,h,i=0!==b.length,j=zmInit.getListingDetObj(),k="unread"===j.view,l=!1,m=[],n=[],o={action:"read"};if(i||(f=j.flag&&"flag"||j.view||j.label,b=zmUtil.getListMap(f,"MO")||[]),g=b.length){for(h=0;h<g;h++){if(c=zmList.getMailObj(b[h]),!i&&(c.TH||k&&c.FD===a)){l=!0;break}a===c.FD&&(c.TH?n.push(c.M):m.push(c.M))}l?(d="unread"===j.view?"zm_unread":"",f=j.label&&"label"||f,e=j.label||j.flag,zmCache.clearListObj(),zmInit.setListingDetObj({}),zmInit.foldView({folId:d,view:f,viewId:e,reInitialize:!0})):(0===zmUtil.getMLConversionValue()?(m=m.concat(n),o.mailId=m):(o.mailId=m,o.tmailId=n),zmail.MailAction.Initializer.rapplyActions({result:"success"},o))}},c.markFolderAsArchived=function(a,b){if(a){var c;zmUtil.isFolderId(a)&&(c=zmList.getRowInfo(a,"zmlTreeH","info")),c&&(b?c.IA=parseInt(b):c.IA=1)}}}();