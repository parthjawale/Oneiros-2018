"use strict";!function(){window.zmMailCollab=window.zmMailCollab||{};var a=window.zmMailCollab,b=!1,c=function(){var a=zmAdHocSettings.getSuppressedMessagesState();return"on"===a.conversationShareWarning},d=function(a,b){return zmText.get("mailCollaboration",a,b)},e=function(a){var b=zmMailCollab.Util,e=b.DeferredCollection,f=zmMailCollab.Backend;a=a||{};var g=["interface","createCommentEntity",a.mailID,a.shareConversation,a.useConversation,a.inviteRecipients,a.lockInvites].join("_"),h=["deferred",g].join("_"),i=e.get(h);if(a.mailID&&a.hasOwnProperty("shareConversation")&&a.hasOwnProperty("useConversation")&&a.hasOwnProperty("inviteRecipients")&&a.inviteesList)if(a.inviteRecipients||a.inviteesList.length){var j=zmMailCollab.Components.ConversationShareAlertDialog.create({senderList:a.senderList,mailCount:a.mailCount}),k=function(){f.createCommentEntity(a).done(function(a){a=a||{},a.success=!0,i.resolve(a)}).fail(function(a){i.reject({success:!1,error:{code:3,message:["Request failed",a].join(". ")}})})};!c()||1===a.mailCount||!a.shareConversation||a.mailList&&a.mailList.length?k():j.show().done(function(){k()}).fail(function(){i.reject({success:!1,error:{code:4,message:["User cancelled share"].join(""),suppress:!0}})})}else{var l=d,m=l("labels.mail");a.isDraftShare?m=l("labels.draft"):a.useConversation&&a.shareConversation&&(m=l("labels.conversation"));var n=l("messages.noMentionsError",{shareItemType:m});i.reject({success:!1,error:{code:2,message:n}})}else i.reject({success:!1,error:{code:1,message:"Invalid data"}});return i.done(function(b){b=b||{};var c=zmMailCollab.Event,d=zmMailCollab.EventConstants;c.publish(d.COMMENT_ENTITY_CREATED,{mailID:a.mailID,useConversation:a.useConversation,conversationID:b.conversationID,inviteesList:a.inviteesList,lockInvites:a.lockInvites,data:b})}),i.promise()},f=function(){return zmail.zuid},g=function(){return zmail.accId},h=function(){return document.body},i=function(){var a=zmAdHocSettings.getSuppressedMessagesState();return a.mailShareTip="off",zmAdHocSettings.setSuppressedMessagesState(a)},j=function(){var a=zmAdHocSettings.getSuppressedMessagesState();return a.conversationShareWarning="off",zmAdHocSettings.setSuppressedMessagesState(a)},k=function(){return zmAdHocSettings.getSuppressedMessagesState().mailShareTip},l=function(){return zmsDialog.remove()},m=function(a,b){return zmsDialog.create(a,b)},n=function(){return zmsDialog.isOpen()},o=function(a){return zmsDialog.listenOnceDialogClose(a)},p=function(a,b){return zmStreamsApp.CommentModule.init(a,$(b))},q=function(a){return zmStreamsApp.PostActions.init(a)},r=function(a){return zmComponent.loadingBand(a)},s=function(){return $},t=function(){return zmUtil.requireStreamsComments()},u=function(a){return zmUtil.isZohoAccount(a)},v=function(){return b},w=function(){return zmUtil.isChildWindow()},x=function(a){return[zmail.folId.oId,zmail.folId.dId,zmail.folId.teId].indexOf(a)!==-1},y=function(a){return zmail.shrTree[0]&&zmail.shrTree[0][a]},z=function(){return zmTab.currentTab},A=function(){var a=s();return a(zmsuite.getCenter()[0].$el)},B=function(){return window},C=function(){var a=Array.prototype.slice.apply(arguments);return zmUtil.debugLog.apply(zmUtil.debugLog,a)},D=function(a){return zmAjq.XHR(a)},E=function(){return zmail.conPath},F=function(a,b,c){return _zm.succErrMsg(a,b,c)},G=function(a){zmsuite.isWorkspaceAvailable(a)&&zmTab.currentTab!==a&&zmsuite.showWorkSpace(a)},H=function(){return zmUtil.getMLConversionValue()<2},I=function(){var a={0:"SINGLE_MAILS",1:"FOLDER_MAILS",2:"ALL_MAILS"};return a[zmUtil.getMLConversionValue()]},J=function(a){return a=a||"",zmUtil.replaceHTMLEntities(a)},K=function(){return zmail.collabVersion},L=function(a,b){setTimeout(a,b)},M=function(a){return zmUtil.getMailObj(a)||{}},N=function(a){return zmUtil.getFolderObject(a)},O=function(a){var b={},c=zmail.aInfo||{},d=(zmail.fromAddr||"").trim().toLowerCase();if(a=(a||"").trim().toLowerCase(),!a)return!1;for(var e in c){var f=(c[e].mailId||"").trim().toLowerCase();f&&(b[f]=!0)}return d&&(b[d]=!0),"undefined"!=typeof b[a]},P=function(){b=zmail.isOrg};return a.Interface={},a.Interface.Internal={createCommentEntity:e,getCurrentZUID:f,getCurrentAccountID:g,getDocumentBody:h,turnOffMailShareTip:i,isShareWarningActive:c,turnOffShareWarning:j,removeDialog:l,createDialog:m,isDialogOpen:n,listenOnceDialogClose:o,createStreamsCommentComponent:p,createStreamsPostActionComponent:q,createLoadingBand:r,getJQuery:s,getMailShareTipState:k,loadStreamsModule:t,isZohoAccount:u,isOrgAccount:v,isPopupWindow:w,isShareRestrictedFolder:x,isSharedFolder:y,getCurrentTabID:z,getCurrentAppContainer:A,getCurrentWindow:B,logConsole:C,createZMAjaxRequest:D,getContextPath:E,showZMSuccessErrorMessage:F,switchToApp:G,isPartialConversationView:H,getCurrentConversationViewType:I,replaceHTMLEntities:J,getCollabVersion:K,invokeAfter:L,getMailMetaData:M,getFolderData:N,isCurrentUserEmail:O,getI18N:d},P(),a}(),function(){window.zmMailCollab=window.zmMailCollab||{};var a=window.zmMailCollab,b=zmMailCollab.Interface.Internal,c=b.getJQuery(),d=function(){var a=zmMailCollab.Event,c=zmMailCollab.EventConstants,d=Array.prototype.slice.apply(arguments);d.unshift("zmMailCollab"),b.logConsole.apply(b.logConsole,d),a.publish(c.MAILSHAREDATA_LOG,d)},e=function(a){return"undefined"!=typeof a&&a.constructor===Array},f=function(a){return"undefined"!=typeof a&&("object"===("undefined"==typeof a?"undefined":babelHelpers["typeof"](a))&&a instanceof Object&&!(a instanceof Array))},g=function(a){return!a||!f(a)&&!e(a)},h=function(a,b){return c.extend(b,a)},i=function(a,b){return a.hasOwnProperty(b)},j=function(a){return"undefined"!=typeof a&&a.constructor===Function},k=function(a){a=a||{};var e;return a.accountID=a.accountID||b.getCurrentAccountID(),b.isZohoAccount(a.accountID)?a.folderID&&b.isShareRestrictedFolder(a.folderID)?(d("SHARING_INVALID","O/D/T_MAIL"),!1):a.folderID&&b.isSharedFolder(a.folderID)?(d("SHARING_INVALID","UR_SF_MAIL"),!1):a.folderData&&"undefined"!=typeof a.folderData.SH&&"-1"!==a.folderData.SH?(d("SHARING_INVALID","EXT_SF_MAIL"),!1):(a.containerDOM&&(a.containerDOM=c(a.containerDOM)),a.containerDOM&&(e=!(a.containerDOM.hasClass("SCS_postMail")||a.containerDOM.parent(".SCS_postMail").length>0),!e)?(d("SHARING_INVALID","NOTIF_OPEN_MAIL"),!1):"notification-popout"!==a.openedBy&&(zmUtil.isChildWindow()||"zm_stream"!==b.getCurrentTabID()&&"zmStreamsApp"!==b.getCurrentTabID()?!zmUtil.isChildWindow()&&b.getCurrentAppContainer().hasClass("zms_streams")?(d("SHARING_INVALID","STREAMS_LIST_MAIL"),!1):!(a.containerDOM&&!a.suppressComponentCheck&&!(e=0===a.containerDOM.find(".SCS_cmnt").length))||(d("SHARING_INVALID","CMTBX_AVAIL"),!1):(d("SHARING_INVALID","STREAMS_MAIL"),!1))):(d("SHARING_INVALID","NON_ZOHO_ACCOUNT"),!1)},l=function(a,b,c){var d="",e="",g="";if(f(a)){j(b)||(b=function(b){return a[b]}),j(c)||(c=function(b,c){a[b]=c});var h=function(a){return function(){var c=this,d=Array.prototype.slice.apply(arguments);return d.unshift(a),b.apply(c,d)}},i=function(a){return function(){var b=this,d=Array.prototype.slice.apply(arguments);return d.unshift(a),c.apply(b,d)}};for(var k in a)a.hasOwnProperty(k)&&(d=k.charAt(0).toUpperCase()+k.substr(1),e="get"+d,g="set"+d,a[e]=h(k),a[g]=i(k))}},m=function(){var a={},b=function(b){return function(){a[b]=void 0,delete a[b]}},d=function(d){var e;return a[d]?e=a[d]:(e=c.Deferred(),a[d]=e,e.always(b(d))),e},e=function(b){return"undefined"!=typeof a[b]};return{get:d,has:e}}(),n=function(a){a=a||{};var c=a.requestID||"ajaxpostreq_"+Date.now(),e=!m.has(c),f=m.get(c);if(e){var g=_zm.copyOf(a.data);"getMailShareData"!==g.mode&&(g.streamsView=!0);var h=b.createZMAjaxRequest({u:b.getContextPath()+a.url,p:g,t:"post",fn:function(a){f.resolve({state:"success",response:a})},efn:function(){d("Ajax request failed",arguments),f.reject({state:"fail",reason:"Request failed"})}});f.ajaxInstance=h}return f.promise()},o=function(a,c){b.showZMSuccessErrorMessage(c.type,a,c)},p=function(a,b){b=b||{},b.type="s",o(a,b)},q=function(a,b){b=b||{},b.type="e",o(a,b)},r=function(a){var c=0,d={},e={},f=[];return a=a||[],a.forEach(function(a){if(a=a||{},a.M&&!b.isShareRestrictedFolder(a.FD)){e[a.M]=a.R;var g=(a.F||"").trim(),h=(a.SN||"").trim(),i=[];h?(i.push(h),g&&i.push("<"+g+">")):g&&i.push(g),i=(i.join(" ")||"").trim(),i&&(d[i]=""),c+=1,f.push(a.M)}}),d=Object.keys(d),{mailCount:c,senderList:d,mailReceiveTime:e,mailIds:f}},s=function(a,b){for(var c=b.mailIds,d=[],e=0;e<c.length;e++)a.indexOf(c[e])!==-1&&d.push(c[e]);return d},t=function(a,c){return b.getI18N(a,c)},u=function(a){a&&(zmUtil.getMailObj(a)&&"undefined"!=typeof zmCache&&(zmCache.updateObj({mode:"upd",msgId:a,key:"CT",val:1}),d("Update Mail Listing Object")),zmUtil.isChildWindow()&&opener.zmail&&opener.zmCache&&opener.zmCache.updateObj({mode:"upd",msgId:a,key:"CT",val:1}))},v=function(){return zmUtil.isSelectedShareEnabled()},w=function(a){if(a||v){var b=$(a).find(".SC_Twpr");b.length&&$(b).css("bottom")&&$(b).css("bottom","0px")}},x=function(a,b){var c=0===b.getOpenedBy()&&zmPrev.isEntityOpenedInPreview(b.mailID,b.getOpenedTab())||0!==b.getOpenedBy();return c},y=function(a){var b=zmMailCollab.Collection.MailShareData.get(a);if(!$.isEmptyObject(b)){var c=b.getRecipientList(),d=$.isEmptyObject(c)?[]:b.getRecipientList()[0].orgUsers;return d}return[]},z=function(a){var b=!1;return a&&(b=a.openedTab.indexOf("zm_srch")!==-1),zmUtil.isChildWindow()&&zmail.mailDataObj&&zmail.mailDataObj.thdId?b=zmail.showFullConv:b||(b=0===zmUtil.getMLConversionValue(a.folderID)),b},A=function(a){return zmUtil.isChildWindow()?"":a||zmTab.currentTab},B=function(){return zmUtil.hideCommentBox()};return a.Util={isObject:f,isArray:e,isPrimitive:g,isFunction:j,copyOf:h,isOwnProperty:i,makeGetSetAPI:l,log:d,isSharingValid:k,DeferredCollection:m,ajaxPostRequest:n,showSuccessMessage:p,showErrorMessage:q,parseConversationData:r,getI18N:t,updateMailCache:u,isNewCollabUser:v,sortMailIds:s,resetBottom:w,getRecipients:y,isValidContainer:x,getCurrentTab:A,isConversationFalse:z,isCommentBoxHidden:B},a}(),function(){window.zmMailCollab=window.zmMailCollab||{};var a=window.zmMailCollab,b=zmMailCollab.Util,c=zmMailCollab.Interface.Internal.getJQuery(),d="/mail/collab/",e={MAILSHAREDATA_LOG:"log",MAILSHAREDATA_PROPERTY_CHANGED:"sharedata/property/changed",MAILSHAREDATA_INSTANCE_CREATED:"sharedata/instance/created",COLLABCOMPONENT_INSTANCE_CREATED:"component/instance/created",COLLABCOMPONENT_INSTANCE_DATA_SET:"component/instance/dataset",COLLABCOMPONENT_INSTANCE_RESIZE:"component/instance/resize",COMMENT_ENTITY_CREATED:"comment/entity/created",COLLABCOMPONENTCONTAINER_PROPERTY_CHANGED:"collabcontainer/property/changed",COLLECTION_COLLABCOMPONENT_INSTANCE_REMOVED:"collabcontainercollection/instance/removed",MAILSHAREDATA_SELECTMAIL:"/mail/selectMail",EXTERNAL_MAIL_FORWARD_EVENT:"/mail/forwardmail",EXTERNAL_COMPOSE_BCC_EVENT:"/compose/bccpresent",EXTERNAL_MAIL_OPENING_EVENT:"/mail/openingincontainer",EXTERNAL_MAIL_OPENED_EVENT:"/mail/openedincontainer",EXTERNAL_MAIL_VIEW_FOCUSCOMMENT:"/mail/view/focuscommentbox",EXTERNAL_MAILCOLLAB_SHARE_STATUS:"/mail/collab/share/status",EXTERNAL_MAIL_PREVIEW_UPDATE_SHARE:"/mail/preview/updateshare",EXTERNAL_MAIL_PREVIEW_UPDATE_SHAREICON:"/mail/collab/updateshareicon",EXTERNAL_DRAFT_OPENED_EVENT:"/draft/openedincompose",EXTERNAL_DRAFT_OPENING_EVENT:"/draft/openingincompose",EXTERNAL_DRAFT_COMMENT_CONSTRUCT_EVENT:"/draft/openCommentRHS",EXTERNAL_DRAFT_NOTIFY_UPDATES_EVENT:"/draft/sharing/notifyupdates",EXTERNAL_MAIL_CLOSE_PREVIEW:"/mail/previewclosed",EXTERNAL_MAIL_CHANGE_PREVIEW:"mail/preview/unload",EXTERNAL_COMMENT_COMPONENT_RESIZE:"zmstreamsapp/keyevent",EXTERNAL_MAIL_THREAD_CREATED:"mail/threadCreated"},f=function(){var a=function(a,b){c.publish(d+a,b)},b=function(a,b){c.subscribe(d+a,b)},e=function(a,b){c.unsubscribe(d+a,b)};return{publish:a,subscribe:b,unsubscribe:e}}();return a.Event=f,a.EventConstants=b.copyOf(e,{}),a}(),function(){function a(a){a=a||{},this.mailID=a.mailID||void 0,this.useConversation=a.useConversation||!1,this.conversationID=a.conversationID||void 0,this.folderID=a.folderID||void 0,this.commentValue=a.commentValue,this.commentData=a.commentData||{},this.commentData.comments=this.commentData.comments||{},this.commentData.order=this.commentData.order||[],this.isDraftShare=a.isDraftShare||!1,this.likeList=a.likeList||[],this.inviteeList=a.inviteeList||[],this.lockInvites=a.lockInvites,this.entityExists=!1,this.sharedUptoTime=void 0,this.sharedMailIds=[],this.conversationData=a.conversationData||{},this.conversationData.mailCount=this.conversationData.mailCount||1,this.conversationData.senderList=this.conversationData.senderList||[],this.conversationData.mailReceiveTime=this.conversationData.mailReceiveTime||{},this.recipientList=[],this.openedBy=a.openType,this.openedTab=a.openedTab}function b(a){a=a||{},this.mailID=a.mailID||"",this.useConversation=a.useConversation||!1,this.conversationID=a.conversationID||"",this.containerDOM=a.containerDOM,this.component=a.component,this.updateOperationPending=a.updateOperationPending||!1}window.zmMailCollab=window.zmMailCollab||{};var c=window.zmMailCollab,d=zmMailCollab.Interface.Internal,e=function(a,b){var c=zmMailCollab.Util,e=zmMailCollab.Backend;b=b||{};var f=c.DeferredCollection.get("initMailShareData_"+a.mailID+"_"+a.useConversation),g=function(){e.getMailShareData({mailID:a.mailID,useConversation:a.useConversation,commentValue:a.commentValue,isDraftShare:a.isDraftShare,requiredData:["commentData","lastReceiveTime","likesList","inviteesList","conversationData","recipientList"]}).done(function(b){b=b||{},a.setLockInvites(b.lockInvites),a.setMailID(b.mailID||""),a.setUseConversation(b.useConversation||!1),a.setConversationID(b.conversationID),a.setFolderID(b.folderID),b.sharedMailIds&&a.setSharedMailIds(b.sharedMailIds),a.setRecipientList(b.recipientList),b.commentData=b.commentData||{};var d={comments:b.commentData.comments||{},order:b.commentData.order||[],totalCount:parseInt(b.commentData.totalCommentCount)||0};a.setCommentData(d),b.likesList=b.likesList||[],a.setLikeList(b.likesList),b.inviteesList=b.inviteesList||[],a.setInviteeList(b.inviteesList),a.setConversationData(c.parseConversationData(b.conversationData)),void 0===b.lastReceiveTime&&b.useConversation===!1&&b.entityExists&&(b.lastReceiveTime=a.conversationData.mailReceiveTime[b.mailID]),a.setSharedUptoTime(b.lastReceiveTime),a.setEntityExists(b.entityExists),f.resolve({instance:a})}).fail(function(){f.reject()})};return b.delay?d.invokeAfter(function(){b.cancel?f.reject({suppressError:!0}):g()},b.delay):g(),f.promise()},f=function(b){var c=zmMailCollab.Util,d=zmMailCollab.Event,f=zmMailCollab.EventConstants;b=b||{};var g,h=new a(b),i={},j=function(a){var b=zmMailCollab.Util,c=this,d=c[a];if(!b.isOwnProperty(c,a))throw new Error("No such property");return b.isArray(d)?b.copyOf(d,[]):b.isObject(d)?b.copyOf(d,{}):d},k=function(a,b,c){var e=zmMailCollab.Util,g=this,h=b,i=j.apply(g,[a]);if(c=c||{},!e.isOwnProperty(g,a))throw new Error("No such property");return e.isArray(b)&&(h=e.copyOf(b,[])),e.isObject(b)&&(h=e.copyOf(b,{})),g[a]=h,b===i&&(c.suppress=!0),d.publish(f.MAILSHAREDATA_PROPERTY_CHANGED,{instance:g,property:a,oldValue:i,value:b}),b};return c.makeGetSetAPI(h,j,k),h.initialize=function(a){return i=c.copyOf(a,i),g||(g=e(h,i)),g},h.abortInit=function(){if(g)switch(g.state()){case"pending":i.cancel=!0,g.fail(function(){i={}});break;case"rejected":i={},g=void 0}},h},g=function(a){var c=zmMailCollab.Util;a=a||{};var d=new b(a),e=function(a,b,c){var d=zmMailCollab.Util,e=zmMailCollab.Event,f=zmMailCollab.EventConstants,g=this,h=b,i=g[a];if(c=c||{},!d.isOwnProperty(g,a))throw new Error("No such property");return g[a]=h,e.publish(f.COLLABCOMPONENTCONTAINER_PROPERTY_CHANGED,{instance:g,property:a,oldValue:i,value:b,suppress:c.suppress||!1}),b};return c.makeGetSetAPI(d,void 0,e),d},h=function(){var a=zmMailCollab.Util,b=[],c=function(c,d,e){var f,g,h;if(!c||"undefined"==typeof d)return a.log("mailsharedatacollection.finditem","invalid params"),{index:-1};if(d===!0&&"undefined"==typeof e)return a.log("mailsharedatacollection.finditem","invalid params"),{index:-1};for(f=0,g=b.length;f<g;f++){h=b[f];var i=!1;if(d&&e&&h.conversationID===e&&h.conversationData.mailIds&&h.conversationData.mailIds.indexOf(c)?i=!0:h.mailID===c&&(i=!0),i)return{index:f,instance:h}}return{index:-1}},d=function(a){return a=a||{},c(a.mailID,a.useConversation,a.conversationID).index!==-1},e=function(a){var b=zmMailCollab.Util;return d(a)?c(a.mailID,a.useConversation,a.conversationID).instance:void b.log("mailsharedatacollection.getitem","Instance not found")},f=function(a){var d=c(a.mailID,a.useConversation,a.conversationID);return d.index!==-1&&(b.splice(d.index,1),!0)},g=function(a,c){var e=zmMailCollab.Util;if(c=c||{},c.overwrite)f(a);else if(d({mailID:a.mailID,useConversation:a.useConversation}))return e.log("mailsharedatacollection.putitem","Instance already added"),!1;return b.push(a),!0};return{get:e,put:g,has:d,remove:f,collection:b}}(),i=function(){var a=[],b=function(b){b=b||{};var c=[];return a.forEach(function(a){a.getContainerDOM()===b.containerDOM&&c.push(a)}),c},c=function(b){b=b||{};var c=[];return a.forEach(function(a){var d=!1;b.useConversation&&b.conversationID===a.getConversationID()?d=!0:b.mailID===a.getMailID()&&(d=!0),d&&c.push(a)}),c},d=function(b){return a.push(b),!0},e=function(b){var c=zmMailCollab.Event,d=zmMailCollab.EventConstants,e=0;return a.forEach(function(f){return f===b?(a.splice(e,1),c.publish(d.COLLECTION_COLLABCOMPONENT_INSTANCE_REMOVED,{instance:b}),!0):void e++}),!1};return{getWithDOM:b,getWithData:c,put:d,remove:e,removeAll:function(a){a=a||[];var b=0;return a.forEach(function(a){b+=e(a)?1:0}),b},collection:a}}(),j=function(a,b){b=b||{};var c;if(c=h.get({mailID:b.mailID,useConversation:b.useConversation,conversationID:b.conversationID})){var e=b.data||{},f=b.inviteesList;e.conversationID&&c.setConversationID(e.conversationID),e.folderID&&c.setFolderID(e.folderID),e.inviteeList&&Object.keys(e.inviteeList).length||(e.inviteeList={},f.forEach(function(a){e.inviteeList[a]=d.getCurrentZUID()})),c.setInviteeList(e.inviteeList),e.hasOwnProperty("useConversation")&&c.setUseConversation(e.useConversation),e.useConversation||b.conversationID||c.setSharedMailIds(b.mailID),e.sharedMailIds&&c.setSharedMailIds(e.sharedMailIds),e.lastReceiveTime&&c.setSharedUptoTime(e.lastReceiveTime),c.setEntityExists(!0)}},k=function(a,b){b=b||{};var c=-1,d=zmMailCollab.Collection.CollabContainer;if(c=["mailID","conversationID","useConversation"].indexOf(b.property),c!==-1){var e=b.instance,f={};f.mailID=0===c?b.oldValue:e.getMailID(),f.conversationID=1===c?b.oldValue:e.getConversationID(),f.useConversation=2===c?b.oldValue:e.getUseConversation();var g=d.getWithData(f)||[];g.forEach(function(a){a.setMailID(e.getMailID()),a.setConversationID(e.getConversationID()),a.setUseConversation(e.getUseConversation())})}},l=function(a,b){b=b||{};var c=b.instance;if("sharedUptoTime"!==b.property&&c.entityExists&&void 0===c.sharedUptoTime&&c.useConversation===!1){var d=c.conversationData.mailReceiveTime[c.mailID];c.setSharedUptoTime(d)}},m=function(){var a=zmMailCollab.Event,b=zmMailCollab.EventConstants;a.subscribe(b.COMMENT_ENTITY_CREATED,j),a.subscribe(b.MAILSHAREDATA_PROPERTY_CHANGED,k),a.subscribe(b.MAILSHAREDATA_PROPERTY_CHANGED,l)},n=function(){return m(),c.Model={MailShareData:{create:f},CollabContainer:{create:g}},c.Collection={MailShareData:h,CollabContainer:i},c};return n()}(),function(){window.zmMailCollab=window.zmMailCollab||{};var a=window.zmMailCollab,b="/mailCollab.do",c=zmMailCollab.Util,d=zmMailCollab.Util.DeferredCollection,e=zmMailCollab.Interface.Internal,f=function(a){a=a||{};var f=["getMailShareData",a.mailID,a.useConversation,a.requiredData.join("_")].join("_"),g=["deferred",f].join("_"),h=!d.has(g),i=d.get(g);if(h){var j={mode:"getMailShareData",mailID:a.mailID,useConversation:a.useConversation,zohoID:e.getCurrentZUID(),accountID:e.getCurrentAccountID(),requiredData:a.requiredData.join(",")};a.conversationID&&(j.conversationID=a.conversationID),a.commentValue||a.conversationID||a.useConversation||a.isDraftShare?c.ajaxPostRequest({url:b,data:j,requestID:["ajax",f].join("_")}).always(function(a){a=a||{},"success"===a.state?i.resolve(a.response):i.reject(a.reason)}):i.resolve({mailID:a.mailID,folderID:a.folderID,useConversation:a.useConversation,entityExists:!1})}return i.promise()},g=function(a){a=a||{};var f=["createCommentEntity",a.mailID,a.shareConversation,a.useConversation,a.inviteRecipients,a.lockInvites,a.recipientList,a.inviteesList.join("_")].join("_"),g=["deferred",f].join("_"),h=!d.has(g),i=d.get(g),j=a.useConversation?a.useConversation:Boolean(e.getMailMetaData(a.mailID).T),k=a.mailList?a.mailList.join(","):"";j=!a.isDraftShare&&j;var l=c.isNewCollabUser()&&!a.isDraftShare?!k.length:j,m=a.inviteRecipients&&!a.inviteesList.length;if(h){var n={mode:"createCommentEntity",mailID:a.mailID,shareConversation:l,useConversation:j,zohoID:e.getCurrentZUID(),accountID:e.getCurrentAccountID(),inviteesList:a.inviteesList.join(","),lockInvites:a.lockInvites,mailList:k,inviteRecipients:m};c.ajaxPostRequest({url:b,data:n,requestID:["ajax",f].join("_")}).always(function(a){a=a||{},"success"===a.state?i.resolve(a.response):i.reject(a.reason)})}return i.promise()},h=function(a){a=a||{};var f=[a.mode,a.mailID].join(""),g=["deferred",f].join("_"),h=!d.has(g),i=d.get(g);if(h){var j=c.isNewCollabUser(),k={mode:a.mode,zohoID:e.getCurrentZUID(),accountID:e.getCurrentAccountID()};"unShareMailsInConversation"===a.mode?(a.conversationID&&(k.conversationID=a.conversationID),k.mailList=a.mailID):(k.mailID=a.mailID,k.shareType=j),c.ajaxPostRequest({url:b,data:k,requestID:["ajax",f].join("_")}).always(function(a){a=a||{},"success"===a.state?i.resolve(a.response):i.reject(a.reason)})}return i.promise()},i=function(a){a=a||{};var f=["unShareMailsInConversation",a.mailID].join(""),g=["deferred",f].join("_"),h=!d.has(g),i=d.get(g);if(h){var j={mode:"unShareMailsInConversation",mailID:a.mailID,zohoID:e.getCurrentZUID(),accountID:e.getCurrentAccountID(),conversationID:e.getConversationID()};c.ajaxPostRequest({url:b,data:j,requestID:["ajax",f].join("_")}).always(function(a){a=a||{},"success"===a.state?i.resolve(a.response):i.reject(a.reason)})}return i.promise()},j=function(a){a=a||{};var e=["notifyDraftUpdate",a.draftID].join(""),f=["deferred",e].join("_"),g=!d.has(f),h=d.get(f);if(g){var i={mode:"notifyDraftUpdate",draftID:a.draftID,zohoID:a.zohoID,accountID:a.accountID};c.ajaxPostRequest({url:b,data:i,requestID:["ajax",e].join("_")}).always(function(a){a=a||{},"success"===a.state?h.resolve(a.response):h.reject(a.reason)})}return h.promise()};return a.Backend={getMailShareData:f,createCommentEntity:g,updateConversationShare:h,notifyDraftUpdate:j,unshareMails:i},a}(),function(){window.zmMailCollab=window.zmMailCollab||{};var a=window.zmMailCollab,b=zmMailCollab.Event,c=zmMailCollab.EventConstants,d=zmMailCollab.Util,e=zmMailCollab.Interface.Internal,f=e.getJQuery(),g=e.getI18N,h="SCS_postWra js-collab-component",i="js-load-progress",j={MailCollab:['<div class="'+h+'"></div>'].join(""),MailShareTipDialog:['<div style="">',"<h4>",'<span x-id="message">'+g("messages.tipMessage")+"</span>",'<div style="margin-top: 20px">','<span x-id="checkbox-holder" style="margin-left: 5px; cursor: pointer;">','<i x-id="checkbox" class="msi-uncheck" style="margin-right: 5px;"></i>',g("labels.dontShowAgain"),"</span>","</div>","</h4>","</div>"].join(""),ConversationShareAlertDialog:['<div style="">','<div class="paraDiv">','<div x-id="message"></div>',"<div>"+g("messages.proceed")+"</div>","<div></div>","<div>",'<span x-id="checkbox-holder" style="cursor: pointer;">','<i x-id="checkbox" class="msi-uncheck" ></i>',g("labels.dontShowAgain"),"</span>","</div>","</div>","</div>"].join("")},k=function(a,b){a=a||{};var c={isDraftShare:!0,comments:a.commentData,total:a.commentData.totalCount,id:a.mailID,isShare:!1,fixedComment:!1,mentions:[],groupsMention:!0,groupId:a.zohoUserID,etype:"1",owner:a.zohoUserID,sharedCall:!0,sharedApiCall:!1,placeHolder:{button:g("labels.shareDraft"),changeText:g("labels.sharing"),textArea:g("placeholders.shareDraftByMention")},entityExists:!a.createEntity,miscData:a.miscData||{mailID:a.mailID},resizeComment:a.resizeFn};return b.isSmartCompose&&(c.fixedComment=!0,c.fixedElement=$(b.containerDOM).parent(),c.isNewCollabUser=!0),a.createEntity&&(c.createEntityDeferredCallback=a.createEntityDeferredCallback),c},l=function(a){a=a||{};var b=a.inviteeIDList?Object.keys(a.inviteeIDList):[],c=g(a.useConversation&&a.mailCount>1?"labels.shareConversation":"labels.shareMail"),e=g(a.useConversation&&a.mailCount>1?"placeholders.shareByMention":"placeholders.shareMailByMention"),f={comments:a.commentData,total:a.commentData.totalCount,id:a.conversationID||a.mailID,isShare:!1,fixedComment:!1,mentions:[],groupsMention:!0,groupId:a.zohoUserID,etype:"1",owner:a.zohoUserID,sharedCall:!0,sharedApiCall:a.createEntity,hideComponent:d.isCommentBoxHidden(),placeHolder:{button:c,changeText:g("labels.sharing"),textArea:e},inviteeList:b,entityExists:!a.createEntity,miscData:{mailID:a.mailID,openedBy:a.openedBy,openedTab:a.openedTab},recipientList:a.recipientList};return d.isNewCollabUser()&&(f.fixedComment=!0,f.fixedElement=$(a.parentElm).parent(),f.isNewCollabUser=!0,f.openedId=a.mailID),a.createEntity&&(f.createEntityDeferredCallback=a.createEntityDeferredCallback),f},m=function(a){a=a||{};var b={by:a.zohoUserID,actionType:"viewSelfData",id:a.conversationID||a.mailID,etype:1,lockInvites:a.lockInvites,groupId:a.zohoUserID,showinvite:!0,like:a.selfLiked,invitee:Object.keys(a.inviteeIDList).length,likes:a.likeCount,privateToPost:!1,inviteeList:a.inviteeIDList,showInviteeList:!0,likeList:a.likeList};return d.isNewCollabUser()&&(b.fixedComment=!0),b},n=function(){var a=f('<div class="'+i+'"></div>');return e.createLoadingBand({container:a[0],type:"pagination"}),zmMailCollab.reqPatch&&a.children(".SC_sld").css("margin","10px auto").attr("title",g("labels.loadingComments")),a[0]},o=function(){var a={},b=function(b,d){f.unsubscribe(c.EXTERNAL_COMMENT_COMPONENT_RESIZE,a[b]),a[b]=d,f.subscribe(c.EXTERNAL_COMMENT_COMPONENT_RESIZE,d)};return{subscribe:b}}(),p=function(a){a=a||{};var h={},i=50,p=f(j.MailCollab);a.isSmartCompose&&p.addClass("SC_DrftShr"),zmMailCollab.patch&&(a.isDraftShare!==!0?p.css("padding","10px 15px 0 20px"):p.css("padding","0"));var q,r,s=f(n()).appendTo(p).hide(),t=!1,u=!1,v=function(){b.publish(c.COLLABCOMPONENT_INSTANCE_RESIZE,{instance:h})};return h.setData=function(j){j=j||{};for(var n=["zohoUserID","mailID","createEntity"],w=!1,x=0,y=n.length;x<y;x++){var z=n[x];if(!j.hasOwnProperty(z)){w=!0;break}}if(w)return d.log("Error","Required data missing for initialization",h,j),!1;if(j.createEntity)t=!1;else{if(!r){var A=m(j);r=f(e.createStreamsPostActionComponent(A)).appendTo(p).hide(),zmMailCollab.patch&&(a.isDraftShare!==!0?r.find(".mailSharedList").css("margin-top","-6px"):r.find(".mailSharedList").css("margin-top","-16px")),a.isDraftShare&&v()}t=!0}if(j.commentData){if(!q){j.resizeFn=v;var B=a.isDraftShare!==!0?l(j,q):k(j,a);if(d.isNewCollabUser()&&!a.isDraftShare||a.isSmartCompose&&a.isDraftShare){q=e.createStreamsCommentComponent(B,p),q.find(".zms_fixed").addClass("zmCmntFixed ").data("openType",j.openedBy).data("openedTab",j.openedTab);var C=q.find("textarea.zms_cmTxt");a.isSmartCompose&&a.isDraftShare||!j.useConversation||!d.isConversationFalse(j)||!j.createEntity||1!==q.parent().find(".js-shareicon").length?a.isSmartCompose&&a.isDraftShare&&a.commentFocused&&C.focus(function(){a.commentFocused()}):(C.addClass("focusin"),C.focus(function(){var a=q.parent().find(".js-shareicon");!a.hasClass("sld")&&C.hasClass("focusin")&&q.parent().find(".js-shareicon").click(),C.removeClass("focusin")}))}else q=f(e.createStreamsCommentComponent(B)).appendTo(p).hide();zmMailCollab.patch&&(q.find(".zm_inclr").css("user-select","none"),q.find(".zm_inclr").css("-webkit-user-select","none"),q.find(".zm_inclr").css("vertical-align","middle"),q.find(".zm_inclr").find("i:first").css("vertical-align","middle").css("margin-right","3px"),q.find(".zm_inclr").find("div:first").css("vertical-align","middle").css("display","inline-block").css("cursor","pointer")),(zmMailCollab.globalPatch||zmMailCollab.patch)&&(q.find(".zm_inclr").find("div:first").on("click",function(){q.find(".zm_inclr").find("i:first").trigger("click")}),q.find(".zm_inclr").find("div:first").text(g("messages.includeRecipients"))),a.isDraftShare&&(o.subscribe(j.mailID,v),v(),p.find(".sc_cmdv").addClass("SCS_draftCmnt"))}u=!0}else u=!1;var D=!(t||u);return h.setProgress(D).done(function(){var b=[f.Deferred(),f.Deferred()];r&&(t?r.fadeIn(i,b[0].resolve):r.fadeOut(i,b[0].resolve)),q&&(u?q.fadeIn(i,b[1].resolve):q.fadeOut(i,b[1].resolve)),a.isDraftShare&&(b[0].done(v),b[1].done(v)),d.isCommentBoxHidden()&&!d.isNewCollabUser()&&q.parent().hide()}),r&&r.prependTo(p),s.prependTo(p),b.publish(c.COLLABCOMPONENT_INSTANCE_DATA_SET,{instance:h}),a.isDraftShare&&v(),!0},h.show=function(a){a=a||{};var b=f.Deferred();return a.animation===!1?(p.show(),b.resolve()):p.fadeIn(i,b.resolve),a.isDraftShare&&b.done(v),b},h.focus=function(a){a=a||{},a.suppressScroll||p[0].scrollIntoView(),p.focus(),p.find("textarea").focus()},h.highlight=function(){var a=p.find(".zmCmntFixed"),b=p.find("textarea").parent(".zm_mention")[0];_zm.hasClass(a[0],"highlightClass")&&_zm.hasClass(b,"highlightClass")||(a.addClass("highlightClass"),_zm.addClass(b,"highlightClass"),setTimeout(function(){a.removeClass("highlightClass"),_zm.removeClass(b,"highlightClass")},5e3))},h.hide=function(a){a=a||{};var b=f.Deferred();return a.animation===!1?(p.hide(),b.resolve()):p.fadeOut(i,b.resolve),a.isDraftShare&&b.done(v),b},h.remove=function(){p.remove(),a.isDraftShare&&v()},h.getDOM=function(){return p[0]},h.appendTo=function(b){p.appendTo(f(b)),a.isDraftShare&&v()},h.setProgress=function(b){var c=f.Deferred();return b===!1?s.is(":visible")?s.fadeOut(i,c.resolve):(s.hide(),c.resolve()):b===!0&&s.fadeIn(i,c.resolve),a.isDraftShare&&c.done(v),c.promise()},h.hide(),b.publish(c.COLLABCOMPONENT_INSTANCE_CREATED,{instance:h}),h},q=function(){var a,b="share-mail-tip-dialog",d=!1,h=j.MailShareTipDialog,i=f(h).attr("id",b),k=i.find("[x-id=checkbox]");i.find("[x-id]").removeAttr("x-id");var l=!1,m=function(){e.removeDialog(),f("#"+b).remove()},n=function(){l&&(e.turnOffMailShareTip(),l=!1,k.removeClass("msi-check").addClass("msi-uncheck"))},o=function(){n(),m()},p=function(){n(),m(),f.publish(c.EXTERNAL_MAIL_VIEW_FOCUSCOMMENT,a)},q={style:{width:"500px"},mask:!0,hideclose:!1,pos:"center",title:g("labels.shareTipDialogTitle"),closeaction:function(){f("#"+b).remove(),d=!1}},r={"default":[{txt:g("labels.shareTipDialogOk"),callback:o,selected:!0}],forward:[{txt:g("labels.shareTipDialogOk"),callback:o,selected:!0},{txt:g("labels.shareTipDialogShareNow"),callback:p,isCancel:!0}]},s=function(b){if(b=b||{},a=b,!d){var c=a.mode||"default";"forward"!==c||a.containerDOM||(c="default"),q.buttons=r[c];var f=function(){i.hide()};e.isDialogOpen()?e.listenOnceDialogClose(function(){f()}):f()}};return{show:s}}(),r=function(a){a=a||{};var b=["conversation-share-alert-dialog",String(Date.now())].join("_"),c=f.Deferred(),d=f(j.ConversationShareAlertDialog).attr("id",b),h=d.find("[x-id=message]"),i=d.find("[x-id=checkbox-holder]"),k=d.find("[x-id=checkbox]"),l=!1;d.find("[x-id]").removeAttr("x-id");var m=function(){e.removeDialog(),f("#"+b).remove()},n=function(){l&&(e.turnOffShareWarning(),l=!1,k.removeClass("msi-check").addClass("msi-uncheck"))},o=function(){n(),c.resolve(),m()},p=function(){n(),c.reject(),m()},q=function(){k.toggleClass("msi-check").toggleClass("msi-uncheck"),l=k.hasClass("msi-check")},r={style:{width:"500px"},mask:!0,hideclose:!1,pos:"center",title:g("labels.shareDialogTitle"),closeaction:function(){f("#"+b).remove(),c.reject();
}},s=[{txt:g("labels.dialogOkay"),callback:o,selected:!0},{txt:g("labels.dialogCancel"),callback:p,isCancel:!0}],t=function(a){a=(a||"").trim().toLowerCase();var b,c,d;if(a)return c=a.indexOf("<"),d=a.indexOf(">"),c>-1&&d>-1&&(b=a.substring(c+1,d)),b},u=function(){if(!a.mailCount||!a.senderList)return c.reject(),c.promise();var j=a.senderList||[],l=!1;if(j.forEach(function(a,b){var c=t(a);e.isCurrentUserEmail(c)&&(l=!0,j.splice(b,1))}),l&&j.push(g("labels.yourself")),j.length>1){var m=j.splice(j.length-1,1)[0];j=j.join(", "),j=[j,"&",m].join(" ")}else 1===j.length&&(j=j[0]);j=e.replaceHTMLEntities(j||"");var n=f("<span>").text(a.mailCount).html(),o=f("<span>").text(j).html(),p=g("messages.shareDialogMessage",{mailCount:n,senderList:o}),u=f("<div>").html(p),v="",w={SINGLE_MAILS:g("listingTypes.noConversations"),FOLDER_MAILS:g("listingTypes.folderSpecific"),ALL_MAILS:g("listingTypes.acrossFolder")},x="";if(e.isPartialConversationView()){var y=w[e.getCurrentConversationViewType()];x=g("messages.partialConversationView",{listingMode:y})}return x&&(v=f("<div>").html(x)),h.append(u).append(v),i.hide(),k.hide(),i.off().on("click",q),r.buttons=s,d.hide(),d.appendTo(e.getDocumentBody()),e.createDialog(b,r),d.show(),c.promise()};return{show:u}};return a.Components={MailCollab:{create:p},MailShareTipDialog:{show:q.show},ConversationShareAlertDialog:{create:r}},a}(),function(){window.zmMailCollab=window.zmMailCollab||{};var a=window.zmMailCollab,b=zmMailCollab.EventConstants,c=zmMailCollab.Interface.Internal,d=c.getJQuery(),e=zmMailCollab.Components.MailShareTipDialog,f=c.getI18N,g=function(a,b){b=b||{};var d=c.getMailShareTipState();if("off"!==d){var f=c.getMailMetaData(b.mailID)||{};(b.mailID||"forward"!==b.mode)&&(b.suppressComponentCheck=!0,b.folderID=f.FD,b.folderData=c.getFolderData(b.folderID)||{},zmMailCollab.Util.isSharingValid(b)&&e.show(b))}},h=function(a){if(a){var b={zohoUserID:c.getCurrentZUID(),mailID:a.mailID,conversationID:a.useConversation&&a.conversationID?a.conversationID:a.mailID,useConversation:a.useConversation,createEntity:!a.entityExists,commentData:a.commentData,selfLiked:a.likeList.indexOf(c.getCurrentZUID())!==-1,likeCount:a.likeList.length,inviteeIDList:a.inviteeList,mailCount:a.conversationData.mailCount,lockInvites:a.lockInvites,likeList:a.likeList,recipientList:a.recipientList,openedBy:a.openedBy,openedTab:a.openedTab};return b}},i=function(a,b){b=b||{};var e=b.deferred||d.Deferred(),f=zmMailCollab.Event,g=zmMailCollab.EventConstants;if(!b.draftID)return e.reject({code:0,message:"Invalid params"}),e.promise();if(b.suppressComments)return e.reject({code:1,message:"User suppressed",suppressError:!0}),e.promise();var i=zmMailCollab.Model.MailShareData,j=zmMailCollab.Collection.MailShareData,k=zmMailCollab.Components.MailCollab,l=i.create({mailID:b.draftID,useConversation:!1});l=j.get(l);var m=k.create({isDraftShare:!0,isSmartCompose:b.isSmartCompose,containerDOM:b.containerDOM});b.containerDOM?m.appendTo(b.containerDOM):"function"==typeof b.appendCallback&&b.appendCallback({jqDOM:d(m.getDOM())});var n={mailID:b.draftID,uploadCallback:function(){"function"==typeof b.onResize&&b.onResize({draftID:b.draftID,context:b.context})}},o=function(){m.setProgress(!0),m.show();var a=h(l);a.createEntity&&(a.createEntityDeferredCallback=function(b){b=b||{},b.mentions=(b.mentions||"").trim();var d=b.mentions.length?b.mentions.split(","):[],e=c.createCommentEntity({mailID:a.mailID,shareConversation:!1,useConversation:!1,inviteRecipients:!1,lockInvites:b.lockInvites,inviteesList:d,isDraftShare:!0});return e.promise()}),a.miscData=n,m.setData(a),f.subscribe(g.MAILSHAREDATA_PROPERTY_CHANGED,function(b,c){c=c||{},l===c.instance&&"entityExists"===c.property&&c.value===!0&&(a=h(l),a.miscData=n,m.setData(a))}),e.resolve({focusComments:function(){m.focus({suppressScroll:!0})},jqDOM:d(m.getDOM())})};return c.loadStreamsModule().then(o),e.promise()},j=function(a,b){b=b||{};var c=b.deferred||d.Deferred();if(!b.draftID)return c.reject({code:0,message:"Invalid params"}),c.promise();if(b.suppressComments)return c.reject({code:1,message:"User suppressed",suppressError:!0}),c.promise();var e=zmMailCollab.Model.MailShareData,f=zmMailCollab.Collection.MailShareData,g=e.create({mailID:b.draftID,useConversation:!1});f.put(g,{overwrite:!0}),g.initialize().done(function(){var a=g.getCommentData()||{};c.resolve({success:!0,entityExists:g.getEntityExists(),context:b.context,count:a.totalCount})})},k=function(a,b){b=b||{};var d=zmMailCollab.Util;if(!b.suppressComments){if(!b.mailID&&!b.containerDOM)return void d.log("Invalid params");b.useConversation=!b.hasOwnProperty("useConversation")||b.useConversation;var e=d.isSharingValid({containerDOM:b.containerDOM,folderID:b.folderID,folderData:b.mailID===b.conversationID?c.getFolderData(b.folderID)||{}:{}});if(e){var f=zmMailCollab.Model.MailShareData,g=zmMailCollab.Collection.MailShareData,h=zmMailCollab.Collection.MailShareData.get(b);if(!h||b.commentValue!==h.commentValue||h.entityExists){var i=f.create({mailID:b.mailID,useConversation:b.useConversation,conversationID:b.conversationID,lockInvites:b.lockInvites,commentValue:b.commentValue,recipientList:b.recipientList});i.initialize(),g.put(i,{overwrite:!0})}}}},l=function(a,b){var e=zmMailCollab.Util,g=e.isSharingValid({containerDOM:b.containerDOM,folderID:b.folderID,folderData:b.mailID===b.conversationID?c.getFolderData(b.folderID)||{}:{}});if(g){var i=zmMailCollab.Collection.CollabContainer,j=zmMailCollab.Event,k=zmMailCollab.EventConstants,l=zmMailCollab.Model.MailShareData,m=zmMailCollab.Components.MailCollab,n=m.create(),o=zmMailCollab.Model.CollabContainer,p=i.getWithDOM({containerDOM:d(b.containerDOM)[0]}),q=o.create({mailID:b.mailID,useConversation:b.useConversation,conversationID:b.conversationID,containerDOM:d(b.containerDOM)[0],component:n,commentValue:b.commentValue,openType:b.openedBy,openedTab:b.openedTab});i.removeAll(p),i.put(q),c.loadStreamsModule().then(function(){n.setProgress(!0),n.appendTo(b.containerDOM),n.show();var a=zmMailCollab.Collection.MailShareData.get(b),d=!0;if(!a){a=l.create({mailID:b.mailID,useConversation:b.useConversation,conversationID:b.conversationID,lockInvites:b.lockInvites,commentValue:b.commentValue,recipientList:b.recipientList});var g=zmMailCollab.Collection.MailShareData;g.put(a,{overwrite:!0}),d=!1}a.openedBy=b.openedBy,a.openedTab=e.getCurrentTab(b.openedTab),a.initialize({delay:b.commentLoadDelay}).done(function(){if(!e.isValidContainer(b.containerDOM,a))return e.log("SHARING_INVALID","wrong container loaded"),i.remove(b.containerDOM),!1;var g=h(a);if(g.parentElm=b.containerDOM,g.createEntity&&(g.createEntityDeferredCallback=function(b){b=b||{},b.mentions=(b.mentions||"").trim(),b.includeRecipients=b.includeRecipients||!1,b.selectedMailIds=b.selectedMailIds||[];var d=b.mentions.length?b.mentions.split(","):[],h=b.selectedMailIds.length?e.sortMailIds(b.selectedMailIds,a.conversationData):[],i=c.createCommentEntity({mailID:g.mailID,shareConversation:Boolean(a.useConversation&&a.conversationID),useConversation:a.useConversation,inviteRecipients:b.includeRecipients,inviteesList:d,lockInvites:b.lockInvites,senderList:a.conversationData.senderList,mailCount:a.conversationData.mailCount,mailList:h}),j=a.useConversation&&a.conversationData.mailCount>1;return i.done(function(){e.showSuccessMessage(f(j?"messages.conversationShareSuccess":"messages.mailShareSuccess")),e.updateMailCache(g.mailID)}),i.promise()}),n.setData(g),j.subscribe(k.MAILSHAREDATA_PROPERTY_CHANGED,function(b,c){c=c||{},a===c.instance&&"entityExists"===c.property&&c.value===!0&&(g=h(a),n.setData(g))}),d){var l=zmMailCollab.Event;l.publish(k.MAILSHAREDATA_PROPERTY_CHANGED,{containerDOM:a.containerDOM,property:"sharedUptoTime",instance:a,mailID:a.mailID})}}).fail(function(a){a=a||{},a.suppressError||e.showErrorMessage(f("messages.cantLoadComments")),e.log("Cannot load comment data for mail",b.mailID,b.containerDOM)})})}},m=function(a,b){b=b||{};var e=zmMailCollab.Event,f=zmMailCollab.EventConstants,g=zmMailCollab.Util,i=b.deferred||d.Deferred();if(!b.draftID)return i.reject({code:0,message:"Invalid params"}),i.promise();if(b.suppressComments)return i.reject({code:1,message:"User suppressed",suppressError:!0}),i.promise();var j=zmMailCollab.Model.MailShareData,k=zmMailCollab.Collection.MailShareData,l=zmMailCollab.Components.MailCollab,m=j.create({mailID:b.draftID,useConversation:!1,isDraftShare:!0}),n=l.create({isDraftShare:!0,isSmartCompose:b.isSmartCompose,containerDOM:b.containerDOM,commentFocused:b.commentFocused});b.containerDOM?n.appendTo(b.containerDOM):"function"==typeof b.appendCallback&&b.appendCallback({jqDOM:d(n.getDOM())}),b.isSmartCompose||e.subscribe(f.COLLABCOMPONENT_INSTANCE_RESIZE,function(a,c){c=c||{},c.instance===n&&"function"==typeof b.onResize&&(g.log("Calling onResize() of compose...",b),b.onResize({draftID:b.draftID,context:b.context}))}),k.put(m,{overwrite:!0}),m.initialize();var o={mailID:b.draftID,uploadCallback:function(){"function"==typeof b.onResize&&b.onResize({draftID:b.draftID,context:b.context})}},p=function(){n.setProgress(!0),n.show(),m.initialize().done(function(){var a=h(m);a.createEntity&&(a.createEntityDeferredCallback=function(b){b=b||{},b.mentions=(b.mentions||"").trim();var d=b.mentions.length?b.mentions.split(","):[],e=c.createCommentEntity({mailID:a.mailID,shareConversation:!1,useConversation:!1,inviteRecipients:!1,lockInvites:b.lockInvites,inviteesList:d,isDraftShare:!0});return e.promise()}),a.miscData=o,n.setData(a),e.subscribe(f.MAILSHAREDATA_PROPERTY_CHANGED,function(b,c){c=c||{},m===c.instance&&"entityExists"===c.property&&c.value===!0&&(a=h(m),a.miscData=o,n.setData(a))});var g=m.getCommentData()||{};i.resolve({success:!0,entityExists:m.getEntityExists(),focusComments:function(){n.focus({suppressScroll:!0})},highlightComment:function(){n.highlight()},jqDOM:d(n.getDOM()),context:b.context,count:g.totalCount})}).fail(function(a){a=a||{},a.success=!1,i.reject(a),g.log("Cannot load comment data for draft",b.mailID,b.containerDOM)})};return c.loadStreamsModule().then(p),i.promise()},n=function(a,b){b=b||{};var c=zmMailCollab.Backend;return b.deferred=b.deferred||d.Deferred(),b.draftID&&b.zohoID&&b.accountID?void c.notifyDraftUpdate({draftID:b.draftID,zohoID:b.zohoID,accountID:b.accountID}).done(function(a){b.deferred.resolve(a)}).fail(function(a){b.deferred.reject(a)}):void b.deferred.reject({code:0,message:"Invalid params"})},o=function(a,b){b=b||{},b.config=b.config||{};var c=zmMailCollab.Util;b.config.allowed=c.isSharingValid(b);var d=zmMailCollab.Collection.CollabContainer,e=d.getWithDOM({containerDOM:b.container[0]})[0];if(b.config.allowed&&e){var g=zmMailCollab.Collection.MailShareData,h=g.get({mailID:e.getMailID(),conversationID:e.getConversationID(),useConversation:e.getUseConversation()}),i=h.entityExists;if(b.config.entityExists=i,b.config.isConvo=e.getUseConversation(),i){var j=h.getSharedMailIds();b.config.sharedText=f(j&&j.indexOf(b.mailID)!==-1?"tooltips.unshare":"tooltips.shareConvo")}}},p=function(a,b){b=b||{};var c=zmMailCollab.Util;if(c.log("Update share icon clicked !",b),!b.containerDOM||!b.mailID)return void c.log("Update share error. Params missing.");if(b.elm&&$(b.elm).hasClass("shd")&&!c.isNewCollabUser())return void c.log("Already shared mail.");var e=zmMailCollab.Backend,g=zmMailCollab.Collection.MailShareData,h=zmMailCollab.Collection.CollabContainer,i=h.getWithDOM({containerDOM:b.containerDOM})[0];if(!i)return void c.log("container component empty check if from streams side...");if(i.getUpdateOperationPending())return c.showErrorMessage(f("messages.updateShareInProcess")),void c.log("Already an update operation is pending...");var j="updateConversationShare";$(b.elm).hasClass("shd")&&i.getUseConversation()&&(j="unShareMailsInConversation");var k,l=g.get({mailID:i.getMailID(),conversationID:i.getConversationID(),useConversation:i.getUseConversation()}),m=zmMailCollab.EventConstants;if(b.elm&&(k=$(b.elm).data("shared"),!k&&!l.entityExists))return $(b.elm).toggleClass("sld"),b.mode=$(b.elm).hasClass("sld")?"add":"remove",void d.publish(m.MAILSHAREDATA_SELECTMAIL,b);if(!l)return c.showErrorMessage(f("messages.updateShareNoData")),void c.log("Mailshare data was not available...");var n=l.getConversationData()||{},o=n.mailReceiveTime||{},p=l.getSharedUptoTime(),q=o[b.mailID];p&&q&&p>=q&&!l.getSharedMailIds().length&&"unShareMailsInConversation"!==j||(i.setUpdateOperationPending(!0),e.updateConversationShare({mailID:b.mailID,mode:j,conversationID:i.conversationID}).done(function(a){if(a=a||{},a.lastReceiveTime||"updateConversationShare"!==j){i=h.getWithDOM({containerDOM:b.containerDOM})[0];var d=g.get({mailID:b.mailID,useConversation:i.useConversation,conversationID:i.conversationID});if(d)if(c.isNewCollabUser){var e,k=d.getSharedMailIds();"updateConversationShare"===j?(k.push(b.mailID),e=f("tooltips.unshare"),$(b.elm).attr("title",e)):(k.splice(k.indexOf(b.mailID),1),e=f("tooltips.shareConvo"),$(b.elm).attr("title",e)),d.setSharedMailIds(k)}else d.setSharedUptoTime(a.lastReceiveTime);if(b.elm){var l="updateConversationShare"===j?"addClass":"removeClass";$(b.elm)[l]("shd")}c.showSuccessMessage(f("messages.updateShareSuccess")),c.log("Update share success",d)}}).fail(function(a){c.showErrorMessage(f("messages.updateShareError")),c.log("Update share error",a)}).always(function(){i.setUpdateOperationPending(!1)}))},q=function(a,b){b=b||{};var e=zmMailCollab.Collection.CollabContainer,f=zmMailCollab.Util;if(!b.containerDOM)return void f.log("Cannot handle component focus without ContainerDOM reference");b.workspaceID&&c.switchToApp(b.workspaceID);var g=e.getWithDOM({containerDOM:d(b.containerDOM)[0]});f.isCommentBoxHidden()&&$(b.containerDOM).find(".SCS_postWra").show().find(".SCS_cmnt").show(),g.forEach(function(a){var b=a.getComponent();b.focus()})},r=function(a,b){b=b||{};var c=zmMailCollab.Util;if(["entityExists","sharedUptoTime"].indexOf(b.property)!==-1){var e=zmMailCollab.Collection.CollabContainer,g=zmMailCollab.EventConstants,h=b.instance,i=e.getWithData({mailID:h.getMailID(),useConversation:h.getUseConversation(),conversationID:h.getConversationID()}),j=h.getSharedMailIds(),k=h.getConversationData(),l=k.mailReceiveTime||{},m=h.getSharedUptoTime(),n=k.mailIds;n=h.getUseConversation()?n:[h.mailID];var o,p;if(c.isNewCollabUser()){if(!j.length)for(o in l)p=l[o],m>=p&&j.push(o)}else if(h.getEntityExists()&&!m){for(o in l)p=l[o],m?m>p&&(m=p):m=p;if(m)return void h.setSharedUptoTime(String(m))}var q={disabled:-1,shared:1,notshared:0},r={disabled:"",shared:f("tooltips.sharedMail"),notshared:f("tooltips.unsharedMail"),singleMailShare:f("tooltips.singleMailShare")};i.forEach(function(a){for(var b,e=0;e<n.length;e++){b=n[e];var i=q.disabled,k=r.disabled;c.isNewCollabUser()?j&&j.indexOf(b)!==-1?(i=q.shared,k=f("tooltips.unshare")):j.length?(i=q.notshared,k=f("tooltips.shareConvo")):(i=q.notshared,k=r.singleMailShare):m&&h.getEntityExists()&&(m>=l[b]?(i=q.shared,k=r.shared):(i=q.notshared,k=r.notshared)),d.publish(g.EXTERNAL_MAIL_PREVIEW_UPDATE_SHAREICON,{containerDOM:a.getContainerDOM(),mailID:b,state:i,tooltip:k,entityExists:h.getEntityExists()})}})}},s=function(a,b){b=b||{};var c=zmMailCollab.Collection.MailShareData,d=zmMailCollab.Util,e=b.instance;if(!e&&b.mailID&&(e={mailID:b.msgId,conversationID:b.thdId,useConversation:b.thdId&&""!==b.thdId}),e){var f=c.get({mailID:e.mailID,conversationID:e.conversationID,useConversation:e.useConversation});f&&(d.log("Data Initialize cancelled. Because new component loaded in same container... ",f),f.abortInit())}},t=function(a,b){b=b||{};var c=zmMailCollab.Util;b.conversationID&&c.log("Single mail converted into thread",b.conversationID)},u=function(a){zmMailCollab.Util.resetBottom(zmsuite.getCenter("zm_Container")[1].$el)},v=function(){var a=zmMailCollab.Event;d.subscribe(b.EXTERNAL_COMPOSE_BCC_EVENT,g),d.subscribe(b.EXTERNAL_MAIL_OPENING_EVENT,k),d.subscribe(b.EXTERNAL_MAIL_OPENED_EVENT,l),d.subscribe(b.EXTERNAL_DRAFT_OPENED_EVENT,m),d.subscribe(b.EXTERNAL_DRAFT_OPENING_EVENT,j),d.subscribe(b.EXTERNAL_DRAFT_COMMENT_CONSTRUCT_EVENT,i),d.subscribe(b.EXTERNAL_DRAFT_NOTIFY_UPDATES_EVENT,n),d.subscribe(b.EXTERNAL_MAILCOLLAB_SHARE_STATUS,o),d.subscribe(b.EXTERNAL_MAIL_VIEW_FOCUSCOMMENT,q),d.subscribe(b.EXTERNAL_MAIL_PREVIEW_UPDATE_SHARE,p),d.subscribe(b.EXTERNAL_MAIL_THREAD_CREATED,t),d.subscribe(b.EXTERNAL_MAIL_CLOSE_PREVIEW,u),d.subscribe(b.EXTERNAL_MAIL_CHANGE_PREVIEW,s),a.subscribe(b.MAILSHAREDATA_PROPERTY_CHANGED,r),a.subscribe(b.COLLECTION_COLLABCOMPONENT_INSTANCE_REMOVED,s),zmMailCollab.reqPatch=!0};return v(),a}();